"use strict";(window.webpackChunk=window.webpackChunk||[]).push([[26901],{26901:(e,t,i)=>{i.r(t),i.d(t,{default:()=>ce});var n=i(661533),s=i.n(n),o=i(629133),r=i.n(o),a=i(987081),l=i(128508),d=i(460159),c=i.n(d),_=i(395882),h=i.n(_),u=i(162262),f=i.n(u),p=i(267651),g=i.n(p),m=i(313981),v=i(116028),y=i(156040),b=i(335745),w=i(672034),k=i(926168),A=i(214558),C=i(982862),E=i(445368),T=i(168807),P=i(450422),S=i(500034),F=i(418860),I=i(278385),M=i(774986),O=i(881436),x=i(658903),L=i(5465),j=i(796940),N=i(22748),R=i(89096),D=i(940437),U=i(996308),V=i(482857),B=i(942378),$=i(843985),J=i(963034),W=i(271311),H=i(580326),G=i(585543),z=i(238935),q=i(757738),K=i(70156),Y=i(762091),X=i(43205),Z=i(466072),Q=i(956332),ee=i(353256);function te(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function ie(e,t,i,n,s,o,r){try{var a=e[o](r),l=a.value}catch(e){return void i(e)}a.done?t(l):Promise.resolve(l).then(n,s)}function ne(e){return function(){var t=this,i=arguments;return new Promise((function(n,s){var o=e.apply(t,i);function r(e){ie(o,n,s,r,a,"next",e)}function a(e){ie(o,n,s,r,a,"throw",e)}r(void 0)}))}}function se(e,t){var i,n,s,o,r={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;r;)try{if(i=1,n&&(s=2&o[0]?n.return:o[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,o[1])).done)return s;switch(n=0,s&&(o=[2&o[0],s.value]),o[0]){case 0:case 1:s=o;break;case 4:return r.label++,{value:o[1],done:!1};case 5:r.label++,n=o[1],o=[0];continue;case 7:o=r.ops.pop(),r.trys.pop();continue;default:if(!((s=(s=r.trys).length>0&&s[s.length-1])||6!==o[0]&&2!==o[0])){r=0;continue}if(3===o[0]&&(!s||o[1]>s[0]&&o[1]<s[3])){r.label=o[1];break}if(6===o[0]&&r.label<s[1]){r.label=s[1],s=o;break}if(s&&r.label<s[2]){r.label=s[2],r.ops.push(o);break}s[2]&&r.ops.pop(),r.trys.pop();continue}o=t.call(e,r)}catch(e){o=[6,e],n=0}finally{i=s=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var oe=[APP.element_types.leads,APP.element_types.customers,APP.element_types.contacts],re="amocrm",ae=(0,S.isFeatureAvailable)(S.Features.IS_CUSTOMIZATION_FOR_GLOBAL);function le(e){var t=s().Deferred();return r().every(this.views,(function(i){if(1===i.view.models.length){if(i.view.model===e)return t.resolve(i.view.$el),!1}else if(r().contains(i.view.models,e))return r().isFunction(i.view.retrieveGroupedViewByModel)?i.view.retrieveGroupedViewByModel(e).then((function(e){t.resolve(e)})):t.resolve(i.view.$el),!1;return!0}))&&t.reject(),t.promise()}i(897920);var de=m.default.extend({className:"notes-wrapper",views:[],readers:null,_editing:null,_callbacks:{},_last_height:0,_unseen_count:0,_fully_loaded:!1,_scrollOnFullLoad:null,_classes:function(){return{notes:"js-notes",notes_scroller:"notes-wrapper__scroller",tasks:"js-tasks",tasks_wrapper:"notes-wrapper__tasks",filter_and_chat_users:"js-notes-filter-and-chat-users",firstTask:"js-feed-first-task-lite",ai_task:"js-ai-task",search:"js-feed-search",feed_compose:"feed-compose",green_line:"js-green-line",plug:"js-notes-plug",wrapper_animate_entrance:"feed-note-wrapper_animate-entrance",load_more_wrapper:"notes-wrapper__load-more",load_more_button:"js-feed-load-more",notification_reaction_wrapper:"notes-wrapper__reaction-notification",fixable:"js-note-fixable",fixable_future:"js-future-tasks-fixable",fixable_pinned:"js-note-pinned",today_task:"today",unseen_count:"js-unseen-count"}},_selectors:function(){return{compose_scrollbar:".notes-wrapper__compose-bottom, .feed-compose"}},events:{"click .js-feed-load-more":"_onLoadMoreClick","click .js-unseen-count":"_scrollToEnd","scroll .notes-wrapper__scroller":"_onScroll","click .reaction-notification":"_onNotificationClick"},document_events:{"notes:scroll-down":"_scrollToEnd"},initialize:function(e){m.default.prototype.initialize.apply(this,arguments),(0,P.isAmoChatsFullEnabled)()||this.loadMixins(),this.subscriptions=new a.Subscription,this.params=e||{},this.onTimelineRequestEnd=this.params.onTimelineRequestEnd,r().bindAll(this,"_onFileApiWindowOver"),this._debouncedStickyUpdate=r().debounce(r().bind(this._triggerStickyUpdate,this),50),this.views=[],this._views_now=[],this.all_printing={},this._unseen_count=0,this._has_future_tasks=!1,this.readers=[],this.params.callbacks&&this._setCallbacks(this.params.callbacks),this.params.class_name&&this.$el.addClass(this.params.class_name),this.params.no_player||this._addComponent(Q.default,{append_to:".feed-note-wrapper-call_in_out",input_special_class:"js-form-changes-skip",afterSetPositions:function(e,t){var i=e.position();t.css("width",""),t.css({left:i.left+e.width()/2-t.width()/2,top:i.top+e.height()/2-t.height()/2})}}),this._filter=this._addComponent(U.default,{element_type:this.params.element_type,getExtraData:r().bind((function(){var e=this.notes&&this.notes.findCollection(this.params.element_id);return this._getExtraData(e&&e.first(),e)}),this),onFilter:r().bind(this.loadMore,this,{reset:!0})}),this._search=this._addComponent(V.default,{element_id:this.params.element_id,element_type:this.params.element_type,filter:this._filter,onSearchScrollToView:r().bind(this.findAndScrollToView,this),onSearchApply:r().bind((function(){this.notes.trigger("notes:update-sticky")}),this),onSearchClear:r().bind((function(){this._current_search_highlight&&(this._current_search_highlight.trigger("search:highlight:unset"),this._current_search_highlight=null)}),this),onFilterToggle:r().bind((function(e){this._scrollDisable(e)}),this)}),this.initCollection({PagerCollection:this.params.PagerCollection,element_id:this.params.element_id,element_type:this.params.element_type,element_info:this.params.element_info}),this.params.notes&&this.addNotes(this.params.notes),this._$document.on("click".concat(this.ns),"#save_and_close_contacts_link",r().bind(this._preventSaveOrCancel,this)).on("click".concat(this.ns),r().bind(this._saveOrCancelOnClick,this)),h().event.dnd(window,this._onFileApiWindowOver,r().noop),this.params.element_type!==APP.element_types.catalog_elements&&(0!==this.params.element_id&&this._initAmoJoSocket(),y.onPageFullyLoaded(r().bind((function(){this.offReadOnInitHandler=y.onPageComponentLoadEnd(r().bind(this.read,this,r().bind((function(e){return(e.entity&&e.entity.id||"").toString()===this.params.element_id.toString()?{id:[e.notification_id.toString()],chat_ids:r().keys(H.AmoJoMediator.get())}:{}}),this),this.params.element_id,(0,k.convertElementType)(this.params.element_type,"single")),y.components.inbox)}),this))),APP.constant("old_unsorted_uid")&&y.onPageFullyLoaded(r().bind((function(){this.offReadOnInitUnsortedHandler=y.onPageComponentLoadEnd(r().bind((function(){this.read(r().bind((function(e){return(e.entity&&e.entity.id||"").toString()===APP.constant("old_unsorted_uid").toString()?{id:[e.notification_id.toString()],chat_ids:r().keys(H.AmoJoMediator.get())}:{}}),this),APP.constant("old_unsorted_uid"),"unsorted")}),this),y.components.inbox)}),this)),this.rich_links=(0,X.richLinks)({onStartRichLinksResolve:r().bind(this._onStartNotesMutations,this),onEndRichLinksResolve:r().bind(this._onEndNotesMutations,this),richesResolverRunner:y.onPageFullyLoaded})},_getTwigTemplate:function(){return"/tmpl/notes/wrapper.twig"},destroy:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this._destroyed=!0,this._$document.off(this.ns),this._scrolling_to_talk_id&&this._scrolling_to_talk_id.abort&&this._scrolling_to_talk_id.abort(),this.offReadOnInitHandler&&this.offReadOnInitHandler(),this.offReadOnInitUnsortedHandler&&this.offReadOnInitUnsortedHandler(),this._loading_more&&r().isFunction(this._loading_more.abort)&&this._loading_more.abort(),h().event.dnd.off(window,this._onFileApiWindowOver,r().noop),z.default.flush(),m.default.prototype.destroy.apply(this,t),this.subscriptions.unsubscribe(),r().isFunction(this._disconnectFeedWidthObserver)&&this._disconnectFeedWidthObserver(),this.readers=r().reject(this.readers,(function(e){return APP.inbox&&APP.inbox.removeReader(e),!0}))},loadMixins:function(){return ne((function(){var e,t;return se(this,(function(n){switch(n.label){case 0:return[4,i.e(51520).then(i.bind(i,451520))];case 1:return e=n.sent(),t=e.default,f().mixin(this,t),this.initFirstTaskView(),[2]}}))})).apply(this)},addReactionsNotifications:function(e){this.reactions=r().union(e,this.reactions||[]),this._renderReactionNotification()},_renderReactionNotification:function(){var e=this._findElem("notification_reaction_wrapper"),t="";if(e.empty(),0!==this.reactions.length){var i=c()({ref:"/tmpl/notes/types/amojo/reaction_notification.twig"}).render({count:this.reactions.length,id:this.reactions[0]});this._elem("tasks").is(":visible")&&(t=parseInt(getComputedStyle(this._elem("tasks").get(0)).bottom)+this._elem("tasks").get(0).offsetHeight+15),e.css("bottom",t).append(i)}},checkIsAiConfigured:function(){return ne((function(){return se(this,(function(e){switch(e.label){case 0:return ae?[2,!1]:[4,(0,w.isFeaturesAvailableAsync)({queries:[S.Features.IS_AI_CONFIGURED],shouldCamelCase:!1})];case 1:return[2,e.sent()]}}))}))()},_updateAiFeatures:function(){return ne((function(){var e,t,i,n,s;return se(this,(function(o){switch(o.label){case 0:return[4,this.checkIsAiConfigured()];case 1:return n=o.sent(),s=Boolean((0,S.isFeatureAvailable)(S.Features.AIREWRITER)&&(ae||n)),(0,S.updateFeature)(S.Features.IS_AI_FUNCTIONALITY_ENABLED_IN_FEED,s),this.notes.trigger("render").trigger("ai-features:ready"),null===(i=this._compose)||void 0===i||null===(t=i._active_view)||void 0===t||null===(e=t.toggleAiRewriter)||void 0===e||e.call(t,(0,S.isFeatureAvailable)(S.Features.IS_AI_FUNCTIONALITY_ENABLED_IN_FEED)),[2]}}))})).apply(this)},_onNotificationClick:function(e){var t=s()(e.currentTarget).attr("data-id");this.findAndScrollToView(t,""),this._removeReactionNotification(t)},_removeReactionNotification:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this.notes.get(e),n=i&&r().propertyOf(i.get("dialog"))("id");this.reactions&&(this.reactions.splice(0,1),n&&t?s().ajax({url:"/api/v4/talks/".concat(n,"/reactions"),type:"DELETE"}).then(r().bind((function(){this._renderReactionNotification()}),this)):this._renderReactionNotification())},_onFileApiWindowOver:function(e){if(!this._editing||this._editing&&this._editing._active_view&&!this._editing._opened)this.notes.trigger("notes:dnd:compose",e);else switch(!0){case!r().isUndefined(this._editing)&&!r().isUndefined(this._editing._active_view):this._editing._active_view.model.trigger("notes:dnd:window",e);break;case!r().isUndefined(this._editing)&&r().isUndefined(this._editing._active_view):this._editing.model.trigger("notes:dnd:window",e)}},_toggleFilterAndTasksOnCompose:function(e){var t="";"open"===e&&(t="hidden"),this._elem("tasks").css("visibility",t),this._elem("filter_and_chat_users").css("visibility",t)},_toggleFirstTaskVisibility:function(e){var t="";"open"===e&&(t="hidden"),this._findElem("firstTask").css("visibility",t)},_initAmoJoSocket:function(){var e=W.default.socket.pipe(l.map((function(e){var t=e.data;try{return JSON.parse(t)}catch(e){return t}}))),t=e.pipe(l.filter((function(e){return"message_created"===e.type||"message_updated"===e.type})),l.map(r().bind((function(e){return e.data.message&&e.data.message.msec_created_at&&(e.data.message.created_at=e.data.message.msec_created_at/1e3),e.data.message&&e.data.message.msec_edited_at&&(e.data.message.edited_at=e.data.message.msec_edited_at/1e3),e.data.message}),this)),l.filter(r().bind((function(e){var t=H.AmoJoMediator.get();return t[e.chat_id]&&!r().isEmpty(t[e.chat_id])}),this))),i=e.pipe(l.filter((function(e){return"reaction"===e.type})),l.map(r().bind((function(e){var t,i=e.data.message,n=this.notes.get(e.data.message.id),s=i&&i.reactions,o=n&&n.get("reactions");return n&&(o||s)&&(e.data.actor&&e.data.actor.origin)!==re&&(o&&(r().isNull(s)||o.length>s.length)?this._removeReactionNotification(i.id,!1):s&&(r().isNull(o)||o.length<s.length)?this.addReactionsNotifications([i.id]):r().each(o,(function(e){(t=r().find(s,(function(t){return t.user_id===e.user_id})))&&t.emoji!==e.emoji&&this.addReactionsNotifications([i.id])}),this)),e.data.message}),this)),l.filter(r().bind((function(e){var t=H.AmoJoMediator.get();return t[e.chat_id]&&!r().isEmpty(t[e.chat_id])}),this))),n=e.pipe(l.filter((function(e){return"typing"===e.type})),l.map((function(e){return e.data})),l.filter(r().bind((function(e){var t=H.AmoJoMediator.get();return t[e.chat_id]&&!r().isEmpty(t[e.chat_id])}),this))),s=e.pipe(l.filter((function(e){return"message_delivery_status_changed"===e.type})),l.map((function(e){return e.data})),l.filter(r().bind((function(e){var t=H.AmoJoMediator.get();return t[e.chat_id]&&!r().isEmpty(t[e.chat_id])}),this))),o=e.pipe(l.filter((function(e){return"chat_disabled"===e.type})),l.map((function(e){return e.data})),l.filter(r().bind((function(e){var t=H.AmoJoMediator.get();return t[e.chat_id]&&!r().isEmpty(t[e.chat_id])}),this))),a=e.pipe(l.filter((function(e){return"close_dialog"===e.type})),l.map((function(e){return e.data})),l.filter(r().bind((function(e){var t=H.AmoJoMediator.get();return t[e.chat_id]&&!r().isEmpty(t[e.chat_id])}),this)));this.subscriptions.add(t.subscribe(r().bind((function(e){this.notes.trigger("add:from_socket",e)}),this),(function(e){throw e}))),this.subscriptions.add(i.subscribe(r().bind((function(e){this.notes.trigger("add:reaction:from_socket",e)}),this),(function(e){throw e}))),this.subscriptions.add(n.subscribe(r().bind((function(e){this.notes.trigger("add:typing:from_socket",e)}),this),(function(e){throw e}))),this.subscriptions.add(s.subscribe(r().bind(this._onChangeStatusMessage,this),(function(e){throw e}))),this.subscriptions.add(o.subscribe(r().bind((function(e){this.notes.trigger("chat_disabled:from_socket",e.disabled)}),this),(function(e){throw e}))),this.subscriptions.add(a.subscribe(r().bind(this._onCloseDialogMessage,this),(function(e){throw e})))},read:function(e,t,i){var n={chat_ids:r().keys(H.AmoJoMediator.get())};r().extend(n,{entity_id:t.toString(),entity_type:i}),APP.inbox&&(this.readers.push(APP.inbox.addReader(e,t)),APP.inbox.read(n))},_setCallbacks:function(e){return r().extend(this._callbacks||{},e||{})},initCollection:function(e){this.notes=this._addComponent(e.PagerCollection||J.default,[],{element_type:e.element_type,element_id:e.element_id,element_info:e.element_info,getFilter:r().bind(this._filter.get,this._filter),onTimelineRequestEnd:this.onTimelineRequestEnd}),this.listenTo(this.notes,"reset",this._resetViews).listenTo(this.notes,"fetched:before-add",r().bind(this._filter.initPresets,this._filter)).listenTo(this.notes,"fetched",this._addNotesAndScroll).listenTo(this.notes,"fetched",this._renderCustomersGreenBar).listenTo(this.notes,"sync note:view:update",this._onModelUpdate).listenTo(this.notes,"destroy note:view:destroy",this._onModelRemove).listenTo(this.notes,"add:from_socket add:reaction:from_socket",this._onAddAmojoViewCheckChatExists)},_onChangeStatusMessage:function(e){var t=this.notes.get(e.id);t?(e.delivery_status>t.get("delivery_status")||-1===e.delivery_status)&&t.set({delivery_status:e.delivery_status,error:e.error,pricing_type:e.pricing_type}):this.lost_status=e},_onCloseDialogMessage:function(e){var t=r().result(e,"last_opened_dialog");t&&this.notes.trigger("dialog:closed",{talk:t})},_onAddAmojoViewCheckChatExists:function(e,t){var i=this,n=e.chat_id,s=H.AmoJoMediator.isFullChat(n),o={};if(s)this._onAddAmojoView(e,t);else{if(s=G.default.get(n))return o[n]=s.toJSON(),H.AmoJoMediator.extend(o,!0),void this._onAddAmojoView(e,t);G.default.load(n).then((function(){(s=G.default.get(n))&&(o[n]=G.default.get(n).toJSON(),H.AmoJoMediator.extend(o,!0),i._onAddAmojoView(e,t))}))}},_onAddAmojoView:function(e,t){var i=this,n=r().find(this.notes.last(10),(function(t){return t.id===e.id}),this);((0,S.isFeatureAvailable)("airewriter")||(0,S.isFeatureAvailable)("kommo_ai_trial_started")&&!(0,S.isFeatureAvailable)("kommo_ai_trial_ended"))&&e.dialog&&(e.author.origin===re||"bot"===e.author.origin?g().publish(ee.AI_ANSWER_CLOSE,{talkId:e.dialog.id,event:ee.AiAnswerCloseEvents.SOCKET_EXTERNAL}):g().publish(ee.AI_ANSWER_MESSAGE_ADD,{talkId:e.dialog.id,messageId:e.id,event:ee.AiAnswerCloseEvents.SOCKET_INCOMING}));var s,o=this.notes.get(e.id);if(this.removeTypingAfterSendMessage(e.author),o?o.update=!0:e.new_from_socket=!0,r().isUndefined(n)||!r().isUndefined(o)){if(!this.notes._filterLinkedAndOld([{view:{model:e}}]).length)return;(s=this._addToCollection(e))[0].get("dialog")&&this.notes.setLastDialogsIds(s[0]),this.addNotes(e,r().extend({scroll_anchor_model_id:e.id},t||{})).then((function(){i._updateUnseen(r().isUndefined(o)?1:0),i._updateIfMulticategoriesAppeared(e.chat_id)})),s.length&&this._onSendExternalChatCloseFollowUp(s[0])}},scrollFromTyping:function(){var e=this._elem("notes_scroller").scrollTop(),t=this._elem("notes_scroller")[0].offsetHeight,i=Math.abs(this._last_height-(e+t)),n=i>=0&&i<15;return r().bind((function(){n&&this._scrollToEnd()}),this)},_getComposeView:function(){return 1==(this.params.element_type===APP.element_types.catalog_elements)?$.default:B.default},setFullyLoaded:function(){var e=this,t=this._getComposeView(),i=(0,S.isFeatureAvailable)("single_timeline");r().isFunction(this._scrollOnFullLoad)?(this._scrollOnFullLoad(),this._scrollOnFullLoad=null):this._scrollToEnd(),this._fully_loaded=!0,this.notes.setFullyLoaded(!0),y.onPageFullyLoaded((function(){var n=["top"];i&&n.push("bottom"),r().each(n,(function(t){var n={};n["max-".concat(t)]=300,e._addComponent(Z.default,{element:e._elem("notes_scroller").get(0),conditions:n,throttle:300,onLoadMore:r().bind(e._handleAutoLoadMore,e,i?t:void 0)})})),e.params.can_add&&(e._compose=e._addComponent(t,{el:e.$(".feed-compose"),notes:e.notes,$notes_scroller:e._elem("notes_scroller"),onToggle:r().bind(e._toggleFilterAndTasksOnCompose,e),onFirstTaskVisibilityToggle:r().bind(e._toggleFirstTaskVisibility,e),setEdit:r().bind(e._setEdit,e),addNotes:r().bind(e._addNotes,e),getResponsibleId:r().bind(e.params.getResponsibleId,e),getMainContactId:r().bind(e.params.getMainContactId,e),getExtraData:r().bind(e._getExtraData,e),scrollToEnd:r().bind(e._scrollToEnd,e),scrollUpdate:r().bind(e._scrollUpdate,e),hide_users_list:!!e.params.hide_users_list,disabled_types:e.params.disabled_types,mainEntityData:e._getMainEntity(),isChatEnabled:r().bind(e._isChatEnabled,e)})),e._scrollAutoMargin(),e._initStacking(),e._updateAiFeatures()}))},_onStartNotesMutations:function(){this._notes_is_mutating||(this._notes_is_mutating=!0,this._scrollDisable(!0))},_widthObserver:function(e){var t=e.element,i=e.callback;if(void 0===window.ResizeObserver||!t)return r().noop;var n=new ResizeObserver(i);return n.observe(t),function(){n.disconnect()}},triggerFeedResize:function(){this.notes.trigger("notes:resize",this._findElem("notes").outerWidth())},_onEndNotesMutations:function(){this._notes_is_mutating&&(this._notes_is_mutating=!1,this._scrollDisable(!1))},_preventSaveOrCancel:function(e){e.stopPropagation(),this._$document.trigger("controls:hide")},_saveOrCancelOnClick:function(e){2!==e.button&&this._editing&&this._editing._editing&&(this._editing.hasChanges()?this._editing.save().then(r().bind((function(){this._editing=null}),this)):this._editing=this._editing.cancel()||null)},_getMainEntity:function(){return r().isFunction(this.params.getMainEntity)?this.params.getMainEntity():{id:this.notes.element_id,element_type:this.notes.element_type}},_getLinkedEntities:function(){return r().isFunction(this.params.getLinkedEntities)?this.params.getLinkedEntities():{}},_getAccountUsers:function(){return r().isFunction(this.params.getAccountUsers)?this.params.getAccountUsers():{}},_getFullChats:function(){return r().isFunction(this.params.getFullChats)?this.params.getFullChats():H.AmoJoMediator.get()},_collectEmailsFromCF:function(e){return r().isFunction(this.params.collectEmailsFromCF)?this.params.collectEmailsFromCF(e):[]},_setEdit:function(e){this._editing&&this._editing.hasChanges()?this._editing.save().then(r().bind((function(e){var t;this._editing=null,this._setEdit.apply(this,function(e){if(Array.isArray(e))return te(e)}(t=e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(t)||function(e,t){if(e){if("string"==typeof e)return te(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(i):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?te(e,t):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}())}),this,arguments)):(this._editing&&this._editing.cancel(),this._editing=e,this._editing.edit(),this._callbacks.onChange&&this._callbacks.onRevert&&this._editing._form&&!this._editing.not_check_changes&&this._editing._form.model.on("has_changes",this._callbacks.onChange).on("has_reverted",this._callbacks.onRevert))},_onModelRemove:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._resort(r().filter(this.views,(function(t){return!r().contains(t.view.models,e)}))),t.silent||this.notes.trigger("view:removed",e)},_onModelUpdate:function(e,t){if(e!==this.notes){var i=this._getItemDate(e.toJSON());r().each(this.views,(function(t){t.view.model!==e||e._pending||e!==r().last(t.view.models)||(t.date=i,this._isFutureTask(e)?this._elem("tasks").prepend(t.view.el):this._elem("notes").prepend(t.view.el))}),this),this._isFutureTask(e)&&(this._has_future_tasks=!0),this._elem("tasks").is(":empty")?this._elem("tasks_wrapper").addClass("empty"):(this._elem("tasks_wrapper").removeClass("empty"),this._checkTodayTasks()),this._resort(null,r().pick(t,"update_scroll_delta"))}},findAndScrollToView:function(e,t,i){var n=this;return i=i||"",this.notes.findBy(e,{onHoldOnStarted:function(e){if((0,S.isFeatureAvailable)("single_timeline"))return n.loadByTimestamp(t);var i=s()("<span>".concat((0,E.i18n)("The found event was a very long time ago and it will take us time to get to it"),' <span class="feed__loader-container-cancel js-feed-search-hold-on-cancel">').concat((0,E.i18n)("No, thanks (search hold on)"),"</span></span>")).on("click",".js-feed-search-hold-on-cancel",(function(){e(),n._toggleContainerLoader(!1)}));n._toggleContainerLoader(!0,{blur:!0,$message:i})}}).always((function(){n._toggleContainerLoader(!1)})).then((function(e){r().isEmpty(e)||(n._page=e.page,n._current_search_highlight&&n._current_search_highlight.trigger("search:highlight:unset"),i.length>0&&e.model.trigger("search:highlight:set",i.split(" ")),n._fully_loaded?n.scrollToItem(e.model):n._scrollOnFullLoad=r().bind(n.scrollToItem,n,e.model),n._current_search_highlight=e.model)}))},_onLoadMoreClick:function(){this._handleAutoLoadMore((0,S.isFeatureAvailable)("single_timeline")&&"top")},_handleAutoLoadMore:function(e){var t=this,i={};switch(e){case"top":i={direction:"prev"};break;case"bottom":i={direction:"next"};break;default:this._page=this._page||1,i={page:this._page+1}}this.loadMore({fetch:i}).then((function(){i.page>0&&(t._page=i.page)}))},loadMore:function(e){var t=this,i=!this.notes.length;return this.notes._pending||!this.notes.element_id||this._loading_more?s().Deferred().reject():(e=e||{},this.$el.addClass("loading-more"),e.reset&&(i=!0,this._toggleContainerLoader(!0)),this._loading_more=this.notes.fetch(r().extend({reset:e.reset,silent:e.silent},e.fetch)),this._loading_more[this._loading_more.finally?"finally":"always"]((function(){setTimeout((function(){t._loading_more=null}))})),this._loading_more.then((function(){t._toggleLoadMoreButton(),i&&(e.reset?t._toggleContainerLoader(!1):t._search.actualize()),t.$el.removeClass("loading-more")})))},loadByTimestamp:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t={};if(e){var i=e.toString().replace(".","").split("");e=r().map(r().range(14),(function(e){return i[e]||0})).join("")/1e4,r().extend(t,{fetch:{filter:{created_at:{gte_lte:e.toFixed(4)}}}})}return this.loadMore(r().extend(t,{reset:!0}))},addNotes:function(e,t){return new Promise(r().bind((function(i){return c()._preload(["/tmpl/cards/notes/wrapper.twig"])().then(r().bind(this._addNotes,this,e,t)).then(i)}),this))},_addNotes:function(e,t){(0,b.logPerformanceMetric)({type:(0,b.getRealCardPageType)(),name:"feedGroupStart",isSync:!0});var i=r().findIndex(this.views,(function(e){return!r().contains(["tasks","opened_talks"],r().propertyOf(e.view.model.get("object_type"))("code"))})),n=this.views[i]&&this.views[i].view;return t=t||{},r().isArray(e)||(e=[e]),K.default.process(e,{element_id:this.notes.element_id,element_type:this.notes.element_type,last_view_model:n&&r().last(n.models).toJSON(),last_view_models:n?n.models:[],exclude_reducers:t.exclude_reducers||[],renderView:r().bind(this.renderView,this)}),v.default.fix("(feed) отработали группировки/объединение"),(0,b.logPerformanceMetric)({type:(0,b.getRealCardPageType)(),name:"feedGroupEnd",isSync:!0}),this.renderViews(t)},_addNotesAndScroll:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.addNotes(e,{update_scroll_delta:!r().isBoolean(t.update_scroll_delta)||t.update_scroll_delta,is_page_render:!0}),this._scrollAutoMargin()},getExistingModelByTalkId:function(e){return this.notes.find((function(t){var i=t.get("data")||{},n=i.params||{},s=t.get("type");return!(r().isEmpty(i)||r().isEmpty(n)||n.talk_id!==e.talk_id||s!==APP.note_types.ai_result||t.get("id")!==e.id&&t.get("id"))}))},_addToCollection:function(e){return r().isArray(e)||(e=[e]),r().reduce(e,(function(e,t){var i=this.notes.get(t.id);if(t.type===APP.note_types.ai_result){var n=t.data.params.talk_id,s=this.getExistingModelByTalkId({talk_id:n,id:t.id});if(s)return s.set(t),e.push(s),e}if(!i&&r().contains(r().values(r().omit(APP.note_types)),t.type)&&t.id){var o=this.notes.findWhere({note_id:t.id});o&&(t=r().extend({},o.toJSON(),r().omit(t,"id","type","object_type")))}return i&&this.lost_status&&this.lost_status.id===t.id&&(t.delivery_status=this.lost_status.delivery_status,this.lost_status=null),i&&i.get("object_type")&&t.object_type&&t.object_type.code!==i.get("object_type").code&&(t.id+=t.object_type.code),e.push(this.notes.add(t,{merge:!0})),e}),[],this)},_removeFromCollection:function(e){this.notes.remove(e),this.notes.trigger("note:view:destroy",e)},renderView:function(e,t){var i,n,s={onAdd:r().bind(this._addNotes,this),addToCollection:r().bind(this._addToCollection,this),removeFromCollection:r().bind(this._removeFromCollection,this)};e=r().isArray(e)?e:[e];var o=this._getItemDate(r().last(e)),a=(0,Y.default)(e[0],t),l=this._addToCollection(e),d=r().isEmpty(l)?{}:l[l.length-1];d.get("dialog")&&this.notes.setLastDialogsIds(d);var c=r().find(this.views,(function(e){return r().find(e.view.models,(function(t){var i=t.get("object_type")||{},s=l[0].get("data")||{},o=l[0].get("object_type")||{},a=r().contains(r().pick(APP.note_types,"common","attachment"),t.get("type"))?t.get("_date_create"):null,c=l[0].get("_date_create")||null;return a&&c&&a===c&&!r().isEmpty(d)&&(r().contains([APP.note_types.common],d.get("type"))||r().contains([APP.note_types.common],d.get("note_type")))&&!e.view.model.id&&(n=!0),(t.id!==l[0].id||!s.params||s.params.talk_id===t.get("data").params.talk_id)&&(t.id===l[0].id&&i.code===o.code||a&&c&&a===c&&t.get("type")!==APP.note_types.common)}))}));c?c.view._editing||(n&&(d.collection.add(c.view.model),c.view.model.set(d.toJSON())),c.view.models=r().union(c.view.models,r().reject(l,(function(e){return r().findWhere(c.view.models,{id:e.id})}))),c.view.model.trigger("render",r().filter(l,(function(t){return r().findWhere(e,{id:t.id})}))),c.view.$el.hasClass(this._class("wrapper_animate_entrance"))?c.view.$el.one(APP.animation_event,(function(){c.view.model.trigger("note:view:update",c.view.model,{update_scroll_delta:!0})})):c.view.model.trigger("note:view:update",c.view.model,{update_scroll_delta:!0})):(i={date:o,view:this._addComponent(a,r().extend({element_id:this.notes.element_id,element_type:this.notes.element_type,models:l,lastConversation:this.notes.lastConversation,onDestroy:r().bind(this._onNoteViewDestroy,this),onEdit:r().bind(this._setEdit,this),getOriginCollection:r().bind(this.notes.getOriginCollection,this.notes),getTalkLastMessageId:r().bind(this.notes.getTalkLastMessageId,this.notes),getRichLink:this.rich_links.getRichLink,onStartNoteMutations:r().bind(this._onStartNotesMutations,this),onEndNoteMutations:r().bind(this._onEndNotesMutations,this),getExtraData:r().bind(this._getExtraData,this),scrollUpdate:r().bind(this._scrollUpdate,this),scrollToEnd:r().bind(this._scrollToEnd,this),scrollToEl:r().bind(this._scrollToEl,this),scrollToTalkId:r().bind(this.scrollToTalkId,this),findAndScrollToView:r().bind(this.findAndScrollToView,this),debouncedStickyUpdate:r().bind((function(){this.notes.trigger("notes:cleanup-sticky"),this._debouncedStickyUpdate()}),this)},s))},this._isFutureTask(l[0])&&(this._has_future_tasks=!0),this._views_now.push(i))},_isChatEnabled:function(){var e=H.AmoJoMediator.get(),t=this.notes.element_type===APP.element_types.contacts,i=r().contains(oe,this.notes.element_type),n=!r().isEmpty(e);return t?i&&n:i},render:function(e){var t=this._getTwigTemplate();return c()._preload([t])().then(r().bind(this._render,this,e))},_render:function(e){var t=this,i=this._getTwigTemplate(),n=document.createElement("documentFragment");n.innerHTML=c()({ref:i}).render(r().extend(e||{},{element_type:this.notes.element_type,is_add_mode:!this.notes.element_id,is_free_user:APP.constant("user_rights").is_free_user,is_chat_enabled:this._isChatEnabled(),entity_type:APP.data.current_entity,last_used_type:this.getLastUsedType(),disabled_types:this.params.disabled_types})),this.el.innerHTML=n.firstChild.innerHTML,this._dropElemCache(),this._elem("load_more_wrapper").before(this._search.el),this._disconnectFeedWidthObserver=this._widthObserver({element:this._elem("notes")[0],callback:function(){return t.triggerFeedResize()}})},getLastUsedType:function(){var e=T.storeWithExpiration.get(F.default.LS_LAST_TYPE);return e&&!r().contains(["contacts","companies"],APP.getBaseEntity())&&this.notes.element_id||(e="note"),e},renderViews:function(e){return new Promise(r().bind((function(t){return c()._preload([this._getTwigTemplate()])().then(r().bind(this._renderViews,this,e)).then(t)}),this))},_renderViews:function(e){var t=document.createDocumentFragment(),i=document.createDocumentFragment(),n=this._sortAlgo(this._views_now,this.notes.element_type),s=0,o=this._scrollUpdate({anchor_model_id:e.scroll_anchor_model_id});return e=e||{},this._views_now=[],r().each(n.reverse(),(function(e){e.view._render(),this._isFutureTask(e.view.model)?(i.prepend(e.view.el),s++):t.prepend(e.view.el)}),this),this._elem("tasks").get(0).appendChild(i),e.is_page_render?this._elem("notes").get(0).prepend(t):this._elem("notes").get(0).appendChild(t),this.views=this.views.concat(n),this.views.length>1&&1===n.length&&!s&&this._animateInsert(n[0].view.el),s&&(this._elem("tasks_wrapper").removeClass("empty"),this._checkTodayTasks()),n.length>0&&(this._resort(null,{update_scroll_delta:!1}),this._debouncedStickyUpdate()),o(e.update_scroll_delta),new Promise(r().bind((function(t){return e.is_page_render&&this._elem("plug").remove(),this.notes.trigger("views:added",n),t()}),this))},_animateInsert:r().throttle((function(e){e.classList.add(this._class("wrapper_animate_entrance")),s()(e).one(APP.animation_event,r().bind((function(){e.classList.remove(this._class("wrapper_animate_entrance"))}),this))}),0,{leading:!1}),_triggerStickyUpdate:function(){this.notes.trigger("notes:update-sticky")},_scrollAutoMargin:function(){var e,t=this.$(this._selector("compose_scrollbar"));"y"!==t.attr("data-scroll-calc")&&(e=parseInt(t.css("right")),t.css("right",e+(0,C.getScrollBarWidth)("custom-scroll")),e&&t.attr("data-scroll-calc","y"))},_resetViews:function(){this.views=r().reject(this.views,(function(e){return e.view.destroy(!0),!0})),this._resort()},_scrollToEnd:function(){this._elem("notes_scroller").scrollTop(this._elem("notes_scroller")[0].scrollHeight)},_scrollUpdate:function(e){var t=this,i=this._elem("notes_scroller").get(0),n=i.scrollHeight,s=function(e){return!e||e.getBoundingClientRect().top<0};return e=e||{},s()?(this.notes.trigger("notes:pause-sticky"),r().bind((function(e,o){le.call(t,e.anchor_model_id&&t.notes.get(e.anchor_model_id)).always((function(r){var a=Math.ceil(t._elem("notes_scroller").scrollTop());if(0===a||s(r&&r.get(0)||e.anchor_el)){var l=!1===o?0:i.scrollHeight-n;l>0&&t._elem("notes_scroller").scrollTop(a+l)}t.notes.trigger("notes:resume-sticky")}))}),this,e)):r().noop},_scrollDisable:function(e){e?this._elem("notes_scroller").css({overflow:"hidden",paddingRight:(0,C.getScrollBarWidth)("custom-scroll")}):this._elem("notes_scroller").css({overflow:"",paddingRight:""})},scrollToItem:function(e){e&&le.call(this,e).then(r().bind(this._scrollToEl,this))},highlightMessage:function(e){var t=e.find(".feed-note__avatar").length?e.find(".feed-note__content"):e.find(".js-note");t.animate({opacity:.3},200,(function(){t.animate({opacity:1},1e3)}))},_scrollToEl:function(e){var t=this._elem("notes_scroller").scrollTop(),i=this._elem("notes_scroller").get(0).scrollHeight,n=this._elem("notes_scroller").height(),s=i-n,o=e.offset().top,r=e.height(),a=t+(o+r/2-n/2);a>s-n&&o-s>0&&o-s<i-(o+r)&&(a=s),this._elem("notes_scroller").scrollTop(a),this.highlightMessage(e)},scrollToTalkId:function(e,t){var i=parseInt(e);return this._scrolling_to_talk_id=this.findAndScrollToView((function(e){return r().propertyOf(e)(["dialog","id"])===i}),t),this._scrolling_to_talk_id},_onScroll:function(e,t){var i=this._elem("filter_and_chat_users").height();t&&e>=t-i&&this._setUnseen(0)},_toggleLoadMoreButton:function(){var e=this,t=this.notes.hasPrevPage?this.notes.hasPrevPage():this.notes.hasNextPage();if(!this._elem("load_more_button").hasClass("hidden")!==t){var i=this._scrollUpdate({anchor_el:this._elem("load_more_button").get(0)});this.el.classList[t?"remove":"add"]("reached-end"),t?(this._elem("load_more_button").removeClass("hidden"),i()):this._elem("load_more_button").off("transitionend").one("transitionend",(function(){e._elem("load_more_button").addClass("hidden"),i()}))}},_toggleContainerLoader:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e?(this._$full_container_loader||(this._$full_container_loader=s()(['<div class="feed__loader-container '.concat(t.blur?"feed__loader-container_blur":"",' default-overlay default-overlay-visible">'),'<span class="spinner-icon spinner-icon-abs-center"></span>',t.$message?'<span class="feed__loader-container-text"></span>':"","</div>"].join("")),t.$message&&this._$full_container_loader.find(".feed__loader-container-text").append(t.$message)),this.$el.append(this._$full_container_loader)):this._$full_container_loader&&(this._$full_container_loader.remove(),this._$full_container_loader=null)},_stopTimeline:r().noop,_startTimeline:r().noop,_updateTimeline:r().noop,_renderCustomersGreenBar:r().noop,_onCustomersGreenLineOutside:r().noop,_initStacking:r().noop,_resort:function(e,t){var i,n;t=t||{},this.views=this._sortAlgo(e||this.views,this.notes.element_type),i=r().pluck(this.views,"date"),(!0===t.update_scroll_delta||!1!==t.update_scroll_delta&&this._dates_before_sort&&!r().isEqual(this._dates_before_sort,i))&&(n=this._scrollUpdate()),this._stopTimeline(),this._updateViewsSort(!0),this._updateViewsSort(!1),this._startTimeline(),r().isFunction(n)&&(n(),this.notes.trigger("notes:update-sticky",{after_resort:!0})),this._dates_before_sort=i},_updateViewsSort:function(e){var t=this.views;if(t.length&&(!e||this._has_future_tasks)){var i=document.createDocumentFragment();this._has_future_tasks&&!0===e&&(this._elem("tasks").removeClass("editing"),t=r().filter(t,(function(e){return this._isFutureTask(e.view.model)}),this)),r().each(t,(function(t){var n=t.view.el.parentNode;!e&&this._has_future_tasks&&!0===this._isFutureTask(t.view.model)||!n||i.appendChild(t.view.el)}),this),e?this._elem("tasks").get(0).appendChild(i):this._elem("notes").get(0).appendChild(i)}},_isFutureTask:function(e){return r().result(e,"isFutureTask",!1)},_checkEditing:function(e,t){!this._editing||!this._editing.hasChanges()||r().isFunction(this._editing.isSaved)&&this._editing.isSaved()?e():this._editing.save().then(e,t)},save:function(){return new Promise(r().bind((function(e,t){this._checkEditing(e,t)}),this))},saveUnsaved:function(){var e=[];return this.notes.each((function(t){var i;t.get("id")||(i=new Promise((function(e){t.save({success:e})})),e.push(i))})),e.length?null:Promise.all(e)},setMainId:function(e){this.params.element_id||(this.params.element_id=e,this.notes.setMainId(e),this._compose&&r().isFunction(this._compose.setMainId)&&this._compose.setMainId(e))},_getExtraData:function(e,t){var i,n;return n=!0===(r().isUndefined(t)&&!e)?{elements:[this._getMainEntity()].concat(this._getLinkedEntities()),chats:this._getFullChats()}:{leads:(i=(t=t||this.notes.getOriginCollection(e))&&t.embedded||{}).leads||{},customers:i.customers||{},transactions:i.transactions||{},contacts:i.contacts||{},companies:i.companies||{},catalog_elements:i.catalog_elements||{},tags:i.tags||{},types:i.types||{},filter_presets:i.filter_presets||{},users:this._getAccountUsers()||r().propertyOf(i)(["account","_embedded","users"])||{},statuses:i.account?i.account._embedded.status_pipeline:{},customers_statuses:APP.constant("customers_timeline"),pipelines:i.account?i.account._embedded.pipelines:{},loss_reasons:r().propertyOf(i)(["account","_embedded","loss_reasons"])||{}},r().extend(n,this.params.unsorted_data||{})},_onNoteViewDestroy:function(e){!0!==this._destroyed&&(this._elem("tasks").is(":empty")&&(this._elem("tasks").removeClass("today"),this._elem("tasks_wrapper").addClass("empty")),this.notes.trigger("notes:view-destroy",e))},_onSendExternalChatCloseFollowUp:function(e){if(e.get("chat_id")){var t=r().find(this._getExtraData().chats||{},(function(t){var i=e.get("author")||{};return t.chat_id===e.get("chat_id")&&i.id===(0,A.current)("amojo_id")&&parseInt(t.entity_type)===APP.element_types.contacts})),i=this.notes.find((function(e){return"tasks"===(e.get("object_type")||{}).code&&!e.get("status")&&1===parseInt(e.get("type"))&&parseInt(e.get("responsible_user_id"))===parseInt((0,A.current)("id"))}));t&&i&&i.trigger("task:complete-after-chat")}},_checkTodayTasks:function(){var e=this._elem("tasks").children();1===e.length&&e[0].querySelector(this._selector("today_task"))?this._elem("tasks").addClass("today"):this._elem("tasks").removeClass("today")},_updateUnseen:function(e){var t=this._elem("notes_scroller").scrollTop(),i=this._elem("notes_scroller").get(0).scrollHeight-(this._elem("notes_scroller").get(0).offsetHeight+t),n="";e=this._unseen_count+(r().isNumber(e)?e:1),this._elem("unseen_count").get(0).style.bottom="",i>=this._elem("filter_and_chat_users").height()&&e>0?(this._unseen_count=e,this._elem("unseen_count").html(this._unseen_count),this._elem("tasks").is(":visible")&&(n=parseInt(getComputedStyle(this._elem("tasks").get(0)).bottom)+this._elem("tasks").get(0).offsetHeight+15),this._elem("unseen_count").css({right:(0,C.getScrollBarWidth)("custom-scroll"),bottom:n})):(this._unseen_count=0,this._elem("unseen_count").html("")),e>0&&(0,q.default)()},_setUnseen:function(e){this._unseen_count=e,this._updateUnseen(0)},_updateIfMulticategoriesAppeared:function(e){if((0,S.isFeatureAvailable)("ig_replies_to_comments")&&e&&this.notes.isMultipleCategories(e)){var t=this._scrollUpdate();this.notes.setShowSourceProperty(e),t()}},createModel:function(e,t){return r().extend({type:e||"system_note",object_type:{code:"notes"},date_create:t.date,element_type:this.notes.element_type,element_id:this.notes.element_id},t||{},{})},_add:function(e){return r().isArray(e)||(e=[e]),this.addNotes(e)}});f().mixin(de,I.default,M.default,O.default,x.default,L.default,j.default,N.default,R.default,D.default);const ce=de;var _e="../build/transpiled/interface/notes/notes";window.define(_e,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([_e])},963034:(e,t,i)=>{i.r(t),i.d(t,{default:()=>b});var n=i(629133),s=i.n(n),o=i(345839),r=i.n(o),a=i(162262),l=i.n(a),d=i(156040),c=i(116028),_=i(283346),h=i(977717),u=i(410462),f=i(278385),p=i(178839),g=i(439182),m=i(661533);function v(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var y=r().Collection.extend({model:g.default,_fully_loaded:!1,_filter_element_types:[],_page_length:100,_current_page:1,_has_multiple_categories:new Set,initialize:function(e,t){this.element_id=t.element_id,this.element_type=t.element_type,this.element_info=t.element_info,this.getFilter=t.getFilter||s().noop,this._elements=[{id:t.element_id,type:t.element_type}],this._external_pending=[],this.buffer=[],this.addCollection(new u.default([],s().extend({id:t.element_id},t)))},setFullyLoaded:function(){this._fully_loaded=!0,this._fetched()},_filterCollections:function(e){return e?s().filter(this._collections,(function(t){return s().indexOf(e,t.id)+1})):this._collections},findCollection:function(e){return s().find(this._collections,(function(t){return(t.id||t.element_id).toString()===e.toString()}),this)},fetch:function(e){var t,i=m.Deferred(),n=this._page_length,o=this.getFilter(),r=s().bind((function(e,t,i){var n=s().flatten(i);t.finding?n=this._getBufferSlice({start:0}):this._fetched(t),e.resolve(n),this._fetching=!1}),this,i,e);if(!(e=e||{}).collections&&this._fetching)return i.reject();!0===e.reset&&(this._current_page=1,this.buffer=[],this.reset([],{silent:!0})),e.page&&(this._current_page=e.page),t=this._current_page,e.from_start&&(t=1,n=Math.min(this._current_page*this._page_length,500));var a=s().filter(this._filterCollections(e.collections),(function(e){var t=s().contains(o.without,e.type);return e.hasNextPage()&&!t}));return a.length?(this._fetching=!0,Promise.all(s().map(a,(function(e){return e.fetch({data:s().extend({},o||{},{page:t,limit:n})})}),this)).then(r)):r(),i.promise()},isLookingModeActive:function(){return!1},findBy:function(){var e,t=this,i=Array.prototype.slice.call(arguments),n=m.Deferred(),o=i[0],r=!1,a=0,l=s().extend({max_iterations:1/0,onHoldOnStarted:s().noop},i[1]||{}),d=n.promise();function c(e){n.resolve({page:t._current_page,model:t.get(e.id)})}function _(e){var t=e||this.toJSON(),i=s().findLastIndex(t,o),n=i>-1;return n&&(this._fetched({start:0,buffer_length:this.buffer.length,force_buffer:!0}),e&&e.length?this.listenToOnce(this,"views:added",(function(){c(t[i])})):setTimeout((function(){c(t[i])}))),n}return s().isFunction(o)||(e=parseInt(i[0]),o=function(t){return t.id===i[0]||t.id===e}),_.call(t)||function e(){var i=2*Math.floor(a/10);r||a===l.max_iterations?n.reject({page:t._current_page}):(10==++a&&l.onHoldOnStarted((function(){r=!0})),setTimeout((function(){t.fetch({page:t._current_page+1,finding:!0}).then((function(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];i.length?_.call(t,i)||e.call(t):n.reject({page:t._current_page})}),n.reject)}),1e3*i))}.call(t),d.abort=function(){r=!0},d},reset:function(e,t){return s().each(this._collections,(function(i){i.reset(e,t)})),r().Collection.prototype.reset.apply(this,arguments)},hasNextPage:function(){return s().filter(this._filterCollections(),(function(e){var t=s().contains(this.getFilter().without,e.type);return e.hasNextPage()&&!t}),this).length>0},add:function(e){var t;return s().isArray(e)||(e=[e]),s().each(e,(function(e){t=s().find(this._collections,(function(t){return e.chat_id?t.id===e.chat_id:s().isUndefined(t.id)})),e.element_type=parseInt(e.element_type||this._elements[0].type),t.add(e)}),this),r().Collection.prototype.add.apply(this,arguments)},handleEntityLink:function(e){var t=this.findCollection(this.element_id),i=s().invert(APP.element_types);if(t){var n=new u.default([],s().pick(e,["element_id","element_type"]));n.once("fetched",(function(o){var r=this.pluck("id"),a=i[parseInt(e.element_type)];t.embedded||(t.embedded={},t.embedded[a]={}),s().extend(t.embedded[a],(n.embedded||{})[a]||{}),this._pushToBuffer(t,s().filter(o,(function(t){return parseInt(t.element_id)===parseInt(e.element_id)&&!s().contains(r,t.id)}),this)),this._fetched(),n=null}),this),n.fetch()}},handleEntityUnlink:function(e){this.chain().filter((function(t){return parseInt(t.get("element_id"))===parseInt(e.element_id)})).each((function(e){e.trigger("destroy",e,e.collection,{})}))},addExternalPromisePending:function(e){var t=s().bind((function(e){this._external_pending=s().filter(this._external_pending,(function(t){return t.promise!==e})),this._fetched()}),this,e);this._external_pending.push({promise:e,_pending:!0}),e.then(t,t)},_getBufferSlice:function(e){var t,i;e=e||{};var n=s().filter(this.buffer,(function(e){return e.view.model.object_type&&("tasks"===e.view.model.object_type.code&&!e.view.model.status||"notes"===e.view.model.object_type.code&&e.view.model.pinned)}));this.buffer=this._sortAlgo(s().difference(this._filterLinkedAndOld(this.buffer),n),this.element_type),(i=s().isUndefined(e.start)?this.buffer.length-this._page_length:e.start)<0&&(i=0);var o=s().isUndefined(e.buffer_length)?this._page_length:e.buffer_length;return t=e.modify_buffer?this.buffer.splice(i,o):this.buffer.slice(i,i+o),s().union(s().map(n,(function(e){return e.view.model})),s().map(t,(function(e){return e.view.model})))},_fetched:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!(s().find(this._collections.concat(this._external_pending),(function(e){return e._pending}))||!this._fully_loaded||this.length>=this._current_page*this._page_length&&!0!==e.force_buffer)){var t=this._getBufferSlice(s().extend({},e,{modify_buffer:!0}));!0===e.reset&&this.reset([]),this.trigger("fetched:before-add"),c.default.fix("feed (server)"),this.add(t),this.trigger("fetched",t)}},getOriginCollection:function(e){return s().find(this._collections,(function(t){return t.get(e.id)}),this)},getTalkLastMessageId:function(e){var t;return null===(t=this.last_dialogs_ids[e])||void 0===t?void 0:t.id},setLastDialogsIds:function(e){var t,i,n=e.get("dialog").id,o=e.get("created_at"),r=this.last_dialogs_ids||{},a=s().clone(r[n]&&r[n].model),l=r[n]&&o<=r[n].created_at;r[n]=l?r[n]:{id:e.id,created_at:o,model:e},this.last_dialogs_ids=r,!l&&a&&a.set("dialog",(t=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},n=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(i).filter((function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})))),n.forEach((function(t){v(e,t,i[t])}))}return e}({},a.get("dialog")),i=null!=(i={is_last:!1})?i:{},Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):function(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);i.push.apply(i,n)}return i}(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})),t))},setShowSourceProperty:function(e){this._getByChatId(e).forEach((function(e){e.has("show_source")&&e.get("show_source")||e.set("show_source",!0)}))},_getByChatId:function(e){return this.filter((function(t){return t.get("chat_id")===e}))},_pushToBuffer:function(e,t){t&&(this.buffer=this.buffer.concat(s().map(t,(function(e){return{date:this._getItemDate(e),view:{model:s().extend(e,{get:function(e){return this[e]||{}}})}}}),this)))},_onFetchError:function(){this._fetching=!1,this._fetched()},addCollection:function(e){this._collections||(this._collections=[]);var t=s().findWhere(this._collections,{id:e.id});return t?e=t:(e.on("fetched",s().bind(this._pushToBuffer,this,e)).on("error",s().bind(this._onFetchError,this)),this._collections.push(e)),!e.id&&!e.element_id||this.bots_collection&&(this.business_bots_collection||this.element_type!==APP.element_types.leads)||(this.bots_collection||(this.bots_collection=new _.default),!this.business_bots_collection&&this.element_type===APP.element_types.leads&&APP.constant("account").amo_messenger.amo_id&&(this.business_bots_collection=new h.default,this.need_fetch_business_bots=!0),d.onPageFullyLoaded(s().bind((function(){this.bots_collection.fetch().then(s().bind((function(){this.trigger("bot:fetched")}),this))}),this))),this.trigger("collection:added",e),e},removeCollection:function(e){var t;e.each((function(e){e&&(t=this.get(e.id))&&t.trigger("destroy",t,t.collection,{})}),this),this._collections=s().without(this._collections,e),this.trigger("collection:removed",e)},isMultipleCategories:function(e){if(this._has_multiple_categories.has(e))return!0;var t=new Set;return this.each((function(i){var n=s().propertyOf(i.get("dialog"))("category");i.get("chat_id")===e&&n&&t.add(s().propertyOf(i.get("dialog"))("category"))})),t.size>1&&(this._has_multiple_categories.add(e),!0)},setMainId:function(e){var t;this.element_id||(this.element_id=e,(t=this.findCollection(0))&&(t.element_id=e)),this._elements&&this._elements[0]&&!this._elements[0].id&&(this._elements[0].id=e),this.trigger("collection:element-id:updated")}});l().mixin(y,f.default,p.default);const b=y;var w="../build/transpiled/interface/notes/pager";window.define(w,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([w])}}]);var _global="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};_global.SENTRY_RELEASE={id:"build_2025_11_28_18_50_52"},function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=(new Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="fa6f483a-761d-4cf8-9718-d0044f72ce1a",e._sentryDebugIdIdentifier="sentry-dbid-fa6f483a-761d-4cf8-9718-d0044f72ce1a")}catch(e){}}();
//# sourceMappingURL=26901.8dff37cf573ef29e4086.js.map