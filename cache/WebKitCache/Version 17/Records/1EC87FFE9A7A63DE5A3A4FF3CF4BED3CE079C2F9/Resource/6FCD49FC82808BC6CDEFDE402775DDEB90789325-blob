"use strict";(window.webpackChunk=window.webpackChunk||[]).push([[5641],{525827:(e,t,n)=>{n.r(t),n.d(t,{default:()=>y});var i=n(661533),o=n.n(i),s=n(629133),a=n.n(s),r=n(345839),l=n.n(r),c=n(162262),d=n.n(c),u=n(445368),_=n(210481),f=n(207427),p=n(756542),m=n(845043),h=n(729115),g={};g.Model=h.default.Model.extend({is_add:!0,updateDefaults:a().noop,save:function(e){var t=this;this.saving||(this.saving=!0,o().ajax({url:this.url,data:o().param(this.toJSON())+this.save_data,type:"POST",dataType:"json"}).always((function(){t.saving=!1})).done((function(n){a().isFunction(e.success)&&(t.save_data="",e.success.call(t,n))})).fail((function(){a().isFunction(e.error)&&e.error.call(t)})))},toJSON:function(){var e=l().Model.prototype.toJSON.call(this);return(this.get("lead[ID]")||this.get("customers[ID]"))&&(this.get("company[NAME]")||delete e["company[NAME]"],this.get("company[ID]")||delete e["company[ID]"]),p.default._correctNameInputs(e)}}),g.View=h.default.View.extend({events:function(){return a().extend({},h.default.View.prototype.events,{"input .js-suggest-company-for-contact":"resetCompanyForContact","suggest:changed .js-suggest-company-for-contact":"chooseCompanyForContact","blur .js-company-name":"onCompanyNameChangeInAdd","suggest:loaded .js-suggest-contact-company-pei":"peiSuggestLoaded","suggest:loaded .js-linked-pei":"peiSuggestLoaded","suggest:loaded .js-suggest-contact-company":"companySuggestLoaded","suggest:changed .js-suggest-contact-company":"chooseContactFromSuggest","suggest:loaded .js-suggest-company-for-contact":"companySuggestLoaded","suggest:changed .js-suggest-contact-company-pei":"chooseContactFromSuggest","suggest:changed .js-linked-pei":"chooseContactFromSuggest","focus .js-linked-has-actions .linked-form__cf:not(.js-linked-in-edit)":"focusHasActionsField","blur .js-linked-has-actions .linked-form__cf":"unfocusHasActionsField","focus .linked-form__cf:not(.js-linked-in-edit)":"focusField","blur .linked-form__cf":"unfocusField","click .linked-form__field-add-multiple .linked-form__field__value":"addNewVariant","input .linked-form__field-pei input":"showHideAddVariant","change .linked-form__field-pei input":"showHideAddVariant"})},initialize:function(e){var t={main_element_type:0,prepareSave:function(){return""},onSave:a().noop,onSuggestCompany:a().noop,onSuggestContact:a().noop,onChangeCompanyName:a().noop,_onSave:a().bind(this.afterSave,this)};d().mixin(this,_.default,f.default),h.default.View.prototype.initialize.call(this,{model:g.Model}),this.options=o().extend({},t,e||{}),this.model.on("view:destroy",this.destroy,this),this.model.save_data=""},destroy:function(e){h.default.View.prototype.remove.call(this,e)},save:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.model.save_data=this.options.prepareSave.call(this)||"",h.default.View.prototype.save.apply(this,t)},afterSave:function(e){this.$(".linked-form__field-pei .linked-form__field__value").find(":input").val("").trigger("change").trigger("controls:change"),this.options.onSave.call(this,e)},resetCompanyForContact:function(){this.$("#contact_company_id").val()&&this.$("#contact_company_id").val("").trigger("change")},onCompanyNameChangeInAdd:function(e){a().delay(a().bind((function(){this.options.onChangeCompanyName(e.target.value)}),this),100)},chooseCompanyForContact:function(e,t){var n=o()(e.currentTarget),i=o()("#new_company_n");e.stopPropagation(),this.$('input[name="company[ID]"]').val(t.attr("data-value-id")).trigger("change"),i.val()||o()("#companies_list").children(".company_contacts__item").length||this.options.onSuggestCompany.call(this,n)},peiSuggestLoaded:function(e,t,n){var i=o()(e.currentTarget),s=[],r="",l=i.attr("data-pei-code");"ok"===t.status?(o().each(t.result,(function(e,t){r=[a().escape(t.element_type===APP.element_types.contacts?(0,u.contactName)(t.name):t.name),t.company_name?', <span class="u-text-secondary">'.concat(a().escape(t.company_name),"</span>"):""].join(""),t[l]&&t[l].length&&(r+='<div class="suggest-item-pei">'.concat(a().escape(t[l].join(", ")),"</div>")),s.push({id:t.id,title:t.name,text:r,raw_highlight:!0})})),n.trigger("suggest:reset",[s])):n.trigger("suggest:reset",[[]])},companySuggestLoaded:function(e,t,n){var i=[],s=this.options.main_element_type===APP.element_types.companies;"ok"===t.status&&o().each(t.result,(function(e,t){(!s||!t.company_name&&s)&&i.push({id:t.id,text:[a().escape(t.element_type===APP.element_types.contacts?(0,u.contactName)(t.name):t.name),t.company_name?', <span class="u-text-secondary">'.concat(a().escape(t.company_name),"</span>"):""].join(""),company_id:t.company_id?t.company_id:0,raw_highlight:!0})})),n.trigger("suggest:reset",[i])},chooseContactFromSuggest:function(e,t){var n,i=this,s=o()(e.currentTarget),r=o().trim(t.find(".suggest-item-pei").text()),l={id:s.attr("data-value-id"),name:r,company_id:t.attr("company-id")};e.stopPropagation(),s.val(r),a().isFunction(this.options.onBeforeSuggestContact)&&!this.options.onBeforeSuggestContact(s,l)||(n=s.closest("form"),s.val("").trigger("change"),this.hasChanges()?(s.val(r),new m.default({class_name:"modal-list",text:APP.lang["card_confirm_before_link_".concat(n.attr("data-entity"))],accept:function(){i.revert(),this.modal.destroy(),i.options.onSuggestContact.call(i,s,l)},destroy:function(){this.accepted||(s.val(""),APP.is_touch_device||s.focus())}})):this.options.onSuggestContact.call(this,s,l))}});const y=g;var v="../build/transpiled/interface/card/linked/add";window.define(v,(function(){var e="undefined",n=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return n&&n.default||n})),window.require([v])},61964:(e,t,n)=>{n.r(t),n.d(t,{default:()=>a});var i=n(629133),o=n.n(i),s=n(982862);const a=n(210734).default.extend({controlClassName:"js-linked-name-control",_classes:function(){return{name_main_wrapper:"linked-form__field__value-name"}},_selectors:function(){return{view_input:".js-linked-name-view",single_input:".control-fullname__single",editing_block:".js-linked-name-editing-holder"}},events:function(){var e={click:"stopPropagationOnClick"};return e["focus ".concat(this._selector("view_input"))]="onViewInputFocus",e["blur ".concat(this._selector("single_input"))]="onMisclickShowViewMode",e["mousedown ".concat(this._selector("view_input"))]="onViewInputMouseDown",e},document_events:{mouseup:"onViewInputMouseUpReplaceCursor","controls:hide:private":"onMisclickShowViewMode"},stopPropagationOnClick:function(e){this._editing&&(this._$document.trigger({type:"controls:hide",target:this.el}),e.stopPropagation())},onViewInputFocus:function(){var e;this._mousedowned||((e=this._findElem("view_input").scrollLeft(0)).hide(),this.$el.closest(this._selector("name_main_wrapper")).addClass("".concat(this._class("name_main_wrapper"),"_editing")),this._findElem("editing_block").removeClass("hidden").find(":input").trigger("autosize:important").filter((function(t){return e.val()?0!==t:0===t})).last().focus(),this._editing=!0)},onViewInputMouseDown:function(){this.$el.attr("href")||(this._mousedowned=!0)},onViewInputMouseUpReplaceCursor:function(){var e,t,n,i,a;if(this._mousedowned){if(e=this._findElem("view_input").get(0),this._mousedowned=!1,e.selectionStart!==e.selectionEnd)return;t=e.selectionStart,n=o().reduce(e.value.split(" "),(function(e,n,i){return t>=0&&(e=(t-=n.length+(i>0?1:0))<=0?n:e),e}),""),this.onViewInputFocus(),n&&(i=(a=this._findElem("editing_block").find(":input")).filter((function(e,t){return t.value.indexOf(n)>=0})).first(),(0,s.setCursorPosition)(i,2===a.length?i.val().length+t:e.selectionStart))}},onMisclickShowViewMode:function(e){if(e.target!==this.el){var t=this._findElem("editing_block").find(":input").map((function(e,t){return t.value.trim()})).toArray();this._findElem("view_input").val(o().compact(t).join(" ")).trigger("input").show(),this._findElem("editing_block").addClass("hidden"),this.$el.closest(this._selector("name_main_wrapper")).removeClass("".concat(this._class("name_main_wrapper"),"_editing")),this._editing=!1}}});var r="../build/transpiled/interface/card/linked/controls/name";window.define(r,(function(){var e="undefined",n=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return n&&n.default||n})),window.require([r])},27879:(e,t,n)=>{n.r(t),n.d(t,{default:()=>E});var i=n(661533),o=n.n(i),s=n(629133),a=n.n(s),r=n(345839),l=n.n(r),c=n(162262),d=n.n(c),u=n(460159),_=n.n(u),f=n(809228),p=n.n(f),m=n(955026),h=n(926168),g=n(782361),y=n(210481),v=n(207427),k=n(756542),w=n(845043);n(61964);var b={};b.Model=g.default.Model.extend({save:function(e){var t=this,n=function(n){a().isFunction(e.success)&&e.success.call(t,n||{})};this.get("disabled")?n():this.saving||(this.saving=!0,o().ajax({url:this.url,data:o().param(this.toJSON()),type:"POST",dataType:"json"}).always((function(){t.saving=!1})).done((function(i){"success"===i.status?n(i):a().isFunction(e.error)&&e.error.call(t,i)})).fail((function(){a().isFunction(e.error)&&e.error.call(t)})))},toJSON:function(){var e=l().Model.prototype.toJSON.call(this);return this.get("company[NAME]")||delete e["company[NAME]"],this.get("company[ID]")||delete e["company[ID]"],parseInt(this.get("ELEMENT_TYPE"))!==APP.element_types.contacts||"companies"===APP.getBaseEntity()||this.get("company[NAME]")||this.get("company[ID]")||(e.company="remove"),k.default._correctNameInputs(e)}}),b.View=g.default.View.extend({_selectors:function(){return a().extend({},a().result(g.default.View.prototype,"_selectors",{}),{name_input:".linked-form__field__link .js-linked-name-view",social_profile_actions:".user-messenger-actions-tip .js-cf-actions-item",copy_tip_item:".js-linked-entity-name-copy"})},events:function(){return a().extend({},g.default.View.prototype.events,{"click .js-linked-entity-unlink":"unlinkLinkedEntity","click .js-linked-entity-set_main":"setMainLinkedEntity","click .js-linked-has-actions":"showActions","click .js-cf-actions-item":"initTipAction","suggest:loaded .js-linked-contact-company":"companySuggestLoaded","suggest:changed .js-linked-contact-company":"chooseCompanyForContact","input .js-linked-contact-company":"clearContactCompanyId"})},bindEvents:function(){this.events=(a().isFunction(this.events)?this.events():this.events)||{},this.events["focus .linked-form__field__value-name input"]="focusOnName",this.events["blur .linked-form__field__value-name input"]="unfocusOnName",this.events["input ".concat(this._selector("name_input"))]="updateCopyNameValue",this.events["click ".concat(this._selector("copy_tip_item"))]="copyContactName",this.events["click .js-linked-show-all-fields"]="showHiddenFields",this.events["focus .js-linked-fields-shower-input"]="showHiddenFieldsOnFocus",this.events["dblclick .js-linked-has-actions .linked-form__cf:not(.js-linked-in-edit)"]="selectInHasActionsField",this.events["mousemove .js-linked-has-actions .linked-form__cf:not(.js-linked-in-edit)"]="moveOnHasActionsField",this.events["touchstart .js-linked-has-actions .linked-form__cf"]="beforeFocusHasActionsField",this.events["mousedown .js-linked-has-actions .linked-form__cf"]="beforeFocusHasActionsField",this.events["focus .js-linked-has-actions .linked-form__cf:not(.js-linked-in-edit)"]="focusHasActionsField",this.events["blur .js-linked-has-actions .linked-form__cf"]="unfocusHasActionsField",this.events["focus .linked-form__cf:not(.js-linked-in-edit)"]="focusField",this.events["blur .linked-form__cf"]="unfocusField",this.events["input .linked-form__field-pei input"]="showHideAddVariant",this.events["change .linked-form__field-pei input"]="showHideAddVariant",this.events["click .linked-form__field-add-multiple .linked-form__field__value"]="addNewVariant",this.delegateEvents()},initialize:function(e){var t={onUnlink:a().noop,onSuggestCompany:a().noop,_onError:a().bind((function(e){this.savingError(e)}),this),_onSave:a().bind((function(e){this.updateCompanyInput(e&&e.company_id||!1)}),this)};d().mixin(this,y.default,v.default,k.default),g.default.View.prototype.initialize.call(this,{model:b.Model,el:this.$el,entity:{id:this.$el.find('[name="ID"]').val(),type:this.$el.find('[name="ELEMENT_TYPE"]').val()}}),this._findElem("name_input").autosizeInput({comfortZone:0}),this.options=o().extend({},t,e||{}),this.$tip=!1,this.unfocusOnName({currentTarget:this._findElem("name_input"),important:!0}),this.write_first_lead_sources_collection=this.options.write_first_lead_sources_collection,this.$el.closest(".linked-forms__item").hasClass("linked-forms__item-active")&&this.$(".linked-form__field__link").removeAttr("href"),this.model.on("view:destroy",this.destroy,this),this.model.get("disabled")?this.disableForm():this.bindEvents(),this.checkMainLinkedEntityHasStar()},destroy:function(e){this._findElem("social_profile_actions").off("click"),!1!==e&&this.$el.parent().remove(),this.remove(e)},savingError:function(e){var t=this,n=parseInt(this.model.get("ELEMENT_TYPE"));new w.default({class_name:"modal-list modal-confirm-error",text:a().uniq(e.errors).join("<br/><br/>"),decline_text:APP.lang["discard_".concat(1===n?"contact":"company","_changes")],accept_text:"OK",accept:function(){this.destroy()},destroy:function(){!1===this.accepted&&t.revert()}})},setInputValue:function(e,t,n){var i=this._patchContactNameRevert(e,t,n,["contact[N]","contact[FN]","contact[LN]"]);g.default.View.prototype.setInputValue.apply(this,i.length?i:arguments)},revert:function(){g.default.View.prototype.revert.call(this),this.unfocusOnName({currentTarget:this._findElem("name_input")})},save:function(e){var t=this,n=e.success;e.success=function(e){t._updateContactNameOnSave(e),a().isFunction(n)&&n.call(t,e)},g.default.View.prototype.save.call(this,e)},_updateContactNameOnSave:function(e){e&&"contact"===this.entity&&(this.$(".control-fullname").replaceWith(_()({ref:"/tmpl/cards/forms/fields/contact_name.twig"}).render({name:e.name,first_name:e.first_name,last_name:e.last_name})),this.$(".control-fullname").find(":input").trigger("change"),this.model.updateDefaults())},disableForm:function(){this.$(":input").attr("readonly",!0).attr("disabled",!0).addClass("readonly text-input-visible-placeholder"),this.$('.js-cf-actions-item[data-type="edit"]').hide(),this.$el.on("click.linked:disabled",(function(e){if(!o()(e.target).closest(".linked-form__field-name").length)return!1}))},enableForm:function(){this.$(":input").removeAttr("readonly").removeAttr("disabled").removeClass("readonly text-input-visible-placeholder"),this.$('.js-cf-actions-item[data-type="edit"]').show(),this.$el.off("click.linked:disabled")},updateCompanyInput:function(e){var t;e&&((t=this.$(".linked-form__field__value-company")).find('.js-tip .tips-item[data-type="company"]').attr("href","/companies/detail/".concat(e)),t.find("input").attr("data-value-id",e).closest(".js-linked-with-actions").addClass("js-linked-has-actions"))},companySuggestLoaded:function(e,t,n){var i=[];"ok"===t.status&&(i=a().map(t.result,(function(e){return{id:e.id,text:e.name}}))),n.trigger("suggest:reset",[i])},chooseCompanyForContact:function(e,t){var n=o()(e.currentTarget),i=o().trim(t.text()),s=n.attr("data-value-id");e.stopPropagation(),n.closest(".js-linked-with-actions").addClass("js-linked-has-actions"),n.closest(".linked-form__field__value-company").find('input[name="company[ID]"]').val(s).trigger("change"),n.val(i),this.options.onSuggestCompany.call(this,n)},clearContactCompanyId:function(e){var t=o()(e.currentTarget);t.attr("data-value-id","").closest(".js-linked-with-actions").removeClass("js-linked-has-actions"),this.model.get("company[ID]")&&t.closest(".linked-form__field__value-company").find('input[name="company[ID]"]').val("").trigger("change")},setMainLinkedEntity:function(e){var t,n=o()(e.currentTarget).closest(".linked-forms__item"),i=this.$('input[name="ELEMENT_TYPE"]').val(),s=a().invert(APP.element_types),r=s[i]||!1,l=o().trim(this.$(".linked-form__field__value-name input").val()),c={main_id:this.$('input[name="MAIN_ID"]').val(),linked_id:this.$('input[name="ID"]').val()},d="/ajax/linked/".concat(APP.data.current_entity,"/set/main/").concat(r),u="application/x-www-form-urlencoded",_=this;APP.data.current_entity===s[APP.element_types.customers]&&(c=JSON.stringify({request:{links:{link:[{from:APP.data.current_entity,to:r,from_id:this.$('input[name="MAIN_ID"]').val(),to_id:this.$('input[name="ID"]').val(),main_contact:!0}]}}}),d="/ajax/v1/links/set",u="application/json"),o()(document).trigger("controls:hide"),r&&(t=new w.default({class_name:"modal-list",text:APP.lang["are_you_sure_to_set_main_".concat(r)].toString().replace("#MARKER#",l),accept:a().bind((function(){t.requestStart().xhr=o().ajax({url:d,data:c,type:"POST",dataType:"json",contentType:u}).done((function(e){e.response&&(e=e.response),"success"===e.result||(0,m.hasKeys)(e,["links","link","errors"])&&0===e.links.link.errors.length?(t.requestSuccess(APP.lang.modal_success),_.changeMainLinkedEntityPosition(n)):t.requestFail()}))}),this)})),e.stopPropagation()},changeMainLinkedEntityPosition:function(e){var t=o()("#contacts_list"),n=t.find(".linked-forms__main_item");n.removeClass("linked-forms__main_item").find(".linked-form__field__main").remove(),n.find(".js-linked-entity-set_main").removeClass("hidden"),e.find(".js-linked-entity-set_main").addClass("hidden"),e.addClass("linked-forms__main_item"),e.attr("data-main-item","true"),t.prepend(e),this.checkMainLinkedEntityHasStar(e),a().isFunction(this.options.onChangeMainContact)&&this.options.onChangeMainContact.call(this)},checkMainLinkedEntityHasStar:function(e){var t=o()("#contacts_list"),n=(e=e||t.find('.linked-forms__item[data-main-item="true"]')).find(".linked-form__field__main");t.find(".linked-forms__item").length>1?n.length||e.addClass("linked-forms__main_item"):(e.removeClass("linked-forms__main_item"),n.remove())},updateCopyNameValue:function(e){var t=o()(e.currentTarget),n=t.closest(".linked-form__field__value-name").find(this._selector("copy_tip_item"));n.length&&n.attr("data-clipboard-text",a().escape(t.val()))},copyContactName:function(){var e=new(p())(this._selector("copy_tip_item"));e.on("success",a().bind((function(t){var n=o()(t.trigger),i=n.find(".js-linked-entity-name-copy-inner"),s=i.text();i.hasClass("js-copied")||(i.text(n.data("copied")).css("color","#868C90"),i.addClass("js-copied"),setTimeout((function(){i.text(s).css("color",""),i.removeClass("js-copied"),o()(document).trigger("controls:hide"),e.destroy()}),1e3))}),this))},unlinkLinkedEntity:function(e){var t,n,i,s=this,r=this.$('input[name="ID"]').val(),l=parseInt(this.$('input[name="ELEMENT_TYPE"]').val()),c=3===l?"company":"contact",d=o().trim(this.$(".linked-form__field__value-name input").val()),u={request:{links:{unlink:[]}}};o()(document).trigger("controls:hide"),d=a().escape(d),APP.getBaseEntity()===(0,h.convertElementType)(APP.element_types.customers,"string")?(n="/ajax/v1/links/set",i={from:APP.data.current_entity,to:(0,h.convertElementType)(l,"string"),from_id:s.$('input[name="MAIN_ID"]').val(),to_id:r},u.request.links.unlink.push(i)):(n="/ajax/linked/".concat(APP.data.current_entity,"/remove/"),u={element_id:r,element_type:l,main_id:s.$('input[name="MAIN_ID"]').val()}),new w.default({class_name:"modal-list",text:APP.lang["are_you_sure_to_unlink_".concat(c)].toString().replace("#MARKER#",d),accept:function(){var e=this;this.requestStart().xhr=o().ajax({url:n,type:"POST",dataType:"json",data:u,success:function(n){!0===n.response||(0,m.hasKeys)(n,["response","links","unlink","errors"])&&0===n.response.links.unlink.errors.length?(s.destroy(),"contact"===c&&n.main_contact_id&&(t=o()("#linked_form_".concat(n.main_contact_id)).closest(".linked-forms__item")).length&&(t.hasClass("linked-forms__main_item")?s.checkMainLinkedEntityHasStar(t):s.changeMainLinkedEntityPosition(t)),s.options.onFormUnlink.call(s,s),s.options.onUnlink.call(s,{element_id:r,element_type:l}),e.requestSuccess(APP.lang.linked_entity__unlinked)):e.requestFail()},error:function(){e.requestFail()}})}}),e.stopPropagation()},showHideAddVariant:function(e){var t=o()(e.currentTarget),n=t.closest(".linked-form__field-pei"),i="show";t.val()?i="show":n.prev(".linked-form__field-pei").length||(i="hide"),n.next(".linked-form__field-add-multiple")[i]()}});const E=b;var P="../build/transpiled/interface/card/linked/edit";window.define(P,(function(){var e="undefined",n=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return n&&n.default||n})),window.require([P])},664431:(e,t,n)=>{n.r(t),n.d(t,{default:()=>g});var i=n(661533),o=n.n(i),s=n(629133),a=n.n(s),r=n(345839),l=n.n(r),c=n(313981),d=n(500034),u=n(450422),_=n(27879),f=n(525827),p=n(661799),m=n(845043),h={};h.EditForm=_.default,h.AddForm=f.default,h.View=c.default.extend({_selectors:function(){return{linked_exists_not_active:".linked-forms__item:not(.linked-forms__item-active):not(.linked-forms__item_is-add)",linked_new:".linked-forms__item_is-add:not(.expanded)",linked_name:".linked-form__field__value-name .linked-form__cf.text-input",profile_messengers_wrapper:".profile_messengers-wrapper"}},events:function(){var e={"click .js-linked-cancel":"cancelAddForm","click .linked-form__field__link":"preventNavigateToEntity","tip:showed .linked-form__field__more__tip":"onTipShowed"};return e["mousedown ".concat(this._selector("linked_exists_not_active"))]="preventNameFocus",e["touchstart ".concat(this._selector("linked_exists_not_active"))]="preventNameFocusTouch",e["click ".concat(this._selector("linked_exists_not_active"))]="toggleForm",e["click ".concat(this._selector("linked_new"))]="showAddForm",e["focus ".concat(this._selector("linked_exists_not_active")," ").concat(this._selector("linked_name"))]="toggleFormOnFocus",e["focus ".concat(this._selector("linked_new")," ").concat(this._selector("linked_name"))]="showAddForm",e},initialize:function(e){var t=this,n=this,i={forms_selector:".linked-forms ",add_forms_selector:".linked-forms__item_is-add ",element_type:0,onAdd:a().noop,onModify:a().noop,onSaveStart:a().noop,onSaveForm:a().noop,onSaveComplete:a().noop,onRevert:a().noop,onValidate:a().noop,edit:{type:"edit",onFormUnlink:a().bind(this.unlinkForm,this),onUnlink:a().noop,onSuggestCompany:a().noop},add:{type:"add",prepareSave:function(){return""},onSuggestCompany:a().noop,onSuggestContact:a().noop}},s=function(e,t){o()(e).closest(this.options.forms_selector).length?this.addForm(_.default.View,e,this.options.edit):this.addForm(f.default.View,e,this.options.add).$el.on("form:cancel",a().bind(this.cancelAddForm,this)),a().result(t,"is_last",!1)&&this.trigger("inited")};this.options=o().extend(!0,{},i,e||{}),this.form_views=[],this.form_models=new(l().Collection),this.profile_messengers_wrapper=this._elem("profile_messengers_wrapper");var r=this.$("".concat(this.options.forms_selector," form, ").concat(this.options.add_forms_selector," form"));r.each((function(e,t){var i={is_last:e===r.length-1};(0,d.isFeatureAvailable)("single_timeline")?setTimeout(a().bind(s,n,t,i)):s.call(n,t,i)})),this.listenTo(this.form_models,"has_changes",this.hasModified),this.listenTo(this.form_models,"has_reverted",this.hasReverted),this.form_views.reverse(),c.default.prototype.initialize.apply(this,arguments),this.profile_messengers_wrapper.each((function(e,n){var i=o()(n).find(".profile_messengers");t._addComponent(p.default,{el:i})}))},destroy:function(){this.form_models.each((function(e){e.trigger("view:destroy",!1)})),this.stopListening()},preventNavigateToEntity:function(e){(e.metaKey||e.ctrlKey)&&(window.open("".concat(o()(e.currentTarget).attr("href"),"?compact=yes"),"_blank"),e.stopPropagation()),e.preventDefault()},unlinkForm:function(e){this.form_models.remove(e.model),this.form_views=a().without(this.form_views,e)},addEditForm:function(e){var t=this.addForm(_.default.View,e,this.options.edit);a().isFunction(this.options.onAdd)&&this.options.onAdd.call(t)},addForm:function(e,t,n){"add"===n.type&&a().extend(n,{onChangeCompanyName:a().bind(this._onChangeCompanyName,this)});var i=new e(a().extend({el:t,main_element_type:this.options.element_type,write_first_lead_sources_collection:this.options.write_first_lead_sources_collection,onSaveForm:this.options.onSaveForm},n||{}));return this.form_views.push(i),this.form_models.push(i.model),i},_onChangeCompanyName:function(e){var t=a().filter(this.form_views,(function(e){var t=e.$("#contact_company_id");switch(!0){case t.length&&t.val().length:case parseInt(e.model.get("ELEMENT_TYPE"))===APP.element_types.contacts&&!e.$(".js-company-name").val():return!1;default:return"add"===e.options.type||parseInt(e.model.get("ELEMENT_TYPE"))===APP.element_types.companies}}));2===t.length&&a().each(t,(function(t){t.$(".js-company-name").val(e).trigger("change")}))},setMainId:function(e){var t,n;a().each(this.form_views,(function(i){(t=i.$el.find(".main-entity-id")).length&&(n=t.attr("name"),t.val(e).trigger("change"),i.model.set(n,e),i.model.defaults[n]=e)}))},hasReverted:function(){var e=!0;a().every(this.form_views,(function(t){return e=!t.hasChanges()})),e&&this.options.onRevert()},hasModified:function(){this.options.onModify()},scrollToEl:function(e,t){if(this.saving)return"function"==typeof t&&t(),!1;o()("body").animate({scrollTop:e.offset().top-100},300,t)},onTipShowed:function(e){var t=o()(e.target),n=t.closest(".js-tip-holder").closest(".linked-form__field-name")[0].getBoundingClientRect();t.css("left","");var i=t[0].getBoundingClientRect();i.right>n.right&&t.css({left:-1*i.width+30,right:"auto"})},showAddForm:function(e){var t,n,i,s=this,a=o()(e.currentTarget).closest(".linked-forms__item_is-add"),r=a.closest(".card-fields__linked-block"),l=a.children("form"),c=function(){l.find(".linked-form__multiple-container").each((function(){var e=o()(this).children();e.length>2&&e.slice(1,-1).each((function(){o()(this).remove()}))}));var e=s.getFormViewByEl(l);a.addClass("expanded").find(".js-suggest-contact-company").focus(),"new_contact_form"===a.attr("id")&&1===(t=o()("#companies_list").children("li")).length&&(n=t.find('input[name="ID"]').val(),o()("#contact_company_input").val(o().trim(t.find('.linked-form__field__value-name input[type="text"]').val())).attr("data-value-id",n).trigger("change"),o()("#contact_company_id").val(n).trigger("change"),e.model.initialize(),e.checkChanges())};if(a.hasClass("expanded"))if((i=this.getFormViewByEl(l))&&i.hasChanges()){if(!1===this.validate(i))return;this.saveForm(i,(function(){i.save({success:function(){s.hasReverted()}})}))}else a.removeClass("expanded").find(".js-suggest-contact-company").blur();else this.toggleForm({afterToggle:c,currentTarget:r.find(".linked-forms__item-active")})&&c()},cancelAddForm:function(e,t){var n=o()(e&&e.currentTarget||this.closest(".linked-forms__item_is-add").children(".js-linked-cancel")).closest(".linked-forms__item_is-add"),i=n.find("form"),s=this.getFormViewByEl(i);s&&(s.model.trigger("clear_errors",s.$el,s.model.toJSON()),s.revert());var a=t||n.prev(this.forms_selector).find(".linked-forms__item:first");a.length?this.toggleForm({currentTarget:a}):n.removeClass("expanded").find(".js-suggest-contact-company").blur()},preventNameFocusTouch:function(e){o()(e.currentTarget).find(".linked-form__field__link input").prop("readonly",!0)},preventNameFocus:function(){return!1},getFormViewByEl:function(e){return a().find(this.form_views,(function(t){return t.el===e[0]}))},saveForm:function(e,t){var n=this.getFormViewByEl(o()("#new_company")),i=!1;2===parseInt(this.options.element_type)&&e!==n&&n&&(!e.model.get("company[NAME]")||e.model.get("company[ID]")||o()("#companies_list").children("li").length||n.hasChanges()||n.model.set("company[NAME]",e.model.get("company[NAME]")),n.hasChanges()&&(n.save({success:function(i){n.revert(),e!==n&&(e.$el.find('input[name="company[ID]"]').val(i.company.ID).trigger("change"),e.model.set("company[ID]",i.company.ID)),t()}}),i=!0)),i||t()},toggleFormOnFocus:function(e){var t,n=o()(e.currentTarget);APP.is_touch_device||(this.toggleForm({currentTarget:n.closest(this._selector("linked_exists_not_active")).get(0)}),t=n.val().length,n.get(0).setSelectionRange&&n.get(0).setSelectionRange(t,t))},toggleForm:function(e){var t=this,n=o()(e.currentTarget),i=n.hasClass("linked-forms__item-active"),s=i?n:n.closest(this.options.forms_selector).find(".linked-forms__item-active"),r=i?[]:n.closest(".linked-forms-holder").next(".linked-forms__item_is-add.expanded"),l=s.find("form"),c=function(){var e=s.find(".linked-form__field__link");r.length?r.removeClass("expanded").find(".js-suggest-contact-company").blur():(s.removeClass("linked-forms__item-active").find(".linked-form__fields").slideUp(200),e.attr("href",e.attr("data-href"))),i||(n.addClass("linked-forms__item-active").find(".linked-form__fields").slideDown(200),n.find(".linked-form__field__link").removeAttr("href"))};e.preventDefault&&(e.preventDefault(),document.activeElement.blur()),n.find(".linked-form__field__link input").removeProp("readonly"),r.length&&(l=r.find("form"));var d=this.getFormViewByEl(l);if(d&&d.hasChanges()){if(!1===this.validate(d))return;return new m.default({class_name:"modal-list",text:(APP.lang["linked_form_".concat(d.model.get("ELEMENT_TYPE"),"_has_changes")]||"").toString().replace("#MARKER#",d.$(".linked-form__field__value-name input").val()),accept:function(){!1!==t.validate(d)?t.saveForm(d,a().bind((function(){d.save({success:a().bind((function(){this.destroy(),this.requestSuccess(),c(),a().isFunction(e.afterToggle)&&e.afterToggle(),t.hasReverted()}),this),error:a().bind((function(){this.destroy()}),this)})}),this)):this.destroy()},destroy:function(){!1===this.accepted&&(d.revert(),c(),"function"==typeof e.afterToggle&&e.afterToggle())}}),!1}return c(),this.$el.find(".text-input-textarea.linked-form__cf").trigger("controls:textarea:autosize"),!0},validate:function(e){return!e||!1!==this.options.onValidate.call(this,e)},save:function(e,t){var n,i=this;t=t||[],e=e||{};var o=a().find(this.form_views,(function(e){return(0,u.isAmoChatsFullEnabled)()&&parseInt(e.model.get("ELEMENT_TYPE"))===APP.element_types.contacts&&!e.model.get("ID")&&(n=!0),(e.hasChanges()||n)&&!0!==e._completely_saved}));this.saving=!0,o?this.saveForm(o,(function(){o.save({success:function(n){n.element_type=o.model.get("ELEMENT_TYPE"),t.push(n),o._completely_saved=!0,i.save(e,t)},error:function(t){i.saving=!1,"function"==typeof e.error&&e.error(t)}})})):(a().each(this.form_views,(function(e){delete e._completely_saved})),this.saving=!1,a().isFunction(e.success)&&e.success(t),this.options.onSaveComplete())}});const g=h;var y="../build/transpiled/interface/card/linked/forms";window.define(y,(function(){var e="undefined",n=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return n&&n.default||n})),window.require([y])},661799:(e,t,n)=>{n.r(t),n.d(t,{default:()=>w});var i=n(629133),o=n.n(i),s=n(460159),a=n.n(s),r=n(162262),l=n.n(r),c=n(313981),d=n(171701),u=n(210481),_=n(207427),f=n(661533);function p(e,t,n,i,o,s,a){try{var r=e[s](a),l=r.value}catch(e){return void n(e)}r.done?t(l):Promise.resolve(l).then(i,o)}function m(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function h(e,t,n){return h="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=g(e)););return e}(e,t);if(i){var o=Object.getOwnPropertyDescriptor(i,t);return o.get?o.get.call(n||e):o.value}},h(e,t,n||e)}function g(e){return g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},g(e)}function y(e,t){return y=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},y(e,t)}function v(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,i=g(e);if(t){var o=g(this).constructor;n=Reflect.construct(i,arguments,o)}else n=i.apply(this,arguments);return function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(this,n)}}var k=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&y(e,t)}(s,e);var t,n,i=v(s);function s(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),i.apply(this,arguments)}return t=s,n=[{key:"template",get:function(){return"/tmpl/cards/forms/profile_messengers/user_messenger.twig"}},{key:"document_events",value:function(){return{"linked:tip:remove":"render"}}},{key:"events",value:function(){return{"click .js-profile_messengers-counter":"initSuggestProfiles"}}},{key:"_selectors",value:function(){return{social_profile_actions:".user-messenger-actions-tip .js-cf-actions-item",profile_messengers_item:".profile_messengers-item",profile_messengers_item_name:".profile_messengers-item-name",profile_messengers:".profile_messengers"}}},{key:"bindTipActionEvent",value:function(){this._findElem("social_profile_actions").on("click",o().bind(this.initTipAction,this))}},{key:"initialize",value:function(){h(g(s.prototype),"initialize",this).apply(this,arguments),this.bindTipActionEvent()}},{key:"initSuggestProfiles",value:function(e){e.stopPropagation(),this.suggestProfiles=this._addComponent(d.default,{el:this.$el,onSuggestManagerDestroy:o().bind(this.handleSuggestDestroy,this)})}},{key:"render",value:function(){var e,t=this;return(e=function(){return function(e,t){var n,i,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,i&&(o=2&s[0]?i.return:s[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,s[1])).done)return o;switch(i=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,i=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],i=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}}(this,(function(e){switch(e.label){case 0:return[4,a()._preload([t.template])()];case 1:return e.sent(),t._render(),[2]}}))},function(){var t=this,n=arguments;return new Promise((function(i,o){var s=e.apply(t,n);function a(e){p(s,i,o,a,r,"next",e)}function r(e){p(s,i,o,a,r,"throw",e)}a(void 0)}))})()}},{key:"_render",value:function(){var e={element:{profiles:this.prepareData()}},t=f(a()({ref:this.template}).render(e));this.$el.replaceWith(t),this.setElement(t),this.bindTipActionEvent()}},{key:"prepareData",value:function(){var e=this,t={},n=this._elem("profile_messengers_item"),i=o().map(n,(function(t){var n=f(t);return{id:n.data("value"),entity_id:n.data("entity"),source_name:n.find(e._selector("profile_messengers_item_name")).text().trim(),code:n.find(e._selector("profile_messengers_item_name")).data("code"),service:n.data("source"),profile_data:JSON.stringify({chat_id:n.find(".js-tips-item[data-chat-id]").data("chat-id")})}}));return o().each(i,(function(e){var n=e.service;t[n]||(t[n]=[]),t[n].push(e)})),t}},{key:"handleSuggestDestroy",value:function(){o().isEqual(this.suggestProfiles.getExistingItems(),this.suggestProfiles.existing_items)||(this.render(),h(g(s.prototype),"destroy",this).apply(this,arguments))}}],n&&m(t.prototype,n),s}(c.default);l().mixin(k,u.default,_.default);const w=k;var b="../build/transpiled/interface/card/linked/linked_profiles";window.define(b,(function(){var e="undefined",n=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return n&&n.default||n})),window.require([b])},766358:(e,t,n)=>{n.r(t),n.d(t,{default:()=>A});var i=n(661533),o=n.n(i),s=n(629133),a=n.n(s),r=n(345839),l=n.n(r),c=n(162262),d=n.n(c),u=n(313981),_=n(335745),f=n(955026),p=n(168807),m=n(348924),h=n(817603),g=n(170112),y=n(11024);function v(e,t,n,i,o,s,a){try{var r=e[s](a),l=r.value}catch(e){return void n(e)}r.done?t(l):Promise.resolve(l).then(i,o)}function k(e){return function(){var t=this,n=arguments;return new Promise((function(i,o){var s=e.apply(t,n);function a(e){v(s,i,o,a,r,"next",e)}function r(e){v(s,i,o,a,r,"throw",e)}a(void 0)}))}}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function b(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function E(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),i.forEach((function(t){w(e,t,n[t])}))}return e}function P(e,t){var n,i,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,i&&(o=2&s[0]?i.return:s[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,s[1])).done)return o;switch(i=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,i=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],i=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}}var C=function(e,t){return(e=parseInt(e))===parseInt(t)},S=u.default.extend({_element:null,$el:null,_linked_modal:null,_$elements_area:null,_linked_types:[],_linked_holders:null,_static_holders:null,_element_id:0,_element_type:null,_element_model:null,_available_types:{2:[],1:[],3:[],12:[]},_new_transaction:null,initialize:function(e){return k((function(){var t=arguments;return P(this,(function(n){switch(n.label){case 0:return this._static_holders={},this._params=e,this._linked_holders=new(l().Collection)(null),u.default.prototype.initialize.apply(this,t),this.undelegateEvents(),this._element=APP.constant("card_element")||{},this.parseParams(e),this._linked_holders.on("state_changed",this.onHolderChange,this),[4,this.loadTypes()];case 1:return n.sent(),this.checkIsProductsAvailable()&&this._subscribeToProductsSocket(),[2]}}))})).apply(this)},checkIsProductsAvailable:function(){var e=a().find(this._linked_types,{catalog_type:"products"});return!a().isUndefined(e)&&APP.constant("account").products.catalog_id&&this._element_id},_subscribeToProductsSocket:function(){var e={leads:"lead",customers:"customer"}[APP.getBaseEntity()];if(!a().isUndefined(e)){var t="".concat(e,":").concat(this._element_id,":card_links:catalog:").concat(APP.constant("account").products.catalog_id);this._destroyProductsSocketSubscription=(0,h.initSocketSubscription)({channelName:t,onMessageReceive:a().bind(this._handleSocketMessage,this),onMessageFilter:function(e){var t,n;return Boolean(null==e||null===(n=e.body)||void 0===n||null===(t=n.payload)||void 0===t?void 0:t.to_entity_id)}})}},_handleSocketMessage:function(e){var t,n,i=APP.constant("account").products.catalog_id,o=this._linked_holders.find((function(e){return e.id===i})),s=e.to_entity_id;switch(e.type){case 72:var a=e._embedded.catalog_element,r=e.metadata.quantity;this._$document.trigger("updateProductsQuantity",1),null==o||o.trigger("socket:add:element",{id:s,element:(t=E({},a),n={quantity:r},n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n.push.apply(n,i)}return n}(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})),t)});break;case 73:this._$document.trigger("updateProductsQuantity",-1),null==o||o.trigger("socket:delete:element",{id:s});break;case 24:var l=e.field_changed,c=e.new_value;null==o||o.trigger("socket:change:element",{id:s,field_changed:l,new_value:c});break;default:null==o||o.trigger("socket:change:element",{id:s})}},_initBaseTypes:function(){var e,t=this;a().each(t._linked_types,(function(n,i){(e=a().indexOf(t._available_types[t._element_type.id],String(n.id)))>-1&&!n.linked&&(n.linked=!0,n.sort=t._linked_types[i].sort?t._linked_types[i].sort:e)}))},showType:function(e){e&&(this.trigger("show_type",e),this.initLinkedElements(e))},showStatic:function(e){var t=this,i=e.id;this._static_holders[i]?this._static_holders[i].toggle(!0):Promise.resolve().then(n.bind(n,172848)).then((function(n){var o=n.default;t._static_holders[i]=o(i,t._element_type.id,t.getLinkedParams(e)),t._$elements_area.append(t._static_holders[i].el)}))},hideType:function(e){a().each(this._static_holders,(function(t){t._info.type===e.type&&t.toggle(!1)})),this._linked_holders.each((function(t){t._info.type===e.type&&t.toggle(!1)}))},parseParams:function(e){if(!e)throw new Error("Please, use jsDoc to create params for this object");if(!e.element_type)throw new Error("Element type must be defined in params");if(!e.$wrapper||!b(e.$wrapper,o()))throw new Error("Element type must be defined in params");e.element_id&&this.setMainId(e.element_id),this._$elements_area=e.$wrapper,this._onRender=e.onRender||a().noop,this.setElementModel(e.element_model)},setElementModel:function(e){b(e,g.default)&&(this._element_model=e)},destroy:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._$document.off(this.ns),this._linked_holders.each((function(e){b(e,l().View)&&e.destroy()})),a().isFunction(this._destroyProductsSocketSubscription)&&this._destroyProductsSocketSubscription(),u.default.prototype.destroy.apply(this,t)},initLinkedElements:function(e,t){var n=this,i=!1,s=!1,r=null,l=o().Deferred(),c=function(e){null===e?l.resolve():l.reject()};return this._linked_holders.each((function(t){t.getInfo("id")===e.id&&(s=!0,i=i||t.isActive(),r=t)})),i?(l.resolve(r),l.promise()):("widget"===e.type?APP.widgets.list[e.id]?this._initLinkedElement(e,c):n._$document.on("widget:".concat(e.id,":loaded").concat(this.ns),a().bind((function(){this._initLinkedElement(e,c),o()(this._selector("toggler_area")).children("div:not(".concat(this._class("dots"),")")).each((function(){C(o()(this).attr("id"),e.id)&&!o()(this).hasClass(n._class("active_class"))&&n._linked_holders.slice(-1)[0].$el.hide()}))}),this)):s?l.resolve():this._initLinkedElement(e,c),l.promise().then(a().bind(this._initLinkedElements,this,e,t)))},_initLinkedElements:function(e,t){var n=null;return!0!==t&&a().each(this._static_holders,(function(e){e.toggle(!1)})),this._linked_holders.each((function(i){var o=i.getInfo("id")===e.id;!0===t?i.toggle(i.isActive()):i.toggle(o),o&&(n=i)})),n},loadLinkedTypesSettings:function(){var e;return(e=p.storeWithExpiration.get(y.default.getCacheCode()))&&!a().isEmpty(e)?((0,_.logPerformanceMetric)({type:(0,_.getRealCardPageType)(),name:"linkedTypesListEndpointStats",value:null}),e=new Promise(a().bind((function(t){t(e)}),this))):e=this.loadData("/ajax/v1/linked_types/list/","",{}),e},postLinkedTypesSettings:function(e,t){var n={request:{linked_types:{}}},i=t?"update":"delete",o={};return n.request.linked_types[i]={},n.request.linked_types[i][this._element_type.id]=[],a().each(e,(function(e){t?(o={id:e.id,sort:!1===e.sort?9999:e.sort,name:e.name,custom_name:e.custom_name},n.request.linked_types[i][this._element_type.id].push(o)):n.request.linked_types[i][this._element_type.id].push(e.id)}),this),p.storeWithExpiration.remove(y.default.getCacheCode()),this.postData("/ajax/v1/linked_types/set/",n)},loadData:function(e,t,n){return new Promise(a().bind((function(i,s){var r=o().get(e,n||{},a().bind((function(n){if(n=(0,f.cleanResponse)(n),t&&!n[t])throw new Error("Invalid response data: ".concat(JSON.stringify(n)));(function(e){var t=e.type,n=e.name,i=e.url,o=e.request,s=(0,_.getBackendPerformanceMetric)({url:i,request:o});(0,_.logPerformanceMetric)({type:t,name:n,value:s})})({type:(0,_.getRealCardPageType)(),name:"linkedTypesListEndpointStats",request:r,url:"".concat(window.location.origin).concat(e)}),i(t?n[t]:n)}),this),"json");r.fail(s)}),this))},postData:function(e,t){return new Promise(a().bind((function(n,i){o().post(e,t,a().bind((function(e){n(e)}),this),"json").fail(i)}),this))},setTypeLinked:function(e,t){var n=!0;"unlink"===t&&(n=!1),this.postLinkedTypesSettings(e,n).then(a().bind((function(){a().each(e,(function(e){this.removeFromHolders(e),this.markTypeIsLinked(e,n)}),this)}),this))},loadTypes:function(){return this.loadLinkedTypesSettings().then(a().bind((function(e){p.storeWithExpiration.set(y.default.getCacheCode(),e,y.default.linked_types_cache_lifetime),this._onRender(this._loadTypes(e,this._params))}),this))},_loadTypes:function(e,t){if(!e)throw new Error("Invalid result: ".concat(JSON.stringify([e])));var n=e.linked_types,i=e.all_types;if(!n[t.element_type])throw new Error('Unknown element type "'.concat(t.element_type,'"'));if(this._linked_types=[],a().each(i,(function(e){var i=a().findWhere(n[t.element_type],{id:e.id}),o={id:e.id,type:e.type,catalog_type:e.catalog_type,name:a().escape(i&&i.custom_name?i.name:e.name),original_name:e.name,linked:!!a().findWhere(n[t.element_type],{id:e.id}),sort:!!i&&i.sort};"statistic"!==e.id&&-1===a().indexOf(a().keys(this._available_types),parseInt(e.id))&&this._linked_types.push(o),e.type===APP.getBaseEntity()&&(this._element_type=o)}),this),!this._element_type)throw new Error('Unknown element type "'.concat(t.element_type,'"'));return this.getLinkedTypesTabs()},getLinkedParams:function(e){var t=this;return{current:{type:this._element_type,id:this._element_id},id:e.id,type:e,raw_element:this._element,element_model:this._element_model,notes:this._getNotesCollection(),getLinkedForms:this._params.getLinkedForms||a().noop,getLinkedHolderById:function(e){return t.initLinkedElements({id:e,type:"catalog_elements",name:""},!0)}}},_getNotesCollection:function(){var e;return a().isFunction(this._params.getNotesCollection)&&(e=this._params.getNotesCollection()),e},_initLinkedElement:function(e,t){return k((function(){var i,o,s,a,r,l,c,d,u,_,f,p;return P(this,(function(m){switch(m.label){case 0:return i=this,"transactions"!==e.type?[3,1]:(o=Promise.all([n.e(45274),n.e(73919)]).then(n.bind(n,73919)),s=o.default,i._linked_holders.model=s,[3,9]);case 1:return"widget"!==e.type?[3,3]:[4,Promise.all([n.e(65164),n.e(18194),n.e(70013),n.e(76265),n.e(53081),n.e(8289),n.e(12897),n.e(39042),n.e(79954),n.e(20064),n.e(7390),n.e(10642),n.e(68924),n.e(52758),n.e(41136),n.e(39970),n.e(58551),n.e(65062),n.e(42693),n.e(8232),n.e(52434),n.e(67914),n.e(42315),n.e(9034),n.e(44897),n.e(60882),n.e(60200),n.e(75897),n.e(26775),n.e(2836),n.e(34364),n.e(26901),n.e(76987),n.e(42378),n.e(63865),n.e(44875),n.e(30807),n.e(15180),n.e(79310),n.e(59778),n.e(20501)]).then(n.bind(n,82762))];case 2:return a=m.sent(),r=a.default,i._linked_holders.model=r,[3,9];case 3:return"files"!==e.type?[3,5]:[4,Promise.all([n.e(65164),n.e(18194),n.e(70013),n.e(76265),n.e(53081),n.e(8289),n.e(12897),n.e(39042),n.e(79954),n.e(20064),n.e(7390),n.e(10642),n.e(68924),n.e(52758),n.e(41136),n.e(39970),n.e(58551),n.e(65062),n.e(42693),n.e(8232),n.e(52434),n.e(67914),n.e(42315),n.e(9034),n.e(44897),n.e(60882),n.e(60200),n.e(75897),n.e(26775),n.e(2836),n.e(34364),n.e(26901),n.e(76987),n.e(42378),n.e(63865),n.e(44875),n.e(30807),n.e(15180),n.e(79310),n.e(59778),n.e(79041)]).then(n.bind(n,867462))];case 4:return l=m.sent(),c=l.default,i._linked_holders.model=c,[3,9];case 5:return"other_leads"!==e.type?[3,7]:[4,Promise.all([n.e(45274),n.e(3833)]).then(n.bind(n,203833))];case 6:return d=m.sent(),u=d.default,i._linked_holders.model=u,[3,9];case 7:return[4,Promise.all([n.e(65164),n.e(18194),n.e(70013),n.e(76265),n.e(53081),n.e(8289),n.e(12897),n.e(39042),n.e(79954),n.e(20064),n.e(7390),n.e(10642),n.e(68924),n.e(52758),n.e(41136),n.e(39970),n.e(58551),n.e(65062),n.e(42693),n.e(8232),n.e(52434),n.e(67914),n.e(42315),n.e(9034),n.e(44897),n.e(60882),n.e(60200),n.e(75897),n.e(26775),n.e(2836),n.e(34364),n.e(26901),n.e(76987),n.e(42378),n.e(63865),n.e(44875),n.e(30807),n.e(15180),n.e(79310),n.e(59778),n.e(68472)]).then(n.bind(n,862556))];case 8:_=m.sent(),f=_.default,i._linked_holders.model=f,m.label=9;case 9:return p=i._linked_holders.add(i.getLinkedParams(e)),i._$elements_area.append(p.el),"transactions"===e.type&&(i._new_transaction=p._new_element),t(null),[2]}}))})).apply(this)},setMainId:function(e){var t=parseInt(e);if(t<=0)throw new Error("Element id must be positive integer, but given ".concat(e));this._element_id!==t&&(this._element_id=t,this._linked_holders.each((function(t){t.setMainId(e)})))},getAllLinkedTypes:function(){var e,t=this,n=this.getBaseTypes();return a().findWhere(this._linked_types,{linked:!0})||this._initBaseTypes(),a().chain(this._linked_types).map((function(i){return e=a().indexOf(t._available_types[t._element_type.id],String(i.id))>-1,(a().isUndefined(n[i.id])||e)&&e&&(i.linked=!0,i.sort=!1===i.sort?9999:i.sort,i.disabled=!0),a().extend({},i)})).filter((function(i){return e=a().indexOf(t._available_types[t._element_type.id],String(i.id))>-1,a().isUndefined(n[i.id])||e})).sortBy("sort").value()},getLinkedTypesTabs:function(){return a().filter(this.getAllLinkedTypes(),(function(e){return!!this._element.id&&e.linked}),this)},removeFromHolders:function(e){var t=null;this._linked_holders.each((function(n){t||n.getInfo("id")!==e.id||(t=n)})),t&&t.destroy(!0)},markTypeIsLinked:function(e,t){a().each(this._linked_types,(function(n,i){String(n.id)===String(e.id)&&(this._linked_types[i].linked=t,this._linked_types[i].sort=e.sort)}),this),this.applyTypeIsLinked(e.id,t)},promiseAll:function(e,t){a().isFunction(t)||(t=a().noop),e.length?Promise.all(e).then((function(){t()}),(function(){t("fail")})):t()},getBaseTypes:function(){return a().invert(APP.element_types)},_classes:function(){return a().extend({},a().result(u.default.prototype,"_classes"),{dots:"js-dots",dots_wrapper:"js-button_dots_wrapper",linked_type:"js-linked_type",in_context:"js-in_context",linked_elements_wrapper:"js-linked_elements_wrapper",current_catalog_name:"js-current_catalog_name",context_menu:"js-context_menu",add_linked_type:"js-add_linked_type",unlink_linked_type:"js-unlink_linked_type",toggler_items:"js-linked_toggle_item",leads_holder:"js-linked_leads",toggler_area:"js-linked-types-toggler",active_class:"card-fields__linked-toggler-item_active"})},applyTypeIsLinked:function(e,t){this._elem("linked_type").filter(this._selector("in_context")).each((function(){var n=o()(this);C(n.attr("id"),e)&&n.toggleClass("hidden",!t)}))},undelegateEvents:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return this.undelegatePublisherEvents(),u.default.prototype.undelegateEvents.apply(this,t)},delegateEvents:function(e){var t=u.default.prototype.delegateEvents.apply(this,arguments);return e||this.delegatePublisherEvents(),t},events:function(){var e=a().extend({},a().result(u.default.prototype,"events"));return e["click ".concat(this._selector("unlink_linked_type"))]="clickUnlinkLinkedType",e},publisher_events:function(){var e=a().extend({},a().result(u.default.prototype,"publisher_events"));return e["linked:save:before"]="onBeforeElementSave",e["linked:save:after"]="onAfterElementSave",e},onHolderChange:function(){var e=!1,t=this._linked_holders.length>0;this._linked_holders.each((function(n){e=e||n.has_changes,t=t&&(!n.has_changes||n.can_save)})),this.has_changes=e,this.can_save=e&&t,this.trigger("state_changed",this)},onBeforeElementSave:function(e,t){var n=[];if(this._new_transaction&&!this._new_transaction.validate())return this.trigger("save:failed"),void this.promiseAll(n,t("fail"));this._linked_holders.each((function(e){var t=e.getBeforeElementSavePromise();null!==t&&n.push(t)}),this),this.promiseAll(n,t)},onAfterElementSave:function(e,t){var n=[];this._linked_holders.each((function(e){var t=e.getAfterElementSavePromise();null!==t&&n.push(t)})),this.promiseAll(n,t)}});d().mixin(S,m.default);const A=S;var j="../build/transpiled/interface/card/linked/types";window.define(j,(function(){var e="undefined",n=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return n&&n.default||n})),window.require([j])}}]);var _global="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};_global.SENTRY_RELEASE={id:"build_2025_11_28_18_50_52"},function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=(new Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="87c42e56-b688-477e-8921-e9d91f9609ec",e._sentryDebugIdIdentifier="sentry-dbid-87c42e56-b688-477e-8921-e9d91f9609ec")}catch(e){}}();
//# sourceMappingURL=5641.4e095a4ab83198a9093c.js.map