define(["jquery", "lib/components/base/modal"], function ($, Modal) {
  return function FieldSelect(
    self,
    fields,
    user_selected_items = { groups: [], items: [] },
    maxItems,
    maxItemsMessage,
    parentElem,
  ) {
    if (typeof APP == "undefined" || typeof APP.constant != "function") {
      let empty = $("</div>");

      empty.styles = {};
      empty.work_area = $("</div>");
      empty.selected = { groups: [], items: [] };
      empty.items = {};
      empty.is_focused = false;

      return empty;
    }

    let uniqueID = Math.ceil(Math.random() * 10000);
    let select = $(
      '<div id="emfy_field_select-' +
        uniqueID +
        '" class="emfy_field_select-' +
        uniqueID +
        '"><select multiple="multiple"></select></div>',
    );
    let all_items = fields;
    let items = {};
    let groups = {};
    let group_selected_marker =
      btoa(uniqueID + new Date().getTime())
        .replace(/=/g, "")
        .toLowerCase()
        .replace(/[^a-z]/g, "") + "-group-selected__emfy";
    let special_rules_selectors = {};
    let global_rules = {
      ".select2-container--default .select2-selection--multiple": {
        border: "1px solid var(--palette-border-default)",
        "border-radius": "4px",
      },
      ".select2-container--open .select2-dropdown": {
        border: "1px solid var(--palette-border-default)",
        "border-radius": "5px",
        "background-color": "var(--palette-background-primary)",
        overflow: "hidden",
        width: "100%",
        "min-width": "max-content",
      },
      ".select2-results ul li.select2-results__option .select2-results__group":
        {
          padding: "6px 1em",
          "font-weight": "bold",
          background: "var(--palette-salesbot-link)",
          cursor: "pointer",
          "letter-spacing": "1px",
          "text-transform": "uppercase",
          "font-size": "14px",
          color: "var(--color-onyx)",
        },
      ".select2-results ul li.select2-results__option .select2-results__group:hover":
        {
          background: "var(--palette-background-default)",
        },
      ".select2-results ul li.select2-results__option ul li.select2-results__option":
        {
          "font-size": "15px",
        },
      ".select2-results ul li.select2-results__option ul li.select2-results__option.select2-results__option--highlighted[aria-selected]":
        {
          color: "var(--palette-text-primary)",
          background: "var(--palette-background-primary)",
        },
      '.select2-results ul li.select2-results__option ul li.select2-results__option[aria-selected="true"]':
        {
          display: "none",
        },
      ".select2-results ul li.select2-results__option ul li.select2-results__option.select2-results__option--highlighted[aria-selected]:hover":
        {
          background: "var(--palette-background-default)",
        },
      ".select2-results ul li.select2-results__option .select2-results__group:after":
        {
          content: `'${self.i18n("FieldSelect.whole_group")}'`,
          "font-weight": "normal",
          padding: "1px 5px",
          "border-radius": "3px",
          "font-size": "10px",
          "text-transform": "uppercase",
          border: "1px solid var(--palette-border-default)",
          float: "right",
          position: "relative",
          "letter-spacing": "1px",
          top: "1px",
        },
      ".select2-results ul li.select2-results__option .select2-results__group:hover:after":
        {
          background: "var(--palette-background-default)",
          color: "var(--palette-text-primary)",
          border: "1px solid var(--palette-border-default)",
        },
    };
    let check_state = false;
    let time_update = 25;
    let anyway_logic_init = true;

    if ($("style#emfy_fs_uniq").length == 0) {
      let s2s =
          "Ci5zZWxlY3QyLWNvbnRhaW5lciAuc2VsZWN0Mi1zZWxlY3Rpb24tLXNpbmdsZSB7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZGlzcGxheTogYmxvY2s7CiAgICBoZWlnaHQ6IDI4cHg7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmUKfQoKLnNlbGVjdDItY29udGFpbmVyIC5zZWxlY3QyLXNlbGVjdGlvbi0tc2luZ2xlIC5zZWxlY3QyLXNlbGVjdGlvbl9fcmVuZGVyZWQgewogICAgZGlzcGxheTogYmxvY2s7CiAgICBwYWRkaW5nLWxlZnQ6IDhweDsKICAgIHBhZGRpbmctcmlnaHQ6IDIwcHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwCn0KCi5zZWxlY3QyLWNvbnRhaW5lciAuc2VsZWN0Mi1zZWxlY3Rpb24tLXNpbmdsZSAuc2VsZWN0Mi1zZWxlY3Rpb25fX2NsZWFyIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZQp9Cgouc2VsZWN0Mi1jb250YWluZXJbZGlyPSJydGwiXSAuc2VsZWN0Mi1zZWxlY3Rpb24tLXNpbmdsZSAuc2VsZWN0Mi1zZWxlY3Rpb25fX3JlbmRlcmVkIHsKICAgIHBhZGRpbmctcmlnaHQ6IDhweDsKICAgIHBhZGRpbmctbGVmdDogMjBweAp9Cgouc2VsZWN0Mi1jb250YWluZXIgLnNlbGVjdDItc2VsZWN0aW9uLS1tdWx0aXBsZSB7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZGlzcGxheTogYmxvY2s7CiAgICBtaW4taGVpZ2h0OiAzMnB4OwogICAgdXNlci1zZWxlY3Q6IG5vbmU7CiAgICAtd2Via2l0LXVzZXItc2VsZWN0OiBub25lCn0KCi5zZWxlY3QyLWNvbnRhaW5lciAuc2VsZWN0Mi1zZWxlY3Rpb24tLW11bHRpcGxlIC5zZWxlY3QyLXNlbGVjdGlvbl9fcmVuZGVyZWQgewogICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIHBhZGRpbmctbGVmdDogOHB4OwogICAgdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwCn0KCi5zZWxlY3QyLWNvbnRhaW5lciAuc2VsZWN0Mi1zZWFyY2gtLWlubGluZSB7CiAgICBmbG9hdDogbGVmdAp9Cgouc2VsZWN0Mi1jb250YWluZXIgLnNlbGVjdDItc2VhcmNoLS1pbmxpbmUgLnNlbGVjdDItc2VhcmNoX19maWVsZCB7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgYm9yZGVyOiBub25lOwogICAgZm9udC1zaXplOiAxMDAlOwogICAgbWFyZ2luLXRvcDogNXB4OwogICAgcGFkZGluZzogMAp9Cgouc2VsZWN0Mi1jb250YWluZXIgLnNlbGVjdDItc2VhcmNoLS1pbmxpbmUgLnNlbGVjdDItc2VhcmNoX19maWVsZDo6LXdlYmtpdC1zZWFyY2gtY2FuY2VsLWJ1dHRvbiB7CiAgICAtd2Via2l0LWFwcGVhcmFuY2U6IG5vbmUKfQoKLnNlbGVjdDItZHJvcGRvd24gewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tcGFsZXR0ZS1iYWNrZ3JvdW5kLXByaW1hcnkpOwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tcGFsZXR0ZS1ib3JkZXItZGVmYXVsdCk7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgZGlzcGxheTogYmxvY2s7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBsZWZ0OiAtMTAwMDAwcHg7CiAgICB3aWR0aDogMTAwJTsKICAgIHotaW5kZXg6IDEwNTEKfQoKLnNlbGVjdDItcmVzdWx0cyB7CiAgICBkaXNwbGF5OiBibG9jawp9Cgouc2VsZWN0Mi1yZXN1bHRzX19vcHRpb25zIHsKICAgIGxpc3Qtc3R5bGU6IG5vbmU7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwCn0KCi5zZWxlY3QyLXJlc3VsdHNfX29wdGlvbiB7CiAgICBwYWRkaW5nOiA2cHg7CiAgICB1c2VyLXNlbGVjdDogbm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6IG5vbmUKfQoKLnNlbGVjdDItcmVzdWx0c19fb3B0aW9uW2FyaWEtc2VsZWN0ZWRdIHsKICAgIGN1cnNvcjogcG9pbnRlcgp9Cgouc2VsZWN0Mi1jb250YWluZXItLW9wZW4gLnNlbGVjdDItZHJvcGRvd24gewogICAgbGVmdDogMAp9Cgouc2VsZWN0Mi1jb250YWluZXItLW9wZW4gLnNlbGVjdDItZHJvcGRvd24tLWFib3ZlIHsKICAgIGJvcmRlci1ib3R0b206IG5vbmU7CiAgICBib3JkZXItYm90dG9tLWxlZnQtcmFkaXVzOiAwOwogICAgYm9yZGVyLWJvdHRvbS1yaWdodC1yYWRpdXM6IDAKfQoKLnNlbGVjdDItY29udGFpbmVyLS1vcGVuIC5zZWxlY3QyLWRyb3Bkb3duLS1iZWxvdyB7CiAgICBib3JkZXItdG9wOiBub25lOwogICAgYm9yZGVyLXRvcC1sZWZ0LXJhZGl1czogMDsKICAgIGJvcmRlci10b3AtcmlnaHQtcmFkaXVzOiAwCn0KCi5zZWxlY3QyLXNlYXJjaC0tZHJvcGRvd24gewogICAgZGlzcGxheTogYmxvY2s7CiAgICBwYWRkaW5nOiA0cHgKfQoKLnNlbGVjdDItc2VhcmNoLS1kcm9wZG93biAuc2VsZWN0Mi1zZWFyY2hfX2ZpZWxkIHsKICAgIHBhZGRpbmc6IDRweDsKICAgIHdpZHRoOiAxMDAlOwogICAgYm94LXNpemluZzogYm9yZGVyLWJveAp9Cgouc2VsZWN0Mi1zZWFyY2gtLWRyb3Bkb3duIC5zZWxlY3QyLXNlYXJjaF9fZmllbGQ6Oi13ZWJraXQtc2VhcmNoLWNhbmNlbC1idXR0b24gewogICAgLXdlYmtpdC1hcHBlYXJhbmNlOiBub25lCn0KCi5zZWxlY3QyLXNlYXJjaC0tZHJvcGRvd24uc2VsZWN0Mi1zZWFyY2gtLWhpZGUgewogICAgZGlzcGxheTogbm9uZQp9Cgouc2VsZWN0Mi1jbG9zZS1tYXNrIHsKICAgIGJvcmRlcjogMDsKICAgIG1hcmdpbjogMDsKICAgIHBhZGRpbmc6IDA7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgIGxlZnQ6IDA7CiAgICB0b3A6IDA7CiAgICBtaW4taGVpZ2h0OiAxMDAlOwogICAgbWluLXdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiBhdXRvOwogICAgd2lkdGg6IGF1dG87CiAgICBvcGFjaXR5OiAwOwogICAgei1pbmRleDogOTk7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtZGVmYXVsdCk7CiAgICBmaWx0ZXI6IGFscGhhKG9wYWNpdHk9MCkKfQoKLnNlbGVjdDItaGlkZGVuLWFjY2Vzc2libGUgewogICAgYm9yZGVyOiAwICFpbXBvcnRhbnQ7CiAgICBjbGlwOiByZWN0KDAgMCAwIDApICFpbXBvcnRhbnQ7CiAgICBoZWlnaHQ6IDFweCAhaW1wb3J0YW50OwogICAgbWFyZ2luOiAtMXB4ICFpbXBvcnRhbnQ7CiAgICBvdmVyZmxvdzogaGlkZGVuICFpbXBvcnRhbnQ7CiAgICBwYWRkaW5nOiAwICFpbXBvcnRhbnQ7CiAgICBwb3NpdGlvbjogYWJzb2x1dGUgIWltcG9ydGFudDsKICAgIHdpZHRoOiAxcHggIWltcG9ydGFudAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHQgLnNlbGVjdDItc2VsZWN0aW9uLS1zaW5nbGUgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tcGFsZXR0ZS1iYWNrZ3JvdW5kLXByaW1hcnkpOwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tcGFsZXR0ZS1ib3JkZXItZGVmYXVsdCkgIWltcG9ydGFudDsKICAgIGJvcmRlci1yYWRpdXM6IDNweDsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZSAhaW1wb3J0YW50Cn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tZGVmYXVsdCAuc2VsZWN0Mi1zZWxlY3Rpb24tLXNpbmdsZSAuc2VsZWN0Mi1zZWxlY3Rpb25fX3JlbmRlcmVkIHsKICAgIGNvbG9yOiB2YXIoLS1wYWxldHRlLXRleHQtcHJpbWFyeSk7CiAgICBsaW5lLWhlaWdodDogMjhweAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHQgLnNlbGVjdDItc2VsZWN0aW9uLS1zaW5nbGUgLnNlbGVjdDItc2VsZWN0aW9uX19jbGVhciB7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBmbG9hdDogcmlnaHQ7CiAgICBmb250LXdlaWdodDogNzAwCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tZGVmYXVsdCAuc2VsZWN0Mi1zZWxlY3Rpb24tLXNpbmdsZSAuc2VsZWN0Mi1zZWxlY3Rpb25fX3BsYWNlaG9sZGVyIHsKICAgIGNvbG9yOiB2YXIoLS1wYWxldHRlLXRleHQtc2Vjb25kYXJ5LWRhcmspCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tZGVmYXVsdCAuc2VsZWN0Mi1zZWxlY3Rpb24tLXNpbmdsZSAuc2VsZWN0Mi1zZWxlY3Rpb25fX2Fycm93IHsKICAgIGNvbnRlbnQ6ICIiOwogICAgcG9zaXRpb246IGFic29sdXRlICFpbXBvcnRhbnQ7CiAgICB0b3A6IGNhbGMoNTAlIC0gNXB4KSAhaW1wb3J0YW50OwogICAgd2lkdGg6IDZweCAhaW1wb3J0YW50OwogICAgaGVpZ2h0OiA2cHggIWltcG9ydGFudDsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCB2YXIoLS1wYWxldHRlLWJvcmRlci1kZWZhdWx0KSAhaW1wb3J0YW50OwogICAgYm9yZGVyLXJpZ2h0OiAxcHggc29saWQgdmFyKC0tcGFsZXR0ZS1ib3JkZXItZGVmYXVsdCkgIWltcG9ydGFudDsKICAgIC13ZWJraXQtdHJhbnNmb3JtOiByb3RhdGUoNDVkZWcpICFpbXBvcnRhbnQ7CiAgICB0cmFuc2Zvcm06IHJvdGF0ZSg0NWRlZykgIWltcG9ydGFudDsKICAgIG1hcmdpbi1sZWZ0OiA3cHggIWltcG9ydGFudDsKICAgIHJpZ2h0OiAxMnB4ICFpbXBvcnRhbnQ7CiAgICB6LWluZGV4OiAxMCAhaW1wb3J0YW50Cn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tZGVmYXVsdFtkaXI9InJ0bCJdIC5zZWxlY3QyLXNlbGVjdGlvbi0tc2luZ2xlIC5zZWxlY3QyLXNlbGVjdGlvbl9fY2xlYXIgewogICAgZmxvYXQ6IGxlZnQKfQoKLnNlbGVjdDItY29udGFpbmVyLS1kZWZhdWx0W2Rpcj0icnRsIl0gLnNlbGVjdDItc2VsZWN0aW9uLS1zaW5nbGUgLnNlbGVjdDItc2VsZWN0aW9uX19hcnJvdyB7CiAgICBsZWZ0OiAxcHg7CiAgICByaWdodDogYXV0bwp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHQuc2VsZWN0Mi1jb250YWluZXItLWRpc2FibGVkIC5zZWxlY3QyLXNlbGVjdGlvbi0tc2luZ2xlIHsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXBhbGV0dGUtYmFja2dyb3VuZC1kZWZhdWx0KTsKICAgIGN1cnNvcjogZGVmYXVsdAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHQuc2VsZWN0Mi1jb250YWluZXItLWRpc2FibGVkIC5zZWxlY3QyLXNlbGVjdGlvbi0tc2luZ2xlIC5zZWxlY3QyLXNlbGVjdGlvbl9fY2xlYXIgewogICAgZGlzcGxheTogbm9uZQp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHQuc2VsZWN0Mi1jb250YWluZXItLW9wZW4gLnNlbGVjdDItc2VsZWN0aW9uLS1zaW5nbGUgLnNlbGVjdDItc2VsZWN0aW9uX19hcnJvdyBiIHsKICAgIGJvcmRlci1jb2xvcjogdHJhbnNwYXJlbnQgdHJhbnNwYXJlbnQgdmFyKC0tcGFsZXR0ZS1ib3JkZXItZGVmYXVsdCk7CiAgICBib3JkZXItd2lkdGg6IDAgNHB4IDVweAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHQgLnNlbGVjdDItc2VsZWN0aW9uLS1tdWx0aXBsZSB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtcHJpbWFyeSk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1wYWxldHRlLWJvcmRlci1kZWZhdWx0KTsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGN1cnNvcjogdGV4dAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHQgLnNlbGVjdDItc2VsZWN0aW9uLS1tdWx0aXBsZSAuc2VsZWN0Mi1zZWxlY3Rpb25fX3JlbmRlcmVkIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBsaXN0LXN0eWxlOiBub25lOwogICAgbWFyZ2luOiAwOwogICAgcGFkZGluZzogMCA1cHg7CiAgICB3aWR0aDogMTAwJQp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHQgLnNlbGVjdDItc2VsZWN0aW9uLS1tdWx0aXBsZSAuc2VsZWN0Mi1zZWxlY3Rpb25fX3JlbmRlcmVkIGxpIHsKICAgIGxpc3Qtc3R5bGU6IG5vbmUKfQoKLnNlbGVjdDItY29udGFpbmVyLS1kZWZhdWx0IC5zZWxlY3QyLXNlbGVjdGlvbi0tbXVsdGlwbGUgLnNlbGVjdDItc2VsZWN0aW9uX19wbGFjZWhvbGRlciB7CiAgICBjb2xvcjogdmFyKC0tcGFsZXR0ZS10ZXh0LXNlY29uZGFyeS1kYXJrKTsKICAgIG1hcmdpbi10b3A6IDVweDsKICAgIGZsb2F0OiBsZWZ0Cn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tZGVmYXVsdCAuc2VsZWN0Mi1zZWxlY3Rpb24tLW11bHRpcGxlIC5zZWxlY3QyLXNlbGVjdGlvbl9fY2xlYXIgewogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZmxvYXQ6IHJpZ2h0OwogICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgIG1hcmdpbi10b3A6IDVweDsKICAgIG1hcmdpbi1yaWdodDogMTBweAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHQgLnNlbGVjdDItc2VsZWN0aW9uLS1tdWx0aXBsZSAuc2VsZWN0Mi1zZWxlY3Rpb25fX2Nob2ljZSB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtZGVmYXVsdCk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1wYWxldHRlLWJvcmRlci1kZWZhdWx0KTsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGN1cnNvcjogZGVmYXVsdDsKICAgIGZsb2F0OiBsZWZ0OwogICAgbWFyZ2luLXJpZ2h0OiA1cHg7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICBwYWRkaW5nOiAwIDVweAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHQgLnNlbGVjdDItc2VsZWN0aW9uLS1tdWx0aXBsZSAuc2VsZWN0Mi1zZWxlY3Rpb25fX2Nob2ljZV9fcmVtb3ZlIHsKICAgIGNvbG9yOiB2YXIoLS1wYWxldHRlLXRleHQtc2Vjb25kYXJ5LWRhcmspOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgIG1hcmdpbi1yaWdodDogMnB4Cn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tZGVmYXVsdCAuc2VsZWN0Mi1zZWxlY3Rpb24tLW11bHRpcGxlIC5zZWxlY3QyLXNlbGVjdGlvbl9fY2hvaWNlX19yZW1vdmU6aG92ZXIgewogICAgY29sb3I6IHZhcigtLXBhbGV0dGUtdGV4dC1zZWNvbmRhcnktZGlzYWJsZWQtZGFyaykKfQoKLnNlbGVjdDItY29udGFpbmVyLS1kZWZhdWx0W2Rpcj0icnRsIl0gLnNlbGVjdDItc2VsZWN0aW9uLS1tdWx0aXBsZSAuc2VsZWN0Mi1zZWxlY3Rpb25fX2Nob2ljZSwKLnNlbGVjdDItY29udGFpbmVyLS1kZWZhdWx0W2Rpcj0icnRsIl0gLnNlbGVjdDItc2VsZWN0aW9uLS1tdWx0aXBsZSAuc2VsZWN0Mi1zZWxlY3Rpb25fX3BsYWNlaG9sZGVyLAouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHRbZGlyPSJydGwiXSAuc2VsZWN0Mi1zZWxlY3Rpb24tLW11bHRpcGxlIC5zZWxlY3QyLXNlYXJjaC0taW5saW5lIHsKICAgIGZsb2F0OiByaWdodAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHRbZGlyPSJydGwiXSAuc2VsZWN0Mi1zZWxlY3Rpb24tLW11bHRpcGxlIC5zZWxlY3QyLXNlbGVjdGlvbl9fY2hvaWNlIHsKICAgIG1hcmdpbi1sZWZ0OiA1cHg7CiAgICBtYXJnaW4tcmlnaHQ6IGF1dG8KfQoKLnNlbGVjdDItY29udGFpbmVyLS1kZWZhdWx0W2Rpcj0icnRsIl0gLnNlbGVjdDItc2VsZWN0aW9uLS1tdWx0aXBsZSAuc2VsZWN0Mi1zZWxlY3Rpb25fX2Nob2ljZV9fcmVtb3ZlIHsKICAgIG1hcmdpbi1sZWZ0OiAycHg7CiAgICBtYXJnaW4tcmlnaHQ6IGF1dG8KfQoKLnNlbGVjdDItY29udGFpbmVyLS1kZWZhdWx0LnNlbGVjdDItY29udGFpbmVyLS1mb2N1cyAuc2VsZWN0Mi1zZWxlY3Rpb24tLW11bHRpcGxlIHsKICAgIGJvcmRlcjogc29saWQgdmFyKC0tcGFsZXR0ZS1ib3JkZXItZGVmYXVsdCkgMXB4OwogICAgb3V0bGluZTogMAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHQuc2VsZWN0Mi1jb250YWluZXItLWRpc2FibGVkIC5zZWxlY3QyLXNlbGVjdGlvbi0tbXVsdGlwbGUgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tcGFsZXR0ZS1iYWNrZ3JvdW5kLWRlZmF1bHQpOwogICAgY3Vyc29yOiBkZWZhdWx0Cn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tZGVmYXVsdC5zZWxlY3QyLWNvbnRhaW5lci0tZGlzYWJsZWQgLnNlbGVjdDItc2VsZWN0aW9uX19jaG9pY2VfX3JlbW92ZSB7CiAgICBkaXNwbGF5OiBub25lCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tZGVmYXVsdC5zZWxlY3QyLWNvbnRhaW5lci0tb3Blbi5zZWxlY3QyLWNvbnRhaW5lci0tYWJvdmUgLnNlbGVjdDItc2VsZWN0aW9uLS1zaW5nbGUsCi5zZWxlY3QyLWNvbnRhaW5lci0tZGVmYXVsdC5zZWxlY3QyLWNvbnRhaW5lci0tb3Blbi5zZWxlY3QyLWNvbnRhaW5lci0tYWJvdmUgLnNlbGVjdDItc2VsZWN0aW9uLS1tdWx0aXBsZSB7CiAgICBib3JkZXItdG9wLWxlZnQtcmFkaXVzOiAwOwogICAgYm9yZGVyLXRvcC1yaWdodC1yYWRpdXM6IDAKfQoKLnNlbGVjdDItY29udGFpbmVyLS1kZWZhdWx0LnNlbGVjdDItY29udGFpbmVyLS1vcGVuLnNlbGVjdDItY29udGFpbmVyLS1iZWxvdyAuc2VsZWN0Mi1zZWxlY3Rpb24tLXNpbmdsZSwKLnNlbGVjdDItY29udGFpbmVyLS1kZWZhdWx0LnNlbGVjdDItY29udGFpbmVyLS1vcGVuLnNlbGVjdDItY29udGFpbmVyLS1iZWxvdyAuc2VsZWN0Mi1zZWxlY3Rpb24tLW11bHRpcGxlIHsKICAgIGJvcmRlci1ib3R0b20tbGVmdC1yYWRpdXM6IDA7CiAgICBib3JkZXItYm90dG9tLXJpZ2h0LXJhZGl1czogMAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHQgLnNlbGVjdDItc2VhcmNoLS1kcm9wZG93biAuc2VsZWN0Mi1zZWFyY2hfX2ZpZWxkIHsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLXBhbGV0dGUtYm9yZGVyLWRlZmF1bHQpCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tZGVmYXVsdCAuc2VsZWN0Mi1zZWFyY2gtLWlubGluZSAuc2VsZWN0Mi1zZWFyY2hfX2ZpZWxkIHsKICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50OwogICAgYm9yZGVyOiBub25lOwogICAgb3V0bGluZTogMDsKICAgIGJveC1zaGFkb3c6IG5vbmU7CiAgICAtd2Via2l0LWFwcGVhcmFuY2U6IHRleHRmaWVsZAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHQgLnNlbGVjdDItcmVzdWx0cz4uc2VsZWN0Mi1yZXN1bHRzX19vcHRpb25zIHsKICAgIG1heC1oZWlnaHQ6IDIwMHB4OwogICAgb3ZlcmZsb3cteTogYXV0bwp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHQgLnNlbGVjdDItcmVzdWx0c19fb3B0aW9uW3JvbGU9Z3JvdXBdIHsKICAgIHBhZGRpbmc6IDAKfQoKLnNlbGVjdDItY29udGFpbmVyLS1kZWZhdWx0IC5zZWxlY3QyLXJlc3VsdHNfX29wdGlvblthcmlhLWRpc2FibGVkPXRydWVdIHsKICAgIGNvbG9yOiB2YXIoLS1wYWxldHRlLXRleHQtc2Vjb25kYXJ5LWRhcmspCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tZGVmYXVsdCAuc2VsZWN0Mi1yZXN1bHRzX19vcHRpb25bYXJpYS1zZWxlY3RlZD10cnVlXSB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtcHJpbWFyeSkKfQoKLnNlbGVjdDItY29udGFpbmVyLS1kZWZhdWx0IC5zZWxlY3QyLXJlc3VsdHNfX29wdGlvbiAuc2VsZWN0Mi1yZXN1bHRzX19vcHRpb24gewogICAgcGFkZGluZy1sZWZ0OiAxZW0KfQoKLnNlbGVjdDItY29udGFpbmVyLS1kZWZhdWx0IC5zZWxlY3QyLXJlc3VsdHNfX29wdGlvbiAuc2VsZWN0Mi1yZXN1bHRzX19vcHRpb24gLnNlbGVjdDItcmVzdWx0c19fZ3JvdXAgewogICAgcGFkZGluZy1sZWZ0OiAwCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tZGVmYXVsdCAuc2VsZWN0Mi1yZXN1bHRzX19vcHRpb24gLnNlbGVjdDItcmVzdWx0c19fb3B0aW9uIC5zZWxlY3QyLXJlc3VsdHNfX29wdGlvbiB7CiAgICBtYXJnaW4tbGVmdDogLTFlbTsKICAgIHBhZGRpbmctbGVmdDogMmVtCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tZGVmYXVsdCAuc2VsZWN0Mi1yZXN1bHRzX19vcHRpb24gLnNlbGVjdDItcmVzdWx0c19fb3B0aW9uIC5zZWxlY3QyLXJlc3VsdHNfX29wdGlvbiAuc2VsZWN0Mi1yZXN1bHRzX19vcHRpb24gewogICAgbWFyZ2luLWxlZnQ6IC0yZW07CiAgICBwYWRkaW5nLWxlZnQ6IDNlbQp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHQgLnNlbGVjdDItcmVzdWx0c19fb3B0aW9uIC5zZWxlY3QyLXJlc3VsdHNfX29wdGlvbiAuc2VsZWN0Mi1yZXN1bHRzX19vcHRpb24gLnNlbGVjdDItcmVzdWx0c19fb3B0aW9uIC5zZWxlY3QyLXJlc3VsdHNfX29wdGlvbiB7CiAgICBtYXJnaW4tbGVmdDogLTNlbTsKICAgIHBhZGRpbmctbGVmdDogNGVtCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tZGVmYXVsdCAuc2VsZWN0Mi1yZXN1bHRzX19vcHRpb24gLnNlbGVjdDItcmVzdWx0c19fb3B0aW9uIC5zZWxlY3QyLXJlc3VsdHNfX29wdGlvbiAuc2VsZWN0Mi1yZXN1bHRzX19vcHRpb24gLnNlbGVjdDItcmVzdWx0c19fb3B0aW9uIC5zZWxlY3QyLXJlc3VsdHNfX29wdGlvbiB7CiAgICBtYXJnaW4tbGVmdDogLTRlbTsKICAgIHBhZGRpbmctbGVmdDogNWVtCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tZGVmYXVsdCAuc2VsZWN0Mi1yZXN1bHRzX19vcHRpb24gLnNlbGVjdDItcmVzdWx0c19fb3B0aW9uIC5zZWxlY3QyLXJlc3VsdHNfX29wdGlvbiAuc2VsZWN0Mi1yZXN1bHRzX19vcHRpb24gLnNlbGVjdDItcmVzdWx0c19fb3B0aW9uIC5zZWxlY3QyLXJlc3VsdHNfX29wdGlvbiAuc2VsZWN0Mi1yZXN1bHRzX19vcHRpb24gewogICAgbWFyZ2luLWxlZnQ6IC01ZW07CiAgICBwYWRkaW5nLWxlZnQ6IDZlbQp9Cgouc2VsZWN0Mi1jb250YWluZXItLWRlZmF1bHQgLnNlbGVjdDItcmVzdWx0c19fb3B0aW9uLS1oaWdobGlnaHRlZFthcmlhLXNlbGVjdGVkXSB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtZGVmYXVsdCk7CiAgICBjb2xvcjogdmFyKC0tcGFsZXR0ZS10ZXh0LXByaW1hcnkpCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tZGVmYXVsdCAuc2VsZWN0Mi1yZXN1bHRzX19ncm91cCB7CiAgICBjdXJzb3I6IGRlZmF1bHQ7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIHBhZGRpbmc6IDZweAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWNsYXNzaWMgLnNlbGVjdDItc2VsZWN0aW9uLS1zaW5nbGUgewogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tcGFsZXR0ZS1iYWNrZ3JvdW5kLWRlZmF1bHQpOwogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tcGFsZXR0ZS1ib3JkZXItZGVmYXVsdCk7CiAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICBvdXRsaW5lOiAwOwogICAgYmFja2dyb3VuZC1pbWFnZTogLXdlYmtpdC1saW5lYXItZ3JhZGllbnQodG9wLCB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtZGVmYXVsdCkgNTAlLCB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtcHJpbWFyeSkgMTAwJSk7CiAgICBiYWNrZ3JvdW5kLWltYWdlOiAtby1saW5lYXItZ3JhZGllbnQodG9wLCB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtZGVmYXVsdCkgNTAlLCB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtcHJpbWFyeSkgMTAwJSk7CiAgICBiYWNrZ3JvdW5kLWltYWdlOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtZGVmYXVsdCkgNTAlLCB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtcHJpbWFyeSkgMTAwJSk7CiAgICBiYWNrZ3JvdW5kLXJlcGVhdDogcmVwZWF0LXg7CiAgICBmaWx0ZXI6IHByb2dpZDpEWEltYWdlVHJhbnNmb3JtLk1pY3Jvc29mdC5ncmFkaWVudChzdGFydENvbG9yc3RyPScjRkZGRkZGRkYnLCBlbmRDb2xvcnN0cj0nI0ZGRUVFRUVFJywgR3JhZGllbnRUeXBlPTApCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tY2xhc3NpYyAuc2VsZWN0Mi1zZWxlY3Rpb24tLXNpbmdsZTpmb2N1cyB7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1idXR0b25fYmx1ZV9ib3JkZXIpCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tY2xhc3NpYyAuc2VsZWN0Mi1zZWxlY3Rpb24tLXNpbmdsZSAuc2VsZWN0Mi1zZWxlY3Rpb25fX3JlbmRlcmVkIHsKICAgIGNvbG9yOiB2YXIoLS1wYWxldHRlLXRleHQtc2Vjb25kYXJ5LWRhcmspOwogICAgbGluZS1oZWlnaHQ6IDI4cHgKfQoKLnNlbGVjdDItY29udGFpbmVyLS1jbGFzc2ljIC5zZWxlY3QyLXNlbGVjdGlvbi0tc2luZ2xlIC5zZWxlY3QyLXNlbGVjdGlvbl9fY2xlYXIgewogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZmxvYXQ6IHJpZ2h0OwogICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgIG1hcmdpbi1yaWdodDogMTBweAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWNsYXNzaWMgLnNlbGVjdDItc2VsZWN0aW9uLS1zaW5nbGUgLnNlbGVjdDItc2VsZWN0aW9uX19wbGFjZWhvbGRlciB7CiAgICBjb2xvcjogdmFyKC0tcGFsZXR0ZS10ZXh0LXNlY29uZGFyeS1kYXJrKQp9Cgouc2VsZWN0Mi1jb250YWluZXItLWNsYXNzaWMgLnNlbGVjdDItc2VsZWN0aW9uLS1zaW5nbGUgLnNlbGVjdDItc2VsZWN0aW9uX19hcnJvdyB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtZGVmYXVsdCk7CiAgICBib3JkZXI6IG5vbmU7CiAgICBib3JkZXItbGVmdDogMXB4IHNvbGlkIHZhcigtLXBhbGV0dGUtYm9yZGVyLWRlZmF1bHQpOwogICAgYm9yZGVyLXRvcC1yaWdodC1yYWRpdXM6IDRweDsKICAgIGJvcmRlci1ib3R0b20tcmlnaHQtcmFkaXVzOiA0cHg7CiAgICBoZWlnaHQ6IDI2cHg7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDFweDsKICAgIHJpZ2h0OiAxcHg7CiAgICB3aWR0aDogMjBweDsKICAgIGJhY2tncm91bmQtaW1hZ2U6IC13ZWJraXQtbGluZWFyLWdyYWRpZW50KHRvcCwgdmFyKC0tcGFsZXR0ZS1iYWNrZ3JvdW5kLWRlZmF1bHQpIDUwJSwgdmFyKC0tcGFsZXR0ZS1iYWNrZ3JvdW5kLXByaW1hcnkpIDEwMCUpOwogICAgYmFja2dyb3VuZC1pbWFnZTogLW8tbGluZWFyLWdyYWRpZW50KHRvcCwgdmFyKC0tcGFsZXR0ZS1iYWNrZ3JvdW5kLWRlZmF1bHQpIDUwJSwgdmFyKC0tcGFsZXR0ZS1iYWNrZ3JvdW5kLXByaW1hcnkpIDEwMCUpOwogICAgYmFja2dyb3VuZC1pbWFnZTogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgdmFyKC0tcGFsZXR0ZS1iYWNrZ3JvdW5kLWRlZmF1bHQpIDUwJSwgdmFyKC0tcGFsZXR0ZS1iYWNrZ3JvdW5kLXByaW1hcnkpIDEwMCUpOwogICAgYmFja2dyb3VuZC1yZXBlYXQ6IHJlcGVhdC14OwogICAgZmlsdGVyOiBwcm9naWQ6RFhJbWFnZVRyYW5zZm9ybS5NaWNyb3NvZnQuZ3JhZGllbnQoc3RhcnRDb2xvcnN0cj0nI0ZGRUVFRUVFJywgZW5kQ29sb3JzdHI9JyNGRkNDQ0NDQycsIEdyYWRpZW50VHlwZT0wKQp9Cgouc2VsZWN0Mi1jb250YWluZXItLWNsYXNzaWMgLnNlbGVjdDItc2VsZWN0aW9uLS1zaW5nbGUgLnNlbGVjdDItc2VsZWN0aW9uX19hcnJvdyBiIHsKICAgIGJvcmRlci1jb2xvcjogdmFyKC0tcGFsZXR0ZS1ib3JkZXItZGVmYXVsdCkgdHJhbnNwYXJlbnQgdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItc3R5bGU6IHNvbGlkOwogICAgYm9yZGVyLXdpZHRoOiA1cHggNHB4IDA7CiAgICBoZWlnaHQ6IDA7CiAgICBsZWZ0OiA1MCU7CiAgICBtYXJnaW4tbGVmdDogLTRweDsKICAgIG1hcmdpbi10b3A6IC0ycHg7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDUwJTsKICAgIHdpZHRoOiAwCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tY2xhc3NpY1tkaXI9InJ0bCJdIC5zZWxlY3QyLXNlbGVjdGlvbi0tc2luZ2xlIC5zZWxlY3QyLXNlbGVjdGlvbl9fY2xlYXIgewogICAgZmxvYXQ6IGxlZnQKfQoKLnNlbGVjdDItY29udGFpbmVyLS1jbGFzc2ljW2Rpcj0icnRsIl0gLnNlbGVjdDItc2VsZWN0aW9uLS1zaW5nbGUgLnNlbGVjdDItc2VsZWN0aW9uX19hcnJvdyB7CiAgICBib3JkZXI6IG5vbmU7CiAgICBib3JkZXItcmlnaHQ6IDFweCBzb2xpZCB2YXIoLS1wYWxldHRlLWJvcmRlci1kZWZhdWx0KTsKICAgIGJvcmRlci1yYWRpdXM6IDA7CiAgICBib3JkZXItdG9wLWxlZnQtcmFkaXVzOiA0cHg7CiAgICBib3JkZXItYm90dG9tLWxlZnQtcmFkaXVzOiA0cHg7CiAgICBsZWZ0OiAxcHg7CiAgICByaWdodDogYXV0bwp9Cgouc2VsZWN0Mi1jb250YWluZXItLWNsYXNzaWMuc2VsZWN0Mi1jb250YWluZXItLW9wZW4gLnNlbGVjdDItc2VsZWN0aW9uLS1zaW5nbGUgewogICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tYnV0dG9uX2JsdWVfYm9yZGVyKQp9Cgouc2VsZWN0Mi1jb250YWluZXItLWNsYXNzaWMuc2VsZWN0Mi1jb250YWluZXItLW9wZW4gLnNlbGVjdDItc2VsZWN0aW9uLS1zaW5nbGUgLnNlbGVjdDItc2VsZWN0aW9uX19hcnJvdyB7CiAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsKICAgIGJvcmRlcjogbm9uZQp9Cgouc2VsZWN0Mi1jb250YWluZXItLWNsYXNzaWMuc2VsZWN0Mi1jb250YWluZXItLW9wZW4gLnNlbGVjdDItc2VsZWN0aW9uLS1zaW5nbGUgLnNlbGVjdDItc2VsZWN0aW9uX19hcnJvdyBiIHsKICAgIGJvcmRlci1jb2xvcjogdHJhbnNwYXJlbnQgdHJhbnNwYXJlbnQgdmFyKC0tcGFsZXR0ZS1ib3JkZXItZGVmYXVsdCk7CiAgICBib3JkZXItd2lkdGg6IDAgNHB4IDVweAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWNsYXNzaWMuc2VsZWN0Mi1jb250YWluZXItLW9wZW4uc2VsZWN0Mi1jb250YWluZXItLWFib3ZlIC5zZWxlY3QyLXNlbGVjdGlvbi0tc2luZ2xlIHsKICAgIGJvcmRlci10b3A6IG5vbmU7CiAgICBib3JkZXItdG9wLWxlZnQtcmFkaXVzOiAwOwogICAgYm9yZGVyLXRvcC1yaWdodC1yYWRpdXM6IDA7CiAgICBiYWNrZ3JvdW5kLWltYWdlOiAtd2Via2l0LWxpbmVhci1ncmFkaWVudCh0b3AsIHZhcigtLXBhbGV0dGUtYmFja2dyb3VuZC1wcmltYXJ5KSAwJSwgdmFyKC0tcGFsZXR0ZS1iYWNrZ3JvdW5kLWRlZmF1bHQpIDUwJSk7CiAgICBiYWNrZ3JvdW5kLWltYWdlOiAtby1saW5lYXItZ3JhZGllbnQodG9wLCB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtcHJpbWFyeSkgMCUsIHZhcigtLXBhbGV0dGUtYmFja2dyb3VuZC1kZWZhdWx0KSA1MCUpOwogICAgYmFja2dyb3VuZC1pbWFnZTogbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgdmFyKC0tcGFsZXR0ZS1iYWNrZ3JvdW5kLXByaW1hcnkpIDAlLCB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtZGVmYXVsdCkgNTAlKTsKICAgIGJhY2tncm91bmQtcmVwZWF0OiByZXBlYXQteDsKICAgIGZpbHRlcjogcHJvZ2lkOkRYSW1hZ2VUcmFuc2Zvcm0uTWljcm9zb2Z0LmdyYWRpZW50KHN0YXJ0Q29sb3JzdHI9JyNGRkZGRkZGRicsIGVuZENvbG9yc3RyPScjRkZFRUVFRUUnLCBHcmFkaWVudFR5cGU9MCkKfQoKLnNlbGVjdDItY29udGFpbmVyLS1jbGFzc2ljLnNlbGVjdDItY29udGFpbmVyLS1vcGVuLnNlbGVjdDItY29udGFpbmVyLS1iZWxvdyAuc2VsZWN0Mi1zZWxlY3Rpb24tLXNpbmdsZSB7CiAgICBib3JkZXItYm90dG9tOiBub25lOwogICAgYm9yZGVyLWJvdHRvbS1sZWZ0LXJhZGl1czogMDsKICAgIGJvcmRlci1ib3R0b20tcmlnaHQtcmFkaXVzOiAwOwogICAgYmFja2dyb3VuZC1pbWFnZTogLXdlYmtpdC1saW5lYXItZ3JhZGllbnQodG9wLCB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtZGVmYXVsdCkgNTAlLCB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtcHJpbWFyeSkgMTAwJSk7CiAgICBiYWNrZ3JvdW5kLWltYWdlOiAtby1saW5lYXItZ3JhZGllbnQodG9wLCB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtZGVmYXVsdCkgNTAlLCB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtcHJpbWFyeSkgMTAwJSk7CiAgICBiYWNrZ3JvdW5kLWltYWdlOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtZGVmYXVsdCkgNTAlLCB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtcHJpbWFyeSkgMTAwJSk7CiAgICBiYWNrZ3JvdW5kLXJlcGVhdDogcmVwZWF0LXg7CiAgICBmaWx0ZXI6IHByb2dpZDpEWEltYWdlVHJhbnNmb3JtLk1pY3Jvc29mdC5ncmFkaWVudChzdGFydENvbG9yc3RyPScjRkZFRUVFRUUnLCBlbmRDb2xvcnN0cj0nI0ZGRkZGRkZGJywgR3JhZGllbnRUeXBlPTApCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tY2xhc3NpYyAuc2VsZWN0Mi1zZWxlY3Rpb24tLW11bHRpcGxlIHsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXBhbGV0dGUtYmFja2dyb3VuZC1kZWZhdWx0KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLXBhbGV0dGUtYm9yZGVyLWRlZmF1bHQpOwogICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgY3Vyc29yOiB0ZXh0OwogICAgb3V0bGluZTogMAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWNsYXNzaWMgLnNlbGVjdDItc2VsZWN0aW9uLS1tdWx0aXBsZTpmb2N1cyB7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1idXR0b25fYmx1ZV9ib3JkZXIpCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tY2xhc3NpYyAuc2VsZWN0Mi1zZWxlY3Rpb24tLW11bHRpcGxlIC5zZWxlY3QyLXNlbGVjdGlvbl9fcmVuZGVyZWQgewogICAgbGlzdC1zdHlsZTogbm9uZTsKICAgIG1hcmdpbjogMDsKICAgIHBhZGRpbmc6IDAgNXB4Cn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tY2xhc3NpYyAuc2VsZWN0Mi1zZWxlY3Rpb24tLW11bHRpcGxlIC5zZWxlY3QyLXNlbGVjdGlvbl9fY2xlYXIgewogICAgZGlzcGxheTogbm9uZQp9Cgouc2VsZWN0Mi1jb250YWluZXItLWNsYXNzaWMgLnNlbGVjdDItc2VsZWN0aW9uLS1tdWx0aXBsZSAuc2VsZWN0Mi1zZWxlY3Rpb25fX2Nob2ljZSB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtZGVmYXVsdCk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1wYWxldHRlLWJvcmRlci1kZWZhdWx0KTsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGN1cnNvcjogZGVmYXVsdDsKICAgIGZsb2F0OiBsZWZ0OwogICAgbWFyZ2luLXJpZ2h0OiA1cHg7CiAgICBtYXJnaW4tdG9wOiA1cHg7CiAgICBwYWRkaW5nOiAwIDVweAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWNsYXNzaWMgLnNlbGVjdDItc2VsZWN0aW9uLS1tdWx0aXBsZSAuc2VsZWN0Mi1zZWxlY3Rpb25fX2Nob2ljZV9fcmVtb3ZlIHsKICAgIGNvbG9yOiB2YXIoLS1wYWxldHRlLXRleHQtc2Vjb25kYXJ5LWRhcmspOwogICAgY3Vyc29yOiBwb2ludGVyOwogICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgIG1hcmdpbi1yaWdodDogMnB4Cn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tY2xhc3NpYyAuc2VsZWN0Mi1zZWxlY3Rpb24tLW11bHRpcGxlIC5zZWxlY3QyLXNlbGVjdGlvbl9fY2hvaWNlX19yZW1vdmU6aG92ZXIgewogICAgY29sb3I6IHZhcigtLXBhbGV0dGUtdGV4dC1zZWNvbmRhcnktZGFyaykKfQoKLnNlbGVjdDItY29udGFpbmVyLS1jbGFzc2ljW2Rpcj0icnRsIl0gLnNlbGVjdDItc2VsZWN0aW9uLS1tdWx0aXBsZSAuc2VsZWN0Mi1zZWxlY3Rpb25fX2Nob2ljZSB7CiAgICBmbG9hdDogcmlnaHQ7CiAgICBtYXJnaW4tbGVmdDogNXB4OwogICAgbWFyZ2luLXJpZ2h0OiBhdXRvCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tY2xhc3NpY1tkaXI9InJ0bCJdIC5zZWxlY3QyLXNlbGVjdGlvbi0tbXVsdGlwbGUgLnNlbGVjdDItc2VsZWN0aW9uX19jaG9pY2VfX3JlbW92ZSB7CiAgICBtYXJnaW4tbGVmdDogMnB4OwogICAgbWFyZ2luLXJpZ2h0OiBhdXRvCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tY2xhc3NpYy5zZWxlY3QyLWNvbnRhaW5lci0tb3BlbiAuc2VsZWN0Mi1zZWxlY3Rpb24tLW11bHRpcGxlIHsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWJ1dHRvbl9ibHVlX2JvcmRlcikKfQoKLnNlbGVjdDItY29udGFpbmVyLS1jbGFzc2ljLnNlbGVjdDItY29udGFpbmVyLS1vcGVuLnNlbGVjdDItY29udGFpbmVyLS1hYm92ZSAuc2VsZWN0Mi1zZWxlY3Rpb24tLW11bHRpcGxlIHsKICAgIGJvcmRlci10b3A6IG5vbmU7CiAgICBib3JkZXItdG9wLWxlZnQtcmFkaXVzOiAwOwogICAgYm9yZGVyLXRvcC1yaWdodC1yYWRpdXM6IDAKfQoKLnNlbGVjdDItY29udGFpbmVyLS1jbGFzc2ljLnNlbGVjdDItY29udGFpbmVyLS1vcGVuLnNlbGVjdDItY29udGFpbmVyLS1iZWxvdyAuc2VsZWN0Mi1zZWxlY3Rpb24tLW11bHRpcGxlIHsKICAgIGJvcmRlci1ib3R0b206IG5vbmU7CiAgICBib3JkZXItYm90dG9tLWxlZnQtcmFkaXVzOiAwOwogICAgYm9yZGVyLWJvdHRvbS1yaWdodC1yYWRpdXM6IDAKfQoKLnNlbGVjdDItY29udGFpbmVyLS1jbGFzc2ljIC5zZWxlY3QyLXNlYXJjaC0tZHJvcGRvd24gLnNlbGVjdDItc2VhcmNoX19maWVsZCB7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1wYWxldHRlLWJvcmRlci1kZWZhdWx0KTsKICAgIG91dGxpbmU6IDAKfQoKLnNlbGVjdDItY29udGFpbmVyLS1jbGFzc2ljIC5zZWxlY3QyLXNlYXJjaC0taW5saW5lIC5zZWxlY3QyLXNlYXJjaF9fZmllbGQgewogICAgb3V0bGluZTogMDsKICAgIGJveC1zaGFkb3c6IG5vbmUKfQoKLnNlbGVjdDItY29udGFpbmVyLS1jbGFzc2ljIC5zZWxlY3QyLWRyb3Bkb3duIHsKICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLXBhbGV0dGUtYmFja2dyb3VuZC1kZWZhdWx0KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHRyYW5zcGFyZW50Cn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tY2xhc3NpYyAuc2VsZWN0Mi1kcm9wZG93bi0tYWJvdmUgewogICAgYm9yZGVyLWJvdHRvbTogbm9uZQp9Cgouc2VsZWN0Mi1jb250YWluZXItLWNsYXNzaWMgLnNlbGVjdDItZHJvcGRvd24tLWJlbG93IHsKICAgIGJvcmRlci10b3A6IG5vbmUKfQoKLnNlbGVjdDItY29udGFpbmVyLS1jbGFzc2ljIC5zZWxlY3QyLXJlc3VsdHM+LnNlbGVjdDItcmVzdWx0c19fb3B0aW9ucyB7CiAgICBtYXgtaGVpZ2h0OiAyMDBweDsKICAgIG92ZXJmbG93LXk6IGF1dG8KfQoKLnNlbGVjdDItY29udGFpbmVyLS1jbGFzc2ljIC5zZWxlY3QyLXJlc3VsdHNfX29wdGlvbltyb2xlPWdyb3VwXSB7CiAgICBwYWRkaW5nOiAwCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tY2xhc3NpYyAuc2VsZWN0Mi1yZXN1bHRzX19vcHRpb25bYXJpYS1kaXNhYmxlZD10cnVlXSB7CiAgICBjb2xvcjogdmFyKC0tcGFsZXR0ZS10ZXh0LXNlY29uZGFyeS1kYXJrKQp9Cgouc2VsZWN0Mi1jb250YWluZXItLWNsYXNzaWMgLnNlbGVjdDItcmVzdWx0c19fb3B0aW9uLS1oaWdobGlnaHRlZFthcmlhLXNlbGVjdGVkXSB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1wYWxldHRlLWJhY2tncm91bmQtZGVmYXVsdCk7CiAgICBjb2xvcjogdmFyKC0tcGFsZXR0ZS10ZXh0LXByaW1hcnkpCn0KCi5zZWxlY3QyLWNvbnRhaW5lci0tY2xhc3NpYyAuc2VsZWN0Mi1yZXN1bHRzX19ncm91cCB7CiAgICBjdXJzb3I6IGRlZmF1bHQ7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIHBhZGRpbmc6IDZweAp9Cgouc2VsZWN0Mi1jb250YWluZXItLWNsYXNzaWMuc2VsZWN0Mi1jb250YWluZXItLW9wZW4gLnNlbGVjdDItZHJvcGRvd24gewogICAgYm9yZGVyLWNvbG9yOiB2YXIoLS1wYWxldHRlLWJvcmRlci1kZWZhdWx0KQp9",
        select2styles = '<style id="emfy_fs_uniq">' + atob(s2s);
      ("</select>");

      $("head").append(select2styles);
    }

    $.each(special_rules_selectors, function (i, v) {
      global_rules[v[0]] = v[1];
    });

    select.styles = {};
    select.work_area = select.find("select");
    select.selected = {
      groups: user_selected_items.groups ?? [],
      items: user_selected_items.items ?? [],
    };
    select.items = {};
    select.is_focused = false;

    select.style_obj = $("#emfy_field_select__select-2-styles-" + uniqueID);
    if (select.style_obj.length == 0) {
      $("head").append(
        '<style id="emfy_field_select__select-2-styles-' +
          uniqueID +
          '"></style>',
      );
      select.style_obj = $("#emfy_field_select__select-2-styles-" + uniqueID);
    }

    select.set_css_rule = function (
      selector,
      css = {},
      is_global = false,
      draw = true,
    ) {
      if (typeof selector == "object") {
        $.each(selector, function (s, c) {
          select.set_css_rule(s, c, is_global, false);
        });

        if (draw) select.fill_css();
      } else {
        let css_selector =
          (!is_global
            ? "#emfy_field_select-" +
              uniqueID +
              ".emfy_field_select-" +
              uniqueID +
              " "
            : "") + selector;
        select.styles[css_selector] = "{";

        $.each(css, function (i, v) {
          select.styles[css_selector] =
            select.styles[css_selector] + i + ":" + v + " !important;";
        });

        select.styles[css_selector] = select.styles[css_selector] + "}";
        if (draw) select.fill_css();
      }
    };

    select.destroy_css_rule = function (selector, draw = true) {
      if (typeof selector == "object") {
        $.each(selector, function (i, v) {
          select.destroy_css_rule(v, false);
        });

        select.fill_css();
      } else {
        delete select.styles[selector];
        if (draw) select.fill_css();
      }
    };

    select.fill_css = function () {
      let css_code = "";

      $.each(select.styles, function (selector, css) {
        css_code = css_code + selector + css;
      });

      select.style_obj.html(css_code);
    };

    select._open = function (allowed) {
      if (allowed) {
        select
          .find(".select2-selection.select2-selection--multiple")
          .css("pointer-events", "all");
      } else {
        select
          .find(".select2-selection.select2-selection--multiple")
          .css("pointer-events", "none");
      }

      select
        .find(
          ".select2-selection.select2-selection--multiple ul li.select2-selection__choice",
        )
        .css("pointer-events", "all");
      select
        .find(
          ".select2-selection.select2-selection--multiple ul span.select2-selection__clear",
        )
        .css("pointer-events", "all");
    };

    select._form_position = function (no_timeout = false) {
      let sfo_callback = function (object) {
        return object;
      };

      select.set_css_rule(global_rules, {}, true);
      if ($(".select2-results ul li.select2-results__option").length > 0) {
        sfo_callback(
          $(
            ".select2-container.select2-container--default.select2-container--open:not(.select2)",
          ),
        );
      } else {
        let sfi = setInterval(function () {
          if ($(".select2-results ul li.select2-results__option").length > 0) {
            sfo_callback(
              $(
                ".select2-container.select2-container--default.select2-container--open:not(.select2)",
              ),
            );
            clearInterval(sfi);
          }
        }, time_update);
      }
    };

    select._check_selected = function (anyway = false, allow_open = false) {
      setTimeout(function () {
        if (check_state || anyway) {
          check_state = false;

          let selected_values = (select.work_area.val() ?? []).map(
              function (e) {
                return e.split(uniqueID + "_ems_m_")[1];
              },
            ),
            selected_groups = [],
            selected_items = [],
            gc = {};

          $.each(select.items, function (i, v) {
            select.items[i].selected = false;
          });

          $.each(selected_values, function (i, v) {
            let niid = uniqueID + "_ems_m_" + v;

            select.items[niid].selected = true;
            if (typeof gc[select.items[niid].group] == "undefined") {
              gc[select.items[niid].group] = 1;
            } else gc[select.items[niid].group]++;

            selected_items.push(v);
            if (
              gc[select.items[niid].group] ==
              groups[select.items[niid].group].items_ids.length
            ) {
              let ngid = uniqueID + "_ems_g_" + select.items[niid].group;

              select.items[ngid].selected = true;
              selected_groups.push(select.items[niid].group);
            }
          });

          select.selected.groups = selected_groups;
          select.selected.items = selected_items;

          let is_closed = true;
          $.each(select.items, function (i, v) {
            if (is_closed) {
              is_closed = v.selected;
            }
          });

          select._open(!is_closed || allow_open);
        }

        select._form_position();
      }, time_update);
    };

    select.css({ display: "none" });
    select.init = function () {
      Promise.all([all_items]).then(function (promise_data) {
        let select_html = "",
          gc = {},
          group_and_fields = promise_data[0];

        groups = group_and_fields.groups;
        items = group_and_fields.items;

        $.each(groups, function (id, group) {
          if (group.items.length > 0) {
            let ngid = uniqueID + "_ems_g_" + id,
              g_item = {
                id: ngid,
                option: group.name,
                items_ids: group.items_ids,
                type: "group",
                selected: select.selected.groups.indexOf(id.toString()) + 1 > 0,
              },
              group_html = "";

            group_html =
              group_html + '<optgroup label="' + g_item.option + '">';
            select.items[ngid] = g_item;

            $.each(group.items, function (iid, item) {
              let niid = uniqueID + "_ems_m_" + item.id,
                m_item = {
                  id: niid,
                  option: item.option,
                  type: "item",
                  selected:
                    select.selected.items.indexOf(item.id.toString()) + 1 > 0 ||
                    g_item.selected,
                  group: item.group,
                },
                is_selected = m_item.selected ? " selected" : "",
                item_html =
                  '<option value="' +
                  m_item.id +
                  '"' +
                  is_selected +
                  ">" +
                  m_item.option +
                  "</option>";

              if (is_selected) {
                if (typeof gc[item.group] == "undefined") {
                  gc[item.group] = 1;
                } else gc[item.group]++;
              }

              group_html = group_html + item_html;
              select.items[niid] = m_item;
              select.items[ngid].selected =
                gc[item.group] == g_item.items_ids.length || g_item.selected;
            });

            group_html = group_html + "</optgroup>";
            select_html = select_html + group_html;
          }
        });
        select.work_area.html(select_html);

        select.set_css_rule({
          ".select2-selection__choice .select2-selection__choice__remove": {
            display: "none",
          },
          ".select2-selection__choice": {
            cursor: "pointer",
            background: "none",
            color: "var(--palette-text-primary)",
          },
          ".select2-container--default.select2-container--focus .select2-selection--multiple":
            {
              border: "1px solid var(--palette-border-default)",
              "border-radius": "4px",
            },
          ".select2.select2-container.select2-container--default": {
            opacity: "1",
            height: "100%",
          },
          ".select2-container--default .select2-selection--multiple .select2-selection__clear":
            {
              "font-size": "25px",
              "line-height": "12.5px",
              "font-weight": "normal",
              position: "absolute",
              right: "0",
              top: "calc(50% - 9px)",
            },
          ".select2-container--default .select2-selection--multiple .select2-selection__rendered":
            {
              position: "relative",
            },
          ".select2-container.select2-container--default": {
            display: "block",
            width: "100%",
            height: "100%",
          },
        });

        const selectSettings = {
          closeOnSelect: false,
          placeholder: self.i18n("FieldSelect.fields_and_groups"),
          allowClear: true,
          tags: false,
          templateResult: function (state) {
            if (!state.id) return state.text;
            return $(
              "<div><span>" +
                state.text +
                '</span><span data-id="' +
                state.id +
                '" class="control-user_state"></span></div>',
            );
          },
        };

        if (maxItems) selectSettings.maximumSelectionLength = maxItems;
        if (maxItemsMessage) {
          selectSettings.language = { maximumSelected: () => maxItemsMessage };
        }
        if (parentElem) selectSettings.dropdownParent = $(parentElem);

        let controller = select.work_area.select2(selectSettings).data(),
          position_counter = function () {
            setTimeout(function () {
              let this_controller = controller.select2.dropdown,
                e = $(window),
                t = this_controller.$dropdown.hasClass(
                  "select2-dropdown--above",
                ),
                n = this_controller.$dropdown.hasClass(
                  "select2-dropdown--below",
                ),
                r = null,
                i = this_controller.$container.offset();

              i.bottom = i.top + this_controller.$container.outerHeight(!1);

              let o = {
                height: this_controller.$container.outerHeight(!1),
              };

              (o.top = i.top), (o.bottom = i.top + o.height);

              let s = this_controller.$dropdown.outerHeight(!1),
                a = e.scrollTop(),
                l = e.scrollTop() + e.height(),
                c = a < i.top - s,
                u = l > i.bottom + s,
                d = {
                  left: i.left,
                  top: o.bottom + 3,
                  opacity: 1,
                  width: controller.select2.$selection.innerWidth(),
                },
                p = this_controller.$dropdownParent;

              "static" === p.css("position") && (p = p.offsetParent());
              let h = {
                top: 0,
                left: 0,
              };

              ($.contains(document.body, p[0]) || p[0].isConnected) &&
                (h = p.offset()),
                (d.top -= h.top),
                (d.left -= h.left),
                t || n || (r = "below"),
                u || !c || t ? !c && u && t && (r = "below") : (r = "above"),
                ("above" == r || (t && "below" !== r)) &&
                  (d.top = o.top - h.top - s - 3),
                null != r &&
                  (this_controller.$dropdown
                    .removeClass(
                      "select2-dropdown--below select2-dropdown--above",
                    )
                    .addClass("select2-dropdown--" + r),
                  this_controller.$container
                    .removeClass(
                      "select2-container--below select2-container--above",
                    )
                    .addClass("select2-container--" + r)),
                this_controller.$dropdownContainer.css(d);

              this_controller.$dropdown
                .parents(".select2-container")
                .addClass("edus-" + uniqueID);
              let uniq_selector_dropdown = {};
              uniq_selector_dropdown[".select2-container.edus-" + uniqueID] = {
                width: d.width + "px",
                display: "block",
              };
              select.set_css_rule(uniq_selector_dropdown, {}, true);
            }, time_update * 3);
          },
          dropdown_show_handler = function () {
            let this_controller = controller.select2.dropdown;

            this_controller.$dropdownContainer.appendTo(
              this_controller.$dropdownParent,
            );
            if (is_ohbd)
              this_controller.$dropdownContainer.css({ opacity: "0.75" });
            this_controller._positionDropdown();
            this_controller._resizeDropdown();
          },
          dropdown_hide_handler = function () {
            let this_controller = controller.select2.dropdown;

            this_controller.$dropdownContainer.detach();
          },
          is_ohbd = false;

        controller.select2.dropdown._positionDropdown = position_counter;
        controller.select2.dropdown._showDropdown = dropdown_show_handler;
        controller.select2.dropdown._hideDropdown = dropdown_hide_handler;

        select.on("click", ".select2-selection__choice", function (e) {
          $(this).find(".select2-selection__choice__remove").trigger("click");

          if (!select.is_focused) {
            select
              .find(".select2-selection.select2-selection--multiple")
              .trigger("click");
          }

          select._check_selected(true);
          select.trigger("ms:change");
        });

        let is_init_logic = false,
          clear = function () {
            if (
              $(".select2-results ul li.select2-results__option").length == 0
            ) {
              is_init_logic = false;
              select
                .find(".select2-selection.select2-selection--multiple")
                .trigger("click");
            }
          },
          logic = function () {
            if (!is_init_logic || anyway_logic_init) {
              check_state = false;
              select.set_css_rule(global_rules, {}, true);

              if (is_ohbd)
                select.set_css_rule(
                  ".select2-container.select2-container--default.select2-container--open",
                  { opacity: "0.75" },
                );
              select._check_selected(true);
              is_init_logic = true;

              setTimeout(function () {
                let destroy = [],
                  add = {},
                  extra_check = true;

                if (extra_check) {
                  $.each(select.items, function (id, item) {
                    if (typeof item.group != "undefined") {
                      select.items[id].selected = false;
                    }
                  });

                  $.each(select.selected.items, function (i, iid) {
                    let niid = uniqueID + "_ems_m_" + iid;
                    select.items[niid].selected = true;
                  });
                }

                $.each(select.items, function (id, item) {
                  if (typeof item.group == "undefined") {
                    let selector =
                        '.select2-container--default .select2-results__option[role="group"][aria-label="' +
                        item.option +
                        '"] .select2-results__group',
                      gid = item.id.split(uniqueID + "_ems_g_")[1],
                      counter = 0;

                    $(selector).parent().removeClass(group_selected_marker);
                    destroy.push(selector);

                    if (extra_check) {
                      $.each(select.items, function (i, mitem) {
                        if (
                          typeof mitem.group != "undefined" &&
                          mitem.group == gid &&
                          mitem.selected
                        ) {
                          counter++;
                        }
                      });

                      item.selected = counter == item.items_ids.length;
                      select.items[id] = item;
                    }

                    if (item.selected) {
                      add[selector] = {
                        display: "none",
                      };

                      $(selector).parent().addClass(group_selected_marker);
                      $(selector).parent().remove();
                    }
                  }
                });

                select.destroy_css_rule(destroy);
                select.set_css_rule(add, {});
                select.set_css_rule(
                  ".select2-container.select2-container--default.select2-container--open",
                  { opacity: "1" },
                );

                select._form_position();
              }, time_update * 2);

              let group = function (e) {
                  render();

                  let items = $(this)
                      .parent()
                      .find(
                        'ul li.select2-results__option[aria-selected="false"]',
                      ),
                    counter = 0;

                  $(this).hide(0);
                  items.each(function () {
                    check_state = items.length == ++counter;
                    $(this).trigger("mouseup");
                  });

                  select._form_position(true);
                  select.trigger("ms:change");
                },
                option = function (e) {
                  render();

                  let obj = $(this),
                    group = obj.parent().parent();

                  group.removeClass(group_selected_marker);
                  if (
                    group.find(
                      'ul li.select2-results__option[aria-selected="false"]',
                    ).length > 0
                  ) {
                    group.show(0);
                  } else {
                    group.hide(0);
                    group.addClass(group_selected_marker);
                    group.remove();
                  }
                  check_state = e.type == "click" ? true : check_state;

                  select._check_selected();
                  if (
                    $(
                      '.select2-results__options[role="listbox"] li[role="group"]',
                    ).length == 0
                  ) {
                    $(
                      ".select2-container.select2-container--default.select2-container--open:not(.select2)",
                    ).hide(0);
                  }

                  select._form_position(true);
                  select.trigger("ms:change");
                };

              $(document).off(
                "click",
                ".select2-results ul li.select2-results__option .select2-results__group",
              );
              $(document).on(
                "click",
                ".select2-results ul li.select2-results__option .select2-results__group",
                group,
              );

              $(document).off(
                "mouseup click",
                ".select2-results ul li.select2-results__option ul li.select2-results__option",
              );
              $(document).on(
                "mouseup click",
                ".select2-results ul li.select2-results__option ul li.select2-results__option",
                option,
              );
            }

            if (
              $('.select2-results__options[role="listbox"] li[role="group"]')
                .length == 0
            ) {
              $(
                ".select2-container.select2-container--default.select2-container--open:not(.select2)",
              ).hide(0);
            } else {
              $(
                ".select2-container.select2-container--default.select2-container--open:not(.select2)",
              ).show(0);
            }
          },
          render = function (e) {
            if (
              $(
                ".select2-container.select2-container--default.select2-container--open:not(.select2)",
              ).length == 0
            ) {
              select.set_css_rule(global_rules, {}, true);
            }
          },
          unrender = function (e) {
            if (!select.is_focused) {
              let destroy = [];

              $.each(global_rules, function (i, v) {
                destroy.push(i);
              });
              select.destroy_css_rule(destroy);
            }
          };

        select.on("mouseenter", ".select2-selection__clear", function (e) {
          select.off("mouseup", clear);
          select.one("mouseup", clear);
        });

        select.on("mouseleave", ".select2-selection__clear", function (e) {
          select.off("mouseup", clear);
        });

        select
          .find(".select2-selection.select2-selection--multiple")
          .on("click focus", function (e) {
            render();
            logic();

            select.trigger("ms:open");
          });

        select.work_area.on("select2:close", function (e) {
          let destroy = [];
          select.is_focused = false;

          $.each(global_rules, function (i, v) {
            destroy.push(i);
          });
          select.destroy_css_rule(destroy);

          is_init_logic = false;
        });

        select.work_area.on("select2:opening", function (e) {
          select.is_focused = true;
          render();
          logic();
        });

        select.work_area
          .next()
          .find(".selection")
          .on("mouseenter mousemove", render);
        select
          .find(
            ".select2-selection.select2-selection--multiple ul li.select2-selection__choice",
          )
          .on("mouseenter mousemove", render);

        select.work_area.next().find(".selection").on("mouseleave", unrender);
        select
          .find(
            ".select2-selection.select2-selection--multiple ul li.select2-selection__choice",
          )
          .on("mouseleave", unrender);

        select.trigger("ms:init");
        select.css({ display: "block" });
      });
    };

    return select;
  };
});
