"use strict";(window.webpackChunk=window.webpackChunk||[]).push([[34364],{940437:(e,t,s)=>{s.r(t),s.d(t,{default:()=>b});var i=s(629133),n=s.n(i),o=s(128508),a=s(567952),r=s.n(a),d=s(623967),l=s.n(d),_=s(797078),c=s(926168),u=s(418860),p=s(233579);function h(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}var f=[u.default.NOTE_DELETED,u.default.TASK_DELETED],m=[],y=null,g={getChannelName:function(e){if(21===e.element_type&&(e.element_type=APP.element_types.contacts),e.element_type===APP.element_types.catalog_elements){var t,s=e.is_open_from_card||!1;switch(e.type){case"leads":t="lead";break;case"customers":t="customer";break;default:s=!1}return s?[t,e.card_id,"catalog",e.catalog_id,"card",e.element_id].join(":"):"catalog:".concat(e.catalog_id,":card:").concat(e.element_id)}return[(0,c.convertElementType)(e.element_type,"single"),"card",e.element_id].join(":")},addingTimeout:function(e){Date.now()-y<e?window.requestAnimationFrame(n().bind(g.addingTimeout,this,e)):g.addNotes.call(this)},addNotes:function(){this.addNotes(m),m=[]}};const b={initCollection:function(e){this._auto_update={},this._auto_update_ws_state=_.default.status.subscribe(n().bind((function(e){e.state===WebSocket.OPEN&&this._reconnectAllFeeds()}),this)),e.element_id&&this.listenToOnce(this.notes,"fetched",(function(){var t=this.notes.findCollection(this.notes.element_id);this._connectFeedSocket(e.element_info.catalog_id||null),t&&t.embedded&&n().each(n().extend({},t.embedded.contacts,t.embedded.companies),(function(e){e.element_type!==this.notes.element_type&&this._subscribeFeedSocket(g.getChannelName({element_id:e.id,element_type:e.element_type}))}),this)})),this.listenTo(this.notes,"linked:link",(function(e){this._subscribeFeedSocket(g.getChannelName(e))})),this.listenTo(this.notes,"linked:unlink",(function(e){this._unsubscribeFeedSocket(g.getChannelName(e))}))},destroy:function(){n().each(n().keys(this._auto_update),(function(e){this._unsubscribeFeedSocket(e)}),this),this._auto_update_ws_state&&this._auto_update_ws_state.unsubscribe()},_connectFeedSocket:function(e){var t,s,i,o,a;this._subscribeFeedSocket(g.getChannelName((o=function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{},i=Object.keys(s);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(s).filter((function(e){return Object.getOwnPropertyDescriptor(s,e).enumerable})))),i.forEach((function(t){h(e,t,s[t])}))}return e}({},n().pick(this.notes,"element_id","element_type")),a=null!=(a={catalog_id:e||null,is_open_from_card:this.params.is_open_from_card||!1,card_id:this.params.is_open_from_card?null===(t=this.params.base_element)||void 0===t?void 0:t.id:null,type:this.params.is_open_from_card?null===(i=this.params.base_element)||void 0===i||null===(s=i.type)||void 0===s?void 0:s.type:null})?a:{},Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(a)):function(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);s.push.apply(s,i)}return s}(Object(a)).forEach((function(e){Object.defineProperty(o,e,Object.getOwnPropertyDescriptor(a,e))})),o)))},_subscribeFeedSocket:function(e){var t={channel:e};e.split(":").pop()===this.params.element_id.toString()&&(t.working_on=!0),_.default.send([{method:"subscribe",params:t}]),e.includes("catalog")?this._auto_update[e]=_.default.subscribe(e).pipe(o.filter((function(t){var s,i;return Boolean(null==t||null===(i=t.body)||void 0===i||null===(s=i.payload)||void 0===s?void 0:s.data)&&t.body.channel===e})),o.map((function(e){return e.body.payload.data}))).subscribe(n().bind(this._handleFeedSocketMessage,this),n().bind(this._subscribeFeedSocket,this)):this._auto_update[e]=_.default.subscribe(e).pipe(o.filter((function(t){var s,i;return(null==t||null===(s=t.body)||void 0===s?void 0:s.payload)&&"core"===((null===(i=t.body.payload)||void 0===i?void 0:i.service)||"core")&&t.body.channel===e})),o.map((function(e){return e.body.payload}))).subscribe(n().bind(this._handleFeedSocketMessage,this),n().bind(this._subscribeFeedSocket,this))},_unsubscribeFeedSocket:function(e){var t={channel:e};e.split(":").pop()===this.params.element_id.toString()&&(t.working_on=!1),this._auto_update&&(_.default.send([{method:"unsubscribe",params:t}]),this._auto_update[e]&&(this._auto_update[e].unsubscribe(),delete this._auto_update[e]))},_reconnectAllFeeds:function(){n().each(n().keys(this._auto_update),(function(e){this._auto_update[e]&&this._auto_update[e].unsubscribe(),this._subscribeFeedSocket(e)}),this)},_handleFeedSocketMessage:function(e){var t,s,i,o=this.notes.findCollection(this.notes.element_id),a=0;switch(n().propertyOf(e)(["data","params","need_reload"])&&this._$document.trigger("page:reload"),n().isUndefined(e.main_entity_id)||(i=(0,c.convertElementType)(e.main_entity_type,"string"),o.embedded[i]||(o.embedded[i]={}),o.embedded[i][e.main_entity_id]=n().extend(o.embedded[i][e.main_entity_id]||{},{id:e.main_entity_id,name:e.main_entity_name,object_type:{id:e.main_entity_type,code:i}}),e=n().omit(e,"main_entity_id","main_entity_type","main_entity_name")),n().isUndefined(e.transaction)||(o.embedded.transactions||(o.embedded.transactions={}),o.embedded.transactions[e.transaction.id]=n().extend(o.embedded.transactions[e.transaction.id]||{},e.transaction)),!0){case n().contains(f,e.event_type):return void(this.notes.get(e.id)&&(this.notes.get(e.id).trigger("destroy",this.notes.get(e.id)),this.notes.remove(e.id)));case e.type===APP.note_types.transaction:case e.event_type===u.default.TRANSACTION_ADDED_EVENT:(e=n().extend(e,n().pick(e.transaction||{},["price","products","comment","metadata","external_id","receipt_link"]))).bonus_points=n().propertyOf(e)(["transaction","metadata","bonus_points"]),e.transaction_date=n().propertyOf(e)(["transaction","date"]),m.push(n().omit(e,"event_type"));break;case e.type===APP.note_types.task_result:return o.tasks_results.add(n().omit(e,"event_type"),{merge:!0}),void(this.notes.get(e.element_id)&&this.notes.get(e.element_id).trigger("render"));case e.type===u.default.LEAD_STATUS_CHANGED_EVENT:case e.type===APP.note_types.customer_status_changed:e.element&&this.notes.trigger("notes:change-status",e.element.status_id,e.element.pipeline_id,e.element_type),m.push(n().omit(e,"event_type"));break;case e.type===APP.note_types.main_user_changed:case e.type===APP.note_types.attachment:a=800,m.push(n().omit(e,"event_type"));break;case e.type===u.default.FIELD_CHANGED_EVENT&&(null==e||null===(s=e.data)||void 0===s||null===(t=s.params)||void 0===t?void 0:t.field_type)===APP.cf_types.items:(e=JSON.parse(JSON.stringify(e))).data.params=l()((0,p.transformItemsSocketDataToNoteFormat)(r()(e.data.params))),m.push(n().omit(e,"event_type"));break;default:m.push(n().omit(e,"event_type"))}y=Date.now(),a>0?window.requestAnimationFrame(n().bind(g.addingTimeout,this,a)):g.addNotes.call(this)}};var v="../build/transpiled/interface/notes/mixins/auto_update";window.define(v,(function(){var e="undefined",s=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return s&&s.default||s})),window.require([v])},658903:(e,t,s)=>{s.r(t),s.d(t,{default:()=>_});var i=s(629133),n=s.n(i),o=s(460159),a=s.n(o),r=s(214558),d=s(418860),l=s(661533);const _={_renderCustomersGreenBar:function(){var e,t,s,i,o,_=null,c=null,u={};this._page>1||parseInt(this.params.element_type)===APP.element_types.leads&&(t=this.notes.filter((function(e){return"event"===(e.get("object_type")||{}).code&&e.get("type")===d.default.LEAD_STATUS_CHANGED_EVENT})),s=this.notes.where({type:APP.note_types.customer_created}),t.length&&(_=t[t.length-1]),s.length&&(c=s[s.length-1]),s.length&&_&&142===parseInt(_.get("data").params.new_status)&&(i=c.get("data").params.customer_id,o=this._getExtraData(c),u={date:Math.max(c.get("date_create"),_.get("date_create")),responsible_user:n().propertyOf((0,r.get)(_.get("responsible_user")))("title")||"",status_name:APP.lang.pipelines_statuses_closed_won,customer:{id:i,name:n().propertyOf(o)(["customers",i,"name"])||""}},a()._preload(["/tmpl/notes/green_line.twig"],n().bind((function(){e=l(a()({ref:"/tmpl/notes/green_line.twig"}).render(u)),this.$green_line&&this.$green_line.length?this.$green_line.replaceWith(e):this.$el.prepend(e),this.$green_line=e}),this))(),_.set("visible",!1),c.set("visible",!1)))},_onCustomersGreenLineOutside:function(e){this.$green_line&&this.$green_line.length&&(e.style.top="".concat(parseInt(e.style.top)+this.$green_line.height(),"px"))}};var c="../build/transpiled/interface/notes/mixins/customers_green_bar";window.define(c,(function(){var e="undefined",s=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return s&&s.default||s})),window.require([c])},178839:(e,t,s)=>{s.r(t),s.d(t,{default:()=>d});var i=s(629133),n=s.n(i),o=s(926168),a={element_id:0,element_type:0,element_date_create:0,bottom_bracket_of_time:0,main_element_type:0},r={elementDateCreate:function(e){var t=n().propertyOf(e)("created_at");return t||(t=n().propertyOf(APP.constant("card_element"))("date_create")),t},isNeedFilter:function(e){return a.main_element_type=parseInt(e)||0,a.main_element_type>0&&-1!==n().chain(APP.element_types).pick("leads","customers","unsorted").values().value().indexOf(a.main_element_type)},initCreationTime:function(e,t,s,i){var o,d;return e=parseInt(e),t=parseInt(t),a.element_id&&a.element_id===e&&a.element_type===t&&a.element_date_create||(r.initCache(e,t),(o=r.detectCreationNoteType(t))&&(d=n().find(s,(function(e){var t=e.view.model;return t&&t.type===o&&t.object_type&&"notes"===t.object_type.code&&t.element_type===a.element_type&&t.element_id===a.element_id})))&&r.useNoteForSetDates(d)),a.bottom_bracket_of_time>0||r.elementDateCreate(i)>0},detectCreationNoteType:function(e){var t=(0,o.convertElementType)(e,"single"),s=APP.note_types["".concat(t,"_created")];return s||console.error('Unexpected element type "%s"',e),s},initCache:function(e,t){a.bottom_bracket_of_time=a.element_date_create=0,a.element_id=e,a.element_type=t},useNoteForSetDates:function(e){a.element_date_create=e.date_create||0,a.element_date_create>0?a.bottom_bracket_of_time=a.element_date_create:a.element_date_create=0},isLinkedAndOld:function(e,t){var s=a.bottom_bracket_of_time||r.elementDateCreate(t);s>0&&(s-=86400);var i=e.date_create||e.created_at;if(!i)return console.error("Item has no field of date create, item: ",n().clone(e)),!1;var o=e.type!==APP.note_types.key_action_completed&&parseInt(i)<s,d=e.element_type===a.main_element_type;return o&&!d}};const d={element_id:0,element_type:0,initialize:function(){this.on("add",this._checkVisibleOnAdd,this)},_checkVisibleOnAdd:function(e){n().isUndefined(e.get("visible"))&&this._setVisible(e)},_setVisible:function(e){var t=this.getFilter(),s=parseInt(e.get("element_type")),i=e.get("object_type")||{},o=n().contains(n().values(n().pick(APP.element_types,"leads","customers")),this.element_type),a="tasks"===i.code&&!e.get("status"),r=!0;o&&a?e.set("visible",!0):(s!==this.element_type&&(r=!n().contains(t.without,s)),e.get("chat_id")&&(this.getOriginCollection(e)&&(r=!n().contains(t.without,this.getOriginCollection(e).type)),r&&(r=this._checkLinkedTalkVisibility(n().propertyOf(e.get("dialog"))("id")))),!0===r&&e.get("timeline_filter_type")>0&&(r=n().contains(t["filter[type][]"],e.get("timeline_filter_type"))),e.set("visible",r))},_checkLinkedTalkVisibility:function(e){var t=this.getFilter(),s=this.opened_talks_collection&&this.opened_talks_collection.get(e);return!s||!n().contains(t.without,"contacts")||parseInt(this.element_id)===s.get("entity_id")&&this.element_type===s.get("entity_type")},_filterLinkedAndOld:function(e){var t=e,s=this.findCollection(this.element_id),i=s?n().propertyOf(s)(["embedded",(0,o.convertElementType)(this.element_type,"string"),this.element_id]):{};return r.isNeedFilter(this.element_type)&&r.initCreationTime(this.element_id,this.element_type,e,i)&&(t=n().reject(e,(function(e){return r.isLinkedAndOld(e.view.model,i)}),this)),t}};var l="../build/transpiled/interface/notes/mixins/filtering";window.define(l,(function(){var e="undefined",s=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return s&&s.default||s})),window.require([l])},278385:(e,t,s)=>{s.r(t),s.d(t,{default:()=>u});var i=s(629133),n=s.n(i),o=s(161320),a=s.n(o),r=s(418860),d=n().invert(APP.element_types),l={leads:APP.note_types.lead_created,contacts:APP.note_types.contact_created,companies:APP.note_types.company_created,customers:APP.note_types.customer_created},_={leads:r.default.LEAD_ADDED_EVENT,contacts:r.default.CONTACT_ADDED_EVENT,companies:r.default.COMPANY_ADDED_EVENT,customers:r.default.CUSTOMER_ADDED_EVENT,catalog_elements:r.default.INVOICE_CREATED},c=function(e,t){var s=e.get("object_type").code,i=e.get("type"),o={};return!!n().contains(["notes","event"],s)&&(o="event"===s?_:l,t?i===o[d[t]]:n().contains(n().values(o),i))};const u={_getItemDate:function(e){var t=e.date_create;return!t&&e.created_at?e.created_at:(e.object_type&&"tasks"===e.object_type.code&&(t=e.status?e.date_modify:e.complete_till),n().isString(t)&&(t=function(e){var t=APP.system.format.date;return a()(e,"".concat(t.date," ").concat(t.time))}(t).unix()),t)},_sortAlgo:function(e,t){var s=n().find(e,(function(e){return c(e.view.model,t)}),this),i=s&&s.date;return n().sortBy(e,(function(e){var n;return e.view.model.get("type")===APP.note_types.key_action_completed&&e.date<i?[-1,e.date].join(""):i&&e.view.model.get("element_type")!==t&&c(e.view.model)&&(n=(e.date-i)/60,Math.abs(n)<=3)?[0,i+1].join(""):e===s?[0,e.date].join(""):e.view.model.get("pinned")?[-2,e.date].join(""):e.date.toString()}))}};var p="../build/transpiled/interface/notes/mixins/sorting";window.define(p,(function(){var e="undefined",s=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return s&&s.default||s})),window.require([p])},5465:(e,t,s)=>{s.r(t),s.d(t,{default:()=>u});var i,n=s(629133),o=s.n(n),a=s(147562),r=0,d=null,l=0,_=0,c=a.default.extend({refresh:function(e){var t=this;return a.default.prototype.refresh.call(this,(function(){t._calculateHeadersTypes(),o().isFunction(e)&&e()}))},update:function(){var e=this._scroll_top,t=o().clone(this.fix_flag),s=o().result(this.options,"top_offset",0),i=-1,n=-1,a=!1;this._clean||(this.headers&&this.headers.length&&this.headers.length<this.options.max_sticky_count&&(o().each(this.headers,(function(r,d){var l,_,c=0,u=0;this.header_tops[d]-(e+s)<0?(-1===i&&"task"===this.headers_types[d]&&(i=d),-1===n&&"opened_talk"===this.headers_types[d]&&(n=d),c=1,_=s,s+=this.fixed_heights[d]||r.offsetHeight):this.header_tops[d]+10-e>this.top_real_heights[d]+this.viewport_size?(c=2,_=this.el.clientHeight-r.offsetHeight-this.top_fix_heights[d]-this.viewport_size):(c=3,_=null),null!==_&&(1===c&&(0===d?u+="search"===this.headers_types[d]?0:10:o().contains([i,n],d)?u+=10:u+=i>-1&&d>i&&(-1===n||d<n)?-10:n>-1&&d>n?5:10),_+=u,s+=u),this.fix_flag[d]===c&&o().isEqual(t,this.fix_flag)||(r.style.top="",r.style.bottom="",r.classList.remove("outside"),r.classList.remove("outside-top"),r.classList.remove("outside-bottom"),this.fix_flag[d]=c,null===_?this.options.onInside(r,this.headers):(1===c?(r.style.top="".concat(_,"px"),r.classList.add("outside-top")):(r.style.bottom="".concat(_,"px"),r.classList.add("outside-bottom")),r.classList.add("outside"),this.options.onOutside(r,this.headers,1===c?"top":"bottom")),l=r.offsetHeight,1===c&&l!==this.fixed_heights[d]&&(this.fixed_heights[d]=l,this.fix_flag[d]=0,a=!0))}),this),this._setLastTopHeader()),this.options.onUpdate(this.headers,{scroll_top:this._scroll_top}),a&&(this._calculateHeadersTypes(),this.update()))},_calculateHeadersTypes:function(){this.headers_types=o().map(this.headers,(function(e){switch(!0){case e.classList.contains("card-task-wrapper"):return"task";case e.classList.contains("js-feed-search"):return"search";case e.classList.contains("js-feed-opened-talk"):return"opened_talk";default:return"note"}}))}});const u={destroy:function(){_=0},_initStacking:function(){var e=this,t=this._findElem("notes_scroller");this.sticky_tasks=this._addComponent(c,{el:t,selector:[this._selector("fixable"),this._selector("fixable_future"),".js-feed-search",".js-note-pinned",".js-feed-opened-talk"].join(","),disable_click:!0,no_viewport_change:!0,top_offset:function(){return o().result(e.params,"getStackingTopOffset",0)},filterElements:o().bind(this._onStickyHeadersFilter,this),getViewportHeight:o().bind(this._getStickyHeaderViewport,this),onInside:o().bind(this._onStickyHeaderInsideOutside,this),onOutside:o().bind(this._onStickyHeaderInsideOutside,this),onUpdate:o().bind(this._onStickyScrollUpdate,this),getCompareBoundary:o().bind(this._onStickyGetCompareBoundary,this)}),this._updateStickyTasks(),this._$document.on("openWidgetPanel".concat(this.ns," toggleWidgetPanel").concat(this.ns),o().bind(this._updateStickyTasks,this)),this.listenTo(this.notes,"notes:pause-sticky",this._pauseStickyTasks),this.listenTo(this.notes,"notes:resume-sticky",this._resumeStickyTasks),this.listenTo(this.notes,"notes:cleanup-sticky",this._cleanupStickyTasks),this.listenTo(this.notes,"notes:update-sticky",this._updateStickyTasks),this.listenTo(this.notes,"notes:view-destroy",this._updateStackingOnViewDestroy)},_updateStackingOnViewDestroy:function(e){(e.model.get("object_type")&&"tasks"===e.model.get("object_type").code||e.model.get("pinned"))&&this._updateStickyTasks()},_cleanupStickyTasks:function(){var e;this.sticky_tasks&&(e=this._scrollUpdate(),this.sticky_tasks.cleanup()&&e())},_pauseStickyTasks:function(){this.sticky_tasks.pause()},_resumeStickyTasks:function(){this.sticky_tasks.resume()},_updateStickyTasks:function(e){var t;this.sticky_tasks&&(t=this._scrollUpdate(),this._search.toggle(!0),this.sticky_tasks.cleanup(),this.sticky_tasks.refresh(e),t(),this._viewport_height_search=this._getStickyHeaderViewport(),this._sticky_max_scroll_top=this._getStickyMaxScrollTop())},_onStickyGetCompareBoundary:function(e){return e.classList.contains(this._class("fixable_pinned"))||e.classList.contains(this._class("fixable"))||e.classList.contains("js-feed-search")||e.classList.contains("js-feed-opened-talk")?"top":"bottom"},_getStickyHeaderViewport:function(){return this.$(".custom-scroll").get(0).offsetHeight-42-20},_onStickyHeaderInsideOutside:function(e,t){var s=null,i=null,n=null,a=null;o().each(t,(function(e){e.classList.contains("card-task-wrapper")&&(e.classList.contains("outside-top")?(s?e.classList.remove("outside-task_first"):(e.classList.add("outside-task_first"),s=e),i&&i.classList.remove("outside-task_last"),e.classList.add("outside-task_last"),i=e):(e.classList.remove("outside-task_first"),e.classList.remove("outside-task_last"))),e.classList.contains("js-feed-opened-talk")&&(e.classList.contains("outside-top")?(n?e.classList.remove("outside-talk_first"):(e.classList.add("outside-talk_first"),n=e),a&&a.classList.remove("outside-talk_last"),e.classList.add("outside-talk_last"),a=e):(e.classList.remove("outside-talk_first"),e.classList.remove("outside-talk_last")))})),this._onCustomersGreenLineOutside(e)},_onStickyHeadersFilter:function(e){var t=this,s=o().filter(e,(function(e){return e.querySelector(".card-task-expired")})),i=o().last(s,9-o().difference(e,s).length),n=this._search&&this._search.isApplied(),a=this.scrolled_up||n,r=o().filter(e,(function(e){return e.classList.contains("js-feed-search")?a||n:!(!e.children.length||n||e.classList.contains("js-note-pinned")&&t.scrolled_up&&!n||-1===o().indexOf(i,e)&&e.querySelector(".card-task-expired"))}),this);return o().sortBy(r,(function(e){return e.classList.contains(this._class("fixable_future"))?2:e.classList.contains("js-feed-opened-talk")?1:0}),this)},_getStickyMaxScrollTop:function(){var e=this._elem("notes_scroller")[0];return e.scrollHeight-e.offsetHeight},_onStickyScrollUpdate:function(e,t){var s=this,n=this._sticky_max_scroll_top,a=this._elem("filter_and_chat_users").get(0).offsetHeight-20,c=this.scrolled_up,u=this.scrolled_up;this._onScroll(t.scroll_top,n),0!==t.scroll_top&&(n>0&&(t.scroll_top>=n-1?this.el.classList.remove("scrolled"):this.el.classList.add("scrolled")),r>t.scroll_top||t.scroll_top<=0?(n-t.scroll_top>a&&this.el.classList.add("scrolled-up"),l=t.scroll_top):((t.scroll_top-l>150&&t.scroll_top-l<300||n-t.scroll_top<a)&&this.el.classList.remove("scrolled-up"),d||(l=t.scroll_top,d=o().delay(o().bind((function(){d=null}),this),100))),(this.scrolled_up&&t.scroll_top-r<0||!this.scrolled_up&&t.scroll_top-r>0)&&(_=t.scroll_top),Math.abs(t.scroll_top-_)>100&&Math.abs(t.scroll_top-_)<200&&(u=t.scroll_top-_<0),t.scroll_top>n-this._viewport_height_search&&(_=t.scroll_top,u=!1),this.scrolled_up=u,o().isUndefined(c)||u===c||this._search.isApplied()||(this._updateStickyTasks(),u?(this.el.classList.add("scrolled-search"),i=setTimeout((function(){s.el.classList.remove("scrolled-search")}),500)):(s.el.classList.remove("scrolled-search"),clearTimeout(i))),r=t.scroll_top)}};var p="../build/transpiled/interface/notes/mixins/stacking";window.define(p,(function(){var e="undefined",s=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return s&&s.default||s})),window.require([p])},22748:(e,t,s)=>{s.r(t),s.d(t,{default:()=>p});var i=s(629133),n=s.n(i),o=s(460159),a=s.n(o),r=s(445368),d=s(926168),l=s(214558),_=s(418860),c=s(661533),u="js-closed-status-msg";const p={initCollection:function(){this.notes.element_type===APP.element_types.leads&&(this.listenTo(this.notes,"notes:status-changed",this._onClosedStatusChange,this).listenTo(this.notes,"fetched",this._onClosedStatusChange,this).listenTo(this.notes,"reset",this._onResetToClosedStatus,this),this.listenTo(this.notes,"notes:loss-reason-changed",this._onLossReasonChange),this.listenTo(this.notes,"notes:card-saved",this._onFetchTimeline,this))},_onLossReasonChange:function(e){var t,s=this.notes.findCollection(this.notes.element_id);s&&(t=this._getExtraData(s.first()))&&(t.leads[this.notes.element_id].loss_reason_id=n().isNaN(parseInt(e))?0:parseInt(e),this._onClosedStatusChange())},_onFetchTimeline:function(){this._onClosedStatusChange({force:!0})},_onClosedStatusChange:a()._preload(["/tmpl/leads/cards/closed_status_msg.twig"],"_onPreloadedClosedStatusChange"),_onPreloadedClosedStatusChange:function(e){var t;if(e=e||{},(t=this.notes.max((function(e){return"event"===(e.get("object_type")||{}).code&&e.get("type")===_.default.LEAD_STATUS_CHANGED_EVENT&&e.get("date_create")})))&&t!==-1/0){var s=this._getExtraData(t),i=n().extend(s.leads[this.notes.element_id]||{},n().pick(this._getMainEntity(),"status_id"));if(t.get("type")!==_.default.LEAD_STATUS_CHANGED_EVENT&&(0,d.isWonLostStatus)(i.status_id)&&(t=t.clone().set({type:_.default.LEAD_STATUS_CHANGED_EVENT,data:{params:{new_status:i.status_id}},object_type:{id:7,code:"events"},date_create:i.closed_at||"",created_by:""})),t.get("type")===_.default.LEAD_STATUS_CHANGED_EVENT){var o=t.get("data").params||{},a=n().extend({lost_reason:i.loss_reason_id,status_id:o.new_status},n().pick(t.toJSON(),"created_by","date_create"));!i||n().isEqual(this._last_closed_data,a)&&!0!==e.force||(this._last_closed_data=a,this.$(".".concat(u)).remove(),(0,d.isWonLostStatus)(o.new_status)&&this["_closedStatus".concat(o.new_status)]({lead:i,extra:s,model:t}),this.notes.trigger("notes:update-sticky"))}}},_onResetToClosedStatus:function(){this._last_closed_data=null},_closedStatus142:function(e){this._renderClosedStatusBlock(e,{icon:"win",msg:(0,r.i18n)("Lead was successfully closed and won")})},_closedStatus143:function(e){var t=e.lead.loss_reason_id,s=(e.extra.loss_reasons[t]||{}).name;s||(s=t?APP.lang.loss_reason_deleted:(0,r.i18n)("No reason")),this._renderClosedStatusBlock(e,{icon:"loss",msg:(0,r.i18n)("Lead closed and lost"),reason:APP.constant("loss_reason_enabled")?s:""})},_renderClosedStatusBlock:function(e,t){var s=e.model.get("type")!==_.default.LEAD_STATUS_CHANGED_EVENT||(0,d.isWonLostStatus)(e.model.get("data").params.new_status)?e.lead.closed_at:e.model.get("date_create"),i=e.model.get("created_by")?(0,l.getUserName)(e.model.get("created_by")):"",o=this._scrollUpdate();this._elem("notes").before(c(a()({ref:"/tmpl/leads/cards/closed_status_msg.twig"}).render(n().extend({date:s,person:i},t))).addClass(u)),o()}};var h="../build/transpiled/interface/notes/mixins/status_change";window.define(h,(function(){var e="undefined",s=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return s&&s.default||s})),window.require([h])},881436:(e,t,s)=>{s.r(t),s.d(t,{default:()=>_});var i=s(629133),n=s.n(i),o=s(161320),a=s.n(o);s(695763);var r=a()().format(a()().localeData().calendar("today")),d=a()().format(a()().localeData().calendar("yesterday")),l="js-notes-timeline-point";const _={_timelineGroupBy:function(e,t,s){var i,o=Date.now()/1e3,l=n().min(s.view.models,(function(e){return this._getItemDate(e.toJSON())}),this),_=l===1/0?s.date:this._getItemDate(l.toJSON()),c=(o-_)/86400,u=a()(_,"X");switch(!0){case"opened_talks"===n().propertyOf(s.view.model.get("object_type"))("code"):return"";case u.isSame(e,"day"):return r;case u.isSame(t,"day"):return d;case c<=28:return u.format(APP.system.format.date.date);default:return i=u.format("MMMM"),u.isSame(a()(),"year")||(i+=", ".concat(u.format("YYYY"))),i}},_stopTimeline:function(){this.$(".".concat(l)).remove()},_startTimeline:function(){var e,t=a()().startOf("day"),s=a()().subtract(1,"days").startOf("day"),i=Array.prototype.reverse.call(this.views||[]);this._has_future_tasks&&(i=n().filter(i,(function(e){return!this._isFutureTask(e.view.model)}),this)),n().each(i,(function(o,a){var r,d,_,c;if(o.view.model.get("visible")){var u=this._timelineGroupBy(t,s,o,a);if(o.view.el.parentNode){var p=a===i.length-1;(p||e&&u&&u!==e)&&(d=p&&u?u:e)&&((r=document.createElement("div")).innerHTML='<div class="note-time-label__wrapper '.concat(l,'" data-point="').concat(d,'"><div class="note-time-label">').concat(d,"</div></div>"),_=i[p?a:a-1].view,c=n().propertyOf(_.model.get("object_type"))("code"),o.view.el.parentNode.insertBefore(r.firstChild,"opened_talks"===c?_.el.nextSibling:_.el)),u&&(e=u)}}}),this)},_updateTimeline:function(){this._stopTimeline(),this._startTimeline()}};var c="../build/transpiled/interface/notes/mixins/timeline";window.define(c,(function(){var e="undefined",s=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return s&&s.default||s})),window.require([c])},89096:(e,t,s)=>{s.r(t),s.d(t,{default:()=>d});var i=s(460159),n=s.n(i),o=s(629133),a=s.n(o),r=s(661533);const d={initCollection:function(){this.listenToOnce(this.notes,"views:added",this._onTimelineFetched)},_onTimelineFetched:n()._preload(["/tmpl/leads/cards/too_much_linked_entities.twig"],"_onPreloadedTooMuch"),_onPreloadedTooMuch:function(){if(a().propertyOf(this)(["notes","embedded","too_much_linked_entities"])){var e=this._scrollUpdate();this._elem("notes").before(r(n()({ref:"/tmpl/leads/cards/too_much_linked_entities.twig"}).render())),e(),this.notes.trigger("notes:update-sticky")}}};var l="../build/transpiled/interface/notes/mixins/too_much_linked_entites";window.define(l,(function(){var e="undefined",s=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return s&&s.default||s})),window.require([l])},774986:(e,t,s)=>{s.r(t),s.d(t,{default:()=>h});var i=s(629133),n=s.n(i),o=s(345839),a=s.n(o),r=s(128508),d=s(797078),l=s(214558),_=s(926168),c=s(780753),u=s(580326),p=".notes-wrapper__online";const h={initCollection:function(){this.users_online_collection=new(a().Collection)([]),this.expanded=!1,this.listenToOnce(this.notes,"views:added",this._initUsersOnlineSocket),this.listenTo(this.users_online_collection,"add remove change",n().bind(this.renderCardInteractionStatus,this)),this.listenTo(this.notes,"add:typing:from_socket",n().bind(this._onTypingFromSocket,this,"lead"))},setExpanded:function(){return this.expanded=!0,!0},_initUsersOnlineSocket:function(){var e=this;if(this.params.element_id){var t=(0,_.convertElementType)(this.params.element_type,"single"),s=d.default.subscribe([t+":card:"+this.params.element_id]).pipe(r.filter((function(e){return"activity"===e.method&&e.body&&e.body.channel||"get_online"===e.method&&e.body&&e.body.channel})),r.share());this.subscriptions.add(s.subscribe(n().bind((function(t){"get_online"===t.method?e.initActiveUsers(t.body):"user_online"===t.body.event?e._onUserInChatFromSocket(t.body):"user_offline"===t.body.event&&e._removeUserInChatFromSocket(t.body.user_id)}),this),(function(e){throw e}))),d.default.send([{method:"get_online",params:{channel:t+":card:"+this.params.element_id}}])}},initActiveUsers:function(e){var t=this;n().each(e.users,(function(e){t._onUserInChatFromSocket({user_id:e})}))},getCardInteractionUser:function(e){var t,s,i=n().find((0,l.get)(!0),(function(t){return e.user_id===t.amojo_id||e.user_id===parseInt(t.id)}));return n().isUndefined(i)&&(t=u.AmoJoMediator.getChatById(e.chat_id))&&(i=t.contacts[e.user_id])&&(s=n().find(this.params.getLinkedEntities(),(function(e){return e.id===i.id})))&&(i.title=s.name,i.avatar=s.avatar),i},_onUserInChatFromSocket:function(e){var t=this.getCardInteractionUser(e);t&&parseInt(t.id)!==(0,l.current)("id")&&this.users_online_collection.add(t)},_onTypingFromSocket:function(e,t){var s=this;if("bot"!==t.user.origin){var i=this.getCardInteractionUser(t),o=this.users_online_collection.get(i.id);i&&parseInt(i.id)!==(0,l.current)("id")&&(o||(o=this.users_online_collection.add(i)),n().isUndefined(i)||parseInt(i.id)===(0,l.current)("id")||(i._type=e,this.all_printing[i.amojo_id]&&clearTimeout(this.all_printing[i.amojo_id]),this.all_printing[i.amojo_id]=setTimeout(n().bind((function(){s.users_online_collection.length<2||s.expanded?s.$el.find(".feed-note__content-online-".concat(i.id)).removeClass("typing"):o.set("typing",!1)}),this),6e3),this.users_online_collection.length<2||this.expanded?this.$el.find(".feed-note__content-online-".concat(i.id)).addClass("typing"):o.set("typing",!0)))}},_removeUserInChatFromSocket:function(e){this.users_online_collection.remove(e)},removeTypingAfterSendMessage:function(e){var t=n().find((0,l.get)(!0),(function(t){return e.id===t.amojo_id}));!n().isUndefined(t)&&this.all_printing[t.amojo_id]&&(clearTimeout(this.all_printing[t.amojo_id]),this.users_online_collection.length<2||this.expanded?this.$el.find(".feed-note__content-online-".concat(t.id)).removeClass("typing"):this.users_online_collection.get(t.id).set("typing",!1))},destroy:function(){n().each(this.all_printing,(function(e){clearTimeout(e)}))},renderCardInteractionStatus:function(){var e=this._addComponent(c.default,{collection:this.users_online_collection,setExpanded:n().bind(this.setExpanded,this),expanded:this.expanded});this.users_online_collection.length||this.$el.find(p).html(),e.render(),this.$el.find(p).html(e.$el)}};var f="../build/transpiled/interface/notes/mixins/users_online";window.define(f,(function(){var e="undefined",s=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return s&&s.default||s})),window.require([f])}}]);var _global="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};_global.SENTRY_RELEASE={id:"build_2025_11_28_18_50_52"},function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=(new Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="b63ea81a-65c6-40bb-8ee8-2b13972fe445",e._sentryDebugIdIdentifier="sentry-dbid-b63ea81a-65c6-40bb-8ee8-2b13972fe445")}catch(e){}}();
//# sourceMappingURL=34364.41cad7136c09aaaa176d.js.map