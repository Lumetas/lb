"use strict";(window.webpackChunk=window.webpackChunk||[]).push([[56973],{245536:(e,t,i)=>{i.r(t),i.d(t,{default:()=>x});var n=i(661533),s=i.n(n),a=i(460159),o=i.n(a),r=i(629133),l=i.n(r),c=i(161320),d=i.n(c),u=i(810427),_=i.n(u),m=i(214558),h=i(49987),p=i(445368),f=i(93103),g=i(304483),v=i(845043),y=i(611958);function b(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}var w=_().extend({options:null,vars:{},managers:(0,m.get)(),user_id:null,modal:null,initialize:function(e){var t=this,i=APP.constant("user")||{};this.options=s().extend({},e),this.user_id=this.options.user_id||i.id||"",this.options.from_list?this.list=APP.data.current_view:this.options.from_card&&(this.card=APP.data.card_page),this.modal=new g.default({class_name:"modal-list ".concat(this.options.class_name),preload_templates:l().compact([t.options.template||"/tmpl/common/modal/add_entity/add_entity.twig","customers"===this.options.subEntity&&"stylesheets/_chunks/customers.css"]),init:function(e){t.vars.$modal_body=e,t.vars.template=o()({ref:t.options.template||"/tmpl/common/modal/add_entity/add_entity.twig"}),t.init(),l().isFunction(t.options.init)&&t.options.init.call(t),e.on("change","[name=next_date]",(function(){var t=s()(this);d()(t.val(),(0,h.format)("parse")).isValid()?e.find(".js-modal-accept").removeClass("button-input-disabled"):e.find(".js-modal-accept").addClass("button-input-disabled")})).on("click",".js-modal-accept:not(.button-input-disabled)",(function(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];if("function"==typeof t.options.confirm)t.options.confirm.call(t);else if(t.options.from_list||t.options.from_card){var s;t.options.needConfirm?(s=t).onModalAccept.apply(s,function(e){if(Array.isArray(e))return b(e)}(a=i)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(a)||function(e,t){if(e){if("string"==typeof e)return b(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(i):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?b(e,t):void 0}}(a)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()):t.doAjax()}else this.save_xhr=t.doAjax();var a}))},destroy:function(){t.reassign_select&&l().isFunction(t.reassign_select.destroy)&&t.reassign_select.destroy(),l().isFunction(t.options.destroy)&&t.options.destroy.call(t),t.vars.$modal_body&&t.vars.$modal_body.off(),this.save_xhr&&void 0!==this.save_xhr.status&&this.save_xhr.abort()}})},initReassignUsersSelect:function(e,t){var i=s()(e.currentTarget);e.stopPropagation(),this.reassign_select=new f.default(l().extend({el:i,id:"reassign-users_select_holder",class_name:"modal-reassign__users-select",suggest_class_name:"modal-reassign__users-select-suggest",input_name:"reassign_user_id",select_one:!0,not_remove:!0,in_modal:!0,existing_items:s().map(i.find(".js-multisuggest-item"),(function(e){return{id:s()(e).attr("data-id"),title:l().escape(s().trim(s()(e).text()))}})),onInit:function(){this.$list.css({zIndex:9999})}},t))},onModalAccept:function(){var e=this,t="multiple_modal_add_".concat(this.options.subEntity,"_confirm_text");this.modal.hide(),this.confirm=new v.default({text:(0,p.i18n)(t),accept_text:APP.lang.button_yes,decline_text:APP.lang.button_no,accept:function(){e.modal.show(),e.doAjax(),this.destroy()}})},init:function(){var e=this,t=this.managers,i=l().without(e.options.exclude,e.user_id.toString());i&&i.length&&(t=l().filter(t,(function(e,t){return-1===l().indexOf(i,t)}))),this.vars.$modal_body.html(this.vars.template.render(s().extend({title:this.options.title,managers:{class_name:"control--select-white modal-body__inner__managers-select",selected:this.user_id,bg_color:"#fff",items:t},subentity:e.options.subEntity,next_date:d()().format(APP.system.format.date.date)},this.options.template_params))).trigger("modal:loaded").trigger("modal:centrify"),this.vars.$modal_body.on("click","#reassign-users_select_holder",l().bind(e.initReassignUsersSelect,e))},doAjax:function(e){var t,i=this,n={responsible_id:i.vars.$modal_body.find("input:hidden:not(.js-focuser)").val()};return(e=e||{}).entity=e.entity||this.options.entity,e.subEntity=e.subEntity||this.options.subEntity,e.id=e.id||this.options.id,"customers"===e.subEntity&&(n=l().extend(n,{next_date:d()(i.vars.$modal_body.find("[name=next_date]").val(),(0,h.format)("parse")).format("X")})),i.vars.$modal_body.hide(),i.options.id?l().isArray(i.options.id)?t=i.options.id:(t=[]).push(i.options.id):t=l().map(APP.data.current_list.where({is_checked:!0}),(function(e){return e.get("id")})),y.default.createEntitiesFromThreads(t,e.subEntity,n).done((function(){l().isFunction(e.callback)?e.callback():i.options.from_list?i._$document.trigger("list:reload"):i.card&&i.card.reload?i.card.reload():i._$document.trigger("page:reload"),i.modal.show(),i.modal.showSuccess(),i.options.in_modal&&i.options.done.resolve(),i.options.changing&&i.options.changing.resolve()})).fail((function(){i.modal.showError()}))}});const x=w;var E="../build/transpiled/components/lists/actions/add_entity";window.define(E,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([E])},837992:(e,t,i)=>{i.r(t),i.d(t,{default:()=>x});var n=i(661533),s=i.n(n),a=i(629133),o=i.n(a),r=i(345839),l=i.n(r),c=i(460159),d=i.n(c),u=i(162262),_=i.n(u),m=i(445368),h=i(756348),p=i(64076),f=i(729115),g=i(304483),v=i(845043),y=i(923703),b="write_mail",w=f.default.View.extend({options:null,modal:null,send_locked:!1,subviews:{},defaults:{},events:o().extend({},f.default.View.prototype.events||{},{"click .js-modal-accept":"onSendClick","controls:change .modal_write-mail__templates-select":"changeTemplate","controls:change .modal_write-mail__mailboxes-select":"onMailboxChange","click .modal_write-mail__templates-select .control--select--list-opened":"onTemplateSelect","click .mail-action__tag":"insertMarker","click .js-navigate-mailboxes":"openMailboxSettings"}),_selectors:function(){return{templates_select:".modal_write-mail__templates-select",templates_select_input:".modal_write-mail__templates-select input",mailboxes_select_input:".modal_write-mail__mailboxes-select input",mailbox_form__error_select:".mailbox-form__error-select",controls_select_input:".control--select--input",template_content:".mail-action__template-content",template_subject:"#template-subject",template_content_html:"#template-content-html",recipients_container:".mail-action__settings-item_recipients .mail-action__settings-input",ccopy_container:".mail-action__settings-item_ccopy .mail-action__settings-input",mail_suggest:".mail-suggest",send_button:".js-modal-accept"}},initialize:function(e){f.default.View.prototype.initialize.apply(this,arguments),this.options=o().extend({},e),this.sub_entity=this.options.subEntity||this.options.sub_entity,this.thread_id=this.options.id||[],this.options.from_list?(this.list=APP.data.current_view,this.selected_mailbox=this.list.mailbox_id):this.options.from_card&&(this.card=APP.data.card_page,this.sub_entity="reply",this.selected_mailbox=e.box_id),this.initModal()},initModal:function(){var e=this;this.modal=new g.default({class_name:"modal-list modal_write-mail modal_mail-action",init:function(t){e.setElement(t),e._makeRequest()},destroy:function(t){if(!e.force_exit&&(e.form_modified||e.recipients_modified))return s()(".modal.modal-list.modal-leave-confirm.js-modal-confirm").length||APP.router.confirmPageChange(e._confirmModalConfig,o().noop),!1;e.destroy(),o().invoke(e.subviews,"destroy"),APP.router.preventPageChange(!1,b),e.compose_xhr&&void 0!==e.compose_xhr.status&&e.compose_xhr.abort(),o().isFunction(t)&&t()}})},_makeRequest:function(){this.preInit()},preInit:function(){s().when(this.templates_xhr=this.getTemplatesList(),this.mailboxes_xhr=this.getMailboxesList(),this.reply_data_xhr="reply"===this.sub_entity?this.getReplyData():this.getRecipientsList()).then(o().bind((function(){this.init()}),this))},init:function(){var e=["recipients"];this.initCollections(),this.render().then(o().bind((function(){this.watchForm(),this.changeTemplate(),this.onMailboxChange(),this.$el.trigger("modal:loaded").trigger("modal:centrify"),this.initPagePreventer(),APP.router.preventPageChange(!1,b),"reply"===this.sub_entity&&e.push("ccopy"),o().each(e,o().bind((function(e){this.subviews[e]=new h.default({$container:this._findElem("".concat(e,"_container")),items:this[e],class_name:"mail-suggest_".concat(e),data_type:e}),this.defaults[e]=JSON.stringify(this.subviews[e].items_collection.toJSON()),this.listenTo(this.subviews[e].items_collection,"remove",this.onMailboxCollectionChange),this.listenTo(this.subviews[e].items_collection,"add",this.onMailboxCollectionChange)}),this))}),this))},initCollections:function(){var e,t,i=this,n="reply"===this.sub_entity;this.templates_collection=new(l().Collection),this.mailboxes_collection=new(l().Collection),!n&&this.templates.length||(e={name:APP.lang.mail_template_empty_name,id:"blank",subject:n?this.reply_data.subject:"",content:n?this.reply_data.content:""},this.templates.unshift(e)),this.templates&&o().each(i.templates,(function(e){e.option=e.name,i.templates_collection.push(new(l().Model)(e))})),this.mailboxes.length||(t={id:0,email:APP.lang.no_available_mailboxes},this.mailboxes=[t]),this.mailboxes&&o().each(i.mailboxes,(function(e){e.option=e.email,i.mailboxes_collection.push(new(l().Model)(e))}))},render:d()._preload(["/tmpl/mail/modal/write_mail.twig"],"_render"),_render:function(){var e=0,t=this.mailboxes_collection.get(this.selected_mailbox),i=this.mailboxes_collection.first();o().isUndefined(t)?o().isUndefined(i)||(e=i.get("id")):e=t.get("id"),this.$el.trigger("modal:loaded").html(d()({ref:"/tmpl/mail/modal/write_mail.twig"}).render({markers:this.markers,reply:"reply"===this.sub_entity,templates:{class_name:"modal_write-mail__templates-select",items:this.templates_collection.toJSON()},mailboxes:{class_name:"modal_write-mail__mailboxes-select",selected:e,items:this.mailboxes_collection.toJSON()}}))},initPagePreventer:function(){this._confirmModalConfig={message:APP.lang.write_mail_on_modal_close,gray_button:!0,accept:o().bind((function(e){this.force_exit=!0,this.modal.destroy(),o().isFunction(e)&&e()}),this)},APP.router.registerPreventConfig(this._confirmModalConfig,b)},watchForm:function(){var e=this;this._findElem("controls_select_input").addClass("js-form-changes-skip"),this.initModelFromForm(),this._elem("send_button").trigger("button:save:enable"),this.model.on("has_changes",(function(){e.form_modified=!0,APP.router.preventPageChange(!0,b)})).on("has_reverted",(function(){e.form_modified=!1,APP.router.preventPageChange(!1,b)}))},getTemplatesList:function(){var e=this,t={render:!0,mode:this.sub_entity,template_params:{"contact.name":this.options.recipient_name}};return y.default.getMailTemplates(t).done((function(t){e.templates=t.items,e.markers=t.markers})).fail((function(t){e.renderErrorModal(t,!1)}))},getMailboxesList:function(){var e=this;return y.default.getMailboxes({list:"short",active:1}).done((function(t){e.mailboxes=t.items})).fail((function(t){e.renderErrorModal(t,!1)}))},getRecipientsList:function(){var e=this,t={type:"income",threads:this.thread_id};return y.default.getRecipients(t).done((function(t){e.recipients=t})).fail((function(t){e.renderErrorModal(t,!1)}))},getReplyData:function(){return y.default.getThreadReplyData(this.thread_id).done(o().bind(this.resolveRecipients,this)).fail(o().bind((function(e){this.renderErrorModal(e,!1)}),this))},resolveRecipients:function(e){this.recipients=e.to,this.ccopy=e.cc,this.reply_data=e},onMailboxCollectionChange:function(){var e=this,t=this.subviews.recipients.items_collection.length+("reply"===this.sub_entity?this.subviews.ccopy.items_collection.length:null),i=["recipients"];"reply"===this.sub_entity&&i.push("ccopy"),this._elem("send_button").trigger("button:save:".concat(t?"enable":"disable")),this.send_locked=!t,o().every(i,(function(t){return e.defaults[t]===JSON.stringify(e.subviews[t].items_collection.toJSON())}))?(this.recipients_modified=!1,APP.router.preventPageChange(!(!this.recipients_modified&&!this.form_modified),b)):(this.recipients_modified=!0,APP.router.preventPageChange(!0,b))},onMailboxChange:function(){var e=+this._elem("mailboxes_select_input").val(),t=this.mailboxes_collection.get(e);o().isUndefined(t)&&(t=this.mailboxes_collection.first());var i=t.get("smtp");void 0!==e&&0===e?(this._elem("send_button").trigger("button:save:disable"),this.send_locked=!0):(this._elem("mailbox_form__error_select").toggle(!i),this.send_locked=!i,this._elem("send_button").trigger("button:save:".concat(i?"enable":"disable")))},changeTemplate:function(){var e=this._findElem("controls_select_input").val(),t=this.templates_collection.get(e);t.get("subject")&&this._elem("template_subject").val((0,m.unescapeHTML)(t.get("subject"))).trigger("input"),this._elem("template_content").val(t.get("content")).trigger("input").trigger("controls:textarea:autosize"),t.get("content_html")?this._elem("template_content_html").prop("checked",!0).trigger("change"):this._elem("template_content_html").attr("checked",!1).trigger("change"),this.form_modified=!1,this.model.updateDefaults()},onTemplateSelect:function(e){var t=s()(e.target).closest(".control--select--list--item").data("value");if(this.form_modified)return this.confirm=new v.default({text:APP.lang.write_mail_on_template_select,accept:o().bind((function(){this.confirm.destroy(),this._elem("templates_select_input").val(t).trigger("controls:change:visual").trigger("controls:change")}),this),decline:o().bind((function(){return this.confirm.destroy(),!1}),this)}),!1},onSendClick:function(e){if(this.send_locked)return!1;var t="reply"===this.sub_entity&&this.subviews.ccopy.items_collection.where({invalid:!0}).length;if(this.subviews.recipients.items_collection.where({invalid:!0}).length||t)return this.modal.showError(APP.lang.write_mail_incorrect_recipients);var i=o().extend(this.model.toJSON(),{from:+this._elem("mailboxes_select_input").val(),to:this.subviews.recipients.items_collection.toJSON()});"reply"===this.sub_entity&&(i.cc=this.subviews.ccopy.items_collection.toJSON()),this._elem("send_button").trigger("button:load:start"),this.send_locked=!0,this.compose_xhr=this.composeReply(e,i)},composeReply:function(e,t){var i,n=this;if("reply"===this.sub_entity){var s=this.thread_id.length?this.thread_id.pop():null;i=y.default.composeReply(s,t)}else i=y.default.composeMailing(t);return i.always((function(){n.$el.show(),n._elem("send_button").trigger("button:load:stop")})).done((function(t){n.force_exit=!0,APP.router.preventPageChange(!1,b),t.message=APP.lang.write_mail_sent_success,n.modal.show(),n.modal.showSuccess(t.message),o().isFunction(e.callback)?e.callback():n.options.from_list?n._$document.trigger("list:reload"):n.card&&n.card.reload?n.card.reload():n._$document.trigger("page:reload"),o().isFunction(e.success)&&(n.force_exit=!0)})).fail((function(e){n.renderErrorModal(e),n.send_locked=!1}))},openMailboxSettings:function(){var e=+this._elem("mailboxes_select_input").val();this.force_exit=!0,this.modal.destroy(),o().isFunction(this.options.setNeedReload)&&this.options.setNeedReload(),this._$document.trigger("mailbox:view:settings",e)},renderErrorModal:function(e,t){var i;if(t="boolean"!=typeof t||t,e.responseJSON)switch(e.responseJSON.error){case 410:i=APP.lang.mail_letter_deleted,t=!1;break;case 403:i=APP.lang.mail_letter_view_forbidden,t=!1}this.modal.showError(i,t)}});_().mixin(w,p.default);const x=w;var E="../build/transpiled/components/lists/actions/write_mail";window.define(E,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([E])},923703:(e,t,i)=>{i.r(t),i.d(t,{default:()=>l});var n,s=i(629133),a=i.n(s),o=i(444459),r=function(){(n=new o.default("/api/v1.1")).loadBackendVersion()};a().extend(r.prototype,{linkLead:function(e,t){var i=n.makeUrl("/account_id/mail/leads/link"),s={lead_id:t,thread_id:e};return n.request("POST",i,s)},unlinkLead:function(e){var t=n.makeUrl("/account_id/mail/leads/unlink"),i={thread_id:e};return n.request("POST",t,i)},getAddressesWithoutContact:function(e){var t=n.makeUrl("/account_id/mail/address"),i={thread_ids:e,type:"without_contact"};return n.request("GET",t,i)},linkAddress:function(e,t){var i=n.makeUrl("/account_id/mail/address/link"),s={id:t,address_id:e};return n.request("POST",i,s)},listThreads:function(e,t,i,s){var a=n.makeUrl("/account_id/mail/list"),o={page:t||1,folder:e,mailbox_id:i};return n.request("GET",a,o,{},s||{})},restoreThreads:function(e){var t=n.makeUrl("/account_id/mail/threads/restore"),i={threads:e};return n.request("POST",t,i)},deleteThreads:function(e){var t=n.makeUrl("/account_id/mail/threads/delete"),i=a().extend({},{threads:e});return n.request("POST",t,i)},createEntitiesFromThreads:function(e,t,i){var s=n.makeUrl("/account_id/mail/".concat(t)),o=a().extend({},i,{threads:e});return n.request("POST",s,o)},deleteMailbox:function(e){var t=n.makeUrl("/account_id/mail/mailboxes/".concat(e,"/delete"));return n.request("POST",t)},enableMailbox:function(e,t){var i=n.makeUrl("/account_id/mail/mailboxes/".concat(e,"/connect"));return n.request("POST",i,t)},disableMailbox:function(e){var t=n.makeUrl("/account_id/mail/mailboxes/".concat(e,"/disconnect"));return n.request("POST",t)},syncMailbox:function(e){var t=n.makeUrl("/account_id/mail/mailboxes/".concat(e,"/sync"));return n.request("POST",t)},addMailbox:function(e){var t=n.makeUrl("/account_id/mail/mailboxes");return n.request("POST",t,e)},saveMailbox:function(e,t,i){var s=n.makeUrl("/account_id/mail/mailboxes/".concat(e,"?save=").concat(i));return n.request("POST",s,t)},getMailbox:function(e){var t=n.makeUrl("/account_id/mail/mailboxes/".concat(e));return n.request("GET",t)},getMailboxes:function(e){var t=n.makeUrl("/account_id/mail/mailboxes");return n.request("GET",t,e)},getMailboxStatus:function(e){var t=n.makeUrl("/account_id/mail/mailboxes/status"),i={id:e};return n.request("GET",t,i)},getCounters:function(){var e=n.makeUrl("/account_id/mail/mailboxes/counters");return n.request("GET",e)},getThread:function(e,t,i){var s=n.makeUrl("/account_id/mail/threads/".concat(e));return n.request("GET",s,t||{},{},i)},getMessage:function(e){var t=n.makeUrl("/account_id/mail/messages/".concat(e));return n.request("GET",t)},readThread:function(e,t){var i=n.makeUrl("/account_id/mail/threads/view"),s={threads:e};return n.request("POST",i,s,{},t)},shareThread:function(e,t){var i=n.makeUrl("/account_id/mail/threads/share"),s=a().extend(t,{threads:e});return n.request("POST",i,s)},findSettings:function(e){var t=n.makeUrl("/account_id/mail/settings"),i={email:e};return n.request("GET",t,i)},getThreadReplyData:function(e){var t=n.makeUrl("/account_id/mail/threads/".concat(e,"/reply"));return n.request("GET",t)},composeReply:function(e,t){var i=e?"threads/".concat(e,"/reply"):"reply",s=n.makeUrl("/account_id/mail/".concat(i));return n.request("POST",s,t)},composeMailing:function(e){var t=n.makeUrl("/account_id/mail/compose");return n.request("POST",t,e)},getRecipients:function(e){var t=n.makeUrl("/account_id/mail/threads/recipients");return n.request("GET",t,e)},getMailTemplates:function(e){var t=n.makeUrl("/account_id/mail/templates");return n.request("GETJSON",t,e)},createMailTemplate:function(e){var t=n.makeUrl("/account_id/mail/templates");return n.request("POST",t,e)},updateMailTemplate:function(e){var t=n.makeUrl("/account_id/mail/templates/".concat(e.id));return n.request("POST",t,e)},removeMailTemplate:function(e){var t=n.makeUrl("/account_id/mail/templates/".concat(e.id,"/delete"));return n.request("POST",t,e)},updateMailTemplatesSort:function(e){var t=n.makeUrl("/account_id/mail/templates/sort");return n.request("POST",t,e)}});const l=new r;var c="../build/transpiled/components/mail/api";window.define(c,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([c])},871741:(e,t,i)=>{i.r(t),i.d(t,{default:()=>y});var n=i(661533),s=i.n(n),a=i(345839),o=i.n(a),r=i(460159),l=i.n(r),c=i(810427),d=i.n(c),u=i(445368),_=i(304483),m=i(923703),h="/tmpl/mail/modal/add_contacts.twig",p="/tmpl/mail/modal/contacts_list_view.twig",f=o().Model.extend({onSave:null,save:function(){var e=this;return this.onSave=s().Deferred(),m.default.linkAddress().done((function(){e.onSave.resolve()})).fail((function(t,i,n){var s={req_obj:t,msg:i,error:n};e.onSave.reject(s)})),this.onSave.promise()}}),g=o().Collection.extend({onFetch:null,model:f,fetch:function(e){var t=this,i=e.threadIds||[];return this.onFetch=s().Deferred(),m.default.getAddressesWithoutContact(i).done((function(e){t.add(e.items),t.onFetch.resolve(e)})).fail((function(e,i,n){var s={req_obj:e,msg:i,error:n};t.onFetch.reject(s)})),this.onFetch.promise()}}),v=d().extend({template:p,threadIds:null,dataLoaded:null,collection:null,parent:null,events:{"click #contact-list__checkbox-all":"onToggleAll","click .js-contact-checkbox input":"onCheckboxChange"},_selectors:function(){return{footer:".contacts-list__footer",checkboxes:".js-contact-checkbox input",mainCheckbox:"#contact-list__checkbox-all",buttonCreate:"#add-contacts-create-button",buttonCreateLabel:".button-input-inner__text",buttonNext:"",buttonSkip:""}},initialize:function(e){var t=this;this.threadIds=e.threadIds,this.$container=e.container,this.modal=e.modal,this.parent=e.parent,this.collection=new g,this.collection.fetch({threadIds:this.threadIds}).done((function(e){t.render(e)}))},render:l()._preload([p],"_render"),_render:function(e){var t={all_contacts:APP.lang.mail_modal_all_contacts_checkbox,count:e.items.length,items:e.items,button_text_start:APP.lang.mail_modal_add_button_text_create,button_text_end:APP.lang.mail_letter_contacts_more_contacts};this.$el.html(l()({ref:this.template}).render(t)),this.$container.html(this.$el),this._findElem("mainCheckbox").trigger("click"),this.setButtonTitle()},destroy:function(){this.collection.reset(),this.collection=null,this.remove()},onToggleAll:function(e){this.toggleAll(s()(e.currentTarget))},onCheckboxChange:function(e){var t=e.currentTarget.checked,i=+s()(e.currentTarget).val(),n=this._findElem("mainCheckbox"),a=n.closest(".control-checkbox");this.collection.findWhere({address_id:i}).set("checked",t);var o=this.collection.where({checked:!0}).length;o===this.collection.length?(n.prop("checked",!0),a.removeClass("control-checkbox-dash")):(o>0?a.addClass("control-checkbox-dash"):a.removeClass("control-checkbox-dash"),n.prop("checked",!1)),this.setButtonTitle()},toggleAll:function(e){var t=e.prop("checked"),i=this.collection.where({checked:!0}).length,n=e.closest(".control-checkbox");i>0&&(t=!1,e.prop("checked",!1)),this.collection.each((function(e){e.set("checked",t)})),this._findElem("checkboxes").each((function(){this.checked=t})),n.removeClass("control-checkbox-dash"),this.setButtonTitle()},setButtonTitle:function(){var e=this.$container.find(this._selector("buttonCreate")),t=this.collection.where({checked:!0}).length,i="".concat(APP.lang.mail_modal_add_button_text_create," ").concat(t," ").concat((0,u.numeralWord)(t,APP.lang.mail_letter_contacts_more_contacts));e.find(this._selector("buttonCreateLabel")).text(i),t>0?(e.addClass("button-input_blue"),e.removeClass("button-input-disabled"),e.prop("disabled",!1)):(e.removeClass("button-input_blue"),e.addClass("button-input-disabled"),e.prop("disabled",!0))}});const y=d().extend({template:h,modal:null,subview:null,threadIds:[],_selectors:function(){return{subviewContainer:".add-contact-view__subview-container"}},initialize:function(e){var t,i;t=e.threadIds,(null!=(i=Array)&&"undefined"!=typeof Symbol&&i[Symbol.hasInstance]?i[Symbol.hasInstance](t):t instanceof i)?this.threadIds=e.threadIds:"number"==typeof e.threadIds&&(this.threadIds=[e.threadIds]),this.render()},render:l()._preload([h],"_render"),_render:function(){var e=this;this.$el.html(l()({ref:this.template}).render({title:APP.lang.multiple_modal_add_contacts_title})),this.modal=new _.default({init:function(t){t.trigger("modal:loaded").html(e.$el).trigger("modal:centrify")}}),this.showList()},showList:function(){this.subview=new v({threadIds:this.threadIds,container:this._findElem("subviewContainer"),modal:this.modal,parent:this})},showForm:function(){}});var b="../build/transpiled/interface/mail/add_contacts";window.define(b,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([b])},756348:(e,t,i)=>{i.r(t),i.d(t,{default:()=>b});var n=i(661533),s=i.n(n),a=i(629133),o=i.n(a),r=i(345839),l=i.n(r),c=i(460159),d=i.n(c),u=i(313981),_=i(982862),m=i(445368),h=i(69991),p=i(611958);function f(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}var g={},v=/[?:<+](.*)[?:>+]/g,y=/^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[\da-z](?:[\da-z-_]*[\da-z])?\.)+[a-z]{2,}$/i;g[32]=function(e,t){var i=t.$input.prop("selectionStart")===t.value.length;if((y.test(t.value.trim())||f(t.value.match(v),Array))&&i)return e.preventDefault(),this.parseMailboxInput({id:t.cmid||++this.counter,value:t.value,edit:!!t.cmid})},g[8]=function(e,t){var i=s()(e.target).closest(".mail-suggest__list__item"),n=i.data("id");t.value.length||this.deletion_blocked||(i.hasClass("multiple-suggest__list__input")?this.items_collection.remove(this.items_collection.last()):(this.items_collection.remove(this.items_collection.get(n)),this.onSuggestFocus()),this.deletion_blocked=!0)},g[27]=function(e,t){s()(e.target).closest(".mail-suggest__list__item").hasClass("mail-suggest__list__item_in-edit")&&(e.stopImmediatePropagation(),this.active_edits=!1,this.updateMailboxItem(this.items_collection.get(t.cmid)),this._findElem("mail_suggest__list_item_by_id",t.cmid).focus())},g[37]=function(e,t){var i=s()(e.target).closest(".mail-suggest__list__item");t.value.length||i.prev(".mail-suggest__list__item").focus()};const b=u.default.extend({enter_keys:[13,9],mailbox_item_template:{ref:"/tmpl/mail/modal/mailbox_suggest_item.twig"},mailbox_input_template:{ref:"/tmpl/controls/suggest.twig"},events:{"click .multiple-suggest__list":"onSuggestFocus","click .mail-suggest__list__item:not(.multiple-suggest__list__input)":"clickToEditMailbox","keydown .mail-suggest__list__item:focus":"onListItemKeydown","click .tag_close":"clickToRemoveMailbox","keydown .mail-suggest__input":"onMailboxKeydown","keyup .mail-suggest__input":"onMailboxKeyup","paste .mail-suggest__input":"onMailboxPaste","input .mail-suggest__input":"autoStretchInput","blur .mail-suggest__input":"onMailboxBlur","input .mail-suggest__input:not(.mail-suggest__input_in-edit)":"onMailboxInput","mousedown .js-control--suggest--list":"onControlSuggestClickDown","touchstart .js-control--suggest--list":"onControlSuggestClickDown","suggest:changed .control--suggest--input":"onSuggestChanged","suggest:loaded .js-suggest-contact-company-pei":"peiSuggestLoaded"},_selectors:function(){return{parent_div:".mail-suggest.mail-suggest_ext_addresses",mail_suggest__input:".mail-suggest__input",multiple_suggest__list__input:".multiple-suggest__list__input",mail_suggest__list_items:".mail-suggest__list__item[data-id]",mail_suggest__list_item_by_id:".mail-suggest__list__item[data-id=%s]",error_tooltip:".js-error-tooltip",error_element:".mail-suggest__list__item_invalid:first"}},initialize:function(e){u.default.prototype.initialize.call(this),this.options=e||{},this.items_collection=new(l().Collection),this.options.items&&this.setItems(this.options.items),this._$window.on("resize".concat(this.ns),o().debounce(o().bind((function(){this.autoStretchInput(),this.processEmailInputError()}),this),50)),this.counter=this.items_collection.length,this.listenTo(this.items_collection,"add",this.renderMailboxItem),this.listenTo(this.items_collection,"remove",this.removeMailboxItem),this.listenTo(this.items_collection,"reset",this.resetMailboxItems),this.listenTo(this.items_collection,"model:change",this.updateMailboxItem),this.listenTo(this.items_collection,"all",this.autoStretchInput),this.render().then(o().bind((function(){this.autoStretchInput(),this.autoStretchTooltip()}),this))},destroy:function(){this.items_collection.reset(),u.default.prototype.destroy.call(this,!0)},setItems:function(e){var t=[];o().each(e,(function(i){i.id=o().indexOf(e,i)+1,i.name=i.name?i.name:"",t.push(new(l().Model)(i))})),this.items_collection.reset(t)},render:d()._preload(["/tmpl/mail/modal/mailbox_suggest.twig"],"_render"),_render:function(){var e=!!o().isUndefined(this.options.search_contacts)||this.options.search_contacts,t={placeholder:this.options.placeholder||"",input_class_name:"js-suggest-contact-company-pei mail-suggest__input js-form-changes-skip",data_type:this.options.data_type,mailboxes:this.items_collection.toJSON(),label_flag:this.options.label_flag,class_name:this.options.class_name};e&&(t.ajax={url:"/private/ajax/search.php",params:"type=contacts&q=#q#&query_type=email"});var i=s()(d()({ref:"/tmpl/mail/modal/mailbox_suggest.twig"}).render(t));this.setElement(i),this.options.$container.append(i),this._elem("mail_suggest__input").autosizeInput()},onSuggestFocus:function(e){var t=e?s()(e.target):null;e&&(t.closest(".mail-suggest__list__item").length||t.hasClass("mail-suggest__list__item")||this.active_edits)?t.hasClass("js-error-tooltip")&&this._elem("mail_suggest__input").focus():this._elem("mail_suggest__input").focus()},processEmailInputError:function(){var e=this._findElem("error_element"),t=this._elem("error_tooltip"),i=e.position();e.length&&!e.hasClass("mail-suggest__list__item_in-edit")?(i.left+=e.outerWidth(),i.top+=t.outerHeight()-e.outerHeight()-5,t.css(i),t.visible()?t.removeClass("left"):(i.left=e.position().left-t.outerWidth(),i.left-=parseInt(t.css("margin-right")),t.css("left",i.left).addClass("left")),t.show().addClass("showed")):t.removeClass("showed").hide()},onMailboxKeydown:function(e){var t=s()(e.target),i=t.closest(".mail-suggest__list__item"),n=i.find(".control--suggest--list--item-selected"),a=i.data("id"),r=t.val();return o().indexOf(this.enter_keys,e.keyCode)>=0?(e.preventDefault(),e.stopPropagation(),n.length?this.onSuggestChanged(e,n):this.parseMailboxInput({id:a||++this.counter,value:r,edit:!!a})):o().isFunction(g[e.keyCode])?g[e.keyCode].call(this,e,{value:r,cmid:a,$input:t}):void 0},onMailboxKeyup:function(e){8===e.keyCode&&(this.deletion_blocked=!1)},onMailboxInput:function(e){var t=s()(e.target);this.clipboard_paste&&t.val().length&&(this.clipboard_paste=!1,this._elem("mail_suggest__input").val("").trigger("input"))},onMailboxPaste:function(e){var t,i=this,n=s()(e.target).val(),a=e.originalEvent.clipboardData.getData("Text");n.length||(this.clipboard_paste=!0,o().each(this.parseClipboardInput(a),(function(e){i.items_collection.any((function(t){return t.get("email").toLowerCase()===e.email.toLowerCase()}))||(t=!y.test(e.email),i.items_collection.add({id:++i.counter,name:e.name||"",email:e.email,invalid:t}),t&&i.processEmailInputError())})),"ext_addresses"===this.options.data_type&&i.saveChanges(),APP.is_touch_device||this.onSuggestFocus())},onControlSuggestClickDown:function(){this.click_down=!0,setTimeout(o().bind((function(){this.click_down=!1}),this),100)},onMailboxBlur:function(e){var t=s()(e.currentTarget),i=t.closest(".mail-suggest__list__item"),n=t.val().trim(),a=i.data("id");if(!this.click_down&&(i.hasClass("mail-suggest__list__item_in-edit")&&this.active_edits||i.hasClass("multiple-suggest__list__input")))return this.parseMailboxInput({id:a||++this.counter,value:n,edit:!!a,blur:!0})},parseClipboardInput:function(e){for(var t,i=/(?:"?([A-Z][^<"]+)"?\s*)?<?([^>\s,;]+)/g,n=[];t=i.exec(e);)t[1]&&(t[1]=t[1].trim()),n.push({name:t[1],email:t[2]});return n},parseMailboxInput:function(e){var t=e.value.trim(),i=f(t.match(v),Array)?t.match(v).shift().replace(/[<>]/gi,""):"",n=i.length?i:t,s=i.length?t.replace(t.match(v).shift(),"").trim():"",a=y.test(n);return this.processMailboxInput({id:e.id,name:s,email:n,len:t.length,invalid:!a,edit:e.edit,blur:e.blur})},processMailboxInput:function(e){var t;this.active_edits=!1;var i=this.items_collection.any((function(t){if(t.id!==e.id)return t.get("email").toLowerCase()===e.email.toLowerCase()}));e.edit?(t=this.items_collection.get(e.id),i||!e.len?this.items_collection.remove(t):(t.set(e),this.items_collection.trigger("model:change",t))):i||!e.len?this._elem("mail_suggest__input").val("").trigger("input"):this.items_collection.add(e),this.processEmailInputError(),"ext_addresses"===this.options.data_type&&this.old_value!==e.email&&this.saveChanges(),APP.is_touch_device||e.blur||this.onSuggestFocus()},saveChanges:function(){var e=this,t=[];this.items_collection.each((function(e){e.get("invalid")||t.push(e.get("email"))})),p.default.updateExternalAddresses(t).done(o().bind((function(t){e.items_collection.each((function(i){t&&o().has(t,"invalid_emails")&&!o().isEmpty(t.invalid_emails)&&o().each(t.invalid_emails,(function(t){t===i.get("email")&&(i.set("invalid",!0),e.items_collection.trigger("model:change",i))})),i.get("invalid")||i.set("saved",!0)}))}))).fail(o().bind((function(){h.default.commonErrorConfirm()})))},clickToEditMailbox:function(e){var t,i=s()(e.currentTarget).closest(".mail-suggest__list__item"),n=i.data("id"),a=this.items_collection.get(n),r=a.get("name"),l=r?"".concat(r," <").concat(a.get("email"),">"):a.get("email");this.old_value=l,this.active_edits=!0,this.edit_cmid=n,i.hasClass("mail-suggest__list__item_in-edit")||i.hasClass("multiple-suggest__list__input")||(t={placeholder:"",input_class_name:"js-suggest-contact-company-pei mail-suggest__input js-form-changes-skip",type:"email",styled_input:!0},(!!o().isUndefined(this.options.search_contacts)||this.options.search_contacts)&&(t.ajax={url:"/private/ajax/search.php",params:"type=contacts&q=#q#&query_type=email"}),i.html(d()(this.mailbox_input_template).render(t)).addClass("mail-suggest__list__item_in-edit").find("input").val(l).select().autosizeInput(),this.processEmailInputError(),this.autoStretchInput())},clickToRemoveMailbox:function(e){var t=s()(e.target).closest(".mail-suggest__list__item"),i=this.items_collection.get(t.data("id"));e.stopPropagation(),this.items_collection.remove(i)},renderMailboxItem:function(e,t){o().isUndefined(t)&&(t=!0),this._elem("multiple_suggest__list__input").before(d()(this.mailbox_item_template).render(e.toJSON())),t&&this._elem("mail_suggest__input").val("").trigger("input")},updateMailboxItem:function(e){this._findElem("mail_suggest__list_item_by_id",e.id).replaceWith(d()(this.mailbox_item_template).render(e.toJSON())),this.autoStretchInput()},removeMailboxItem:function(e){this._findElem("mail_suggest__list_item_by_id",e.id).remove(),this.processEmailInputError(),"ext_addresses"===this.options.data_type&&e.get("saved")&&this.saveChanges(),this.active_edits=!1},resetMailboxItems:function(){this._findElem("mail_suggest__list_items").remove(),this.items_collection.each((function(e){this.renderMailboxItem(e,!1)}),this),this.active_edits=!1,this._elem("mail_suggest__input").val("").trigger("input")},onListItemKeydown:function(e){var t,i=s()(e.target);37===e.keyCode?i.prev(".mail-suggest__list__item").focus():39===e.keyCode?this.focusNext(i):13===e.keyCode?(e.preventDefault(),e.stopImmediatePropagation(),i.click()):46!==e.keyCode&&8!==e.keyCode||(e.preventDefault(),e.stopImmediatePropagation(),this.focusNext(i),t=this.items_collection.get(i.data("id")),this.items_collection.remove(t))},focusNext:function(e){var t=e.next(".mail-suggest__list__item");t.hasClass("multiple-suggest__list__input")?t.find("input").focus():t.focus()},autoStretchInput:function(){var e=this._elem("mail_suggest__input");e.css("min-width",5);var t=(e.offset()||{}).left,i=this.$el.offset().left,n=this.$el.outerWidth()-(t-i)-15,s=e.attr("placeholder");if(s){var a=(0,_.getTextWidth)(s,e.css("font"));n<a&&(n=a)}this._elem("mail_suggest__input").css("min-width",n)},autoStretchTooltip:function(){var e=this._elem("error_tooltip");e.css("width",e.outerWidth()+1)},peiSuggestLoaded:function(e,t,i){var n=[],a="",r="email";"ok"===t.status?(s().each(t.result,(function(e,t){a=[o().escape(t.element_type===APP.element_types.contacts?(0,m.contactName)(t.name):t.name),t.company_name?', <span style="color: rgba(103,110,121,0.502)">'.concat(o().escape(t.company_name),"</span>"):""].join(""),t[r]&&t[r].length&&(a+='<div class="suggest-item-pei">'.concat(o().escape(t[r].join(", ")),"</div>")),n.push({id:t.id,title:t.name,text:a,raw_highlight:!0})})),i.trigger("suggest:reset",[n])):i.trigger("suggest:reset",[[]])},onSuggestChanged:function(e,t){var i=t.closest(".mail-suggest__list__item"),n=this.active_edits?this.edit_cmid:i.data("id"),s=t.find(".suggest-item-pei").text(),a=t.children(".control--suggest--list--item-inner").prop("title");return this.processMailboxInput({id:n||++this.counter,name:a||"",email:s,invalid:!y.test(s),len:!0,edit:!!n})}});var w="../build/transpiled/interface/mail/mailbox_suggest";window.define(w,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([w])},64076:(e,t,i)=>{i.r(t),i.d(t,{default:()=>o});var n=i(661533),s=i.n(n),a=i(982862);const o={insertMarker:function(e,t){var i=s()(e.target).text(),n=t||s()(this._selector("template_content"));if(n){var o=n.prop("selectionStart"),r=n.val(),l=r.substring(0,o),c=r.substring(o,r.length);n.val(l+i+c).trigger("change"),(0,a.setCursorPosition)(n,l.length+i.length)}}};var r="../build/transpiled/interface/mail/mixins/insert_marker";window.define(r,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([r])},56973:(e,t,i)=>{i.r(t),i.d(t,{default:()=>M});var n,s=i(661533),a=i.n(s),o=i(629133),r=i.n(o),l=i(345839),c=i.n(l),d=i(460159),u=i.n(d),_=i(313981),m=i(656580),h=i(709104),p=i(445368),f=i(184437),g=i(826632),v=i(871741),y=i(266020),b=i(304483),w=i(845043),x=i(245536),E=i(837992),k=i(466072),C=i(923703),P=i(611958);i(168258),i(521170);var A=c().Collection.extend({_pending:!1,nextPageToken:null,initialize:function(e,t){this.options=t||{},this.on("letter:collection:destroy",this.letterDestroy)},fetch:function(e){var t=this;this._pending=!0;var i=this.nextPageToken;return P.default.getMessages(e.id,null,10,this.options.ajax_params,i).done((function(e){var i=(e||{}).next_page_token,n=void 0===i?null:i;t.nextPageToken=n}))},destroy:function(){this.each((function(e){e.destroy()}),this)},letterDestroy:function(e){this.remove({id:e})}}),S=c().Model.extend({initialize:function(){},destroy:function(){}}),T=_.default.extend({events:{"click .thread_letter__message a":"checkOuterHref","click .feed-note__mail-content a":"checkOuterHref","click .js-letter-show-line-contacts":"showContactsInline","click .js-letter-show-all-contacts":"showHiddenContacts","click .js-letter-hide-all-contacts":"hideShownContacts","click .js-letter-show-all-contacts-to":"showAllContactsTo","click .js-letter-show-all-copies":"showAllCopies","click .js-letter-remove":"removeLetter","click .thread_letter__attachment":"getFile",mousedown:"toggleThreadModeStart",click:"toggleThreadModeStop"},errorFlag:!1,_classes:function(){return{load_icon:"thread_letter__attachment-container--loading"}},_selectors:function(){return{contacts:".js-letter-contacts-table",fromShort:".thread-letter__contacts-from_short",fromFull:".thread-letter__contacts-from_full",toShort:".thread-letter__contacts-to_short",toLine:".thread-letter__contacts-to_line",toFull:".thread-letter__contacts-to_full",toAll:".thread-letter__contacts-to_all",copies:".thread_letter__copy",copiesAll:".thread-letter__copy_all",attachment:".thread_letter__attachment",attachment_loader:".thread_letter__attachment-loader"}},initialize:function(e){this.active_ajaxes={},this.in_modal=e.in_modal},destroy:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];r().each(this.active_ajaxes,(function(e){e.abort()})),_.default.prototype.destroy.apply(this,t)},checkOuterHref:function(e){var t=a()(e.currentTarget),i=t.attr("href");i.indexOf(window.location.host)<0&&!t.attr("target")&&(e.preventDefault(),window.open(i,"_blank"))},_createErrorModal:function(e){var t=this;return new w.default({class_name:"modal-list file_error_modal",accept_text:"ОК",should_be_raw:!0,text:'<span class="file_error">'.concat(e,"</span>"),destroy:function(){t.errorFlag=!1}})},getFile:function(e){if(e.preventDefault(),e.stopPropagation(),!a()(e.currentTarget).hasClass("thread_letter__attachment_blocked")){if("archived"!==a()(e.currentTarget).data("state")){var t,i=a()(e.currentTarget),n=i.parents(".thread_letter__attachment-container"),s="".concat(i.data("id")),o=this,l=0,c=3e3,d=r().bind(this._createErrorModal,this),u=function(){n.removeClass("thread_letter__attachment-container--loading"),delete o.active_ajaxes[s]},_=function(e,i){var n;u(),"abort"!==i&&(e.responseJSON&&"fail"===(n=e.responseJSON).status?o.errorFlag||(t=APP.lang["file_error_".concat(n.code)],r().isUndefined(t)&&(t=APP.lang.file_error_unknown),d(t),o.errorFlag=!0):o.errorFlag||(t=APP.lang.file_error_load_failed,d(t),o.errorFlag=!0))},m=function(){o.active_ajaxes[s]=P.default.getAttachment(s).done((function(e){switch(e.status){case"not_downloaded":o.active_ajaxes[s]=P.default.fetchAttachment(s).done((function(){l>1?(u(),d(APP.lang.file_error_load_failed)):(l++,setTimeout(m,c))})).fail(_);break;case"processing":setTimeout(m,c),c*=1.5;break;case"complete":u(),window.open(e.url,"_self");break;case"fail":u(),o.errorFlag||(t=APP.lang["file_error_".concat(e.code)],r().isUndefined(t)&&(t=APP.lang.file_error_unknown),d(t),o.errorFlag=!0)}})).fail(_)};return o.active_ajaxes[s]||(o._addClass("load_icon",n),m()),!1}this._createErrorModal((0,p.i18n)("You haven’t visited your account for a long time, so we’ve archived and safely stored your data. When you’re ready to access your data again, please contact our tech support in the chat."))}},showContactsInline:function(){var e=this._findElem("toShort"),t=this._findElem("toLine");e.hide(),t.css({display:"inline-block"}),this.in_modal&&a()(".modal-body").trigger("modal:centrify")},showHiddenContacts:function(){var e=this._elem("fromShort"),t=this._elem("fromFull"),i=this._elem("contacts"),n=this._findElem("toLine");i.css({display:"table"}),e.hide(),t.css({display:"inline-block"}),n.hide(),this.showFullContactsTo(),this.showFullCopies(),this.in_modal&&a()(".modal-body").trigger("modal:centrify")},hideShownContacts:function(){var e=this._elem("fromShort"),t=this._elem("fromFull");this._elem("contacts").hide(),e.css({display:"inline-block"}),t.hide(),this.hideFullContactsTo(),this.hideFullCopies(),this.in_modal&&a()(".modal-body").trigger("modal:centrify")},showFullContactsTo:function(){var e=this._elem("toShort"),t=this._elem("toFull");e.hide(),t.css({display:"inline-block"}),this.in_modal&&a()(".modal-body").trigger("modal:centrify")},showAllContactsTo:function(){var e=this._elem("toFull"),t=this._elem("toAll");e.hide(),t.css({display:"inline-block"}),this.in_modal&&a()(".modal-body").trigger("modal:centrify")},hideFullContactsTo:function(){var e=this._elem("toShort"),t=this._elem("toFull"),i=this._elem("toAll");e.css({display:"inline-block"}),t.hide(),i.hide(),this.in_modal&&a()(".modal-body").trigger("modal:centrify")},showFullCopies:function(){var e=this._elem("copies"),t=this._elem("copiesAll");e.css({display:"inline-block"}),t.hide(),this.in_modal&&a()(".modal-body").trigger("modal:centrify")},showAllCopies:function(){var e=this._elem("copies"),t=this._elem("copiesAll");e.hide(),t.css({display:"inline-block"}),this.in_modal&&a()(".modal-body").trigger("modal:centrify")},hideFullCopies:function(){var e=this._elem("copies"),t=this._elem("copiesAll");e.hide(),t.hide(),this.in_modal&&a()(".modal-body").trigger("modal:centrify")},removeLetter:function(){var e=this;new w.default({text:APP.lang.mail_letter_remove_confirm,destroy:function(){this.accepted&&e.$el.trigger("letter:field:remove",e.id).remove()}})},toggleThreadModeStart:function(){this.is_fast_click=!0,r().delay(r().bind((function(){this.is_fast_click=!1}),this),300)},toggleThreadModeStop:function(e){var t=e.which,i=e.button,n=(0,f.getSelectedText)();this.is_fast_click&&(1!==t&&0!==i||0!==n.length||this.$el.toggleClass("feed-note-wrapper-mail_message--opened"))}});const M=_.default.extend({modal:null,ready:!1,ns:".thread",list:null,compose_data:{},events:{"click .js-mail_thread__create_contact":"createLinkedEntity","click .js-mail_thread__create_lead":"createLinkedEntity","click .js-mail_thread__create_customer":"createLinkedEntity","click .js-mail_thread__link_lead":"onClickLinkLead","click #search_clear_button":"onClickCloseSearch","click .js-mail_thread__delete_thread":"onClickDeleteThread","click .js-mail_thread__restore_thread":"onClickRestoreThread","click .js-linked-entity-unlink":"unlinkLead","click .js-thread-letter-email":"createLinkedEntity","click .js-thread-letter-email-blocked":"createLinkedEntityBlocked","click .js-mail_thread__write_mail":"writeMail","letter:field:remove .thread_letter__holder":"removeLetter","input .js-control--suggest--input-ajax":"onSuggestInput","keydown .js-control--suggest--input-ajax":"onSuggestKeydown","click .mail_thread__action .control--suggest--list--item":"onItemClick","click .feed-compose.minimized":"toggleCompose","click .js-note-edit-cancel":"cancel"},_selectors:function(){return{actions:".mail_thread__actions",buttons:".mail_thread__action_buttons",thread_caption:".mail_thread__caption",thread_wrapper:".mail_thread__wrapper",letter_wrapper:".thread_letter__holder",close_search_button:"#search_clear_button",link_button_action:"#link-button-action",suggest_action:"#suggest-action",suggest_input:".js-control--suggest--input-ajax",suggest_list:".js-control--suggest--list",card_scroller_fake:".card-scroller-fake",modal_body:".modal-body",delete_button_action:"#mail_thread__delete_thread",restore_button_action:"#mail_thread__restore_thread",overlay:"#thread_change_loader",spinner:"#thread_spinner",compose:".feed-compose",scroller_inner:".notes-wrapper__scroller-inner",custom_scroll:".notes-wrapper__scroller.custom-scroll"}},parent:null,hasChanges:function(){return n},initialize:function(e){var t=this;_.default.prototype.initialize.call(this,arguments),a()(window).on("scroll.thread wheel.thread touchmove.thread",(function(){t.setSpinnerPosition()})),n=e.needReloadList||!1,this.parent=e.parent,this.initOptions(e),this.setComposeData(),this.getAjaxLetters()},showOverlay:function(){this.hideOverlay(),this.$el.find("#thread_change_loader").length?this.$page_change_overlay=a()("#thread_change_loader"):(this.$page_change_overlay=a()('<div class="default-overlay" id="thread_change_loader" style="background: rgba(255,255,255,0.4);z-index: 22;"><span id="thread_spinner" class="spinner-icon spinner-icon-abs-center"></span></div>'),this.$el.append(this.$page_change_overlay)),this.setSpinnerPosition(),this.$page_change_overlay.trigger("overlay:show")},hideOverlay:function(){this.options.params.in_modal?this.$page_change_overlay&&this.$page_change_overlay.trigger("overlay:hide"):a()(document).trigger("page:hide:overlay")},setSpinnerPosition:function(){var e=this._findElem("spinner");if(e.length){var t,i=window.scrollY||window.pageYOffset,n=a()(window).height(),s=e.parent(),o=s.offset().top,r=s.height(),l=i-o,c=l+n;l<0&&(l=0),c>r&&(c=r),t=l+(c-l)/2-25,e.css({top:t})}},setListChanged:function(){n=!0},onItemClick:function(e){var t=this,i=a()(e.currentTarget).data("value-id"),n=this.options.params.id;this.showOverlay(),C.default.linkLead(n,i).done((function(){t.setListChanged(),t.reload(),(new b.default).showSuccess()})).fail((function(e){var i=JSON.parse(e.responseText)||{};i.message_code&&"api_unavailable"===i.message_code&&(new b.default({init:t.reload.bind(t)}).showError(APP.lang["mail_error_".concat(i.message_code)],!1),t.setListChanged())}))},onSuggestInput:function(e){var t=this,i=a()(e.currentTarget).parent(),n=i.find(this._selector("suggest_list")),s=this._findElem("suggest_input"),o=s.val().trim(),r=this._findElem("close_search_button");o.length>=3?(i.hasClass("control--suggest-loading")||(r.hide(),i.addClass("control--suggest-loading").append('<span class="control--suggest--loader spinner-icon"></span>')),a().ajax({url:s.data("url"),type:"GET",data:{term:o},success:function(e){var s=e.response.items.leads.other;s.length&&n.removeClass("control--suggest--list").addClass("control--suggest--list-opened").css("display",""),s.length>15&&(s=s.splice(0,15)),t.renderSuggest(s),i.removeClass("control--suggest-loading").children(".control--suggest--loader").remove(),r.show()}})):(n.html("").removeClass("control--suggest--list-opened").addClass("control--suggest--list"),i.css("z-index","").children(".control--suggest--loader").remove())},renderSuggest:function(e){var t=[],i=this._findElem("suggest_list");e.length?(r().each(e,(function(e){t.push({id:e.id,title:[e.name,(0,p.contactName)(e.contact_name),e.company_name].join(", "),type:APP.element_types.leads,text:u()({ref:"/tmpl/mail/suggest.twig"}).render({name:e.name,contact_name:e.contact_name,company_name:e.company_name,type:"lead"}),raw_highlight:!0})}),this),i.trigger("suggest:reset",[t])):i.trigger("suggest:reset",[[]])},checkAsRead:function(){var e=this,t=this.id;C.default.readThread(t).done((function(){a()(document).trigger("mail:update:counter"),e.setListChanged()}))},destroy:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];a()(document).trigger("thread:closing"),a()(window).off(this.ns),a()(document).off("controls:hide:only"),this.letters_collection&&this.letters_collection.destroy(),_.default.prototype.destroy.apply(this,t)},reload:function(e){e&&this.setListChanged(),this.getAjaxLetters()},initOptions:function(e){e=r().extend({filter:{}},e),this.options={params:e,items:{}}},setComposeData:function(){this.id&&C.default.getThreadReplyData(this.id).then(r().bind((function(e){r().each(e.to,(function(e){e.name||(e.name=""),e.email=[e.email],e.element_type=APP.element_types.mail})),e.element_type=e.type,this.compose_data=e}),this))},getAjaxLetters:function(){var e,t,i,n,s=this,a={no_loader:this.options.params.in_modal};Promise.all([P.default.getThread(this.options.params.id),P.default.getMessages(this.options.params.id,null,10,a),m.default.getPipelinesWithUnsorted(),(0,h.getCustomersPeriods)()]).then((function(a){e=a[0],t=a[1],i=a[2].pipelines,n=a[3],s.options.params.in_modal||(e.status_info=s.getStatusInfo(e,i,n)),s.options.params.in_modal||APP.first_load?s.onSuccess(e,t):s.options.params.animationEnd.done((function(){s.onSuccess(e,t)}))})).catch((function(e){s.options.params.in_modal||!s.options.params.in_side_card?s.renderError(e):s.options.params.animationEnd.done((function(){s.renderError(e)}))}))},getStatusInfo:function(e,t,i){var n={},s={};return e.entity&&e.entity.status_id&&((n=r().map(t,(function(e){return e.statuses}))).push(i),n=r().flatten(n),(s=r().findWhere(n,{id:e.entity.status_id})||{}).pipeline_id&&t[s.pipeline_id]&&(s.pipeline_name=t[s.pipeline_id].name)),s},renderError:function(e){var t,i,n=this.$el;switch(e.status){case 403:i=APP.lang.mail_letter_view_forbidden,t="/tmpl/mail/thread/403page.twig";break;case 410:i=APP.lang.mail_letter_deleted,t="/tmpl/mail/thread/404page.twig";break;default:i=APP.lang.page_404_caption,t="/tmpl/mail/thread/403page.twig"}this.options.params.in_modal?this.options.params.modalShowError(i,!1):u()._preload([t],(function(){n.append(u()({ref:t}).render({title:i,text:(0,p.i18n)("page_404_mail_text")}))}))(),this.options.params.onload.call(this,!0)},onSuccess:u()._preload(["/tmpl/mail/thread/card.twig","/tmpl/mail/suggest.twig","/tmpl/customers/common/add_entity_customer.twig","/tmpl/mail/thread/404page.twig","/tmpl/mail/thread/403page.twig","/tmpl/mail/thread/message.twig"],"_onSuccess"),_onSuccess:function(e,t){e.unread&&this.checkAsRead(),this.options.actions=e.actions,this.options.items=t.items,this.options.thread_id=e.id,this.options.thread_name=e.name,this.options.entity=e.entity,this.options.status_info=e.status_info,this.options.total_messages=+t.total,this.options.next_page_token=t.next_page_token,this.renderLetters()},renderLetters:function(){this.options.params.in_modal||(APP.setTitle(this.options.thread_name),this.options.params.onload.call(this,!0));var e=[{svg_icon_absolute:"dashboard--open-pipeline",text:APP.lang.card_to_card,class_name:"js-linked-entity-show",href:this.options.entity?this.options.entity.url:"#"}];this.options.entity&&this.options.actions.unlink&&e.push({icon:"unlink",class_name:"js-linked-entity-unlink",text:APP.lang.card_unlink,enabled:this.options.actions.unlink||!1});var t={items:this.options.items,name:this.options.thread_name,template:this.options.params,in_modal:this.options.params.in_modal,entity:this.options.entity,status_info:this.options.status_info,first_load:APP.first_load||!APP.data.current_list,actions:this.options.actions,more_items:e,ajax:{url:"/ajax/v1/elements/list",params:"term=#q#"},leads:[]};this.options.params.reverse&&t.items.reverse(),t.entity&&"lead"===t.entity.type&&""===t.entity.name&&(t.entity.name="#".concat(t.entity.id));var i=a()(u()({ref:"/tmpl/mail/thread/card.twig"}).render(t));i.find(".thread_letter__message_container a").each((function(e){a()(e).attr({rel:"nofollow",target:"_blank"})})),i.find(".feed-note__mail-content-summary_text font").each((function(e,t){a()(t).attr("size","fix")})),i.find(".thread_letter__message font").each((function(e,t){a()(t).attr("size","fix")})),this.$el.empty().append(i),this.initCollection(),this.options.params.in_modal&&this.options.params.onload.call(this,!0),this._findElem("card_scroller_fake").hide(),this.$el.find(".thread_letter__message_inner").each((function(){var e=a()(this);new g.default({$wrapper:e.parent(),$scroller:e,selectable_content:!0})})),this.delegateEvents(),this.onClickCloseSearch(),this.options.params.in_modal||this.hideOverlay(),this.compose=this._addComponent(y.default,{_type:"email",$notes_scroller:a()(".notes-wrapper__scroller.custom-scroll"),getExtraData:r().bind(this._getExtraData,this),getMailComposeData:r().bind(this._fetchMailComposeData,this),getMainContactId:r().bind(this._getMainContactId,this),onAdd:r().bind(this._addMessage,this),onCancel:r().noop,onToggleClassModificator:r().bind(this._toggleClassModificator,this)}),this._findElem("compose").find(".feed-compose__inner").html("").append(this.compose.el),this.compose.edit(!1),this.scrollThreadBottom(),this.initLoader(this.options.params.in_modal?a()(".modal-scroller"):this.$(".notes-wrapper__scroller"),this.options.params.reverse?{"max-top":300}:{"max-bottom":300}),this.ready=!0},initLoader:function(e,t){this._addComponent(k.default,{element:e.get(0),conditions:t,throttle:100,onLoadMore:r().bind(this.loadMore,this)})},loadMore:function(e){this.letters_collection._pending||this.options.total_messages===this.letters_collection.length||this.letters_collection.fetch({id:this.id}).then(r().bind((function(t){this.insertLoadedMessages(t.items),this.letters_collection._pending=!1,e&&this.fetchNextPage()}),this))},fetchNextPage:function(){this.letters_collection.nextPageToken&&this.options.total_messages!==this.letters_collection.length&&this.letters_collection.length<10&&this.loadMore(!0)},_addMessage:function(e){this.letters_collection.fetch({id:e}).then(r().bind((function(t){this.letters_collection._pending=!1,this.options.params.id?(this.compose.cleanView(),this.cancel(),+this.options.params.id==+e&&(this.options.items=t.items,this.insertLastMessage(r().first(t.items)),this.scrollThreadBottom(),this.hideOverlay())):this.initNewThread(e,r().first(t.items))}),this))},insertLoadedMessages:function(e){var t,i=[],n=this._elem("custom_scroll").scrollTop(),s=this._elem("scroller_inner").height(),o=this.options.params.in_modal?"/tmpl/mail/thread/letter.twig":"/tmpl/mail/thread/message.twig";this.options.params.reverse&&(e=e.reverse()),r().each(e,r().bind((function(e){t=a()(u()({ref:o}).render({item:e})),i.push(t),this.letters_collection.push(this.addLetter(t,e).model)}),this)),this.options.params.in_modal?this.$el.find(".mail_thread__list").append(i):this.$el.find(".js-notes").prepend(i),this._elem("custom_scroll").scrollTop(n+this._elem("scroller_inner").height()-s)},insertLastMessage:function(e){var t=a()(u()({ref:"/tmpl/mail/thread/message.twig"}).render({item:e}));this.$el.find(".js-notes").append(t),this._animateInsert(t[0]),this.addLetter(t,e)},toggleCompose:function(){this._findElem("compose").hasClass("minimized")&&(this._findElem("compose").removeClass("minimized"),this.compose.onOpenCompose())},cancel:function(){this._findElem("compose").addClass("minimized")},_getExtraData:function(){return this.id?{elements:this.compose_data.to,chats:{}}:{elements:{},chats:{}}},_getMainContactId:function(){if(APP.data.current_card)return APP.data.current_card.getMainContactId()},_fetchMailComposeData:function(){return this.id?C.default.getThreadReplyData(this.id).then(r().bind((function(e){return[e]}))):a().Deferred()},_toggleClassModificator:function(e,t){t?this.$el.addClass(e):this.$el.removeClass(e)},onClickLinkLead:function(){var e=this._findElem("close_search_button"),t=this._findElem("link_button_action"),i=this._findElem("suggest_action");this.$el.addClass("search-active"),e.show(),t.addClass("hidden-block"),i.removeClass("hidden-block"),this._findElem("suggest_input").focus()},onSuggestKeydown:function(e){if("Enter"===e.originalEvent.key){e.preventDefault(),e.stopPropagation();var t=this._findElem("suggest_list").find(".control--suggest--list--item-selected");return t.length?this.onItemClick({currentTarget:t.get(0),preventDefault:r().noop}):void 0}},onClickCloseSearch:function(){var e=this._findElem("link_button_action"),t=this._findElem("suggest_action");this.$el.removeClass("search-active"),e.removeClass("hidden-block"),t.addClass("hidden-block"),this._findElem("suggest_input").val(""),this._findElem("suggest_list").empty().hide()},unlinkLead:function(){var e=this,t=this.options.params.id;this.showOverlay(),P.default.unlinkThread(t).done((function(){e.setListChanged(),e.reload()})).fail((function(t){var i=JSON.parse(t.responseText)||{};i.error_code&&"api_unavailable"===i.error_code&&(new b.default({init:e.reload.bind(e)}).showError(APP.lang["mail_error_".concat(i.error_code)],!1),e.setListChanged())}))},initCollection:function(){var e=this.options.items;this.letters_collection=new A([],{ajax_params:{no_loader:this.options.params.in_modal}});var t=this.options.next_page_token;t&&(this.letters_collection.nextPageToken=t),r().each(e,(function(e){this.letters_collection.push(this.addLetter(a()("#thread_letter_".concat(e.id)),e).model)}),this),r().defer(r().bind(this.fetchNextPage,this))},addLetter:function(e,t){return this._addComponent(T,{el:e,model:new S(t),id:t.id,unread:!!t.unread,sent:!!t.sent,in_modal:this.options.params.in_modal})},createLinkedEntity:function(e){var t=a()(e.currentTarget).attr("data-entity");this.callLinkModal(t)},createLinkedEntityBlocked:function(){(new b.default).showError(APP.lang.mail_letter_create_contact_blocked,!1)},callLinkModal:function(e,t){var i,n,s=this,o=a().Deferred(),l=a().Deferred(),c={id:this.id,entity:e,from_list:!1,from_card:!0,subEntity:"".concat(e,"s"),in_modal:this.options.params.in_modal,done:o,changing:l};t=t||this.id,"customer"===e&&(c=r().extend(c,{template:"/tmpl/customers/common/add_entity_customer.twig"})),this.onClickCloseSearch(),o.done(this.reload.bind(this)),l.done((function(){s.setListChanged()})),i=t,(null!=(n=Array)&&"undefined"!=typeof Symbol&&n[Symbol.hasInstance]?n[Symbol.hasInstance](i):i instanceof n)||(t=[+t]),new x.default(c)},createLinkedContact:function(){this.modal=new v.default({threadIds:this.options.thread_id,card:this})},removeLetter:function(e,t){this.letters_collection.trigger("letter:collection:destroy",t)},getLastRecipient:function(){var e=r().findWhere(this.options.items,{sent:!1});return e?e.to:null},writeMail:function(){!0===this.options.params.in_modal?C.default.getThreadReplyData(this.options.thread_id).then(r().bind((function(e){e=r().extend(e,{from:this.getLastRecipient()}),a()(document).trigger("notes:compose:switch",["email",e]),this.options.params.destroyFromReply()}),this)):this.modal=new E.default({entity:APP.data.current_entity,sub_entity:"reply",from_card:!0,id:[this.options.thread_id],box_id:this.mailbox,in_modal:this.options.params.in_modal,setNeedReload:r().bind(this.setListChanged,this)},this)},scrollThreadBottom:function(){this.$(".notes-wrapper__scroller.custom-scroll").scrollTop(this.$(".notes-wrapper__scroller-inner").height())},initNewThread:function(e){this.options.params.id=e,this.id=e,APP.router.navigate("/mail/thread/".concat(e),{trigger:!1,replace:!0}),this.setComposeData(),this.getAjaxLetters()},_animateInsert:r().throttle((function(e){e.classList.add("feed-note-wrapper_animate-entrance"),a()(e).one(APP.animation_event,r().bind((function(){e.classList.remove("feed-note-wrapper_animate-entrance")}),this))}),0,{leading:!1})});var j="../build/transpiled/interface/mail/thread";window.define(j,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([j])},410462:(e,t,i)=>{i.r(t),i.d(t,{default:()=>m});var n=i(629133),s=i.n(n),a=i(974839),o=i.n(a),r=i(365503),l=i(439182),c=i(604197),d=i(418860),u=i(661533),_=s().invert(APP.element_types);const m=o().Collection.extend({url:function(e){var t=_[this.element_type];switch(!0){case"stats"===e&&!s().isUndefined(this.element_id):return"/ajax/v3/".concat(t,"/").concat(this.element_id,"/stats");case!this.links&&!s().isUndefined(this.element_id):return"catalog_elements"===t&&s().propertyOf(this)(["element_info","catalog_id"])?"/ajax/v3/catalogs/".concat(this.element_info.catalog_id,"/elements/").concat(this.element_id,"/timeline"):"/ajax/v3/".concat(t,"/").concat(this.element_id,"/timeline");case this.hasNextPage()&&!s().isUndefined(this.links):return this.links.next;default:return""}},model:l.default,initialize:function(e,t){this.tasks_results=new r.default,this.element_id=t.element_id,this.element_type=t.element_type,this.element_info=t.element_info,this.on("add",this._setVisible,this)},parse:function(e,t){var i;if(t=t||{},!e||s().isArray(e)&&!e.length)return this.links={},[];e=JSON.parse(e),this._pending=!1,i=s().clone(e._embedded.items),s().each(i,(function(e){e.date_create&&e.msec_created_at&&(e._date_create=e.date_create,e.date_create=e.msec_created_at),e.type===d.default.INVOICE&&(e.currency_code=(0,c.getCurrencyCode)(this.element_info.currency_id))}),this),this.tasks_results.add(s().values(e._embedded.tasks_results));var n=o().Collection.prototype.parse.apply(this,[e]);return t.silent||this.trigger("fetched",i),n},hasNextPage:function(){return s().isUndefined(this.links)||this.links&&this.links.next},reset:function(e){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).silent&&delete this.links,o().Collection.prototype.reset.apply(this,arguments)},_fetch:function(e){return e=s().extend(e||{},{remove:!1,dataType:"text"}),o().Collection.prototype.fetch.call(this,e)},fetch:function(e){var t=u.Deferred(),i=s().bind((function(e){this._pending=!1,t.resolve(e)}),this);return this.url()?(this._pending=!0,this._fetch(e).then(i,i),t.promise()):t.resolve([])},_prepareModel:function(e,t){return t=s().extend(t||{},{parse:!1}),e.date_create&&e.msec_created_at&&(e._date_create||(e._date_create=e.date_create),e.date_create=e.msec_created_at),o().Collection.prototype._prepareModel.call(this,e,t)},getStats:function(){return u.ajax({url:this.url("stats"),type:"GET",dataType:"json"}).then((function(e){return[{id:this.element_id,count:e.notes||0,users:s().map(e._embedded.users,(function(e){return{id:e.id,count:e.notes}})),calls:e.calls||{},letters:e.letters||0,tasks:e.tasks||{},visited_pages:e.visited_pages||{}}]}))}});var h="../build/transpiled/interface/notes/collection";window.define(h,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([h])},365503:(e,t,i)=>{i.r(t),i.d(t,{default:()=>o});var n=i(974839),s=i.n(n),a=i(439182);const o=s().Collection.extend({model:a.default});var r="../build/transpiled/interface/notes/results_collection";window.define(r,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([r])},238935:(e,t,i)=>{i.r(t),i.d(t,{default:()=>r});var n=i(214558),s=i(611958),a={},o=function(e,t){return new Promise((function(i,n){a[e]?i(a[e]):t().then((function(t){a[e]=t,i(a[e])}),n)}))};const r={flush:function(){a={}},get:function(e){switch(e){case"signature":return o("signature",(function(){return s.default.getUserSignature((0,n.current)("id"))}));case"templates":return o("templates",(function(){return s.default.getTemplates()}));case"compose":return o("compose",(function(){return s.default.getMailboxes("compose")}))}}};var l="../build/transpiled/interface/notes/utils/mail_provider";window.define(l,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([l])},266020:(e,t,i)=>{i.r(t),i.d(t,{default:()=>T});var n=i(629133),s=i.n(n),a=i(460159),o=i.n(a),r=i(162262),l=i.n(r),c=i(267651),d=i.n(c),u=i(445368),_=i(184437),m=i(955026),h=i(214558),p=i(859200),f=i(926168),g=i(131258),v=i(23456),y=i(500034),b=i(915656),w=i(238935),x=i(718758),E=i(429512),k=i(410462),C=i(611958),P=i(785557),A=i(353256),S=i(661533);const T=b.default.extend({className:"feed-compose__inner_mail",file_uploader_component:x.default,events:s().extend({},b.default.prototype.events||{},{"input .feed-compose__message-area[contenteditable]":"checkForm","change .js-control-wysiwyg .js-wysiwyg-input":"onChange","input .js-compose-mail-subject_field-container input":"checkForm","input .js-compose-mail-to_field-container input":"checkForm","input .js-compose-mail-cc_field-container input":"checkForm","controls:change .js-compose-mail-subject_field-container input":"checkForm","controls:change #mail-template":"onTemplateChange"}),_classes:function(){return s().extend({},b.default.prototype._classes.apply(this)||{},{to_container:"js-compose-mail-to_field-container",cc_container:"js-compose-mail-cc_field-container",subject_container:"js-compose-mail-subject_field-container",sender_container:"js-compose-mail-sender_field-container",content_type:"js-mail-content-type",templates_line:"js-compose-mail-templates",templates_container:"js-compose-mail-templates_field-container"})},_selectors:function(){return s().extend({},b.default.prototype._selectors.apply(this)||{},{subject_input:".js-compose-mail-subject_field-container input",sender_input:".js-compose-mail-sender_field-container input",recepient_input:".js-compose-mail-to_field-container input",textarea:".js-wysiwyg-input",textarea_input:".js-control-wysiwyg .ql-editor[contenteditable]",file_input:"#mail-attach-filenew",mail_template:"#mail-template",wysiwyg_area:".js-control-wysiwyg",simple_area:".js-control-contenteditable",simple_area_wrapper:".feed-compose__message-wrapper",simple_area_input:".js-control-contenteditable .control-contenteditable__area"})},_getTemplate:function(){return"/tmpl/notes/adding/mail.twig"},onChange:function(){var e=this._findElem("textarea_input").text();((0,y.isFeatureAvailable)("airewriter")||(0,y.isFeatureAvailable)("kommo_ai_trial_started")&&!(0,y.isFeatureAvailable)("kommo_ai_trial_ended"))&&(d().publish(A.FEED_COMPOSE_INPUT_CHANGE,e),this.toggleAiRewrite(e)),this.checkForm()},_getRenderParams:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return s().extend({emails:this.emails,is_mail_en:"mail"===APP.getBaseEntity()&&"en"===APP.lang_id},b.default.prototype._getRenderParams.apply(this,t))},_putCursorToEnd:s().noop,getExistingText:function(){return""},getText:function(){return this._findElem("textarea_input").text().trim()},setTextFromAiHelpers:function(e){var t=e.text;(0,y.isFeatureAvailable)("ai_rewriter_fast_reply")&&(null==e?void 0:e.isAnswer)&&(t=this._elem("textarea").text()+(e.text||"")),this.setExistingText(t)},setExistingText:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"")||this.options.text;((0,y.isFeatureAvailable)("airewriter")||(0,y.isFeatureAvailable)("kommo_ai_trial_started")&&!(0,y.isFeatureAvailable)("kommo_ai_trial_ended"))&&this._elem("wysiwyg_area").trigger("control:input:change",e),this._elem("textarea").val(e).trigger("change"),this.$(".control--select--input").trigger("controls:change:visual"),((0,y.isFeatureAvailable)("airewriter")||(0,y.isFeatureAvailable)("kommo_ai_trial_started")&&!(0,y.isFeatureAvailable)("kommo_ai_trial_ended"))&&this.toggleAiRewrite(e)},_getLastRecipient:function(e){return e&&e.get("data").params.to?e.get("data").params.to.email:null},onKeyPressed:s().noop,onOpenCompose:function(){var e=this.options.$notes_scroller,t=e.find(".js-notes-filter-and-chat-users"),i=e[0].scrollHeight>e[0].offsetHeight;t.length&&i&&t.css("margin-top",115),this._findElem("wysiwyg_area").show(),this._findElem("simple_area_wrapper").hide(),this.$el.find("textarea").autosize(),(0,u.stripTags)(this._form.model.get("message"))||this.updateSignature(),(0,_.setCursorPosition)(this._elem("textarea_input"),0),this._renderTemplates(),this._actualizeRecipients(),this.emails.length||this._$document.trigger("notes:compose:switch",["note"])},onFoldCompose:function(){this.options.$notes_scroller.find(".js-notes-filter-and-chat-users").css("margin-top",""),this._actualizeRecipients()},minimizeOrCancel:function(){return!!this._form.hasChanges()},initialize:function(e){this.options=e||{},this.recipient_types=["to","cc"],s().isFunction(this.options.getLastTimelineEmail)?this.last_recipient=this._getLastRecipient(this.options.getLastTimelineEmail()):this.last_recipient=null,this.subviews=[],b.default.prototype.initialize.call(this,e),l().mixin(this,E.default),s().bindAll(this,"loadMailboxData","loadComposeData","loadSignature","_renderSender","cleanView"),this.model.set("mailboxes",[])},setParamsOnSwitch:function(){var e,t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=this,a=!s().isArray(i.to),o=a?i.email:s().first(i.to).email,r=a?"":i.subject,l=s().propertyOf(i)(["from"]);o&&(this._findElem("to_container").one("controls:view:init",(function(e){S(e.target).find("input").val(o).trigger("controls:change:visual")})),this._findElem("to_container").find("input").val(o).trigger("controls:change:visual"),this._findElem("subject_input").val(r).trigger("controls:change")),l&&this._findElem("sender_container").one("controls:view:init",(function(a){(e=n.model.get("mailboxes")).length&&(t=s().findWhere(e,{option:i.from[0].email}))&&S(a.target).find("input").val(t.id).trigger("controls:change:visual")}))},destroy:function(e){this.onFoldCompose(),this.stopListening(this.model),b.default.prototype.cancel.apply(this,arguments),b.default.prototype.destroy.call(this,e)},_render:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];b.default.prototype._render.apply(this,t),this._actualizeRecipients(),this.listenTo(this.model,"change:subject",this.updateSubject),this.listenTo(this.model,"change:templates",this._renderTemplates),this.listenTo(this.model,"change:signature",this.updateSignature),this.listenTo(this.model,"change:mailboxes",this._renderSender),this.loadData().then(s().bind(this._renderSender,this)),this.$el.attr("class","js-note feed-compose_mail")},updateSignature:function(){var e=this.model.get("signature")?this.model.get("signature"):"",t=e?"<p><br></p>".concat(e):"";this._findElem("textarea").val(t).trigger("input")},edit:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];b.default.prototype.edit.apply(this,t),this.listenTo(this._form.model,"has_reverted",this._renderSender)},save:function(){return new Promise(s().bind((function(e,t){var i=this;if("Y"===this._findElem("submit").attr("data-loading"))return t();this._findElem("submit").trigger("button:load:start",["white"]),this._findElem("cancel").hide(),this._findElem("textarea").prop("disabled",!0),((0,y.isFeatureAvailable)("airewriter")||(0,y.isFeatureAvailable)("kommo_ai_trial_started")&&!(0,y.isFeatureAvailable)("kommo_ai_trial_ended"))&&d().publish(A.FEED_COMPOSE_SUBMIT);var n=function(){i._findElem("textarea").prop("disabled",!1),i._findElem("cancel").show(),i._findElem("submit").trigger("button:load:stop")};this._preUploadFiles().then(s().bind(this.send,this),s().bind((function(){n(),t()}),this)).then(s().bind((function(e){this.showNotes(e.message_id).then(s().bind((function(){n(),this.cleanView()}),this))}),this)).then(e,t)}),this))},_getLinkedEmails:function(){return s().chain(this.options.getExtraData().elements).reduce((function(e,t){return e.concat(s().map(t.email,(function(e){var i=s().isUndefined(t.name)?"":t.name;return{element_id:t.id,id:e,name:i,option:i?"".concat(i," <").concat(e,">"):e}})))}),[]).uniq((function(e){return e.id})).value()},loadData:function(){return this.data_promise||(this.data_promise=S.when(this.loadComposeData(),this.loadTemplatesData(),this.loadMailboxData(),this.loadSignature())),this.data_promise.promise()},loadTemplatesData:function(){return w.default.get("templates").then(s().bind((function(e){this.model.set("templates",s().map(e,(function(e){return{id:e.id,option:e.name,content_type:e.fields&&e.fields.type||"text"}})))}),this))},loadMailboxData:function(){var e=this,t=parseInt((0,h.current)("id"));return w.default.get("compose").then((function(i){var n=s().chain(i).map((function(e){return{id:e.id,option:e.email,user_id:e.user_id,type:e.type}})).sort((function(e,i){switch(t){case parseInt(i.user_id):return 1;case parseInt(e.user_id):return-1;default:return 0}})).sortBy((function(e){return(0,p.isAdmin)()?e:e.type===P.MAILBOX_TYPES.private?0:1})).value();e.model.set("mailboxes",n)}),s().bind(this._sendError,this))},loadComposeData:function(e){return this.options.getMailComposeData(e).then(s().bind(this._loadComposeData,this))},_loadComposeData:function(e){var t=S.Deferred();if(0===e.length)return t.resolve();this.threads=e;var i=e[0];return this.model.set("subject",i.subject),t.resolve()},loadSignature:function(){return w.default.get("signature").then(s().bind((function(e){e&&e.items&&e.items[0]&&this.model.set("signature",e.items[0].content)}),this))},_renderSender:function(){var e=this.model.get("mailboxes"),t="";e.length&&(t='<span class="feed-compose_mail__sender">'.concat(e[0].option,'<input type="hidden" name="sender" value="').concat(e[0].id,'"></span>'),e.length>1&&(t=o()({ref:"/tmpl/controls/select.twig"}).render({class_name:"feed-compose_mail__select",name:"sender",id:"mail-sender",items:e})),this._findElem("sender_container").html(t))},_renderTemplates:function(){var e=this.model.get("templates")||[];e.length&&this._findElem("templates_line").removeClass("hidden").find(this._selector("templates_container")).html(o()({ref:"/tmpl/controls/select.twig"}).render({class_name:"feed-compose_mail__select js-form-changes-skip",name:"template",id:"mail-template",need_escape:!0,items:[{id:"",option:"..."}].concat(e)}))},_actualizeRecipients:function(){var e,t=this._getLinkedEmails(),i=this._findElem("to_container"),n=i.find("input").val();t.length&&!s().isEqual(s().pluck(t,"id"),s().pluck(this.emails,"id"))?(e=s().findIndex(t,s().bind((function(e){return e.id===n||e.id===this.last_recipient}),this)),i.html(t.length>1?o()({ref:"/tmpl/controls/select.twig"}).render({class_name:"feed-compose_mail__select",items:t,name:"to",selected:(t[e>-1?e:0]||{}).id}):['<input type="hidden" name="to" value="'.concat(t[0].id,'">'),s().escape(t[0].option)].join(""))):this.options.is_new_thread&&i.html(o()({ref:"/tmpl/controls/input.twig"}).render({class_name:"feed-compose_mail__input",name:"to",value:""})),this.emails=t},handleTriggerOptions:function(e){e&&s().isArray(e.to)&&(this._getLinkedEmails=s().wrap(this._getLinkedEmails,s().bind((function(t){var i=t.call(this)||[];return this._getLinkedEmails=t,s().chain(e.to).map((function(e){return{id:e.email,name:e.name||"",option:s().escape("".concat(e.name||""," <").concat(e.email,">"))}})).reject((function(e){return s().contains(s().pluck(i,"id"),e.id)})).value().concat(i)}),this)))},onTemplateChange:function(e){var t,i=S(e.currentTarget),n=this.model.get("signature")?this.model.get("signature"):"";i.val()?C.default.getTemplate(i.val()).done(s().bind((function(e){this._findElem("content_type").data("is-html","html"===e.fields.type).trigger("controls:change"),e.fields.subject&&this.$('[name="subject"]').val(e.fields.subject).trigger("change"),"html"===e.fields.type?(t=e.fields.content,this._findElem("wysiwyg_area").hide(),this._findElem("simple_area_wrapper").show(),this._findElem("simple_area_input").text(t).trigger("input")):(t=(0,u.cleanXSSContent)(e.fields.content).replace(/\r\n|\n/g,"<br/>"),n&&(t+="<p><br></p>".concat(n)),this._findElem("simple_area_wrapper").hide(),this._findElem("simple_area_input").text(""),this._findElem("wysiwyg_area").show(),this._findElem("textarea").val(t).trigger("input"),this._findElem("textarea_input").trigger("input")),this.file_uploader.template=e}),this)):this.cleanView()},cleanView:function(){var e=this.model.get("signature")?this.model.get("signature"):"";this._findElem("wysiwyg_area").show(),this._findElem("simple_area_wrapper").hide(),this._findElem("simple_area_input").text(""),this._findElem("mail_template").val("").trigger("controls:change:visual"),this._findElem("textarea").val(e?"<p><br></p>".concat(e):"").trigger("input"),this._initAttachWrap(),this.loadComposeData(!0),this._highlightSave(!1),this._setChanges(!1),this._findElem("cancel").show()},updateSubject:function(){this._findElem("subject_container").html(o()({ref:"/tmpl/controls/suggest.twig"}).render({class_name:"feed-compose_mail__input-wrapper",input_class_name:"feed-compose_mail__input",name:"subject",value:s().escape((this.threads[0]||{}).subject),items:s().map(this.threads,(function(e){return{id:e.id,value:s().escape(e.subject)}}))}))},checkForm:function(){var e,t,i=0,n=!0,a=this;s().each(a.recipient_types,(function(e){((t=a._findElem("".concat(e,"_container")).find("input").val())||"to"===e)&&(i++,n=n&&(0,m.isValidEmailForSending)(t))}));var o=this._findElem("subject_input").val().trim().length>0,r=(0,u.stripTags)(this._findElem("textarea").val()||"").replace(/&#xFEFF;/i,"").trim().length>0;r=r||this._findElem("simple_area_input").text().trim().length>0;var l=!s().isEmpty(this.file_uploader.attachments);e=o&&(r||l)&&i>0&&n,this._highlightSave(e)},_sendError:function(){this.$el.addClass("animated shake"),this._findElem("textarea").prop("disabled",!1),s().delay(s().bind((function(){this.$el.removeClass("animated shake")}),this),200)},_getEntityElement:function(){var e=s().find(this.options.getExtraData().elements,(function(e){var t=parseInt(e.element_type);return t===APP.element_types.leads||t===APP.element_types.customers||t===APP.element_types.contacts||t===APP.element_types.companies||t===APP.element_types.mail}));return e&&(e.type=(0,f.convertElementType)(e.element_type,"single")),e},_setChanges:s().noop,getOptionsFileUploader:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=b.default.prototype.getOptionsFileUploader.apply(this,t);return s().extend(n,{onSendError:s().bind(this._sendError,this),onBeforeUploadFile:s().bind((function(){this._highlightSave(!1)}),this),onFileQueueChanged:s().bind((function(){this.checkForm()}),this),onAddAttach:s().noop,max_size_file:20})},_preUploadFiles:function(){return this.file_uploader?this.file_uploader.checkSizeFile()?this.file_uploader.upload_promises||Promise.resolve():Promise.reject():Promise.resolve()},send:function(){var e,t,i,n,a=this._getEntityElement()||{},o={},r=this._findElem("to_container").find("input").val(),l=this.getTemplateParams({entity_to_use:s().find(this.options.getExtraData().elements,(function(e){if(s().contains([APP.element_types.contacts,APP.element_types.companies],e.element_type))return s().contains(e.email,r)}))});return s().each(this.recipient_types,(function(i){e=this._findElem("".concat(i,"_container")).find("input").val(),t=s().find(this.emails,(function(t){return t.id===e}))||{},e&&("cc"===i?(n=e.replace(/,/g," ").replace(/\s\s+/g," ").trim().split(" "),e=s().map(n,(function(e){return{email:e,name:""}})),o[i]=e):(e={email:e,name:""},o[i]=[e]),s().isUndefined(t.element_id)||(e.id=t.element_id))}),this),""===(i=this._findElem("simple_area_input").text().trim())&&(i=this._findElem("textarea").val().trim()),i.indexOf('<li class="ql-indent')>-1&&(i=(0,g.quillDecodeIndent)(i)),C.default.sendMessage({mailbox_id:this._findElem("sender_input").val().trim(),name:l["profile.name"]},o,this._findElem("subject_input").val().trim(),i,"html",this.file_uploader.attachments,l,a.id?a.id:null,a.type?a.type:null).done(s().bind((function(e){e&&e.thread_id&&e.message_id&&this.options.onAdd(e.thread_id),(0,v.kommoLogAmplitude)("emailSent")}),this)).fail(s().bind(this._sendError,this))},showNotes:function(e){var t=S.Deferred(),i=this._getEntityElement(),n=this;if(!i||i.element_type===APP.element_types.mail)return t.reject(),t.promise();var s=new k.default([],{element_id:i.id,element_type:i.element_type});return s.fetch({page:0,limit:10}).done((function(){var i=s.chain().filter((function(t){if(parseInt(t.get("type"))!==APP.note_types.mail_message||!t.has("data"))return!1;var i=t.get("data");return i&&i.params.link_data&&parseInt(i.params.link_data.message_id)===parseInt(e)})).map((function(e){return e.toJSON()})).value();n.options.onAdd(i),t.resolve()})).done(t.resolve).fail(t.reject),t.promise()}});var M="../build/transpiled/interface/notes/views/add/mail";window.define(M,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([M])},718758:(e,t,i)=>{i.r(t),i.d(t,{default:()=>p});var n=i(629133),s=i.n(n),a=i(611958),o=i(814095),r=i(661533);function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function c(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function d(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function u(e,t,i){return u="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_(e)););return e}(e,t);if(n){var s=Object.getOwnPropertyDescriptor(n,t);return s.get?s.get.call(i||e):s.value}},u(e,t,i||e)}function _(e){return _=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},_(e)}function m(e,t){return m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},m(e,t)}function h(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,n=_(e);if(t){var s=_(this).constructor;i=Reflect.construct(n,arguments,s)}else i=n.apply(this,arguments);return function(e,t){return!t||"object"!=((i=t)&&"undefined"!=typeof Symbol&&i.constructor===Symbol?"symbol":typeof i)&&"function"!=typeof t?c(e):t;var i}(this,i)}}var p=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&m(e,t)}(o,e);var t,i,n=h(o);function o(e){var t,i=e.attachments;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(t=n.call.apply(n,[this].concat(Array.prototype.slice.call(arguments)))).current_template=[],i&&s().isArray(i)&&(t._attachments={},s().each(i,(function(e){t._attachments[e.id]=e}),c(t))),t}return t=o,(i=[{key:"addAttach",value:function(e){this.loading=!0,u(_(o.prototype),"addAttach",this).call(this,e)&&this.uploadFiles()}},{key:"getFileSize",value:function(e){var t=0;return e&&(t=s().reduce([e].concat(this._files_queue),(function(e,t){return e+t.size}),0)),this.attachments&&(t+=s().reduce(this.attachments,(function(e,t){return e+t.size}),0)),t}},{key:"removeFileClick",value:function(e){var t=r(e.currentTarget).closest(".js-attach-item").attr("data-id");t&&(this.attachments={remove:t}),e.stopPropagation(),this._removeAttachment(t)}},{key:"template",set:function(e){this.current_template.length&&(s().each(this.current_template,(function(e){this.attachments={remove:e.id},this.onRemoveFile(e.id),this.$('.js-attach-item[data-id="'+s().escape(e.id)+'"]').remove()}),this),this.current_template=[]),s().each(e.fields.attachments,(function(e){var t;this.attachments=e,this.current_template=(t=this.current_template,function(e){if(Array.isArray(e))return l(e)}(t)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(t)||function(e,t){if(e){if("string"==typeof e)return l(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(i):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?l(e,t):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()).concat([e])}),this)}},{key:"attachments",get:function(){return this._attachments},set:function(e){var t={};this._attachments||(this._attachments={}),e.remove?this._attachments=s().omit(this._attachments,e.remove):(!1===e.key&&(t.failed=!0),this.renderAttach(e,t),this._attachments[e.id]=e)}},{key:"uploadFiles",value:function(){return this.upload_promises=u(_(o.prototype),"uploadFiles",this).call(this),this.upload_promises}},{key:"uploadFile",value:function(e){return new Promise(s().bind((function(t,i){a.default.getUploadSandbox().done(s().bind((function(n){this.uploadMailFile(n,e,t,i)}),this))}),this))}},{key:"uploadMailFile",value:function(e,t,i,n){a.default.uploadFiles([t],e).done(s().bind((function(e){s().each(e,(function(e){this.attachments=e}),this),i()}),this)).fail(s().bind((function(){this.renderAttach(t,{failed:!0}),n()}),this))}}])&&d(t.prototype,i),o}(o.default),f="../build/transpiled/interface/uploads/mail";window.define(f,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([f])},131258:(e,t,i)=>{function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function s(e){return function(e){if(Array.isArray(e))return n(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return n(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(i):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?n(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}i.r(t),i.d(t,{quillDecodeIndent:()=>u,quillEncodeIndent:()=>_});var a=function(e){return+(e.className||"0").replace(/[^\d]/g,"")},o=function(e){return"ql-indent-".concat(e)},r=function(e){return e[e.length-1]},l=function(e,t){r(e).appendChild(t)},c=function(e,t,i){var n=Array.from(t.children).filter((function(t){return t.tagName===e})).map((function(n){return Array.from(t.removeChild(n).children).map((function(t){return c(e,n.removeChild(t),i+1)})).reduce((function(e,t){return s(e).concat(s(t))}),[])})).reduce((function(e,t){return s(e).concat(s(t))}),[]);return[{classes:t.className,content:t.innerHTML,indent:i}].concat(s(n))},d=function(e){var t="";return e.indent>0&&(t+="".concat(o(e.indent))),e.classes.length>0&&(t+=" ".concat(e.classes)),"<li".concat(t.length>0?' class="'.concat(t,'"'):"",">").concat(e.content,"</li>")};function u(e){if(!e||0===e.length)return e;var t=window.document.createElement("div");t.setAttribute("style","display: none;"),t.innerHTML=e,["ul","ol"].forEach((function(e){Array.from(t.querySelectorAll(e)).forEach((function(t){var i=Array.from(t.children).filter((function(e){return"LI"===e.tagName})),n=[],s=document.createElement(e);n.push(s);var c=i.map((function(e){return a(e)}));i.forEach((function(t,i){var s=c[i-1]||0,a=c[i],d=c[i+1]||0,u=["decimal","lower-alpha","lower-roman"];if(t.className=t.className.replace(o(a),""),a>s)for(var _=a-s;_>0;){var m=r(n),h=document.createElement(e),p="margin: 0px; list-style-type: ".concat("ol"===e?u[(a-_+1)%u.length]:"disc",";");h.setAttribute("style",p),m.appendChild(h),n.push(h),_--}if(l(n,t),a>d)for(var f=a-d;f>0;)n.pop(),f--})),t.innerHTML=s.innerHTML}))}));var i=t.innerHTML;return t.remove(),i}function _(e){if(!e||0===e.length)return e;var t=window.document.createElement("div");t.setAttribute("style","display: none;"),t.innerHTML=e,["ul","ol"].forEach((function(e){Array.from(t.querySelectorAll(e)).forEach((function(t){var i=Array.from(t.children).filter((function(e){return"LI"===e.tagName})).map((function(t){return c(e.toUpperCase(),t,0)})).reduce((function(e,t){return s(e).concat(s(t))}),[]).map((function(e){return d(e)})).reduce((function(e,t){return"".concat(e).concat(t)}),"");t.innerHTML=i}))}));var i=t.innerHTML;return t.remove(),i}var m="../build/transpiled/utils/quill_list_fix";window.define(m,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([m])}}]);var _global="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};_global.SENTRY_RELEASE={id:"build_2025_11_28_18_50_52"},function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=(new Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="bfdca04c-ce13-4f12-87d2-ca3997990f1f",e._sentryDebugIdIdentifier="sentry-dbid-bfdca04c-ce13-4f12-87d2-ca3997990f1f")}catch(e){}}();
//# sourceMappingURL=56973.9cfde526c26288bcb602.js.map