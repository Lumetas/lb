define(["jquery", "lib/components/base/modal"], function ($, Modal) {
  return function SortableSettings(
    self,
    initialSettings,
    renderModalHandler,
    parseModalDataHandler,
    presentSettings,
    draggable = true,
    withGroups = false,
  ) {
    class SettingsManager {
      #settings;
      #settingsClone;
      #container;
      #self;
      #renderModalHandler;
      #parseModalDataHandler;
      #presentSettings;
      #draggable;
      #withGroups;
      #openedModal;
      #closeCallback;
      #updateHandler;
      #validateHandler;
      #generateIdForItem;
      #generateIdForGroup;
      #addNewItem;
      #AddNewGroup;
      #sortable = [];
      #outerWrapper;
      #oldOuterWrapperRect;
      constructor(
        self,
        initialSettings,
        renderModalHandler,
        parseModalDataHandler,
        presentSettings,
        draggable,
        withGroups,
      ) {
        const { dom } = self;
        this.#self = self;
        this.#settings = JSON.parse(JSON.stringify(initialSettings));
        this.#settingsClone = JSON.parse(JSON.stringify(initialSettings));
        this.#container = dom.add("div");
        this.#container.id = "sortable-settings-emfy";
        this.#renderModalHandler = renderModalHandler;
        this.#parseModalDataHandler = parseModalDataHandler;
        this.#presentSettings = presentSettings;
        this.#draggable = draggable;
        this.#withGroups = withGroups;
        this.updateModalHeight = this.updateModalHeight.bind(this);
      }

      #addStyles() {
        const { dom } = this.#self;
        const container = this.#container;
        const styles = dom.add("style");
        styles.innerHTML = `
#sortable-settings-emfy {
width: 520px;
display: flex;
flex-direction: column;
gap: 15px;
margin: 0px;
}
#sortable-settings-emfy #add-btn {
width: 520px;
height: 69px;
display: flex;
align-items: center;
justify-content: center;
gap: 6px;
background-color: var(--palette-background-primary);
border: 1px solid #e8eaeb;
border-radius: 5px;
-webkit-border-radius: 5px;
-moz-border-radius: 5px;
-ms-border-radius: 5px;
-o-border-radius: 5px;
color: #cbcfd0;
font-family: PT Sans;
font-family: 15px;
font-weight: 400;
line-height: 19px;
cursor: pointer;
padding: 0;
margin: 0;
}

html[data-color-scheme="dark"] #sortable-settings-emfy #add-btn {
border: 1px solid var(--palette-border-default);
color: var(--palette-text-secondary-dark);
}

#sortable-settings-emfy .sortable-groups {
width: 100%;
display: flex;
flex-direction: column;
gap: 15px;
padding: 0;
margin: 0;
list-style: none;
}

#sortable-settings-emfy .sortable-group {
width: 520px;
min-height: 69px;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
background-color: var(--palette-background-primary);
color: var(--palette-border-default);
position: relative;
padding: 0;
margin: 0;
list-style-type: none;
}
#sortable-settings-emfy .sortable-group .header {
width: 520px;
min-height: 39px;
padding: 0px 15px;
box-sizing: border-box;
display: flex;
align-items: center;
justify-content: space-between;
color: var(--palette-border-default);
background-color: var(--palette-background-default);
border-top-left-radius: 5px;
border-top-right-radius: 5px;
cursor: pointer;
pointer-events: all;
transition: min-height 0.5s;
position: relative;
margin: 0;
}

#sortable-settings-emfy .sortable-group .header .add-group {
display: flex;
align-items: center;
cursor: pointer;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .sortable-group:nth-child(1n) .header {
border-bottom: 4px solid var(--color-blueberry);
}
#sortable-settings-emfy .sortable-group:nth-child(2n) .header {
border-bottom: 4px solid rgb(255, 138, 75);
}
#sortable-settings-emfy .sortable-group:nth-child(3n) .header {
border-bottom: 4px solid rgb(105, 255, 75);
}
#sortable-settings-emfy .sortable-group:nth-child(4n) .header {
border-bottom: 4px solid rgb(75, 255, 240);
}

#sortable-settings-emfy .sortable-group.collapsed .header {
min-height: 69px;
border-bottom-left-radius: 5px;
border-bottom-right-radius: 5px;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .sortable-group .header p {
font-family: PT Sans;
font-size: 15px;
font-weight: 700;
line-height: 19.41px;
color: var(--palette-text-primary);
padding: 0;
margin: 0;
}

#sortable-settings-emfy .sortable-group .header .button-group {
display: flex;
align-items: center;
justify-content: end;
gap: 12px;
position: absolute;
right: 0;
width: 21px;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .sortable-group .header .button-group:hover {
width: 50px;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .sortable-group .header .button-group .delete-group {
position: absolute;
opacity: 0;
right: 0;
transition: opacity 0.5s, right 0.5s;
padding: 0;
margin: 0;
}

#sortable-settings-emfy
.sortable-group
.header
.button-group:hover
.delete-group {
position: absolute;
opacity: 1;
right: 35px;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .sortable-list,
#sortable-settings-emfy .sortable-group .sortable-list {
display: flex;
flex-direction: column;
align-items: center;
gap: 15px;
margin: 0;
box-sizing: border-box;
transition: height 0.5s, margin 0.5s, gap 0.5s;
padding: 0;
list-style: none;
}

#sortable-settings-emfy .sortable-group.collapsed .sortable-list {
overflow: hidden;
margin: 0;
gap: 0;
padding: 0;
}

#sortable-settings-emfy .sortable-list .sortable-item {
width: 520px;
height: fit-content;
background-color: var(--palette-background-default);
border-radius: 5px;
color: var(--palette-border-default);
font-family: PT Sans;
font-size: 15px;
font-weight: 400;
line-height: 19.41px;
text-align: left;
text-underline-position: from-font;
text-decoration-skip-ink: none;
cursor: pointer;
position: relative;
pointer-events: all;
box-sizing: border-box;
margin: 0;
list-style-type: none;
}



#sortable-settings-emfy .sortable-group:nth-child(1n) .sortable-item {
background-color: var(--palette-background-default);
color: var(--palette-border-default);
}
#sortable-settings-emfy .sortable-group:nth-child(2n) .sortable-item {
background-color: #ffe8db;
color: var(--palette-border-default);
}
#sortable-settings-emfy .sortable-group:nth-child(3n) .sortable-item {
background-color: #e1ffdb;
color: var(--palette-border-default);
}
#sortable-settings-emfy .sortable-group:nth-child(4n) .sortable-item {
background-color: #dbfffc;
color: var(--palette-border-default);
}

html[data-color-scheme="dark"]
#sortable-settings-emfy
.sortable-group:nth-child(1n)
.sortable-item {
background-color: var(--palette-background-default);
}

html[data-color-scheme="dark"]
#sortable-settings-emfy
.sortable-group:nth-child(2n)
.sortable-item {
background-color: #444245;
}
html[data-color-scheme="dark"]
#sortable-settings-emfy
.sortable-group:nth-child(3n)
.sortable-item {
background-color: #265945;
}
html[data-color-scheme="dark"]
#sortable-settings-emfy
.sortable-group:nth-child(4n)
.sortable-item {
background-color: #205966;
}

#sortable-settings-emfy .sortable-item .first_line,
#sortable-settings-emfy .sortable-item .second_line,
#sortable-settings-emfy .sortable-item .third_line {
display: flex;
gap: 6px;
align-items: center;
justify-content: start;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .sortable-item .active_selector,
#sortable-settings-emfy .sortable-item .card_icon {
display: flex;
align-items: center;
justify-content: center;
padding: 0;
margin: 0;
}
#sortable-settings-emfy .sortable-item .active_selector {
opacity: 0;
transition: opacity 0.5s ease;
padding: 0;
margin: 0;
}
#sortable-settings-emfy .sortable-item:hover .active_selector {
opacity: 1;
}
#sortable-settings-emfy .sortable-item .active_selector label {
cursor: pointer;
padding: 0 14px;
position: absolute;
top: 50%;
left: 6%;
height: 40px;
transform: translateY(-50%);
display: flex;
align-items: center;
margin: 0;
}

#sortable-settings-emfy .sortable-item .active_selector input {
display: none;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .sortable-item .active_selector .line {
width: 12px;
height: 1px;
background-color: #516570;
position: absolute;
right: 50%;
top: 50%;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .sortable-item .active_selector .circle {
position: relative;
display: inline-block;
left: -8px;
width: 12px;
height: 12px;
border-radius: 7px;
transition: left 0.3s;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .sortable-item .active_selector .circle circle {
fill: var(--palette-background-default);
stroke: #516570;
stroke-width: 10;
transition: fill 0.3s, stroke 0.3s;
padding: 0;
margin: 0;
}

#sortable-settings-emfy
.sortable-group:nth-child(1n)
.sortable-item
.active_selector
.circle
circle {
fill: var(--palette-background-default);
}

#sortable-settings-emfy
.sortable-group:nth-child(2n)
.sortable-item
.active_selector
.circle
circle {
fill: #ffe8db;
}

#sortable-settings-emfy
.sortable-group:nth-child(3n)
.sortable-item
.active_selector
.circle
circle {
fill: #e1ffdb;
}

#sortable-settings-emfy
.sortable-group:nth-child(4n)
.sortable-item
.active_selector
.circle
circle {
fill: #dbfffc;
}

html[data-color-scheme="dark"]
#sortable-settings-emfy
.sortable-group:nth-child(1n)
.sortable-item
.active_selector
.circle
circle {
fill: var(--palette-background-default);
}

html[data-color-scheme="dark"]
#sortable-settings-emfy
.sortable-group:nth-child(2n)
.sortable-item
.active_selector
.circle
circle {
fill: #444245;
}

html[data-color-scheme="dark"]
#sortable-settings-emfy
.sortable-group:nth-child(3n)
.sortable-item
.active_selector
.circle
circle {
fill: #265945;
}

html[data-color-scheme="dark"]
#sortable-settings-emfy
.sortable-group:nth-child(4n)
.sortable-item
.active_selector
.circle
circle {
fill: #205966;
}

#sortable-settings-emfy
.sortable-item
.active_selector
input:checked
+ .circle {
left: 8px;
background: var(--palette-background-default);
}

#sortable-settings-emfy
.sortable-item
.active_selector
input:checked
+ .circle
circle {
stroke: var(--color-blueberry);
fill: var(--color-blueberry);
}

#sortable-settings-emfy
.sortable-group
.sortable-item
.active_selector
input:checked
+ .circle
circle {
stroke: var(--color-blueberry);
fill: var(--color-blueberry);
}

#sortable-settings-emfy .sortable-item .text-line {
display: flex;
align-items: center;
gap: 5px;
color: var(--palette-text-primary);
padding: 0;
margin: 0;
max-width: 100%;
}

#sortable-settings-emfy .sortable-item .text-line p {
overflow: hidden;
white-space: nowrap;
text-overflow: ellipsis;
}

#sortable-settings-emfy .sortable-item .text-line.bold p {
font-weight: bold;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .sortable-item .text-line.blue p {
color: var(--color-blueberry);
padding: 0;
margin: 0;
}
#sortable-settings-emfy .sortable-item .text-line.underline p {
text-decoration: underline;
padding: 0;
margin: 0;
}
#sortable-settings-emfy .sortable-item .text-line.border p {
border: 1px solid var(--color-blueberry);
border-radius: 5px;
padding: 0 4px;
margin: 0;
}

#sortable-settings-emfy .sortable-item .three_lines {
display: grid;
grid-template-columns: 60px 400px 60px;
grid-template-rows: repeat(3, 1fr);
grid-column-gap: 0px;
grid-row-gap: 0px;
width: 100%;
height: 100px;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .sortable-list .sortable-item .three_lines::after {
content: "";
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(255, 255, 255, 0);
transition: background-color 0.5s ease;
-webkit-transition: background-color 0.5s ease;
-moz-transition: background-color 0.5s ease;
-ms-transition: background-color 0.5s ease;
-o-transition: background-color 0.5s ease;
z-index: 10;
padding: 0;
margin: 0;
pointer-events: none;
}

#sortable-settings-emfy .sortable-list .sortable-item .three_lines.turned-off::after {
background-color: rgba(255, 255, 255, 0.5);
}

html[data-color-scheme="dark"]
#sortable-settings-emfy
.sortable-list
.sortable-item
.three_lines.turned-off::after {
background-color: rgba(21, 48, 67, 0.5);
}

#sortable-settings-emfy .sortable-item .three_lines .first_line {
grid-area: 1 / 1 / 2 / 3;
padding: 13px 0 0 22px;
margin: 0;
}
#sortable-settings-emfy .sortable-item .three_lines .active_selector {
grid-area: 1 / 3 / 4 / 4;
padding: 0;
margin: 0;
}
#sortable-settings-emfy .sortable-item .three_lines .second_line {
grid-area: 2 / 2 / 3 / 3;
padding: 6px 0 0 0;
margin: 0;
}
#sortable-settings-emfy .sortable-item .three_lines .third_line {
grid-area: 3 / 2 / 4 / 3;
padding: 0 0 14px 0;
margin: 0;
}
#sortable-settings-emfy .sortable-item .three_lines .card_icon {
grid-area: 2 / 1 / 4 / 2;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .sortable-item .two_lines {
display: grid;
grid-template-columns: 60px 400px 60px;
grid-template-rows: repeat(2, 1fr);
grid-column-gap: 0px;
grid-row-gap: 0px;
width: 100%;
height: 69px;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .sortable-list .sortable-item .two_lines::after {
content: "";
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(255, 255, 255, 0);
transition: background-color 0.5s ease;
-webkit-transition: background-color 0.5s ease;
-moz-transition: background-color 0.5s ease;
-ms-transition: background-color 0.5s ease;
-o-transition: background-color 0.5s ease;
z-index: 10;
padding: 0;
margin: 0;
pointer-events: none;
}

#sortable-settings-emfy .sortable-list .sortable-item .two_lines.turned-off::after {
background-color: rgba(255, 255, 255, 0.5);
}

html[data-color-scheme="dark"]
#sortable-settings-emfy
.sortable-list
.sortable-item
.two_lines.turned-off::after {
background-color: rgba(21, 48, 67, 0.5);
}

#sortable-settings-emfy .sortable-item .two_lines .second_line {
grid-area: 1 / 2 / 2 / 3;
padding: 13px 0 0 0;
margin: 0;
}
#sortable-settings-emfy .sortable-item .two_lines .card_icon {
grid-area: 1 / 1 / 3 / 2;
padding: 0;
margin: 0;
}
#sortable-settings-emfy .sortable-item .two_lines .third_line {
grid-area: 2 / 2 / 3 / 3;
padding: 0 0 14px 0;
margin: 0;
}
#sortable-settings-emfy .sortable-item .two_lines .active_selector {
grid-area: 1 / 3 / 3 / 4;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .sortable-item .one_line {
display: grid;
grid-template-columns: 60px 400px 60px;
grid-template-rows: 1fr;
grid-column-gap: 0px;
grid-row-gap: 0px;
width: 100%;
height: 69px;
padding: 0;
}

#sortable-settings-emfy .sortable-list .sortable-item .one_line::after {
content: "";
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(255, 255, 255, 0);
transition: background-color 0.5s ease;
-webkit-transition: background-color 0.5s ease;
-moz-transition: background-color 0.5s ease;
-ms-transition: background-color 0.5s ease;
-o-transition: background-color 0.5s ease;
z-index: 10;
padding: 0;
margin: 0;
pointer-events: none;
}

#sortable-settings-emfy .sortable-list .sortable-item .one_line.turned-off::after {
background-color: rgba(255, 255, 255, 0.5);
}

html[data-color-scheme="dark"]
#sortable-settings-emfy
.sortable-list
.sortable-item
.one_line.turned-off::after {
background-color: rgba(21, 48, 67, 0.5);
}

#sortable-settings-emfy .sortable-item .one_line .card_icon {
grid-area: 1 / 1 / 2 / 2;
padding: 0;
margin: 0;
}
#sortable-settings-emfy .sortable-item .one_line .second_line {
grid-area: 1 / 2 / 2 / 3;
padding: 0;
margin: 0;
}
#sortable-settings-emfy .sortable-item .one_line .active_selector {
grid-area: 1 / 3 / 2 / 4;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .settings-modal {
width: 520px;
display: flex;
flex-direction: column;
border: 1px solid var(--palette-border-default);
border-radius: 1px;
position: absolute;
margin: 8px 0 0 0;
background-color: var(--palette-background-primary);
z-index: 100;
box-sizing: border-box;
box-shadow: 2px 4px 4px 0px #0000000d;
cursor: default;
opacity: 0;
transform: scale(0.9);
transition: opacity 0.3s ease, transform 0.3s ease;
padding: 0;
}

#sortable-settings-emfy .settings-modal.down {
top: 100%;
}

#sortable-settings-emfy .settings-modal.up {
bottom: 100%;
}

#sortable-settings-emfy .settings-modal.show {
opacity: 1;
transform: scale(1);
}

html[data-color-scheme="dark"] #sortable-settings-emfy .settings-modal {
box-shadow: 2px 4px 4px 0px #ffffff0d;
}
#sortable-settings-emfy .settings-modal.down::before {
content: "";
position: absolute;
height: 0;
width: 0;
top: -4px;
left: 25px;
transform: translateY(-50%);
border-bottom: 8px solid var(--palette-border-default);
border-left: 8px solid transparent;
border-right: 8px solid transparent;
}

#sortable-settings-emfy .settings-modal.down::after {
content: "";
position: absolute;
height: 0;
width: 0;
top: -2.5px;
left: 25px;
transform: translateY(-50%);
border-bottom: 8px solid var(--palette-background-primary);
border-left: 8px solid transparent;
border-right: 8px solid transparent;
}

#sortable-settings-emfy .settings-modal.up::before {
content: "";
position: absolute;
height: 0;
width: 0;
bottom: -12px;
left: 25px;
transform: translateY(-50%);
border-top: 8px solid var(--palette-border-default);
border-left: 8px solid transparent;
border-right: 8px solid transparent;
}

#sortable-settings-emfy .settings-modal.up::after {
content: "";
position: absolute;
height: 0;
width: 0;
bottom: -10px;
left: 25px;
transform: translateY(-50%);
border-top: 8px solid var(--palette-background-primary);
border-left: 8px solid transparent;
border-right: 8px solid transparent;
}

#sortable-settings-emfy .settings-modal .buttons {
padding: 0 30px 20px 20px;
display: flex;
gap: 5px;
align-items: center;
justify-content: space-between;
margin: 0;
}

#sortable-settings-emfy .settings-modal .buttons .main-buttons {
display: flex;
align-items: center;
gap: 15px;
padding: 0;
margin: 0;
}
#sortable-settings-emfy .settings-modal .buttons .save-button {
background-color: var(--color-blueberry);
border: none;
border-radius: 5px;
color: var(--color-anti-flash-white);
padding: 8px 22px;
cursor: pointer;
font-family: PT Sans;
font-size: 14px;
font-weight: 700;
line-height: 18px;
margin: 0;
}
#sortable-settings-emfy .settings-modal .buttons .cancel-button {
background: none;
border: none;
cursor: pointer;
color: var(--palette-text-secondary-light);
padding: 8px 11px;
font-family: PT Sans;
font-size: 15px;
font-weight: 700;
line-height: 18px;
margin: 0;
}
#sortable-settings-emfy .settings-modal .buttons .delete-button {
background: none;
border: none;
cursor: pointer;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .groups-modal {
width: 520px;
display: flex;
flex-direction: column;
gap: 20px;
padding: 15px 30px 20px 20px;
border: 1px solid var(--palette-border-default);
border-radius: 1px;
position: absolute;
top: 100%;
margin: 5px 0 0 0;
right: 0;
background-color: var(--palette-background-primary);
z-index: 100;
box-sizing: border-box;
box-shadow: 2px 4px 4px 0px #0000000d;
cursor: default;
opacity: 0;
transform: scale(0.9);
transition: opacity 0.3s ease, transform 0.3s ease;
}

#sortable-settings-emfy .groups-modal.show {
opacity: 1;
transform: scale(1);
padding: 0;
margin: 0;
}

html[data-color-scheme="dark"] #sortable-settings-emfy .groups-modal {
box-shadow: 2px 4px 4px 0px #ffffff0d;
}
#sortable-settings-emfy .groups-modal::before {
content: "";
position: absolute;
height: 0;
width: 0;
top: -4px;
right: 17px;
transform: translateY(-50%);
border-bottom: 8px solid #e8eaeb;
border-left: 8px solid transparent;
border-right: 8px solid transparent;
}
html[data-color-scheme="dark"] #sortable-settings-emfy .groups-modal::before {
border-bottom: 8px solid var(--palette-border-default);
}
#sortable-settings-emfy .groups-modal::after {
content: "";
position: absolute;
height: 0;
width: 0;
top: -2.5px;
right: 17px;
transform: translateY(-50%);
border-bottom: 8px solid var(--palette-background-primary);
border-left: 8px solid transparent;
border-right: 8px solid transparent;
}

#sortable-settings-emfy .groups-modal .field {
display: flex;
width: 100%;
flex-direction: column;
gap: 5px;
align-items: start;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .groups-modal p {
font-family: PT Sans;
font-size: 15px;
font-weight: 400;
line-height: 19px;
color: var(--palette-text-primary);
padding: 0;
margin: 0;
}

#sortable-settings-emfy .groups-modal input {
width: 100%;
background-color: var(--palette-background-primary);
border: 1px solid var(--palette-border-default);
border-radius: 2px;
-webkit-border-radius: 2px;
-moz-border-radius: 2px;
-ms-border-radius: 2px;
-o-border-radius: 2px;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .groups-modal .buttons {
display: flex;
gap: 5px;
align-items: center;
justify-content: start;
padding: 0;
margin: 0;
}

#sortable-settings-emfy .groups-modal .buttons .save-button {
background-color: var(--color-blueberry);
border: none;
border-radius: 5px;
color: var(--color-anti-flash-white);
padding: 8px 22px;
cursor: pointer;
font-family: PT Sans;
font-size: 14px;
font-weight: 700;
line-height: 18px;
margin: 0;
}
#sortable-settings-emfy .groups-modal .buttons .cancel-button {
background: none;
border: none;
cursor: pointer;
color: var(--palette-placeholder-primary-light);
padding: 8px 11px;
font-family: PT Sans;
font-size: 15px;
font-weight: 700;
line-height: 18px;
margin: 0;
}
          `;

        container.appendChild(styles);
      }

      #getSvg(icon) {
        const svgObj = {
          add: `<svg width="21" height="21" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M17.9242 3.07572C16.9515 2.09767 15.7944 1.32224 14.5201 0.794301C13.2457 0.266363 11.8793 -0.00359929 10.4999 3.62357e-05C9.12048 -0.00359929 7.75406 0.266363 6.47969 0.794301C5.20532 1.32224 4.0483 2.09767 3.0756 3.07572C2.09755 4.04843 1.32212 5.20544 0.794179 6.47982C0.266241 7.75419 -0.00372136 9.12061 -8.58346e-05 10.5C-8.58346e-05 13.3043 1.09191 15.9422 3.0756 17.9243C4.04825 18.9024 5.20526 19.6779 6.47964 20.2058C7.75402 20.7338 9.12047 21.0037 10.4999 21C11.8793 21.0037 13.2457 20.7338 14.5201 20.2058C15.7945 19.6779 16.9515 18.9024 17.9242 17.9243C18.9023 16.9516 19.6778 15.7946 20.2057 14.5202C20.7336 13.2459 21.0036 11.8794 20.9998 10.5C21.0036 9.12059 20.7336 7.75415 20.2057 6.47976C19.6778 5.20538 18.9023 4.04837 17.9242 3.07572ZM10.4999 19.3587C8.15118 19.3562 5.89942 18.422 4.23864 16.7612C2.57786 15.1005 1.6437 12.8487 1.64114 10.5C1.6437 8.1513 2.57786 5.89954 4.23864 4.23876C5.89942 2.57798 8.15118 1.64383 10.4999 1.64126C12.8486 1.64383 15.1003 2.57798 16.7611 4.23876C18.4219 5.89954 19.3561 8.1513 19.3586 10.5C19.3561 12.8487 18.4219 15.1005 16.7611 16.7612C15.1003 18.422 12.8486 19.3562 10.4999 19.3587ZM11.3205 9.67939H15.0116V11.319H11.3205V15.0101H9.67927V11.319H5.98812V9.67939H9.67927V5.98825H11.3205V9.67939Z" fill="var(--palette-border-default)"/>
  </svg>`,
          delete: `<svg width="16" height="22" viewBox="0 0 16 22" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M0 5.04437C0 4.57673 0.168571 4.12824 0.468629 3.79756C0.768687 3.46689 1.17565 3.28112 1.6 3.28112H14.4C14.8243 3.28112 15.2313 3.46689 15.5314 3.79756C15.8314 4.12824 16 4.57673 16 5.04437H0ZM4.8 1.51786C4.8 1.28404 4.88429 1.05979 5.03431 0.894454C5.18434 0.729116 5.38783 0.63623 5.6 0.63623H10.4C10.6122 0.63623 10.8157 0.729116 10.9657 0.894454C11.1157 1.05979 11.2 1.28404 11.2 1.51786V2.39949H4.8V1.51786ZM6.4 6.80763L7.2 18.2688H5.6L4.8 6.80763H6.4ZM9.6 6.80763H11.2L10.4 18.2688H8.8L9.6 6.80763ZM3.128 18.6391L3.296 20.0321H12.76L12.928 18.6391L13.992 6.80763H15.808L14.4 20.0321C14.4 20.4997 14.2314 20.9482 13.9314 21.2789C13.6313 21.6096 13.2243 21.7953 12.8 21.7953H3.2C2.77565 21.7953 2.36869 21.6096 2.06863 21.2789C1.76857 20.9482 1.6 20.4997 1.6 20.0321L0.184 6.80763H2.056L3.128 18.6391Z" fill="#F26E6E"/>
  </svg>`,
          burger: `
    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M0 2.28509V0H16V2.28509H0ZM0 9.14327V6.85673H16V9.14327H0ZM0 16V13.7149H16V16H0Z" fill="#CBCFD0"/>
  </svg>`,
        };
        return svgObj[icon];
      }
      renderSortableSettings() {
        const container = this.#container;

        container.innerHTML = "";

        this.#addStyles();

        if (!this.#withGroups) {
          container.appendChild(this.#addNewButton(this.#settings));
        }

        const list = document.createElement("ul");
        list.className = this.#withGroups ? "sortable-groups" : "sortable-list";

        if (this.#withGroups) {
          this.#settings.forEach((setting) => {
            const group = this.#createGroup(setting);
            list.appendChild(group);
          });
          if (this.#draggable) {
            this.#enableDragAndDropForGroups(list);
          }
        } else {
          this.#settings.forEach((setting) => {
            const card = this.#createCard(setting, this.#settings);
            list.appendChild(card);
          });
          if (this.#draggable) {
            this.#enableDragAndDrop(list);
          }
        }

        container.appendChild(list);
        return container;
      }

      #addNewButton(currentSettings) {
        const { dom } = this.#self;

        const addSettingsDiv = dom.add("div");
        addSettingsDiv.style.position = "relative";
        const addButton = dom.add("button");
        const addIcon = this.#getSvg("add");
        addButton.innerHTML = addIcon;
        if (this.#addNewItem) {
          addButton.append(this.#addNewItem);
        } else {
          addButton.append(self.i18n("SortableSettings.add_setting"));
        }

        addButton.id = "add-btn";

        addSettingsDiv.appendChild(addButton);
        const openHandler = (event) => {
          event.stopPropagation();
          addButton.removeEventListener("click", openHandler);
          this.#openModal(currentSettings, null, addSettingsDiv, null, () => {
            addButton.addEventListener("click", openHandler);
          });
        };

        addButton.addEventListener("click", openHandler);
        return addSettingsDiv;
      }

      #addNewGroupButton() {
        const { dom } = this.#self;
        const container = this.#container;
        const addSettingsDiv = dom.add("div");
        addSettingsDiv.style.position = "relative";
        const addButton = dom.add("button");
        const addIcon = this.#getSvg("add");
        addButton.innerHTML = addIcon;
        if (this.#AddNewGroup) {
          addButton.append(this.#AddNewGroup);
        } else {
          addButton.append(self.i18n("SortableSettings.add_group"));
        }
        addButton.id = "add-btn";

        addSettingsDiv.appendChild(addButton);
        addButton.addEventListener("click", () => {
          this.#openModalGroup(addButton, () => {
            if (dom.findAll(container, ".sortable-group").length) {
              addButton.remove();
            }
          });
        });
        dom.find(container, ".sortable-groups").appendChild(addSettingsDiv);
      }

      #addNewSetting(newSettings, currentSettings, addBtnContainer) {
        const container = this.#container;
        const { dom } = this.#self;
        let list;

        if (this.#withGroups) {
          const lists = dom.findAll(container, ".sortable-list");
          list = lists.find((list) => list.contains(addBtnContainer));
        } else {
          list = dom.find(container, ".sortable-list");
        }
        const card = this.#createCard(newSettings, currentSettings);

        const beforeHeight = this.#getFlexContentHeight(list, 15);
        list.appendChild(card);

        const afterHeight = this.#getFlexContentHeight(list, 15);
        list.style.height = `${beforeHeight}px`;
        list.offsetHeight;
        list.style.height = `${afterHeight}px`;
      }

      #updateSetting(currentSettings, newSettings, id) {
        const container = this.#container;
        const { dom } = this.#self;
        let currentLi;
        let currentList;
        const lists = dom.findAll(container, ".sortable-list");

        lists.forEach((list) => {
          if (currentLi) return;
          const possibleLi = dom
            .findAll(list, "li")
            .find((li) => li.dataset.index == id);
          if (possibleLi) {
            currentLi = possibleLi;
            currentList = list;
          }
        });
        currentList.style.removeProperty("height");
        const beforeHeight = this.#getFlexContentHeight(currentList, 15);
        this.#updateCard(currentSettings, currentLi, newSettings);
        const afterHeight = this.#getFlexContentHeight(currentList, 15);
        currentList.style.height = `${beforeHeight}px`;
        currentList.offsetHeight;
        currentList.style.height = `${afterHeight}px`;
      }

      #deleteSetting(id) {
        const container = this.#container;
        const { dom } = this.#self;

        let currentLi;
        let currentList;
        const lists = dom.findAll(container, ".sortable-list");
        lists.forEach((list) => {
          if (currentLi) return;
          const possibleLi = dom
            .findAll(list, "li")
            .find((li) => li.dataset.index == id);
          if (possibleLi) {
            currentLi = possibleLi;
            currentList = list;
          }
        });

        currentList.style.removeProperty("height");
        const beforeHeight = this.#getFlexContentHeight(currentList, 15);
        currentList.style.height = `${beforeHeight}px`;
        currentLi.remove();
        const afterHeight = this.#getFlexContentHeight(currentList, 15);

        currentList.style.height = `${afterHeight}px`;
        setTimeout(() => {
          currentList.addEventListener(
            "transitionend",
            () => {
              currentList.style.removeProperty("height");
            },
            { once: true },
          );
        }, 10);
      }

      #createGroup(group) {
        const { dom } = this.#self;
        const groupItem = dom.add("li");
        groupItem.classList.add("sortable-group");
        groupItem.dataset.index = group.id;

        const groupItemHead = dom.add("div");
        groupItemHead.className = "header";
        const headerBurger = dom.fromString(this.#getSvg("burger"));

        const headerText = dom.add("p");
        headerText.innerHTML = group.name;
        const headerAddBtn = dom.add("div");
        headerAddBtn.className = "add-group";
        headerAddBtn.innerHTML = this.#getSvg("add");

        const headerDeleteBtn = dom.add("div");
        headerDeleteBtn.className = "delete-group";
        headerDeleteBtn.innerHTML = this.#getSvg("delete");
        const btnGroup = dom.add("div");
        btnGroup.className = "button-group";

        const btnGroupWrapper = dom.add("div");
        btnGroupWrapper.style.width = "21px";
        btnGroupWrapper.style.height = "21px";
        btnGroupWrapper.style.position = "relative";

        btnGroupWrapper.appendChild(btnGroup);

        btnGroup.appendChild(headerDeleteBtn);
        btnGroup.appendChild(headerAddBtn);

        groupItemHead.appendChild(headerBurger);
        groupItemHead.appendChild(headerText);
        groupItemHead.appendChild(btnGroupWrapper);
        groupItem.appendChild(groupItemHead);

        const openHandler = (event) => {
          event.stopPropagation();
          headerAddBtn.removeEventListener("click", openHandler);
          this.#openModalGroup(groupItemHead, () => {
            headerAddBtn.addEventListener("click", openHandler);
          });
        };

        headerAddBtn.addEventListener("click", openHandler);

        headerDeleteBtn.addEventListener("click", () => {
          this.#deleteGroup(group.id);
          this.#updateHandler && this.#updateHandler();
        });

        const itemList = dom.add("ul");
        itemList.className = "sortable-list";

        itemList.appendChild(this.#addNewButton(group.items));
        group.items.forEach((setting) => {
          const card = this.#createCard(setting, group.items);
          itemList.appendChild(card);
        });

        dom.addListener(groupItemHead, "click", () => {
          if (!groupItem.classList.contains("collapsed")) {
            const height = this.#getFlexContentHeight(itemList, 15);
            itemList.style.height = `${height}px`;
            itemList.offsetHeight;
            itemList.style.height = "0px";
            groupItem.classList.add("collapsed");
          } else {
            groupItem.classList.remove("collapsed");
            itemList.style.removeProperty("height");
            itemList.style.overflow = "hidden";
            const height = this.#getFlexContentHeight(itemList, 15);
            itemList.style.height = "0px";
            itemList.offsetHeight;
            itemList.style.height = `${height}px`;
            itemList.addEventListener(
              "transitionend",
              () => {
                itemList.style.overflow = "";
                itemList.style.removeProperty("height");
              },
              { once: true },
            );
          }
        });

        groupItem.appendChild(itemList);
        return groupItem;
      }

      #deleteGroup(id) {
        const container = this.#container;
        const { dom } = this.#self;

        const currentGroup = dom
          .findAll(container, ".sortable-group")
          .find((group) => group.dataset.index == id);
        currentGroup.remove();

        if (!dom.findAll(container, ".sortable-group").length) {
          this.#addNewGroupButton();
        }
      }

      #createCard(setting, currentSettings) {
        const { dom } = this.#self;

        const listItem = dom.add("li");
        listItem.className = "sortable-item";
        listItem.dataset.index = setting.id;

        const listItemCard = this.#createCardInner(
          currentSettings,
          setting,
          listItem,
        );

        listItem.appendChild(listItemCard);

        return listItem;
      }

      #createCardInner(currentSettings, setting, listItem) {
        const { dom } = this.#self;

        const listItemCard = dom.add("div");

        const presentSettings = this.#presentSettings;

        const linesArr = ["firstLine", "secondLine", "thirdLine"];
        const needToShowLines = {
          firstLine: false,
          secondLine: false,
          thirdLine: false,
        };
        const containerClasses = {
          three: "three_lines",
          two: "two_lines",
          one: "one_line",
        };
        const lineClasses = {
          firstLine: "first_line",
          secondLine: "second_line",
          thirdLine: "third_line",
        };

        linesArr.forEach((line) => {
          const needToShow =
            typeof presentSettings[line].show == "boolean"
              ? presentSettings[line].show
              : presentSettings[line].show(setting);
          needToShowLines[line] = needToShow;
        });

        if (needToShowLines.firstLine) {
          listItemCard.classList.add(containerClasses.three);
        } else if (needToShowLines.thirdLine) {
          listItemCard.classList.add(containerClasses.two);
        } else {
          listItemCard.classList.add(containerClasses.one);
        }
        const getValueFromPath = (obj, path) => {
          return path.split(".").reduce((acc, key) => acc && acc[key], obj);
        };
        const generateText = (line, type) => {
          const generateType = presentSettings[line][`${type}Type`];
          let result;
          switch (generateType) {
            case "none":
              result = "";
              break;
            case "text":
              result = `<p>${presentSettings[line][type]}</p>`;
              break;
            case "setting":
              const path = presentSettings[line][type];
              const value = getValueFromPath(setting, path);
              if (Array.isArray(value)) {
                result = value.reduce((acc, val) => {
                  acc = acc.concat(`<p>${val}</p>`);
                  return acc;
                }, "");
              } else {
                result = value ? `<p>${value}</p>` : "";
              }
              break;
            case "function":
              const generateFunc = presentSettings[line][type];
              const funcRes = generateFunc(setting);
              if (Array.isArray(funcRes)) {
                result = funcRes.reduce((acc, val) => {
                  acc = acc.concat(`<p>${val}</p>`);
                  return acc;
                }, "");
              } else {
                result = funcRes;
              }
              break;
          }
          return result;
        };

        linesArr.forEach((currentLine) => {
          if (needToShowLines[currentLine]) {
            const line = dom.add("div");
            line.classList.add(lineClasses[currentLine]);

            const lineTitle = dom.add("div");
            lineTitle.className = [
              "text-line",
              ...presentSettings[currentLine].titleDecoration,
            ].join(" ");
            const lineTitleText = generateText(currentLine, "title");
            lineTitle.innerHTML = lineTitleText;

            const lineValue = dom.add("dvi");
            lineValue.className = [
              "text-line",
              ...presentSettings[currentLine].valueDecoration,
            ].join(" ");
            const lineValueText = generateText(currentLine, "value");
            lineValue.innerHTML = lineValueText;

            line.appendChild(lineTitle);
            line.appendChild(lineValue);
            listItemCard.appendChild(line);
          }
        });

        const iconWrapper = dom.add("div");
        iconWrapper.classList.add("card_icon");
        const generateIcon = () => {
          switch (presentSettings.icon.type) {
            case "html":
              return presentSettings.icon.value;
            case "function":
              return presentSettings.icon.value(setting);
          }
        };
        const iconSVG = generateIcon(presentSettings.icon);
        iconWrapper.innerHTML = iconSVG;
        listItemCard.appendChild(iconWrapper);

        if (!setting.active) {
          listItemCard.classList.add("turned-off");
        }

        const activeToggle = dom.add("div");
        activeToggle.className = "active_selector";
        activeToggle.innerHTML = `       
  <div style="position: relative; width:100%; height:100%;">
   <div class="line"></div>
   <label>
    <input type="checkbox" ${setting.active ? "checked" : ""}/>
    <svg class="circle" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" width="14" heigth="14">
      <circle cx="50" cy="50" r="50" fill="var(--blue)"></circle>
    </svg>
  </label>
</div>`;

        const activeToggleLabel = dom.find(activeToggle, "label");
        const activeToggleInput = dom.find(activeToggle, "input");
        dom.addListener(activeToggleLabel, "click", (e) => {
          e.stopPropagation();
          e.preventDefault();
          activeToggleInput.checked = !activeToggleInput.checked;
          setting.active = activeToggleInput.checked;
          if (activeToggleInput.checked) {
            listItemCard.classList.remove("turned-off");
          } else {
            listItemCard.classList.add("turned-off");
          }
          this.#updateHandler && this.#updateHandler();
        });

        listItemCard.appendChild(activeToggle);
        const openHandler = (event) => {
          event.stopPropagation();
          listItemCard.removeEventListener("click", openHandler);
          this.#openModal(
            currentSettings,
            setting,
            listItem,
            setting.id,
            () => {
              listItemCard.addEventListener("click", openHandler);
            },
          );
        };
        listItemCard.addEventListener("click", openHandler);
        return listItemCard;
      }

      #updateCard(currentSettings, li, setting) {
        const { dom } = this.#self;
        const card = dom.find(li, "div");
        card.replaceWith(this.#createCardInner(currentSettings, setting, li));
      }

      async #openModal(
        currentSettings,
        setting,
        container,
        id = null,
        closeHandler = null,
      ) {
        const { dom } = this.#self;
        if (this.#openedModal) {
          await this.#closeModal(this.#closeCallback);
        }
        if (this.#sortable.length) {
          this.#sortable.forEach((sortableList) =>
            sortableList.sortable("disable"),
          );
        }
        this.#closeCallback = closeHandler;
        const modal = dom.add("div");
        modal.className = "settings-modal down";

        const settingsContainer = dom.add("div");
        settingsContainer.className = "container";
        const renderedSettings = await this.#renderModalHandler(
          setting,
          this.#updateModal.bind(this),
        );
        if (typeof renderedSettings == "string") {
          settingsContainer.innerHTML = renderedSettings;
        } else {
          settingsContainer.appendChild(renderedSettings);
        }

        modal.appendChild(settingsContainer);
        const buttonWrapper = dom.add("div");
        buttonWrapper.className = "buttons";
        const cancelButton = dom.add("button");
        cancelButton.className = "cancel-button";
        cancelButton.innerHTML = self.i18n("SortableSettings.cancel_btn");
        const saveButton = dom.add("button");
        saveButton.className = "save-button";
        saveButton.innerHTML = self.i18n("SortableSettings.save_btn");
        const mainBlock = dom.add("div");
        mainBlock.className = "main-buttons";
        mainBlock.appendChild(saveButton);
        mainBlock.appendChild(cancelButton);
        buttonWrapper.appendChild(mainBlock);

        cancelButton.addEventListener("click", async () => {
          await this.#closeModal(closeHandler);
        });

        saveButton.addEventListener("click", async () => {
          if (this.#validateHandler) {
            const error = this.#validateHandler(modal);
            if (error) return;
          }
          const parsedData = this.#parseModalDataHandler(modal);

          if (id === null) {
            let newId;
            if (this.#generateIdForItem) {
              newId = this.#generateIdForItem();
            } else {
              newId = uuid.v4();
            }

            parsedData.id = newId;
            parsedData.active = true;
            this.#addNewSetting(parsedData, currentSettings, container);
            currentSettings.push(parsedData);
          } else {
            const index = currentSettings.findIndex(
              (setting) => setting.id == id,
            );
            parsedData.id = id;
            parsedData.active = currentSettings[index].active;
            currentSettings[index] = parsedData;

            this.#updateSetting(currentSettings, parsedData, id);
          }
          await this.#closeModal(closeHandler);
          this.#updateHandler && this.#updateHandler();
        });

        if (id !== null) {
          const deleteButton = dom.add("button");
          deleteButton.type = "button";
          deleteButton.innerHTML = this.#getSvg("delete");
          deleteButton.className = "delete-button";
          buttonWrapper.appendChild(deleteButton);
          deleteButton.addEventListener("click", async () => {
            const index = currentSettings.findIndex(
              (setting) => setting.id == id,
            );
            currentSettings.splice(index, 1);
            await this.#closeModal(this.#closeCallback);

            this.#deleteSetting(id);
            this.#updateHandler && this.#updateHandler();
          });
        }
        modal.appendChild(buttonWrapper);
        let wrapperBottom;
        let wrapperTop;
        let wrapperRect;
        if (this.#outerWrapper) {
          wrapperRect = this.#outerWrapper.getBoundingClientRect();
          this.#oldOuterWrapperRect = wrapperRect;
          wrapperBottom = wrapperRect.bottom;
          wrapperTop = wrapperRect.top;
        } else {
          wrapperBottom = window.innerHeight;
          wrapperTop = 0;
        }

        container.appendChild(modal);

        setTimeout(() => {
          modal.classList.add("show");
          const modalRect = modal.getBoundingClientRect();

          if (modalRect.bottom + modalRect.height / 18 > wrapperBottom) {
            modal.classList.remove("down");
            modal.classList.add("up");
            modal.style.bottom = `${
              container.getBoundingClientRect().height + 8
            }px`;

            const difference =
              modalRect.bottom + modalRect.height / 18 - wrapperBottom;

            const newModalRect = modal.getBoundingClientRect();

            if (newModalRect.top < wrapperTop) {
              modal.classList.add("down");
              modal.classList.remove("up");
              modal.style.bottom = ``;
              if (this.#outerWrapper) {
                this.#smoothWrapperResize(
                  wrapperRect.height,
                  wrapperRect.height + difference,
                );
              }
            }
          }
        }, 20);
        this.#openedModal = modal;
      }

      async #updateModal(setting) {
        const { dom } = this.#self;

        const modal = this.#openedModal;
        if (!modal) {
          return;
        }

        const settingsContainer = dom.find(modal, ".container");
        const isModalWrapperDown = modal.classList.contains("down");

        const renderedSettings = await this.#renderModalHandler(
          setting,
          this.#updateModal.bind(this),
        );
        settingsContainer.innerHTML = "";
        if (typeof renderedSettings == "string") {
          settingsContainer.innerHTML = renderedSettings;
        } else {
          settingsContainer.appendChild(renderedSettings);
        }
        if (this.#outerWrapper && isModalWrapperDown) {
          setTimeout(() => {
            const wrapperRect = this.#outerWrapper.getBoundingClientRect();
            const newModalRect = modal.getBoundingClientRect();
            const difference = newModalRect.bottom - wrapperRect.bottom;
            this.#smoothWrapperResize(
              wrapperRect.height,
              Math.max(
                wrapperRect.height + difference,
                this.#oldOuterWrapperRect.height,
              ),
            );
          }, 0);
        }
      }
      updateModalHeight() {
        const modal = this.#openedModal;
        if (!modal) {
          return;
        }

        const isModalWrapperDown = modal.classList.contains("down");

        if (this.#outerWrapper && isModalWrapperDown) {
          setTimeout(() => {
            const wrapperRect = this.#outerWrapper.getBoundingClientRect();
            const newModalRect = modal.getBoundingClientRect();
            const difference = newModalRect.bottom - wrapperRect.bottom;
            this.#smoothWrapperResize(
              wrapperRect.height,
              Math.max(
                wrapperRect.height + difference,
                this.#oldOuterWrapperRect.height,
              ),
            );
          }, 0);
        }
      }
      #closeModal(callback) {
        return new Promise((resolve) => {
          this.#openedModal.classList.remove("show");
          this.#openedModal.addEventListener(
            "transitionend",
            () => {
              this.#openedModal.remove();
              this.#openedModal = null;
              if (this.#sortable.length) {
                this.#sortable.forEach((sortableList) =>
                  sortableList.sortable("enable"),
                );
              }
              callback && callback();
              resolve();
            },
            { once: true },
          );
          if (this.#outerWrapper && this.#outerWrapper.style.height) {
            this.#smoothWrapperResize(this.#oldOuterWrapperRect.height);
          }
        });
      }
      #smoothWrapperResize(oldHeight, newHeight) {
        const handleTransitionEnd = (event) => {
          if (event.propertyName === "height") {
            cleanup();
          }
        };

        const cleanup = () => {
          if (!newHeight) this.#outerWrapper.style.removeProperty("height");
          this.#outerWrapper.style.removeProperty("transition");
          this.#outerWrapper.removeEventListener(
            "transitionend",
            handleTransitionEnd,
          );
          clearTimeout(safeTimeout);
        };

        const safeTimeout = setTimeout(cleanup, 500);

        this.#outerWrapper.addEventListener(
          "transitionend",
          handleTransitionEnd,
        );

        this.#outerWrapper.style.transition = "height 0.3s ease";
        this.#outerWrapper.style.height = `${oldHeight}px`;

        this.#outerWrapper.offsetHeight;

        if (newHeight) {
          this.#outerWrapper.style.height = `${newHeight}px`;
        }
      }

      #enableDragAndDrop(list) {
        let startIndex = null;
        let endIndex = null;
        const sortable = $(list).sortable({
          forcePlaceholderSize: true,
          helper: "clone",
          start: (event, ui) => {
            startIndex = ui.item.index();
          },
          stop: (event, ui) => {
            endIndex = ui.item.index();

            const movedSetting = this.#settings.splice(startIndex, 1);
            this.#settings.splice(endIndex, 0, movedSetting[0]);

            startIndex = null;
            endIndex = null;
            this.#updateHandler && this.#updateHandler();
          },
        });
        this.#sortable.push(sortable);
      }

      #enableDragAndDropForGroups(list) {
        const { dom } = this.#self;
        let startIndex = null;
        let endIndex = null;
        let startGroup = null;
        let endGroup = null;
        const sortableGroups = dom.findAll(list, ".sortable-list");

        sortableGroups.forEach((sortableGroup) => {
          const sortable = $(sortableGroup).sortable({
            connectWith: ".sortable-list",
            items: ".sortable-item",
            forcePlaceholderSize: true,
            helper: "clone",
            start: (event, ui) => {
              startIndex = ui.item.index() - 1;
              startGroup = ui.item[0].closest(".sortable-group").dataset.index;
            },
            stop: (event, ui) => {
              endIndex = ui.item.index() - 1;
              const endGroupList = ui.item[0].closest(".sortable-group");
              endGroup = endGroupList.dataset.index;

              const startGroupItem = this.#settings.find(
                (group) => group.id == startGroup,
              );
              const movedSetting = startGroupItem.items.splice(startIndex, 1);
              const endGroupItem = this.#settings.find(
                (group) => group.id == endGroup,
              );
              endGroupItem.items.splice(endIndex, 0, movedSetting[0]);
              this.#updateHandler && this.#updateHandler();
            },
          });
          this.#sortable.push(sortable);
        });

        const sortable = $(list).sortable({
          items: ".sortable-group",
          handle: ".header",
          forcePlaceholderSize: true,
          helper: "clone",
          stop: () => {
            this.#updateHandler && this.#updateHandler();
          },
        });
        this.#sortable.push(sortable);
      }
      #getFlexContentHeight(element, gap) {
        const children = Array.from(element.children);
        const totalHeight = children.reduce(
          (acc, child) => acc + child.offsetHeight,
          0,
        );
        const totalGap = (children.length - 1) * gap;
        return totalHeight + totalGap;
      }

      async #openModalGroup(container, callback) {
        const { dom } = this.#self;
        if (this.#openedModal) {
          await this.#closeModal(this.#closeCallback);
        }
        if (this.#sortable.length) {
          this.#sortable.forEach((sortableList) =>
            sortableList.sortable("disable"),
          );
        }
        const modal = dom.add("div");
        modal.className = "groups-modal";

        const field = dom.add("div");
        field.className = "field";
        const label = dom.add("p");
        label.innerHTML = self.i18n("SortableSettings.group_name");
        const input = dom.add("input");
        input.placeholder = self.i18n(
          "SortableSettings.group_name_placeholder",
        );
        input.addEventListener("input", () => {
          input.style.border = "1px solid var(--palette-border-default)";
        });
        field.appendChild(label);
        field.appendChild(input);
        modal.appendChild(field);

        const buttonWrapper = dom.add("div");
        buttonWrapper.className = "buttons";
        const cancelButton = dom.add("button");
        cancelButton.className = "cancel-button";
        cancelButton.innerHTML = self.i18n("SortableSettings.cancel_btn");
        const saveButton = dom.add("button");
        saveButton.className = "save-button";
        saveButton.innerHTML = self.i18n("SortableSettings.save_btn");

        saveButton.addEventListener("click", async () => {
          if (!input.value) {
            input.style.border = "1px solid var(--color-begonia)";
          } else {
            this.#createNewGroup(input.value);
            await this.#closeModal(callback);
            this.#updateHandler && this.#updateHandler();
          }
        });
        cancelButton.addEventListener("click", async () => {
          await this.#closeModal(callback);
        });

        buttonWrapper.appendChild(saveButton);
        buttonWrapper.appendChild(cancelButton);
        modal.appendChild(buttonWrapper);

        container.appendChild(modal);
        setTimeout(() => modal.classList.add("show"), 10);

        modal.addEventListener("click", (e) => e.stopPropagation());
        this.#openedModal = modal;
        this.#closeCallback = callback;
      }
      #createNewGroup(name) {
        const { dom } = this.#self;
        let newId;
        if (this.#generateIdForGroup) {
          newId = this.#generateIdForGroup();
        } else {
          newId = uuid.v4();
        }

        const newSettings = { id: newId, name: name, items: [] };
        this.#settings.push(newSettings);
        const group = this.#createGroup(newSettings);
        const list = dom.find(this.#container, "ul.sortable-groups");
        list.appendChild(group);
        this.#enableDragAndDropForGroups(group);
      }

      getSettings() {
        return JSON.parse(JSON.stringify(this.#settings));
      }

      setCallbacks(obj) {
        if (obj.update) {
          this.#updateHandler = obj.update;
        }
        if (obj.validate) {
          this.#validateHandler = obj.validate;
        }
        if (obj.generateIdForItem) {
          this.#generateIdForItem = obj.generateIdForItem;
        }
        if (obj.generateIdForGroup) {
          this.#generateIdForGroup = obj.generateIdForGroup;
        }
      }

      setText(obj) {
        if (obj.addNewItem) {
          this.#addNewItem = obj.addNewItem;
        }
        if (obj.AddNewGroup) {
          this.#AddNewGroup = obj.AddNewGroup;
        }
      }

      setWrapper(wrapper) {
        if (wrapper) {
          this.#outerWrapper = wrapper;
        }
      }

      resetSettings() {
        this.#settings = JSON.parse(JSON.stringify(this.#settingsClone));
        this.renderSortableSettings();
      }

      updateSettings() {
        this.#settingsClone = JSON.parse(JSON.stringify(this.#settings));
      }
      setSettings(settings) {
        this.#settings = JSON.parse(JSON.stringify(settings));
        this.#settingsClone = JSON.parse(JSON.stringify(settings));
        this.renderSortableSettings();
      }
    }

    return new SettingsManager(
      self,
      initialSettings,
      renderModalHandler,
      parseModalDataHandler,
      presentSettings,
      draggable,
      withGroups,
    );
  };
});
