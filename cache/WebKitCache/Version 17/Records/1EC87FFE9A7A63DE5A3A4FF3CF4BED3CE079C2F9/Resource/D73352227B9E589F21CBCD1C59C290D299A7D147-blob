"use strict";(window.webpackChunk=window.webpackChunk||[]).push([[94174,61811],{761811:(e,t,i)=>{i.r(t),i.d(t,{default:()=>a});var n=i(445368),s=i(845043);const a=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=APP.getBaseEntity(),i=(0,n.i18n)("".concat(t,"_delete_confirm_1")),a=(0,n.i18n)("".concat(t,"_delete_confirm_2")),o=(0,n.i18n)("delete_".concat(t)),r=(0,n.i18n)("".concat(t,"_remove_item_confirm")),d=e.entity_name,l=[{text:i.replace("#PLACEHOLDER#","«".concat((0,n.leadName)(d,e.lead_id),"»"))},{text:a.replace("#PLACEHOLDER#","«".concat((0,n.leadName)(d,e.lead_id),"»"))}];new s.default({caption:o,template:"/tmpl/common/modal/delete.twig",accept_text:r,message:l,accept:e.accept,destroy:e.destroy})};var o="../build/transpiled/components/base/delete";window.define(o,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([o])},6452:(e,t,i)=>{i.r(t),i.d(t,{default:()=>y});var n=i(661533),s=i.n(n),a=i(629133),o=i.n(a),r=i(345839),d=i.n(r),l=i(460159),c=i.n(l),u=i(313981),h=i(656580),_=i(926168),f=i(859200),m=i(445368),g=i(698857),p=i(729115),v=i(845043);const y=u.default.extend({_templates:function(){return["/tmpl/cards/leads/quick_add_form.twig","stylesheets/_chunks/amoforms.css"]},_suggest_tmpl:function(){return c()({ref:"/tmpl/controls/suggest/dropdown.twig"})},_form_template:function(){return c()({ref:"/tmpl/cards/leads/quick_add_form.twig"})},_selectors:function(){return{save_btn:"#quick_add_form_btn",lead_name:"#quick_add_lead_name",lead_contact_search:"#quick_lead_contact_search",quick_add_button:".pipeline_leads__quick_add_button",quick_add_form:".pipeline_leads__quick_add_form",quick_add_status:"#quick_add_lead_status",linked_entity_form:"#linked-form__add-entity"}},document_events:{"controls:hide:private":"onOutsideClick"},events:{"click .button-cancel":"onCancelClick","click .pipeline_leads__quick_add_button":"onQuickAddButtonClick","click #quick_add_form_btn":"onSubmitClick","click .js-linked-form__unlink":"unlinkEntity",'change input[name="lead[STATUS]"]':"onStatusInputChange",'change input[name="status"]':"onStatusInputChange",click:"stopPropagationOnClick","suggest:loaded .linked-form__ajax-input":"onSuggestLoaded","suggest:changed .linked-form__ajax-input":"onSuggestChanged"},initialize:function(e){this.options=e||{},this.loss_reason_id=null,u.default.prototype.initialize.apply(this,arguments),s().when(c()._preload(this._templates())(),this._getPipelines()).then(o().bind((function(){for(var t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];this.user_rights=(0,f.getRights)(),this.template_params=e.template_params||{},this.linked_entities=new(d().Collection),this.setElement(this.options.$el),u.default.prototype.initialize.apply(this,i),this.init()}),this))},destroy:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];o().isFunction(this.options.onDestroy)&&this.options.onDestroy.call(this),u.default.prototype.destroy.apply(this,t)},clearForm:function(){this._form.revert(),this._$document.trigger("control:select:reset"),this.linked_entities.reset(),this.$el.html(this._cached_form_html),this._dropElemCache()},blurActive:function(){return APP.is_touch_device&&"INPUT"===document.activeElement.tagName&&document.activeElement.blur(),this},init:function(){this._form=this._addComponent(p.default.View,{el:this.$el}),o().isFunction(this.options.onInit)&&this.options.onInit.call(this),this._cached_form_html=this.$el.html()},onOutsideClick:function(e){!this.el||this.el===e.target||s().contains(this.el,e.target)||"pipeline_select_overlay"===s()(e.target).attr("id")||s()(e.target).hasClass("control--suggest")||this.saveCheck()},stopPropagationOnClick:function(e){s()(e.target).closest(".control--select").length||s()(e.target).closest(".control--suggest").length||(this._$document.trigger({type:"controls:hide",target:this.el}),e.stopPropagation())},onSuggestChanged:function(e,t){var i=s()(e.target).data("value-id");this._form.model.set({linked_id:i,element_type:t.data("value-element_type")})},onSuggestLoaded:function(e,t,i){var n=[];"ok"===t.status?(o().each(t.result,o().bind((function(e){var t=this._suggest_tmpl().render(e);n.push({id:e.id,text:t,title:e.name||e.company_name,additional_data:'data-value-element_type="'.concat(e.element_type,'"')}),e.name&&this.linked_entities.push(new(d().Model)(e))}),this)),i.trigger("suggest:reset",[n]).show()):i.trigger("suggest:reset",[[]])},onStatusInputChange:function(e){var t=s()(e.currentTarget).val();(0,_.isLostStatus)(t)&&APP.constant("loss_reason_enabled")?this.modal_loss_reason=this._addComponent(g.default,{onAccept:o().bind((function(e){this.loss_reason_id=e.id}),this)}):this.loss_reason_id=null},onQuickAddButtonClick:function(e){e.stopPropagation(),this._$document.trigger("suggest:manager:destroy"),this._$document.trigger({type:"controls:hide",target:this.el}),this._elem("quick_add_form").toggleClass("expand").one(APP.transition_event,o().bind((function(){o().isFunction(this.options.onToggle)&&this.options.onToggle()}),this)),APP.is_touch_device||!1===this.options.focus||this._findElem("lead_name").focus()},onSubmitClick:function(e){var t=this._form.model,i=t.get("linked_id"),n=o().isFunction(this.options.lead_data)?this.options.lead_data():this.options.lead_data,s=t.get("contact_phone"),a=t.get("contact_email"),r=(0,f.getRights)("contacts","add")&&!i&&!!(a||s||t.get("linked")||APP.data.is_card),d=o().compact((t.get("linked")||"").split(/,(.*)/));e&&(e.preventDefault(),e.stopPropagation()),this.blurActive();var l=o().extend(t.toJSON(),{status:t.get("lead[STATUS]")||t.get("status"),pipeline_id:+t.get("pipeline_id")||+t.get("lead[PIPELINE_ID]")||1===o().keys(this.pipelines_list).length&&+this.pipelines_list[o().keys(this.pipelines_list)[0]].id,main_contact:this.options.main_contact||i,create_contact:r,contact_name:(d[0]||(0,m.i18n)("Name not specified")).trim(),element_type:t.get("element_type")||APP.element_types.contacts},n||{});d[1]&&(l.company_name=(d[1]||"").trim()),o().isNull(this.loss_reason_id)||(l.loss_reason_id=this.loss_reason_id),this.extendSendReq(l)},extendSendReq:function(e){this._elem("save_btn").trigger("button:load:start"),this._sendRequest(e).always(o().bind((function(){this._elem("save_btn").trigger("button:load:stop")}),this)).done(o().bind((function(e){e&&e[0]?(o().isFunction(this.options.onSuccess)&&this.options.onSuccess.call(this,e[0]),this._elem("save_btn").trigger("lead:saved"),this.$el.closest(".pipeline__body").find(".pipeline__no-items").hide(),this.onCancelClick()):o().isFunction(this.options.onFail)&&this.options.onFail.call(this)}),this)).fail(o().bind((function(){o().isFunction(this.options.onFail)&&this.options.onFail.call(this)}),this))},_sendRequest:function(e){return s().ajax({url:"/ajax/leads/multiple/add/",data:s().extend({new_deal:[e]},this.options.data),type:"POST",dataType:"json"})},_getPipelines:function(){h.default.getPipelines().done(o().bind((function(e){this.pipelines_list=e.pipelines}),this))},onCancelClick:function(e){e&&e.stopPropagation(),this._$document.trigger("suggest:manager:destroy"),this._$document.trigger({type:"controls:hide",target:this.el}),this.blurActive().clearForm(!0),this._elem("quick_add_form").removeClass("expand").one(APP.transition_event,o().bind((function(){o().isFunction(this.options.onToggle)&&this.options.onToggle()}),this)),this._elem("quick_add_button").show()},unlinkEntity:function(e){e&&e.stopPropagation(),this._elem("linked_entity_form").html(c()({ref:"/tmpl/leads_pipeline/quick_add/add_entity.twig"}).render()),this._form.updateModelFromForm(),this._form.checkDeleted()},saveCheck:function(){var e=this;this.checkHasChanges()&&!this.confirm&&(this.confirm=new v.default({class_name:"modal-list",text:(0,m.i18n)("quick_lead_confirm"),decline_text:(0,m.i18n)("button_clear"),accept_text:(0,m.i18n)("button_save"),no_close:!0,accept:function(){this.modal.destroy(),e.onSubmitClick()},destroy:function(){!1===this.accepted&&e.onCancelClick(),e.confirm=!1}}))},checkHasChanges:function(){return this._form&&this._form.hasChanges()}});var k="../build/transpiled/components/base/quick_lead/index";window.define(k,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([k])},452919:(e,t,i)=>{i.r(t),i.d(t,{default:()=>f});var n=i(661533),s=i.n(n),a=i(460159),o=i.n(a),r=i(629133),d=i.n(r),l=i(445368),c=i(214558),u=i(93103),h=i(304483),_=function(e){var t=this,i=(0,c.current)();this.ns=".reassign:multiply",this.options=s().extend({},e),this.vars={},this.managers=(0,c.get)(),this.user_id=this.options.user_id||i.id||"",this.user_name=this.options.user_name||i.name||"",s()(document).on("modal:centrify".concat(this.ns),(function(){t.reassign_select&&t.reassign_select.setPositions()})),this.modal=new h.default({class_name:"modal-list ".concat(this.options.class_name),init:o()._preload([t.options.template||"/tmpl/common/modal/reassign.twig"],(function(e){t.vars.$modal_body=e,t.vars.template=o()({ref:t.options.template||"/tmpl/common/modal/reassign.twig"}),t.init(),d().isFunction(t.options.init)&&t.options.init.call(t),e.on("click",".js-modal-accept",(function(){"function"==typeof t.options.confirm?t.options.confirm.call(t):t.options.from_list?(t.modal.hide(),_.linkedReassign({linkeds_text:[(0,l.i18n)("change_main_user_all")],main_user:t.vars.$modal_body.find("input:hidden:not(.js-focuser)").val(),confirm:function(){this.linked_change_accepted=!0,this.modal.destroy()},destroy:function(){t.modal.show(),t.doAjax({with_linked:!0===this.linked_change_accepted})}})):this.save_xhr=t.doAjax()}))})),destroy:function(){s()(document).off("modal:centrify".concat(this.ns)),t.reassign_select&&t.reassign_select.destroy(),d().isFunction(t.options.destroy)&&t.options.destroy.call(t),t.vars.$modal_body&&t.vars.$modal_body.off(),this.save_xhr&&void 0!==this.save_xhr.status&&this.save_xhr.abort()}})};_.linkedReassign=function(e){return new _({template:"/tmpl/common/modal/reassign_linked.twig",template_params:{button_text:(0,l.i18n)("button_yes"),cancel_text:(0,l.i18n)("button_no"),title_before:"".concat((0,l.i18n)("change_main_user_title")," ").concat(e.linkeds_text.join(", ")," "),title_after:(0,l.i18n)("change_main_user_right_postfix")},user_id:e.main_user,confirm:function(){d().isFunction(e.confirm)&&e.confirm.call(this)},destroy:function(){d().isFunction(e.destroy)&&e.destroy.call(this)}})},_.prototype.init=function(){var e=this,t=this.managers,i=d().without(e.options.exclude,e.user_id.toString());i&&i.length&&(t=d().filter(t,(function(e,t){return-1===d().indexOf(i,t)}))),this.vars.$modal_body.trigger("modal:loaded").html(this.vars.template.render(d().extend({title:this.options.title,managers:{class_name:"control--select-white modal-body__inner__managers-select",selected:this.user_id,bg_color:"#fff",items:t}},this.options.template_params))).trigger("modal:centrify"),this.vars.$modal_body.on("click","#reassign-users_select_holder",d().bind(e.initReassignUsersSelect,e))},_.prototype.initReassignUsersSelect=function(e,t){var i=s()(e.currentTarget);e.stopPropagation(),this.reassign_select=new u.default(d().extend({el:i,id:"reassign-users_select_holder",class_name:"modal-reassign__users-select",suggest_class_name:"modal-reassign__users-select-suggest",input_name:"reassign_user_id",select_one:!0,not_remove:!0,in_modal:!0,existing_items:s().map(i.find(".js-multisuggest-item"),(function(){return{id:s()(this).attr("data-id"),title:d().escape(s().trim(s()(this).text()))}})),onInit:function(){this.$list.css({zIndex:1001})}},t))},_.prototype.doAjax=function(e){var t=this;return(e=e||{}).entity=e.entity||this.options.entity,e.id=e.id||this.options.id,t.vars.$modal_body.hide(),s().ajax({url:"/ajax/".concat(e.entity,"/multiple/reassign/"),type:"POST",data:{NEW_MAIN_USER_ID:t.vars.$modal_body.find('[name="reassign_user_id"]').val()||e.new_main_user_id,parties:{id:e.id,with_linked:e.with_linked?1:0}},dataType:"json"}).always((function(){t.vars.$modal_body.show()})).done((function(i){"fail"===i.status?t.modal.showError():(d().isFunction(e.callback)?e.callback():s()(document).trigger("list:reload"),t.modal.showSuccess(i.message))})).fail((function(){t.modal.showError()}))};const f=_;var m="../build/transpiled/components/base/reassign";window.define(m,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([m])},994174:(e,t,i)=>{i.r(t),i.d(t,{default:()=>ae});var n=i(661533),s=i.n(n),a=i(629133),o=i.n(a),r=i(460159),d=i.n(r),l=i(162262),c=i.n(l),u=i(161320),h=i.n(u),_=i(267651),f=i.n(_),m=i(156040),g=i(350562),p=i(656580),v=i(323344),y=i(445368),k=i(168807),b=i(998798),P=i(214558),w=i(500034),C=i(926168),A=i(450422),S=i(859200),x=i(23456),I=i(288420),E=i(490074),T=i(210481),$=i(179488),j=i(207427),F=i(472044),N=i(750823),L=i(76405),D=i(246922),q=i(572944),R=i(843142),B=i(264659),M=i(242949),U=i(224043),O=i(288473),H=i(448596),K=i(766358),V=i(664431),W=i(790580),z=i(845043),Q=i(761811),Y=i(304483),J=i(6452),X=i(452919),G=i(782361),Z=i(260904);function ee(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function te(e){return function(e){if(Array.isArray(e))return ee(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||ie(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ie(e,t){if(e){if("string"==typeof e)return ee(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(i):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?ee(e,t):void 0}}i(59372),i(350646),i(74657),i(298603),i(392744);var ne=s()(document),se=function(e,t){var i=this;t=t||{},this.id=parseInt(e),this.new_card=!this.id,this.user=(0,P.current)(),this.element_type=APP.element_types[APP.getBaseEntity()],this.user_rights=o().extend({is_admin:(0,S.isAdmin)()},(0,S.getRights)(APP.getBaseEntity(),void 0,!0)||{}),this.list_reload=t.after_add||!1,this.readonly_tabs=t.readonly_tabs||!1,this.list=APP.data.current_view,this.from_add=!this.id,this.can_save=this.getCanSaveValue(),this.disable_tags=t.disable_tags,this.offInboxLoadHandling=m.onPageComponentLoadEnd((function(){i.inboxFilter=APP.inbox.addNotifyFilter((function(e){return!e.entity||parseInt(e.entity.id)!==i.id}))}),m.components.inbox),this.$el=s()("#card_holder"),this.$form=s()("#edit_card"),this.$name=this.$el.find("#person_n"),this.$save_btn=this.$el.find("#save_and_close_contacts_link"),this.$save_btn_container=this.$el.find(".card-fields__button-block"),this.main_user=this.getMainUser(),this.$save_and_create_btn=this.$el.find("#save_and_create_contacts_link"),this.initLinked(t),this.element_type===APP.element_types.leads&&APP.constant("loss_reason_enabled")&&c().mixin(this,B.default),APP.constant("user_rights").is_free_user||this.setLinkedTypes(!0);var n=this.getFormParams();this.form=new n.Handler(n.options),this.form.model.on("has_changes",o().bind(this.setChanges,this,{has_changes:!0})).on("has_reverted",o().bind(this.setChanges,this,{has_changes:!1})),this.form.listenTo(this.form.model,"change:lead[MAIN_USER]",o().bind((function(e,t,i){this.setResponsibleUser(t,i)}),this)),this.form.listenTo(this.form.model,"on:customer-created",o().bind((function(e){this._onCustomerCreated(e)}),this)),this.model=this.form.model,this.validator=new O.Validation({el:this.$el,element_type:this.element_type,linked:this.getLinkedForms(),formModel:this.model,onError:function(){i.toggleSaveBlock(!0)}}),this.fields_hider=new Z.default({el:this.form.$el,model:this.model,element_type:this.element_type,rules:APP.constant("card_hidden_fields"),pipeline_id:this.getPipelineId(),status_id:this.getStatusId(),onConflictResolutionHandled:o().bind(this.beforeChangeStatusFieldsHiderConflictResolver,this)}),this._initNotes({notes:t.notes,element_id:this.id}),this.initTabs(),this.validator.model.on("tabs:notification",o().bind(this.showTabNotification,this)).on("tabs:switch",o().bind(this.switchTab,this)),this.setChanges(!1),this.init(),this.canSaveCheck()};o().extend(se.prototype,{template_responsible_user:"/tmpl/users_select/item.twig",_onCustomerCreated:function(e){this.checkChanges()||APP.router.navigate("/customers/detail/".concat(e.customer_id),{trigger:!0})},getCanSaveValue:function(){return this.from_add?this.user_rights.add:o().isUndefined(this.user_rights.can_save)?this.user_rights.edit:this.user_rights.can_save},getCanManageTags:function(){return this.user_rights.manage_tags},checkIfNeedReload:function(){var e;(0,v.getQueryParam)("need_reload")&&(this.setNeedReload(),e=(0,v.removeQueryParam)("need_reload"),APP.router.navigate(window.location.pathname+(e?"?".concat(e):""),{replace:!0}))},setNeedReload:function(){this.list_reload=!0,this.list&&(this.list.need_reload=!0)},setPipelineId:function(e,t,i){var n=this.$el.find('input[name="lead[PIPELINE_ID]"]'),a=n.first(),r=o().result(i,"need_defaults",!0),d=o().result(i,"need_model",!1);i=i||{},o().isBoolean(i.need_defaults)&&(r=i.need_defaults),a.val(e),(n=n.filter((function(){return this.checked=!1,parseInt(s()(this).removeAttr("checked").val())===e}))).length&&(r&&(this.form.model.defaults["lead[PIPELINE_ID]"]=e.toString()),d&&this.form.model.set("lead[PIPELINE_ID]",e.toString(),{silent:!0}),n.prop("checked",!0).attr("checked",!0),!0===t&&n.trigger("change"))},setStatusId:function(e,t,i){var n,a=o().result(i,"field_name","lead[STATUS]"),r=o().result(i,"need_defaults",!0),d=o().result(i,"need_model",!1);n=this.$el.find('input[name="'.concat(a,'"]')),e=parseInt(e)||0;var l=this.getPipelineId();r&&(this.form.model.defaults[a]=e.toString()),1===n.length?n.val(e):(n=n.filter((function(){return this.checked=!1,parseInt(s()(this).removeAttr("checked").val())===e&&s()(this).attr("id").indexOf("_".concat(l,"_"))>-1}))).prop("checked",!0),d&&(this.form.model.set(a,e.toString(),{silent:!0}),n.trigger("controls:change:visual")),!0===t&&n.trigger("change")},setResponsibleUser:function(e,t){this.$el.find("#lead_main_user-users_select_holder .js-multisuggest-list").html(d()({ref:this.template_responsible_user}).render({item:(0,P.get)(e),input_name:"lead[MAIN_USER]"})),t&&t.is_first_assignment_via_socket&&this.unsorted_collection.trigger("unsorted:responsible-assigned"),t&&t.is_trigger&&this.$el.find("#lead_main_user-users_select_holder .js-multisuggest-list").trigger("change")},getPipelineId:function(){return parseInt(this.$el.find('input[name="lead[PIPELINE_ID]"]').val()||0)},getSinglePipelineId:function(){return parseInt(this.$el.find("#card_status_view_mode").data("pipeline-id"))||null},getMainContactId:function(){var e=this.getLinkedForms().$el.find('[data-main-item="true"]').find('[name="ID"]').val();return parseInt(e||0)},getStatusId:function(){var e,t='input[name="lead[STATUS]"]';return this.getPipelineId()&&(t+=":checked"),!(e=parseInt(this.$el.find(t).val()||0))&&this._checkIsUnsorted()&&(e=parseInt(s()("#card_status_view_mode").attr("data-status-id")||0)),e},canSaveCheck:function(e){var t=!e;this.can_save&&!0!==e||(this.$form.find(":input").prop("disabled",t),this.model.set("disabled",t))},getName:function(){var e,t="";if(this.$name.length){if(!(t=this.$name.val()))switch(this.element_type){case APP.element_types.contacts:t=(0,y.contactName)(t);break;case APP.element_types.leads:t=(0,y.leadName)(t,this.id);break;case APP.element_types.customers:t=(0,y.customerName)(t,this.id);break;default:t=this.$name.attr("placeholder")}}else e=this.$el.find(".js-card-name :input"),(t=o().compact(e.map((function(e,t){return t.value}))).join(" "))||(t=e.map((function(e,t){return t.getAttribute("placeholder")})).toArray().join(" "));return t},getMainUser:function(){var e=this.$el.find('.linked-form__field_reassign input[type="hidden"]').val();return e||(e=this.$el.find('.linked-form__field_reassign input[type="checkbox"]').val()),e?parseInt(e):0},setTitle:function(){APP.setTitle(this.getName())},isOnlyNameChanged:function(){var e,t=this.form.model.attributes,i=this.form.model.defaults,n=[];for(e in t)if(o().isEqual(t[e],i[e])||n.push(e),n.length>1)break;return 1===n.length&&"[NAME]"===n[0].slice(-6)},setChanges:function(e){void 0!==e&&(this.changes="boolean"==typeof e?{has_changes:e,notes_added:e,linked_changes:e,quick_lead:e,name_changes:e}:o().extend({},this.changes,e));var t=this.checkChanges(),i=Boolean(t);return i?this._checkChangesExcludeNotes()&&(this.new_card||t>1||!this.isOnlyNameChanged()||this.isOnlyNameChanged()&&this.model.changed_fields.length>1?this.toggleSaveBlock(!0):this.toggleSaveBlock(!1)):this.toggleSaveBlock(!1),APP.router.preventPageChange(i,"card"),this},destroy:function(e){this.removeBeforePrint(),APP.constant("old_unsorted_uid",!1),ne.off("page:show:overlay"),APP.is_touch_device&&s().nonbounce("destroy","card"),this.make_purchase_modal&&o().isFunction(this.make_purchase_modal.destroy)&&this.make_purchase_modal.destroy(),this.offInboxLoadHandling(),this.inboxFilter&&this.inboxFilter.remove(),this.setLinkedTypes(!1),this.canSaveCheck(!0),APP.router.removePreventConfig("card"),this.destroyTabs(),this.destroyLinked(),this.destroyUnsorted(),this.quick_lead&&this.quick_lead.destroy(),this.setChanges(!1),this.form&&this.form.destroy(),this.$el.off(),!0!==e&&(APP.data.current_card=!1,ne.trigger("page:card_changed"))},getPath:function(e,t){var i="/".concat(3===this.element_type?"companies":APP.getBaseEntity(),"/");return t=t||(0,v.getQueryString)(),!1!==e&&(e=e||this.id),i+(e?"detail/".concat(e).concat(t?"?".concat(t):""):"add/".concat(t?"?".concat(t):""))},getFormParams:function(){return{Handler:G.default.View,options:{model:G.default.Model,el:this.$form,entity:{id:this.id,type:this.element_type}}}},getLinkedForms:function(e){return this.linked_forms||!0===e?this.linked_forms:new V.default.View},setId:function(e,t){t=o().extend({navigate:!0},t),e=parseInt(e),this.id!==e&&(this.id=e,this.getLinkedForms().setMainId(e),this._linked_types&&this._linked_types.setMainId(e),this.notes&&this.notes.setMainId(e),t.navigate&&APP.router.navigate(this.getPath(),{replace:!0,trigger:!1}))},checkChanges:function(){return o().compact(o().values(this._checkChangesExcludeNotes())).length},revertChanges:function(){this.setChanges(!1),this.id?(o().each(this.getLinkedForms().form_views,(function(e){e.revert()})),this.form.revert()):APP.router.back(!0)},_checkChangesExcludeNotes:function(){return this.id?o().omit(this.changes,"notes_added"):this.changes},confirmCloseModal:function(e,t,i){var n=this;i=i||(0,y.i18n)("confirm_close_modal"),this.$el.find(".modal-leave-confirm").length||new z.default({class_name:"modal-list modal-leave-confirm",decline_text:(0,y.i18n)("button_exit"),accept_text:(0,y.i18n)("button_save"),button_class:"button-input_blue",text:i,accept:function(){this.destroy()},destroy:function(){!1===this.accepted?o().isFunction(t)&&(n.setChanges(!1),t()):o().isFunction(e)&&e()}})},onOpenCFSettingsClick:function(){var e=this;e.checkChanges()&&e.can_save?e.confirmCloseModal((function(){e.save({callback:function(){e.openCfModal()}})}),(function(){e.openCfModal({init:function(){ne.trigger("page:reload")}})}),(0,y.i18n)("card_page_leave_has_changes")):e.openCfModal()},disableNoEditFields:function(){var e=this.$el.find(".cf-noedit-input");e.find(":input").on("click",(function(){return!1})),e.find(".control--select--list--item").on("click",(function(){return!1})),s()("html").hasClass("explorer")&&e.on("click",(function(){var e=s()(this);e.addClass("cf-noedit-input-animate"),o().delay((function(){e.removeClass("cf-noedit-input-animate")}),1010)})),e.find(":input").prop("disabled",!0)},initReassignUsersSelect:function(e,t){if(e.stopPropagation(),!(0,A.isAmoChatsFullEnabled)()){var i=this,n=i.$el.find(".js-card-fields > .custom-scroll");new H.default(o().extend({el:e.currentTarget,id:"lead_main_user-users_select_holder",input_name:"".concat({companies:"contact",leads:"lead",contacts:"contact",customers:"customers"}[APP.data.current_entity],"[MAIN_USER]"),select_one:!0,class_name:"card-fields__fields-block__users-select",suggest_class_name:"card-fields__fields-block__users-select-suggest",entity:{id:i.id,element_type:i.element_type},onInit:function(){n.height(n[0].scrollHeight)},onDestroy:function(){n.css("height","")}},t))}},getExistedTags:function(e){var t=e||{},i={};return o().isEmpty(t)||(i=s().makeArray(t.find('.js-multisuggest-item:not([data-id="add_tag"])').map((function(){var e=s()(this);return{id:parseInt(e.attr("data-id"))||0,name:e.text().trim(),color:e.attr("data-color")||""}})))),i},getExistedSegments:function(e){var t=e||{},i={};return o().isEmpty(t)||(i=o().map(t.find(".suggest-segments__line-item:not(.suggest-segments__placeholder-item)"),(function(e){var t=s()(e);return{id:parseInt(t.data("id"))||0,color:t.data("color"),name:t.find(".suggest-segments__name").attr("title")}}))),i},initFastTags:function(e){var t,i,n,a=this,r=s()(e.currentTarget),d=r.parent();this.can_save&&!this.disable_tags&&(e.stopPropagation(),d.hasClass("tags-manage")||(i=o().isUndefined(this._existed_tags)?this.getExistedTags(r):o().clone(this._existed_tags),t=this.getFakeTags(r),(n=i).unshift.apply(n,te(t.tags)),new W.default({$el:this.$el,$input_container:r,$container:this.$el.find(".js-card-fields > .custom-scroll"),id:[this.id],tags:i,area:"card",entity:APP.getBaseEntity(),replace:!0,autosize:!1,items_template:"/tmpl/common/fast_tags/fast_tags.twig",onInit:function(){d.addClass("tags-manage"),this.setPositions()},onRenderItemsParams:function(){return{can_add:a.can_save,fake_items:t.items,scoring:void 0,item_tmpl:"interface/common/fast_tags/item.twig"}},onDestroy:function(){this.rerenderInput(this.getSelectedItems()),d.removeClass("tags-manage"),APP.is_touch_device||r.find("input.js-focuser:last").focus()},onSaveSuccess:function(e){a._existed_tags=e,a.id?(this.hasModifications()&&a.setNeedReload(),a._checkAutosave()):this.hasModifications()&&(a.form.model.trigger("has_changes"),a.setNeedReload()),a.$el.trigger("card-tags:save:success")}})))},getFakeTags:function(e){var t=[],i=e.find('.js-multisuggest-fake[data-id="scoring"]');i.length&&t.unshift({id:"scoring",name:i.children("span").text().trim(),color:i.css("background-color"),is_fake:!0});var n=e.find('.js-multisuggest-fake[data-id="lead_id"]');return n.is(":visible")&&t.unshift({id:"lead_id",name:n.text().trim(),is_fake:!0}),{tags:t,items:s().makeArray(e.find(".js-multisuggest-fake").map((function(e,t){return{id:s()(t).attr("data-id"),title:o().escape(s()(t).find(".tag").text().trim()),color:s()(t).attr("data-color"),hidden:t.classList.contains("hidden"),is_fake:!0}})))}},init:d()._preload(["/tmpl/cards/leads/wonlost_item.twig","/tmpl/cards/leads/item.twig","/tmpl/cards/forms/form.twig"],"_init"),onNameChange:function(){!this.new_card&&this.isOnlyNameChanged()&&this.save()},_init:function(){var e,t,n,a=this;this.disableNoEditFields(),this.checkIfNeedReload(),this.onBeforePrint=this.onBeforePrint.bind(this),this.initBeforePrint(),APP.is_touch_device&&s().nonbounce({},"card"),"contacts"===APP.getBaseEntity()&&(n=(0,v.getQueryParam)("phone"))&&this.$el.find('.js-linked-pei[data-type="phone"]:first').val(n).trigger("change"),"yes"===(0,v.getQueryParam)("from_add")&&this._highlightSaved(),this.setTitle(),this.can_save&&APP.router.registerPreventConfig({message:(0,y.i18n)("card_page_leave_has_changes"),accept_text:(0,y.i18n)("button_save"),decline_text:(0,y.i18n)("button_exit"),accept:function(e){a.save({callback:function(){return e(),!1}})},decline:function(e){a.setChanges(!1),ne.off("page:show:overlay"),e()}},"card"),this.$el.on("click","#lead_main_user-users_select_holder",o().bind(this.initReassignUsersSelect,this)).on("input","#person_n",(function(){var e;a.id&&"leads"===APP.getBaseEntity()&&(e=a.$el.find("#add_tags").find('.js-multisuggest-fake[data-id="lead_id"]'),this.value?e.removeClass("hidden"):e.addClass("hidden"))})).on("input","#person_n",o().debounce(o().bind(this.onNameChange,this),3e3)).on("blur","#person_n",o().bind(this.onNameChange,this)).on("click",".js-tracking-data-hide",(function(){var e=s()('.js-cf-group-wrapper[data-id="statistic"]').find(".linked-form__field-tracking-data");e.hasClass("hidden")?(e.removeClass("hidden"),s()(this).text((0,y.i18n)("Hide"))):(e.addClass("hidden"),s()(this).text((0,y.i18n)("Show")))})).on("click",".js-operday-expander",(function(e){var t=s()(e.target),i=t.closest(".js-operday-group").find(".js-operday-users"),n=s()('.js-cf-group-wrapper[data-id="statistic"]').find(".js-operday-users:not(.hidden)"),a=n.closest(".js-operday-group").find(".js-operday-expander");i.is(":visible")?(i.addClass("hidden"),t.text((0,y.i18n)("Show"))):(n.length&&(n.addClass("hidden"),a.text((0,y.i18n)("Show"))),i.removeClass("hidden"),t.text((0,y.i18n)("Hide")))})).on("click","#export-excel",(function(e){e.preventDefault(),Promise.all([i.e(10572),i.e(82966)]).then(i.bind(i,482966)).then((function(e){new(0,e.default)({filter_for_export:{filter:{ID:[(0,v.getParam)("detail")]},type:"excel",encoding:""}})}))})).on("click","#add_tags .js-multisuggest-fake",(function(e){e.stopPropagation()})).on("click","#add_tags",o().bind(this.initFastTags,this)).on("click","#save_and_close_contacts_link:not(.button-input-disabled)",o().bind(a.save,a)).on("click",".js-card-cancel",(function(){a.revertChanges()})).on("click","#save_and_create_contacts_link",(function(){a.save({create_new_after_save:!0})})).on("change controls:change",".js-control-raw-price, .js-control-allow-numeric-negative",(function(e){var t=s()(e.currentTarget),i=t.closest(".linked-form__field__value"),n=t.attr("name");(i.hasClass("linked-form__field__value_computed")||i.data("computed"))&&i.data("computed",i.hasClass("linked-form__field__value_computed")).toggleClass("linked-form__field__value_computed",a.form.model.defaults[n]===a.form.model.attributes[n])})).on("change",'[name="contact[N]"], [name="contact[FN]"], [name="contact[LN]"]',o().bind((function(e){var t=s()(e.currentTarget).closest(".card-fields__top-name-wrapper").find(".js-context-menu-copy"),i="";t.length&&(i=1==!!this.model.get("contact[N]")?this.model.get("contact[N]"):o().compact([this.model.get("contact[FN]"),this.model.get("contact[LN]")]).join(" "),t.attr("data-clipboard-text",i))}),this)).on("click","#card_print",(function(){window.print()})).on("change",'input[name="lead[STATUS]"]',(function(){a.changeStatus()})).on("click",".element__delete-trash",(function(){var e=a.getName();new Q.default({entity_name:o().escape(e),accept:function(){var e=this,t={request:{}},i=function(t){var i=o().isUndefined(t)?(0,y.i18n)("multiple_delete_success_msg"):t.message;e.requestSuccess(i,(function(){a.setNeedReload(),a.setChanges(!1),"yes"===(0,v.getQueryParam)("compact")?(window.opener&&window.opener.APP&&window.opener.APP.router.navigate(window.opener.location.pathname+window.opener.location.search,{trigger:!0,important:!0,replace:!0}),window.close()):APP.router.back()}))};"customers"===APP.getBaseEntity()?(t.request[APP.data.current_entity]={delete:[a.model.get("id")]},a.model.destroy({data:JSON.stringify(t),success:function(){i()},error:function(){e.requestFail()},contentType:"application/json"})):this.requestStart().xhr=s().ajax({url:"/ajax/".concat(APP.data.current_entity,"/multiple/delete/"),type:"POST",data:{ID:[a.id]},success:function(t){if("success"===t.status)i();else{var n=o().first(t.errors);e.requestFail(o().isString(n)?n:null,!1)}},error:function(){e.requestFail()}})}})})).on("click suggest:suggest:click","#add_tags .js-multisuggest-item",(function(e){a.getCanManageTags()||e.stopPropagation()})),this.$el.find("form textarea:not(.control-fullname__single)").trigger("controls:textarea:autosize"),this.$el.on("click",".card-fields__fields-block .js-cf-actions-item",(function(e){a.initTipAction(e)})).on("focus",".card-fields__fields-block .linked-form__cf:not(.js-linked-in-edit)",(function(e){a.focusField(e)})).on("blur",".card-fields__fields-block .linked-form__cf",(function(e){a.unfocusField(e)})).on("focus",".card-fields__fields-block .js-linked-has-actions .linked-form__cf:not(.js-linked-in-edit)",(function(e){APP.is_touch_device||a.focusHasActionsField(e)})).on("blur",".card-fields__fields-block .js-linked-has-actions .linked-form__cf",(function(e){APP.is_touch_device||a.unfocusHasActionsField(e)})).on("blur",".text-input",(function(e){var t=s()(e.currentTarget);t.val(t.val().trim()).trigger("change")})).on("mousedown",".js-cf-has-actions:not(.js-cf-edit-mode)",(function(i){e=i.clientX,t=i.clientY,a.cf_mousedown=!0,a.cf_mousemove=!1})).on("touchstart",".js-cf-has-actions:not(.js-cf-edit-mode)",(function(){a.cf_mousedown=!0,a.cf_mousemove=!1,s()(this).find(":input").prop("readonly",!0)})).on("mouseup touchend",".js-cf-has-actions:not(.js-cf-edit-mode)",(function(){a.cf_mousedown=!1})).on("mousemove",".js-cf-has-actions:not(.js-cf-edit-mode)",(function(i){a.cf_mousedown&&!a.cf_mousemove&&(Math.abs(e-i.clientX)>4||Math.abs(t-i.clientY)>4)&&(a.cf_mousemove=!0)})).on("click",".card-fields__fields-block .js-linked-has-actions",(function(e){a.showActions(e)})),o().contains([APP.element_types.contacts,APP.element_types.companies],this.element_type)&&(this.quick_lead=new J.default({$el:this.$el.find(".pipeline_leads__quick_add__wrapper"),data:{ACTION:"ADD_DEAL_FROM_CONTACTS"},lead_data:function(){return{main_user_id:(0,P.current)().id,main_contact:a.id,element_type:a.element_type}},focus:!1,hide_preventer:".card-leads__quick-add",onToggle:function(){var e=this.$el.children(".js-card-quick-lead-wrapper");this.$el.children(".expand").length?this.$el.parent().addClass("card-leads__quick-add-expanded"):this.$el.parent().removeClass("card-leads__quick-add-expanded"),APP.is_touch_device||e.find("#quick_add_lead_name").focus()},onSuccess:o().bind((function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];a.addLead.apply(this,t),a.notes.saveUnsaved(),(0,x.kommoLogAmplitude)("leadAdded",{"Lead Source":"user"})}),this)})),this.$el.on("click",".pipeline_leads__item-card, .pipeline_customers__item-card",(function(e){return e.ctrlKey||e.metaKey?s()(this).find(".js-navigate-link").trigger({type:"link:navigate",ctrlKey:!0}):APP.router.navigate(s()(this).find(".js-navigate-link").attr("href"),{trigger:!0}),!1})),this.$el.on("click",".control-price",(function(e){s()(e.currentTarget).find("input:visible").focus()})),this.$el.on("suggest:changed",".js-suggest-contact-company-pei, .js-suggest-main-name, .js-linked-pei",(function(e,t){var i=s()(this),n=s().trim(t.find(".suggest-item-pei").text()||t.find("span").attr("title")),r=i.attr("data-value-id"),d=o().invert(APP.element_types)[a.element_type],l=function(){APP.router.navigate("/".concat(d,"/detail/").concat(r),{trigger:!0,replace:!0})};i.val(n),a.checkChanges()?(APP.is_touch_device&&o().delay((function(){document.activeElement.blur()}),100),new z.default({class_name:"modal-list",text:(0,y.i18n)("card_confirm_before_link_".concat(d)),accept:function(){this.modal.destroy()},destroy:function(){this.accepted?(a.setChanges(!1),l()):i.focus()}})):l()})).on("suggest:loaded",".js-suggest-contact-company-pei, .js-suggest-main-name, .js-linked-pei",(function(e,t,i){V.default.AddForm.View.prototype.peiSuggestLoaded(e,t,i)})),this.$el.on("click",".linked-form__field-add-multiple",(function(e){a.addNewVariant(e,a.form)})).on("click",".js-card-linked-tip-holder",(function(e){var t=s()(this).find(".js-tip");t.is(":visible")?ne.trigger("controls:hide"):t.trigger("tip:show"),e.stopPropagation()})).on("keyup",".card-fields__fields-block .linked-form__field-pei input",(function(e){a.showHideAddVariant(e)}))},beforeChangeStatusFieldsHiderConflictResolver:function(e,t){var i=this,n=this.getStatusId(),s=this.getPipelineId(),a={need_model:!0,need_defaults:!1};return new Promise((function(o,r){switch(!0!==e&&void 0!==e||(i.setPipelineId(i.fields_hider.current_pipeline_id,!1,a),i.setStatusId(i.fields_hider.current_status_id,!1,a)),!0){case!0===e:i.save().then((function(){i.setPipelineId(s,!1,a),i.setStatusId(n,!1,a),i.save().then(o,r)}),r);break;case!1===e:i.form.revert(t),o(!0);break;default:r()}}))},changeStatus:function(e,t){var i=this,n=Array.prototype.slice.call(arguments);this.fields_hider.process(this.getPipelineId(),this.getStatusId(),{force:t}).then((function(){var e;(e=i)._changeStatus.apply(e,te(n)),i.updateTabs(i._getDefaultTabs(),"groups")}),o().noop)},_changeStatus:function(e,t){var i=this.getStatusId(),n=this.getPipelineId(),a=o().contains(o().values(o().pick(APP.element_types,"leads","customers")),this.element_type),r=s()("#card_status_view_mode");this.renderStatus(o().extend(e||{},{status_id:i,pipeline_id:n}),t),r.attr("data-pipeline-id",n).attr("data-status-id",i),this.validator.stopValidating(!0),a&&this.validator.updateRules({status_id:this.getStatusId(),pipeline_id:n})},renderStatus:function(e,t){var i=s()("#card_status_view_mode");parseInt(i.attr("data-status-id"))===e.status_id&&parseInt(i.attr("data-pipeline-id"))===e.pipeline_id&&!0!==t||i.html(d()({ref:"/tmpl/cards/leads/controls/view_mode.twig"}).render(o().extend({statuses:APP.constant("lead_statuses"),selected:e.status_id,has_pipelines:Boolean(e.pipeline_id),selected_pipe:{id:e.pipeline_id},editable:this.can_save},e||{})))},saveError:function(){this.$save_btn.trigger("button:save:error"),o().isUndefined(this.keepChangesBeforeSave)||this.setChanges(this.keepChangesBeforeSave())},validate:function(){var e=this.getPipelineId(),t=this.getStatusId(),i=this;return new Promise((function(n){i._checkIsUnsorted()?p.default.getPipelines().done(o().bind((function(s){s.pipelines=o().toArray(s.pipelines),o().each(s.pipelines,(function(i){i.id!==e&&0!==e||i.statuses[0].id!==t||(t=i.statuses[1].id)})),n(i._validate(e,t))})),(function(){n(!1)})):n(i._validate(e,t))}))},_validate:function(e,t){var i=!0;return this.element_type!==APP.element_types.leads&&this.element_type!==APP.element_types.customers||(i=!this.validator.check({status_id:t,pipeline_id:e})),i},_checkAutosave:function(){this.checkChanges()?this.save():this._highlightSaved()},saveRequest:function(e){var t,i=this,n=function(){return i._highlightSaved(),i.setNeedReload(),i.$el.trigger("card:save:success"),!o().isFunction(e.callback)||e.callback()},a=s().Deferred(),r=s().Deferred(),d=s().Deferred(),l=s().Deferred(),c=this.element_type===APP.element_types.leads&&0!==i.id,u=this.form.model,h=s().extend(!0,{},u.attributes),_=o().extend(e.form_data||{},u.toJSON({only_changed:c}));if(e=e||{},this.can_save){if(this.from_add)switch(this.element_type){case APP.element_types.contacts:case APP.element_types.companies:_.contFromLead=i.id;break;case APP.element_types.leads:_.leadFromCont=i.id}else _.ID=i.id;var m=this.keepChangesBeforeSave();m.has_changes&&!0===m.has_changes&&o().has(u.changed,"lead[STATUS]")&&u.get("lead[PIPELINE_ID]")!==u.defaults["lead[PIPELINE_ID]"]&&(this.need_update_tags=!0,this._existed_tags=this.getExistedTags(s()("#add_tags"))),this.new_card&&this._existed_tags&&this.element_type===APP.element_types.leads&&(_["lead[TAGS]"]=o().map(this._existed_tags,(function(e){return{id:e.id||0,name:(0,g.getTagName)(e)}}))),s().ajax({url:i.$form.attr("action"),data:_,type:"POST",dataType:"json"}).done(o().bind((function(c){"success"===c.status?(l=this.saveTempNotes(c.id),this.tryCloseTasks((function(){a.resolve()})),c.scoring&&this.updateScoring(c.scoring),a.done(o().bind((function(){this.checkMainUsers((function(){d.resolve()}))}),this)),t=this.saveTags(this.new_card&&this.element_type!==APP.element_types.leads||this.need_update_tags,c.id,u.defaults["lead[PIPELINE_ID]"]),this.id?r.resolve():(c.id&&this.setId(c.id,{navigate:!1}),f().publish("card:saved",(function(){r.resolve()}))),s().when(a,d,r,t,l).done(o().bind((function(){!1!==n()&&(e.res=c,e.clonned_changes=h,i.afterSave(e))}),this))):this.saveError("card saving: error",c)}),this)).fail(o().bind((function(e){this.saveError("card saving: error",e)}),this))}else n()},saveTags:function(e,t,i){return!e||o().isEmpty(this._existed_tags)?s().Deferred().resolve():(0,g.setTags)({entity:APP.getBaseEntity(),ids:[t],tags:this._existed_tags,old_pipeline_id:i})},_updateLeadName:function(){this.id&&!this.$name.val()&&"leads"===APP.getBaseEntity()&&this.$name.attr("placeholder",(0,y.i18n)("Lead #")+this.id)},_updateContactName:function(e){var t,i=e.first_name,n=e.last_name;"contacts"===APP.getBaseEntity()&&this.$name&&(i||n)&&((t=this.$el.find(".js-card-name")).html(d()({ref:"/tmpl/controls/fullname/index.twig"}).render({name:"contact[N]",input_class_name:"card-fields__top-name-input",comfort_zone:0,placeholder:(0,y.i18n)("placeholder_name"),placeholder_color:"rgba(255, 255, 255, .6)",input_type:"textarea",first_name:{name:"contact[FN]",value:e.first_name},last_name:{name:"contact[LN]",value:e.last_name}})),t.find(":input").trigger("change"))},afterSave:function(e){var t=e.res,i="",n=e.clonned_changes||null,s=this.getStatusId();if(this.from_add||e.create_new_after_save)this.destroy(!0),t.redirect_to?i=t.redirect_to:(i=!this.user_rights.edit&&!this.user_rights.view||e.create_new_after_save?this.getPath(!1,"after_add=yes&r=".concat((0,k.randHex)())):this.getPath(t.id,"after_add=yes&reload=yes"),o().isFunction(e.afterSave)&&e.afterSave({id:t.id,name:this.$el.find("#person_n").val()})),APP.router.navigate(i,{trigger:!0,replace:!0});else{this._updateLeadName(),this._updateContactName(t),this.setTitle(),this.setId(t.id),this.unsorted_collection.trigger("unsorted:responsible-assigned"),this.form.model.updateDefaults(n),this.setChanges({has_changes:this.model.hasChanges()}),this.element_type===APP.element_types.leads&&s!==parseInt(this.form.model.defaults["lead[STATUS]"])&&this.changeStatus({status_changed_from:h()().unix()},!0);var a=this.getPipelineId();if("leads"===APP.getBaseEntity()&&!(0,S.canViewLead)(s,a)){var r=new Y.default({destroy:function(){var e;e="/leads/",(0,b.isImboxSection)()&&(e=(0,w.isFeatureAvailable)("is_customization_for_global")?"/chats/":"/imbox/"),APP.router.navigate(e,{replace:!0,trigger:!0})}});r.showError((0,y.i18n)("You can't view this lead. Please contact your account administrator to update your permissions."),!1),setTimeout((function(){var e;null===(e=r.destroy)||void 0===e||e.call(r)}),3e3)}}},applyChangesBeforeSave:function(){var e=this.changes;return function(){return e}},toggleSaveBlock:function(e,t){var i="card-holder__container_reduced",n=this.$el.find(".card-holder__container");e?(this.$save_btn_container.removeClass("hidden"),n.toggleClass(i,!0),this.$save_btn.trigger("button:save:enable"),this.$save_and_create_btn.show()):(this.$save_and_create_btn.hide(),n.toggleClass(i,!1),this.$save_btn_container.hasClass("js-highlighting")||(this.$save_btn.trigger("button:save:disable"),this.$save_btn_container.addClass("hidden"))),this.is_unsorted&&!(0,A.isAmoChatsFullEnabled)()&&n.addClass(i),!o().isUndefined(t)&&o().isFunction(t)&&t.call()},save:function(e){var t=this,i=this;return this.savePromise||(this.savePromise=new Promise((function(t,n){if(i.quick_lead&&i.quick_lead.checkHasChanges())return i.quick_lead.saveCheck(),void n();e=e||{},"Y"!==i.$save_btn.attr("data-loading")&&i.validate().then((function(s){s?(i.$save_btn.trigger("button:save:start",["#fff"]),i.$el.trigger("card:save:start"),i.keepChangesBeforeSave=i.applyChangesBeforeSave(),i.setChanges(!1),i.toggleSaveBlock(!0),i.notes.save().then(o().bind((function(){i.saveAllLinked({success:o().bind((function(){var n=e.callback||o().noop;e.callback=function(){var e=n();return t(),e},i.makePurchaseOnSuccessfullClose().then((function(t){e.form_data=o().extend(e.form_data||{},t),i.saveRequest(e)}))}),i),error:o().bind((function(e,t){i.saveError("linked saving: error",t||e),n()}),i)})}),i),o().bind((function(){i.saveError("notes saving: error"),n()}),i)),i.id||(0,x.kommoLogAmplitude)("leadAdded",{"Lead Source":"user"})):n()}))})).finally((function(){t.savePromise=null}))),this.savePromise},saveAllLinked:function(e){var t=[];t.push(new Promise((function(e){f().publish("linked:save:before",(function(){e()}))}))),t.push(new Promise(o().bind((function(e,t){this.getLinkedForms().save({success:e,error:t})}),this))),Promise.all(t).then(o().bind((function(){var t,i=function(i,n){t&&f().unsubscribe(t),new Promise((function(e){f().publish("linked:save:after",(function(){e()}))})).then((function(){t?o().isFunction(n)&&n():e.success()}),e.error)};this.id?i():(t=f().subscribe("card:saved",i),e.success())}),this),e.error)},checkMainUsers:function(e){var t=this.getMainUser(),i={},n=[],a=[];if(this.getLinkedForms(!0)&&t!==this.main_user){this.main_user=t;var r=this.getLinkedForms().form_models.filter((function(e){return!(e.get("disabled")||!e.get("ID"))}));o().each(r,(function(e){var t=e.get("ELEMENT_TYPE");i[t]||(i[t]=[],a.push((0,y.i18n)("change_main_user_".concat(t)))),i[t].push(e.get("ID"))})),this.$el.find(".js-card-leads").find(".card-leads__won-lost__body__item, .pipeline_leads__item-card").each((function(){var e=s()(this).attr("data-id");if(!e)return!0;i[APP.element_types.leads]||(i[APP.element_types.leads]=[],a.push((0,y.i18n)("change_main_user_".concat(APP.element_types.leads)))),e&&i[APP.element_types.leads].push(e)})),o().keys(i).length?X.default.linkedReassign({linkeds_text:a,main_user:t,confirm:function(){var a;o().each(i,(function(e,i){n.push(this.doAjax({entity:o().invert(APP.element_types)[i],id:e,new_main_user_id:t,callback:o().noop}))}),this),(a=s()).when.apply(a,te(n)).done(o().bind((function(){o().isFunction(e)&&e()}),this))},destroy:function(){o().isFunction(e)&&e()}}):o().isFunction(e)&&e()}else o().isFunction(e)&&e()},tryCloseTasks:function(e){var t=this.$el.find('input[name="lead[STATUS]"]'),i=this.getStatusId(),n=o().chain(this.notes.views).filter((function(e){var t=e.view.model;return"tasks"===(t.get("object_type")||{}).code&&(parseInt(t.get("element_type"))===this.element_type||parseInt(t.get("element_id"))===this.id)&&t.get("completable")&&!t.get("status")}),this).sortBy((function(e){return e.view.model.get("id")})).value(),a=n.map((function(e){return e.view.model.get("id")}));return e=e||o().noop,!this.id||t.length<1||142!==i&&143!==i?(e(),!1):(a.length?new z.default({class_name:"modal-list modal-leave-confirm",decline_text:(0,y.i18n)("card_page_save_complete_tasks_button_decline"),accept_text:(0,y.i18n)("card_page_save_complete_tasks_button_accept"),button_class:"button-input_blue",text:(0,y.i18n)("card_page_save_complete_tasks"),accept:function(){var e=this;s().ajax({url:"/private/notes/edit2.php",data:{ACTION:"COMPLETE_TASKS",TASKS_IDS:a},type:"POST"}).done((function(){o().each(n,(function(e){e.view.showCompleted()})),e.modal._showSuccess((0,y.i18n)("Done"))}))},destroy:e}):e(),!0)},saveTempNotes:function(e){var t=o().filter(this.notes.notes.toJSON(),(function(e){return 0===e.element_id}));return o().isEmpty(t)?s().Deferred().resolve():s().ajax({url:"/private/notes/tmp_notes.php",data:{element_id:e,comments:t},type:"POST"})},updateScoring:function(e){var t=s()("#card__scoring_wrapper"),i=s()("#card__scoring_value");e.active?(t.show().css("background",e.color),i.text(e.value)):t.hide()},_highlightSaved:function(e){var t,i=this;t=[o().compose(o().isFunction(e)?e:o().noop,o().bind((function(e){i.checkChanges()?i.toggleSaveBlock(!0,(function(){e.removeClass("js-highlighting")})):e.removeClass("js-highlighting").addClass("hidden")}),{},this.$save_btn_container))],this.$save_btn_container.addClass("js-highlighting").removeClass("hidden"),this.$save_btn.trigger("button:saved",t)},_linked_types:null,setLinkedTypes:function(e){if((!e||!this._linked_types)&&(e||this._linked_types)){if(!e)return this._linked_types.destroy(),void(this._linked_types=null);this._linked_types=new K.default({el:this.$el.find(".js-linked-toggler"),element_type:this.element_type,element_id:this.id,$wrapper:this.$el.find(".js-linked_elements_wrapper"),getNotesCollection:o().bind((function(){return this.notes.notes}),this),getLinkedForms:o().bind(this.getLinkedForms,this),onRender:o().bind((function(e){this._linked_types&&this.updateTabs(e,"linked",o().bind(this._linked_types.showType,this._linked_types),o().bind(this._linked_types.hideType,this._linked_types)),m.onPageFullyLoaded(o().bind((function(){this.checkProductsTabExistance(e)}),this)),(0,S.isAdmin)()&&this.updateTabs([{id:"settings",name:(0,y.i18n)("Attach list"),no_highlight:!0,svg_icon:"settings"}],"settings",o().bind(this.onOpenCFSettingsClick,this),o().noop)}),this)}),o().isFunction(this.setModelToLinkedTypes)&&this.setModelToLinkedTypes(),this._linked_types.on("state_changed",(function(e){this.setChanges({linked_changes:e.has_changes})}),this)}},makePurchaseOnSuccessfullClose:function(){var e=s().Deferred();return o().propertyOf(APP.constant("card_element"))("purchase_modal_on_success")&&(0,C.isWonStatus)(this.getStatusId())&&!(0,C.isWonStatus)(this.model.defaults["lead[STATUS]"])?this.initPurchaseModal().then((function(t){e.resolve({purchase:o().pick(t,"price","next_date","comment")})}),(function(){e.resolve({})})):e.resolve({}),e},initPurchaseModal:function(){var e=this;return new Promise((function(t,n){e.id?Promise.all([i.e(57086).then(i.bind(i,257086)),i.e(16034).then(i.bind(i,916034))]).then((function(i){var s,a,r=(a=2,function(e){if(Array.isArray(e))return e}(s=i)||function(e,t){var i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var n,s,a=[],o=!0,r=!1;try{for(i=i.call(e);!(o=(n=i.next()).done)&&(a.push(n.value),!t||a.length!==t);o=!0);}catch(e){r=!0,s=e}finally{try{o||null==i.return||i.return()}finally{if(r)throw s}}return a}}(s,a)||ie(s,a)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),d=r[0].default,l=r[1].default;new d({id:e.id,next_date:l(0),next_price:e.model.get("lead[PRICE]"),complete:o().noop,onRequest:function(e){return t(e),Promise.resolve()},afterDestroy:n})})):n()}))},initBeforePrint:function(){window.addEventListener("beforeprint",this.onBeforePrint)},removeBeforePrint:function(){window.removeEventListener("beforeprint",this.onBeforePrint)},onBeforePrint:function(){this.$el.find(".js-text-input-textarea-value").each((function(){var e,t=s()(this),i=null!==(e=t.prev("textarea").val())&&void 0!==e?e:"";t.text(i)}))},initTabs:o().noop,destroyTabs:o().noop,updateTabs:o().noop,showTabNotification:o().noop,switchTab:o().noop}),c().mixin(se,I.default,E.default,T.default,j.default,F.default,N.default,L.default,$.default,D.default,q.default,R.default,M.default,U.default);const ae=se}}]);var _global="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};_global.SENTRY_RELEASE={id:"build_2025_11_28_18_50_52"},function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=(new Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="bf4f9a96-7590-42e8-bdd5-8ea1be61ba39",e._sentryDebugIdIdentifier="sentry-dbid-bf4f9a96-7590-42e8-bdd5-8ea1be61ba39")}catch(e){}}();
//# sourceMappingURL=94174.d483f107e77307052204.js.map