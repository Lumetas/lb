define(["jquery", "lib/components/base/modal"], function ($, Modal) {
  /**
   * Компонент содержащий методы, которые некуда определить.
   */
  return class Utils {
    /**
     * Доступ к контексту виджета
     * @private
     */
    #self;

    /**
     * @constructor
     * @param {Class} self Контекст виджета this
     */
    constructor(self) {
      this.#self = self;
    }

    /**
     * (DELETE) Выводит логи только на аккаунты представленные в userList.
     * в коде встречается как this.log utils.log self.utils.log this.#self.utils.log
     * @param  {...any} text
     * @returns
     */
    log(...text) {
      const { amo } = this.#self;

      const userList = [
        10714670, // Pavel Krampets
        10713090, // Nikita Detkov
      ];

      if (!userList.includes(amo.get("user").id)) return;

      console.trace(...text);
    }

    /**
     * Добавляет managerSelect
     * Записывает JQuery Element в options.get("managerSelect")
     */
    addManagerSelect() {
      const self = this.#self;
      const { amo, options, dom, utils, managerSelect } = self;

      const saveContainer = dom.get(".emfy-save-container");

      if (!saveContainer) return;

      const widgetOptions = options.get("widget_options");
      const managers = amo.get("managers");
      const filteredManages = Object.values(managers)
        .filter((manager) => manager.active)
        .map((manager) => manager.id);

      const admins = { managers: filteredManages, groups: [] };

      const users = widgetOptions.options
        ? widgetOptions.options.selected_users
          ? widgetOptions.options.selected_users
          : { managers: [], groups: [] }
        : { managers: [], groups: [] };

      const selectedUsers = !users ? admins : users;

      const p = dom.add("p");
      p.innerText = self.i18n("settings.for_users") + ":";
      p.style.color = "var(--palette-text-primary)";
      p.style.marginBottom = "10px";
      p.style.marginTop = "17px";
      p.style.fontWeight = "bold";

      const managerPanel = new managerSelect(self, selectedUsers);

      saveContainer.before(managerPanel[0]);

      managerPanel.init();

      managerPanel.before(p);

      options.set("managerSelect", managerPanel);

      dom.addListener(managerPanel[0], "click", () =>
        utils.useSaveButton("open"),
      );
    }

    /**
     * Проверка для текущего пользователя на статус администратора
     * или нахождение в списке разрешенных менеджеров.
     *
     * @param {string | undefined} userID amo.get("user").id.toString()
     * @returns {boolean}
     */
    allowedManager(userID = undefined) {
      const { options, amo } = this.#self;

      const widgetOptions = options.get("widget_options");

      const selectedUsers =
        Object.hasOwn(widgetOptions, "options") &&
        widgetOptions.options.selected_users;

      if (selectedUsers) {
        const managers = selectedUsers.managers;
        const groups = selectedUsers.groups;
        const stringID = userID || amo.get("user").id.toString();

        if (managers.length === 0) {
          const isAdmin = amo.get("managers")[stringID].is_admin;

          if (isAdmin === "Y") return true;
        } else {
          if (managers.includes(stringID)) return true;
        }
        if (groups.length) {
          const userGroup = amo.get("managers")[stringID].group;
          if (groups.includes(userGroup)) return true;
        }
      } else {
        return true;
      }

      return false;
    }

    /**
     * Прячет кнопку "Сохранить" amoCRM.
     * Добавляет на ее место кастомную кнопку Emfy.
     */
    addSaveButton() {
      const self = this.#self;

      const notInstalled = self.get_install_status() === "install";

      if (notInstalled) return;

      const { options, dom } = self;

      const widgetCode = options.get("params").widget_code;
      const defaultSaveButton = dom.get(`button#save_${widgetCode}`);

      const buttonsContainer = dom.add("div");
      buttonsContainer.className =
        "emfy-save-container widget_settings_block__item_field";
      buttonsContainer.style.opacity = 0;
      buttonsContainer.style.width = 0;
      buttonsContainer.style.height = 0;
      buttonsContainer.style.marginTop = 0;
      buttonsContainer.style.marginBottom = 0;
      buttonsContainer.style.padding = 0;

      const saveButton = dom.add("button");
      saveButton.className = "emfy-save-button button-input button-input_blue";
      saveButton.innerText = self.i18n("settings.activate");
      saveButton.style.opacity = 0;
      saveButton.style.width = 0;
      saveButton.style.height = 0;
      saveButton.style.border = 0;

      const cancelButton = dom.add("button");
      cancelButton.className = "emfy-cancel-button button-input";
      cancelButton.innerText = self.i18n("settings.cancel");
      cancelButton.style.opacity = 0;
      cancelButton.style.width = 0;
      cancelButton.style.height = 0;

      buttonsContainer.append(saveButton);
      buttonsContainer.append(cancelButton);

      defaultSaveButton.parentElement.before(buttonsContainer);
      defaultSaveButton.parentElement.style.display = "none";
    }

    /**
     * Применяет .click() к кнопке "Сохранить" amoCRM
     */
    clickSaveButton() {
      const { dom, options } = this.#self;

      const widgetCode = options.get("params").widget_code;

      const defaultSaveButton = dom.get(`button#save_${widgetCode}`);
      defaultSaveButton.click();
    }

    /**
     * Применяет к кнопке сохранения необходимый триггер.
     * load - в кнопку помещается спинер
     * loaded - в кнопку помещается текст, который был до вызова load
     * text - в кнопку помещается текст из второго аргумента
     * @param {string} type Тип триггера - load, loaded, text
     * @param {string} text Если триггер text, то это необходимый текст
     */
    useSaveButton(type, text = "") {
      const self = this.#self;
      const { dom } = self;

      const saveContainer = dom.get(".emfy-save-container");

      if (!saveContainer) return;

      const saveButton = saveContainer.children[0];
      const cancelButton = saveContainer.children[1];

      switch (type) {
        case "open":
          saveContainer.style.opacity = "1";
          saveContainer.style.width = "fit-content";
          saveContainer.style.height = "fit-content";
          saveContainer.style.marginTop = "16px";
          saveContainer.style.marginBottom = "30px";
          saveContainer.style.padding = "4px 0";

          saveButton.style.opacity = "1";
          saveButton.style.width = "129px";
          saveButton.style.height = "37px";
          saveButton.style.border = "1px solid var(--palette-border-default)";

          if (!cancelButton) break;

          cancelButton.style.opacity = "1";
          cancelButton.style.width = "fit-content";
          cancelButton.style.height = "fit-content";

          break;

        case "close":
          saveContainer.style.opacity = "0";
          saveContainer.style.width = "0";
          saveContainer.style.height = "0";
          saveContainer.style.marginTop = "0";
          saveContainer.style.marginBottom = "0";
          saveContainer.style.padding = "0";

          saveButton.style.opacity = "0";
          saveButton.style.width = "0";
          saveButton.style.height = "0";
          saveButton.style.border = "0";

          if (!cancelButton) break;

          cancelButton.style.opacity = "0";
          cancelButton.style.width = "0";
          cancelButton.style.height = "0";

          break;

        case "load":
          saveButton.setAttribute("emfy-savedInnerHTML", saveButton.innerHTML);
          saveButton.innerHTML = `
        <span class="modal-overlay__spinner spinner-icon"></span>
      `;
          saveButton.style.pointerEvents = "none";

          break;

        case "loaded":
          saveButton.innerHTML = saveButton.getAttribute("emfy-savedInnerHTML");
          saveButton.style.pointerEvents = "all";

          break;

        case "text":
          saveButton.innerHTML = `
        <span class="button-input-inner">${text}</span>
      `;

          break;

        case "removeCancel":
          cancelButton.remove();

          break;

        case "addCancel":
          {
            const cancelButton = document.createElement("button");
            cancelButton.className = "emfy-cancel-button button-input";
            cancelButton.innerText = self.i18n("settings.cancel");
            cancelButton.style.opacity = "1";
            cancelButton.style.width = "fit-content";
            cancelButton.style.height = "fit-content";

            saveContainer.appendChild(cancelButton);
          }
          break;

        default:
          break;
      }
    }

    /**
     * Устанавливает необходимые стили, если виджет не активирован
     * Прячет поля с вводом имени и телефона, если виджет активирован
     */
    setActivationInputs() {
      const self = this.#self;

      const notInstalled = self.get_install_status() === "install";

      if (notInstalled) return;

      const { dom, options } = self;

      const userName = dom.get(`input[name="user_name"]`);
      const userPhone = dom.get(`input[name="user_phone"]`);
      const saveButton = dom.get(".emfy-save-button");

      if (!userName) return;
      if (!userPhone) return;
      if (!saveButton) return;

      const params = options.get("params");

      userPhone.value = params.user_phone || "";
      userName.value = params.user_name || "";

      if (params.user_name && params.user_phone) {
        saveButton.classList.add("emfy-save-enabled");
      }

      saveButton.classList.add("emfy-save-button");

      const widgetCode = options.get("params").widget_code;
      const installed = self.get_install_status();

      if (!installed || installed === "not_configured") {
        const cancelButton = dom.get(".emfy-cancel-button");
        cancelButton.remove();

        const saveContainer = dom.get(".emfy-save-container");

        this.useSaveButton("open");

        saveContainer.style.marginTop = "4px";

        const checkName = () => userName.value;
        const checkPhone = () => userPhone.value;

        const onInput = (e) => {
          const name = checkName();
          const phone = checkPhone();

          const theme =
            document.documentElement.hasAttribute("data-color-scheme");
          const border = theme ? "1px solid #596683" : "1px solid #E3E3E3";

          if (e.target === userName) {
            userName.style.border = border;
          } else {
            userPhone.style.border = border;
          }

          if (name && phone) {
            saveButton.classList.add("emfy-save-enabled");
          } else {
            saveButton.classList.remove("emfy-save-enabled");
          }
        };

        dom.addListener(userName, "input", onInput);
        dom.addListener(userPhone, "input", onInput);
        dom.addListener(saveButton, "click", () => {
          const name = checkName();
          const phone = checkPhone();

          if (name && phone) {
            const defaultSaveButton = dom.get(`button#save_${widgetCode}`);
            defaultSaveButton.click();
          } else {
            const errorBorder = "1px solid #F37575";

            if (!name) {
              userName.style.border = errorBorder;
            }

            if (!phone) {
              userPhone.style.border = errorBorder;
            }
          }
        });

        userName.placeholder = self.i18n("settings.user_name");
        userName.parentElement.previousSibling.remove();

        const p = dom.add("p");
        p.className = "emfy-header";
        p.innerText = self.i18n("settings.activation");

        userName.parentElement.parentElement.before(p);
        userName.parentElement.parentElement.style.display = "flex";
        userName.parentElement.parentElement.style.justifyContent =
          "space-between";

        userPhone.placeholder = self.i18n("settings.user_phone");
        userPhone.parentElement.previousSibling.remove();

        dom.addListener(userPhone, "input", onInput);

        userName.parentElement.after(userPhone.parentElement);

        const activate = self.i18n("settings.activate");

        saveButton.innerText = activate;
      } else if (installed === "installed") {
        if (!userName.value) return;
        if (!userPhone.value) return;
        if (!this.afterSaveEnableCheck()) return;

        userName.parentElement.parentElement.style.display = "none";
        userPhone.parentElement.parentElement.style.display = "none";

        const save = self.i18n("settings.save");

        saveButton.innerText = save;
      }
    }

    /**
     * Добавляет тэг div со стилями hr после описания виджета в настройках
     * @returns {Element} тэг div
     */
    addHr() {
      const self = this.#self;

      const notInstalled = self.get_install_status() === "install";

      if (notInstalled) return;

      const { dom } = self;

      const hr = dom.add("div");
      hr.className = "emfy-hr";

      const desc = dom.get(".widget_settings_block__descr");

      if (!desc) return;

      desc.after(hr);

      return hr;
    }

    addFooterStyles() {
      const { dom, options } = this.#self;

      const widgetCode = options.get("params").widget_code;
      const added = dom.get(`#emfy-footer-styles-${widgetCode}`);

      if (added) return;

      const style = document.createElement("style");
      style.id = `emfy-footer-styles-${widgetCode}`;
      style.innerHTML = `
    .emfy-footer-styles-${widgetCode} .emfy-save-container {
      display: flex;
      transition: all 0.4s ease-out;
    }
    .emfy-footer-styles-${widgetCode} .emfy-save-button {
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--palette-text-primary);
    }
    .emfy-footer-styles-${widgetCode} .emfy-cancel-button {
      border: 0;
      color: var(--palette-text-secondary-light);
    }
    .emfy-footer-styles-${widgetCode} .emfy-cancel-button:hover {
      background: none;
    }
    .emfy-footer-styles-${widgetCode} .emfy-header {
      font-family: PT Sans;
      font-size: 18px;
      font-weight: 400;
      line-height: 23.29px;
      color: var(--palette-text-primary);
      margin-bottom: 10px;
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer {
      position: relative;
      display: flex;
      margin-top: auto;
      align-items: center;
      border-top: 1px solid var(--palette-border-default);
      height: 70px;
      min-height: 70px;
      width: 100%;
      left: -35px;
      padding: 0 35px 0;
      gap: 19px;
      background: var(--palette-background-default);
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer a {
      display: flex;
      align-items: center;
      cursor: pointer;
      margin-left: auto;
      text-decoration: none;
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer a span {
      font-size: 25px;
      font-weight: 900;
      margin-left: 5px;
      color: var(--palette-text-primary);
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer div {
      height: 20px;
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer div:hover div {
      height: 127px;
      border: solid 1px var(--palette-border-default);
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer div:hover div button,  
    .emfy-footer-styles-${widgetCode} .emfy-footer div:hover div a {
      opacity: 1;
      height: auto;
      transition-delay: 0.3s;
      transition-duration: 0.3s;
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer div:hover div button svg,  
    .emfy-footer-styles-${widgetCode} .emfy-footer div:hover div a svg {
      height: auto;
      margin: 0;
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer div:hover div button p,  
    .emfy-footer-styles-${widgetCode} .emfy-footer div:hover div a p {
      font-size: 15px;
      height: auto;
      margin: 0;
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer div button {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      height: 100%;
      color: var(--palette-text-primary);
      background: var(--palette-background-default);
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer div button svg {
      margin-top: 4px;
      margin-left: 1px;
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer div button p {
      margin-top: 7px;
      height: 26px;
    }
    @supports (-moz-appearance:none) {
      .emfy-footer-styles-${widgetCode} .emfy-footer div button p {
        margin-top: 4px;
        height: 26px;
      }
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer div div {
      display: flex;
      position: absolute;
      flex-direction: column;
      justify-content: center;
      gap: 7.5px;
      bottom: 22.5px;
      z-index: 99;
      width: 197px;
      height: 0;
      background: var(--palette-background-default);
      border: none;
      border-radius: 5px;
      filter: drop-shadow(0 4px 4px rgba(0, 0, 0, 0.25));
      transition: height ease-in-out;
      transition-duration: 0.3s;
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer div div button,
    .emfy-footer-styles-${widgetCode} .emfy-footer div div a {
      display: flex;
      gap: 4px;
      margin-left: 18px;
      font-family: "PT Sans";
      font-style: normal;
      font-weight: 400;
      font-size: 15px;
      line-height: 19px;
      text-decoration: none;
      opacity: 0;
      height: 0;
      transition: opacity 0.25s, height 0.25s;
      transition-delay: 0s;
      cursor: pointer;
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer div div button svg,
    .emfy-footer-styles-${widgetCode} .emfy-footer div div a svg {
      height: 0;
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer div div button p,
    .emfy-footer-styles-${widgetCode} .emfy-footer div div a p {
      font-size: 0;
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer div div div { 
      all: initial;
      position: absolute;
      width: 154px;
      height: 22px !important;
      border: none !important;
      background: #363B44;
      border-radius: 5px;
      font-family: 'PT Sans';
      font-style: normal;
      font-weight: 400;
      font-size: 15px;
      line-height: 22px;
      text-align: center;
      color: #FFFFFF;
      transition: opacity 0.3s;
      cursor: pointer;
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer span {
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 7px;
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer span p {
      display: flex;
      gap: 5px;
    }
    .emfy-footer-styles-${widgetCode} .emfy-footer span p a {
      color: #4c8bf7;
      text-decoration: underline;
    }
    .emfy-footer-styles-${widgetCode} .emfy-hr {
      position: relative;
      height: 1px;
      width: 653px;
      left: -35px;
      background: var(--palette-border-default);
    }
    html[data-color-scheme="dark"] .emfy-footer-styles-${widgetCode} .emfy-svg {
      filter: invert(100%) sepia(93%) saturate(300%) hue-rotate(216deg)
        brightness(132%) contrast(90%);
    }
    .emfy-footer-styles-${widgetCode} .custom_separator {
      margin: 0 -35px;
    }
    .emfy-footer-styles-${widgetCode} .emfy-save-enabled {
      background: #4C8BF7 !important;
      color: #FFFFFF !important;
      border: 1px solid #4C8BF7 !important;
    }
    html[data-color-scheme="dark"] .emfy-footer-styles-${widgetCode} .emfy-save-enabled {
      color: #F2F2F2 !important;
    }
  `;

      document.head.append(style);
    }

    #addFooterStylesAdvanced() {
      const { dom, options } = this.#self;

      const widgetCode = options.get("params").widget_code;
      const added = dom.get(`#emfy-footer-advanced-styles-${widgetCode}`);

      if (added) return;

      const style = document.createElement("style");
      style.id = `emfy-footer-advanced-styles-${widgetCode}`;
      style.innerHTML = `
  #work-area-${widgetCode} .emfy-footer {
    position: relative;
    display: flex;
    margin-top: auto;
    align-items: center;
    border-top: 1px solid var(--palette-border-primary);
    height: 70px;
    min-height: 70px;
    width: calc(100% - 10px);
    left: -35px;
    padding: 0 35px 0;
    gap: 19px;
    background: var(--palette-background-primary);
  }
  #work-area-${widgetCode} .emfy-footer a {
    display: flex;
    align-items: center;
    cursor: pointer;
    margin-left: auto;
    text-decoration: none;
  }
  #work-area-${widgetCode} .emfy-footer a span {
    font-size: 25px;
    font-weight: 900;
    margin-left: 5px;
    color: var(--palette-text-primary);
  }
  #work-area-${widgetCode} .emfy-footer div {
    height: 20px;
  }
  #work-area-${widgetCode} .emfy-footer div:hover div {
    height: 127px;
    border: solid 1px var(--palette-border-default);
  }
  #work-area-${widgetCode} .emfy-footer div:hover div button,  
  #work-area-${widgetCode} .emfy-footer div:hover div a {
    opacity: 1;
    height: auto;
    transition-delay: 0.3s;
    transition-duration: 0.3s;
  }
  #work-area-${widgetCode} .emfy-footer div:hover div button svg,  
  #work-area-${widgetCode} .emfy-footer div:hover div a svg {
    height: auto;
    margin: 0;
  }
  #work-area-${widgetCode} .emfy-footer div:hover div button p,  
  #work-area-${widgetCode} .emfy-footer div:hover div a p {
    font-size: 15px;
    height: auto;
    margin: 0;
  }
  #work-area-${widgetCode} .emfy-footer div button {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    height: 100%;
    color: var(--palette-text-primary);
    background: var(--palette-background-default);
  }

  #work-area-${widgetCode} .emfy-footer button.main-button{
  background: var(--palette-background-primary);
  }
  #work-area-${widgetCode} .emfy-footer div button svg {
    margin-top: 4px;
    margin-left: 1px;
  }
  #work-area-${widgetCode} .emfy-footer div button p {
    margin-top: 7px;
    height: 26px;
  }
  @supports (-moz-appearance:none) {
    #work-area-${widgetCode} .emfy-footer div button p {
      margin-top: 4px;
      height: 26px;
    }
  }
  #work-area-${widgetCode} .emfy-footer div div {
    display: flex;
    position: absolute;
    flex-direction: column;
    justify-content: center;
    gap: 7.5px;
    bottom: 22.5px;
    z-index: 99;
    width: 197px;
    height: 0;
    background: var(--palette-background-default);
    border: none;
    border-radius: 5px;
    filter: drop-shadow(0 4px 4px rgba(0, 0, 0, 0.25));
    transition: height ease-in-out;
    transition-duration: 0.3s;
  }
  #work-area-${widgetCode} .emfy-footer div div button,
  #work-area-${widgetCode} .emfy-footer div div a {
    display: flex;
    gap: 4px;
    margin-left: 18px;
    font-family: "PT Sans";
    font-style: normal;
    font-weight: 400;
    font-size: 15px;
    line-height: 19px;
    text-decoration: none;
    opacity: 0;
    height: 0;
    transition: opacity 0.25s, height 0.25s;
    transition-delay: 0s;
    cursor: pointer;
  }
  #work-area-${widgetCode} .emfy-footer div div button svg,
  #work-area-${widgetCode} .emfy-footer div div a svg {
    height: 0;
  }
  #work-area-${widgetCode} .emfy-footer div div button p,
  #work-area-${widgetCode} .emfy-footer div div a p {
    font-size: 0;
  }
  #work-area-${widgetCode} .emfy-footer div div div { 
    all: initial;
    position: absolute;
    width: 154px;
    height: 22px !important;
    border: none !important;
    background: #363B44;
    border-radius: 5px;
    font-family: 'PT Sans';
    font-style: normal;
    font-weight: 400;
    font-size: 15px;
    line-height: 22px;
    text-align: center;
    color: #FFFFFF;
    transition: opacity 0.3s;
    cursor: pointer;
  }
  #work-area-${widgetCode} .emfy-footer span {
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 7px;
  }
  #work-area-${widgetCode} .emfy-footer span p {
    display: flex;
    gap: 5px;
  }
  #work-area-${widgetCode} .emfy-footer span p a {
    color: #4c8bf7;
    text-decoration: underline;
  }
  #work-area-${widgetCode} .emfy-hr {
    position: relative;
    height: 1px;
    width: 653px;
    left: -35px;
    background: var(--palette-border-default);
  }
  html[data-color-scheme="dark"] #work-area-${widgetCode} .emfy-svg {
    filter: invert(100%) sepia(93%) saturate(300%) hue-rotate(216deg)
      brightness(132%) contrast(90%);
  }
  #work-area-${widgetCode} .custom_separator {
    margin: 0 -35px;
  }
  #work-area-${widgetCode} .emfy-save-enabled {
    background: #4C8BF7 !important;
    color: #FFFFFF !important;
    border: 1px solid #4C8BF7 !important;
  }
  html[data-color-scheme="dark"] #work-area-${widgetCode} .emfy-save-enabled {
    color: #F2F2F2 !important;
  }
`;

      document.head.append(style);
    }

    #addSettingsStyles() {
      const self = this.#self;
      const { dom, options } = self;

      const installed = self.get_install_status();

      const hover =
        installed === "installed"
          ? ""
          : `.button-input_blue:not(.button-input-disabled):hover {
        background: none;
      }`;

      const colorDisabledDark =
        installed === "installed"
          ? "color: var(--palette-text-primary);"
          : "color: #7F8BA4;";

      const colorDisabledLight =
        installed === "installed"
          ? "color: var(--palette-text-primary);"
          : "color: #92989B;";

      const p = dom.add("p");
      p.id = "emfy-settings-styles";
      p.innerHTML = `
    <style>
      .widget-settings__wrap-desc-space {
        overflow-y: hidden;
        padding: 32px 35px 0;
      }
      .widget-settings__desc-space {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      .widget_settings_block__descr {
        display: flex;
        flex-direction: column;
        margin-top: 25px;
        margin-bottom: 25px;
      }
      .widget_settings_block {
        position: relative;
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      .widget_settings_block__controls {
        margin-bottom: 20px;
      }
      .popular-chat-swiper {
        margin-bottom: 20px;
      }
      .widget_settings_block__input_field .text-input {
        width: 267px;
        height: 31px;
        font-family: PT Sans;
        font-size: 15px;
        font-weight: 400;
        line-height: 19.41px;
        border: 1px solid #E3E3E3;
      }
      .text-input::placeholder {
        font-family: PT Sans;
        font-size: 15px;
        font-weight: 400;
        line-height: 19.41px;
        color: #B5B5B5;
      }
      html[data-color-scheme="dark"] .text-input::placeholder {
        color: #6A7991;
      }
      html[data-color-scheme="dark"] .widget_settings_block__input_field .text-input {
        border: 1px solid #596683;
      } 
      html[data-color-scheme="dark"] .button-input_blue:not(.button-input-disabled) {
        border: 1px solid #596683;
        ${colorDisabledDark}
      }
      .button-input_blue:not(.button-input-disabled) {
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: PT Sans;
        font-size: 15px;
        font-weight: 700;
        line-height: 19.41px;
        text-align: left;
        ${colorDisabledLight}
        border: 1px solid #E3E3E3;
        background: none;
      }
      .button-input_blue:not(.button-input-disabled) .spinner-icon {
        border-top-color: #158FD2 !important;
        border-left-color: #158FD2 !important;
      }
      html[data-color-scheme="dark"] .button-input_blue:not(.button-input-disabled) .spinner-icon {
        border-top-color: #fff !important;
        border-left-color: #fff !important;
      }
      ${hover}
    </style>
  `;

      const settings = dom.get(".widget-settings");

      if (settings) {
        const widgetCode = options.get("params").widget_code;
        settings.classList.add(`emfy-footer-styles-${widgetCode}`);
      }

      const descr = dom.get(".widget_settings_block__descr");

      if (descr) {
        descr.append(p);
      }
    }

    /**
     * Устанавливает поведение стрелок свайпера
     * @private
     * @param {string[]} iframes Массив iframe'ов
     * @param {string[]} miniTours Массив мини-изображений
     * @param {number} tourCount Количество изображений
     * @param {boolean} left Левая или права стрелка
     */
    #swiperArrow(iframes, miniTours, tourCount, left, video) {
      const { dom } = this.#self;

      let key = undefined;

      iframes.forEach((iframe) => {
        const dataKey = Number(iframe.outerHTML.substring(18, 19));

        if (iframe.style.display === "block") key = dataKey;

        iframe.style.display = "none";
      });

      miniTours.forEach((tour) => {
        tour.classList.add("popular-chat-swiper__mini-opacity");
      });

      const newKey = left
        ? key - 1 < 0
          ? tourCount - 1
          : key - 1
        : key + 1 > tourCount - 1
          ? 0
          : key + 1;

      const arrowLeft = dom.get(".popular-chat-swiper__arrow-left");
      const arrowRight = dom.get(".popular-chat-swiper__arrow-right");

      iframes.forEach((iframe) => {
        const dataKey = Number(iframe.outerHTML.substring(18, 19));

        if (dataKey === newKey) iframe.style.display = "block";
      });

      miniTours.forEach((tour) => {
        const dataKey = Number(tour.outerHTML.substring(15, 16));

        if (dataKey === newKey)
          tour.classList.remove("popular-chat-swiper__mini-opacity");
      });

      if (video && newKey === 0) {
        arrowLeft.style.pointerEvents = "none";
        arrowRight.style.pointerEvents = "none";
      } else {
        arrowLeft.style.pointerEvents = "all";
        arrowRight.style.pointerEvents = "all";
      }
    }

    /**
     * Создает свайпер
     * @private
     * @param {number} tourCount Количество изображений
     */
    #addSwiper(tourCount, video) {
      const self = this.#self;
      const { dom, options, amo } = self;

      const path = options.get("params").path;
      const lang = amo.lang_id;

      let tour = "";
      let miniTour = "";

      if (video) {
        tour += `
        <iframe 
          data-key="0"
          class="popular-chat-swiper__img"
          src="${video}" 
          title="YouTube video player" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
          allowfullscreen
        ></iframe>
      `;

        miniTour += `
        <img 
          data-key="0"
          class="popular-chat-swiper__img"
          src="${path}/images/tour_1_${lang}.png?v=${self.get_version()}"
        >
      `;
      }

      let i = video ? 2 : 1;

      for (; i <= tourCount; i++) {
        const opacity = i === 1 ? "" : "popular-chat-swiper__mini-opacity";
        const display = i === 1 ? "block" : "none";
        const src = `${path}/images/tour_${i}_${lang}.png?v=${self.get_version()}`;

        tour += `
      <iframe
        data-key="${i - 1}"
        class="popular-chat-swiper__img"
        src="${src}"
        style="display:${display}"
        scrolling="no"
        width="593"
        height="304"
      ></iframe>
    `;

        miniTour += `
      <img 
        data-key="${i - 1}"
        class="popular-chat-swiper__img ${opacity}"
        src="${src}"
      >  
    `;
      }

      const events = video ? "none" : "all";

      const swiper = dom.add("div");
      swiper.className = "popular-chat-swiper";
      swiper.innerHTML = `
    <div class="popular-chat-swiper__show-container">
      <div
        class="popular-chat-swiper__arrow-left popular-chat-swiper__img-arrow"
        style="pointer-events: ${events}"
      ></div>
      <div
        class="popular-chat-swiper__arrow-right popular-chat-swiper__img-arrow"
        style="pointer-events: ${events}"
      ></div>
      ${tour}
    </div>
    <div class="popular-chat-swiper__mini-container">
      ${miniTour}
    </div>
  `;

      const hr = dom.add("div");
      hr.className = "emfy-hr";

      const settings = dom.get(".widget_settings_block__descr");

      if (settings) {
        settings.before(swiper);
        swiper.after(hr);

        const arrowLeft = dom.get(".popular-chat-swiper__arrow-left");
        const arrowRight = dom.get(".popular-chat-swiper__arrow-right");
        const container = dom.get(".popular-chat-swiper__show-container");
        const iframes = dom.findAll(container, "iframe");
        const mini = dom.get(".popular-chat-swiper__mini-container");
        const miniTours = dom.findAll(mini, "img");

        dom.addListener(arrowLeft, "click", () =>
          this.#swiperArrow(iframes, miniTours, tourCount, true, video),
        );
        dom.addListener(arrowRight, "click", () =>
          this.#swiperArrow(iframes, miniTours, tourCount, false, video),
        );

        miniTours.forEach((tour) => {
          dom.addListener(tour, "click", () => {
            const className = "popular-chat-swiper__mini-opacity";
            const dataKey = Number(tour.outerHTML.substring(15, 16));

            miniTours.forEach((el) => {
              el.classList.add(className);
            });

            tour.classList.remove(className);

            iframes.forEach((iframe) => {
              const iframeKey = Number(iframe.outerHTML.substring(18, 19));

              if (dataKey === iframeKey) {
                iframe.style.display = "block";
              } else {
                iframe.style.display = "none";
              }
            });

            if (video && dataKey === 0) {
              arrowLeft.style.pointerEvents = "none";
              arrowRight.style.pointerEvents = "none";
            } else {
              arrowLeft.style.pointerEvents = "all";
              arrowRight.style.pointerEvents = "all";
            }
          });
        });

        iframes.forEach((iframe) => {
          const interval = setInterval(() => {
            const content = iframe.contentWindow;

            if (!content) return;

            try {
              const img = content.document.children[0].children[1].children[0];

              if (!img) return;

              clearInterval(interval);

              img.width = "593";
              img.height = "304";
            } catch (err) {
              clearInterval(interval);
            }
          }, 100);
        });
      }
    }

    #addPaymentInfo() {
      const self = this.#self;
      const { options } = self;

      const widgetOptions = options.get("widget_options");

      if (!widgetOptions) return;

      const paidTill = widgetOptions.paid_till;
      const paidLeft = widgetOptions.paid_left;

      if (!paidTill || !paidLeft) {
        return;
      }

      if (!widgetOptions.is_actived) {
        return `
      <span>  
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 16.5C13.2 16.5 16.5 13.2 16.5 9C16.5 4.8 13.2 1.5 9 1.5C4.8 1.5 1.5 4.8 1.5 9C1.5 13.2 4.8 16.5 9 16.5ZM9 18C4.05 18 0 13.95 0 9C0 4.05 4.05 0 9 0C13.95 0 18 4.05 18 9C18 13.95 13.95 18 9 18Z" fill="#FF4646"/>
          <path d="M9.9001 13.5H8.1001V11.7H9.9001V13.5ZM9.9001 9.9H8.1001V4.5H9.9001V9.9Z" fill="#FF4646"/>
        </svg>
        <p>
          ${self.i18n("settings.not_active")} 
          <a class="emfy-renew">
            ${self.i18n("settings.renew")}
          </a>
        </p>  
      </span>    
    `;
      } else if (widgetOptions.is_test_period) {
        return `
      <span>
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 16.5C13.2 16.5 16.5 13.2 16.5 9C16.5 4.8 13.2 1.5 9 1.5C4.8 1.5 1.5 4.8 1.5 9C1.5 13.2 4.8 16.5 9 16.5ZM9 18C4.05 18 0 13.95 0 9C0 4.05 4.05 0 9 0C13.95 0 18 4.05 18 9C18 13.95 13.95 18 9 18Z" fill="#FFD646"/>
          <path d="M9.9001 13.5H8.1001V11.7H9.9001V13.5ZM9.9001 9.9H8.1001V4.5H9.9001V9.9Z" fill="#FFD646"/>
        </svg>
        <p>${self.i18n("settings.test_period")} ${paidTill}</p>
      </span>
    `;
      } else if (paidTill !== "unlimited") {
        return `
      <span>
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12.9734 5.44529L7.74323 11.2683L4.98473 8.62229C4.92637 8.56667 4.85763 8.52309 4.78243 8.49403C4.70723 8.46497 4.62705 8.45101 4.54645 8.45294C4.46585 8.45488 4.38643 8.47266 4.31271 8.50529C4.23899 8.53792 4.17241 8.58475 4.11679 8.64311C4.06117 8.70146 4.01758 8.7702 3.98853 8.8454C3.95947 8.9206 3.94551 9.00079 3.94744 9.08138C3.94937 9.16198 3.96716 9.24141 3.99979 9.31513C4.03242 9.38885 4.07925 9.45542 4.1376 9.51104L7.34498 12.5958C7.45748 12.7083 7.61048 12.7702 7.7736 12.7702H7.79498C7.87626 12.7661 7.95592 12.7459 8.02932 12.7108C8.10271 12.6756 8.16838 12.6262 8.22248 12.5654L13.8835 6.27217C13.9371 6.21183 13.9782 6.14152 14.0046 6.06527C14.031 5.98902 14.0421 5.90831 14.0373 5.82776C14.0325 5.74721 14.0119 5.6684 13.9766 5.59582C13.9413 5.52325 13.8921 5.45834 13.8317 5.40479C13.7737 5.34922 13.7049 5.30603 13.6296 5.27786C13.5544 5.24968 13.4741 5.23711 13.3939 5.24089C13.3136 5.24468 13.2349 5.26475 13.1626 5.29989C13.0903 5.33503 13.0259 5.3845 12.9734 5.44529Z" fill="#679440"/>
          <path d="M9 0C4.03537 0 0 4.03537 0 9C0 13.9646 4.03537 18 9 18C13.9646 18 18 13.9646 18 9C18 4.03537 13.9646 0 9 0ZM9 16.7738C6.93864 16.7726 4.96205 15.9532 3.50445 14.4956C2.04684 13.038 1.22744 11.0614 1.22625 9C1.22744 6.93864 2.04684 4.96205 3.50445 3.50445C4.96205 2.04684 6.93864 1.22744 9 1.22625C11.0614 1.22744 13.038 2.04684 14.4956 3.50445C15.9532 4.96205 16.7726 6.93864 16.7738 9C16.7726 11.0614 15.9532 13.038 14.4956 14.4956C13.038 15.9532 11.0614 16.7726 9 16.7738Z" fill="#679440"/>
        </svg>
        <p>${self.i18n("settings.active")} ${paidTill}</p>
      </span>
    `;
      } else {
        return;
      }
    }

    /**
     * Создает футер
     * @private
     */
    #addFooter() {
      const self = this.#self;
      const { dom, amo } = self;

      const settings = dom.get(".widget_settings_block");
      const paymentInfo = this.#addPaymentInfo();
      const mobileOrTablet = this.mobileOrTablet();

      const copied = self.i18n("settings.copied");
      const contacts = self.i18n("settings.contacts_button");

      const whatsappLink = mobileOrTablet
        ? self.i18n("settings.support_wa_mobile")
        : self.i18n("settings.support_wa");

      const links = mobileOrTablet
        ? `
      <a 
        href="mailto:${self.i18n("settings.emfy_email")}"
        style="color: var(--palette-text-primary)"
      >
        <svg class="emfy-svg" width="17" height="13" viewBox="0 0 17 13" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15.3 0H1.7C0.760467 0 0.00793333 0.726917 0.00793333 1.625L0 11.375C0 11.806 0.179107 12.2193 0.497918 12.524C0.81673 12.8288 1.24913 13 1.7 13H15.3C15.7509 13 16.1833 12.8288 16.5021 12.524C16.8209 12.2193 17 11.806 17 11.375V1.625C17 1.19402 16.8209 0.780698 16.5021 0.475951C16.1833 0.171205 15.7509 0 15.3 0ZM15.3 3.25L8.5 7.3125L1.7 3.25V1.625L8.5 5.6875L15.3 1.625V3.25Z" fill="#363B44"/>
        </svg>
        <p style="margin-left: 5px">${self.i18n("settings.emfy_email")}</p>
      </a>
      <a 
        href="tel:${self.i18n("settings.emfy_phone_href")}" 
        style="color: var(--palette-text-primary)"
      >
        <svg class="emfy-svg" width="12" height="13" viewBox="0 0 12 13" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M2.4168 5.63018C3.3768 7.67473 4.92 9.34582 6.81 10.3858L8.2764 8.79273C8.35845 8.70015 8.46671 8.63382 8.5873 8.60224C8.70788 8.57065 8.83529 8.57526 8.9532 8.61545C9.71593 8.88847 10.5213 9.02806 11.3328 9.02791C11.7036 9.02791 12 9.34936 12 9.75V12.2779C12 12.6797 11.7036 13 11.3328 13C5.0736 13 0 7.50454 0 0.722091C0 0.320273 0.3 0 0.6672 0H3C3.3696 0 3.6672 0.321455 3.6672 0.722091C3.6672 1.62027 3.7992 2.49127 4.0464 3.30082C4.08426 3.42658 4.08915 3.55975 4.06061 3.68788C4.03207 3.81601 3.97104 3.93493 3.8832 4.03355L2.4168 5.63018Z" fill="#363B44"/>
        </svg>
        <p style="margin-left: 10px">${self.i18n("settings.emfy_phone")}</p>
      </a>
    `
        : `
      <button class="emfy-mail">
        <svg class="emfy-svg" width="17" height="13" viewBox="0 0 17 13" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15.3 0H1.7C0.760467 0 0.00793333 0.726917 0.00793333 1.625L0 11.375C0 11.806 0.179107 12.2193 0.497918 12.524C0.81673 12.8288 1.24913 13 1.7 13H15.3C15.7509 13 16.1833 12.8288 16.5021 12.524C16.8209 12.2193 17 11.806 17 11.375V1.625C17 1.19402 16.8209 0.780698 16.5021 0.475951C16.1833 0.171205 15.7509 0 15.3 0ZM15.3 3.25L8.5 7.3125L1.7 3.25V1.625L8.5 5.6875L15.3 1.625V3.25Z" fill="#363B44"/>
        </svg>
        <p style="margin-left: 5px">${self.i18n("settings.emfy_email")}</p>
        <div style="opacity:0">${copied}</div>
      </button>
      <button class="emfy-phone">
        <svg class="emfy-svg" width="12" height="13" viewBox="0 0 12 13" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M2.4168 5.63018C3.3768 7.67473 4.92 9.34582 6.81 10.3858L8.2764 8.79273C8.35845 8.70015 8.46671 8.63382 8.5873 8.60224C8.70788 8.57065 8.83529 8.57526 8.9532 8.61545C9.71593 8.88847 10.5213 9.02806 11.3328 9.02791C11.7036 9.02791 12 9.34936 12 9.75V12.2779C12 12.6797 11.7036 13 11.3328 13C5.0736 13 0 7.50454 0 0.722091C0 0.320273 0.3 0 0.6672 0H3C3.3696 0 3.6672 0.321455 3.6672 0.722091C3.6672 1.62027 3.7992 2.49127 4.0464 3.30082C4.08426 3.42658 4.08915 3.55975 4.06061 3.68788C4.03207 3.81601 3.97104 3.93493 3.8832 4.03355L2.4168 5.63018Z" fill="#363B44"/>
        </svg>
        <p style="margin-left: 10px">${self.i18n("settings.emfy_phone")}</p>
        <div style="opacity:0">${copied}</div>
      </button>
    `;

      const footer = dom.add("div");
      footer.className = "emfy-footer";
      footer.innerHTML =
        `
    ${paymentInfo ? paymentInfo : ""}
    <div>
      <div>
        <a 
          href="${whatsappLink}" 
          target="_blank"
          style="color: #1faf38"
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M0.0664935 7.92935C0.0664935 9.32571 0.423896 10.6888 1.08052 11.894L0 16L4.03117 14.8945C5.13512 15.5247 6.38394 15.8569 7.65507 15.8587C11.8442 15.8587 15.2519 12.3096 15.2519 7.93766C15.2662 5.8508 14.4707 3.8397 13.0327 2.32727C12.3437 1.59379 11.5119 1.00897 10.5886 0.608752C9.6652 0.208533 8.66974 0.00137148 7.66338 0C3.47429 0.00831169 0.0664935 3.56571 0.0664935 7.93766" fill="#1FAF38"/>
            <path d="M5.69357 4.49607C5.55227 4.1553 5.39435 4.14698 5.25305 4.13867H4.88733C4.78738 4.14082 4.68902 4.16415 4.59875 4.20714C4.50848 4.25012 4.42837 4.31177 4.3637 4.38802C4.18084 4.59581 3.67383 5.09452 3.67383 6.10023C3.67383 7.11426 4.38032 8.09504 4.48006 8.22802C4.5798 8.36101 5.83487 10.4971 7.83798 11.32C9.50032 12.0098 9.83279 11.8685 10.1902 11.8353C10.5559 11.802 11.3538 11.3366 11.5201 10.8628C11.6863 10.3807 11.6863 9.97348 11.6364 9.88205C11.5866 9.79893 11.4536 9.74906 11.2541 9.64932C11.0629 9.54127 10.0905 9.04257 9.91591 8.98439C9.73305 8.90958 9.60006 8.87633 9.47539 9.08413C9.3424 9.28361 8.96006 9.74906 8.85201 9.88205C8.73565 10.0233 8.61928 10.04 8.4198 9.94023C8.22863 9.83218 7.58863 9.61607 6.84058 8.91789C6.4109 8.50231 6.0441 8.02631 5.75175 7.50491C5.63539 7.2888 5.73513 7.18075 5.83487 7.08101L6.13409 6.7153C6.23383 6.59893 6.25876 6.51582 6.32526 6.38283C6.39175 6.24153 6.3585 6.11685 6.30863 6.01711C6.25876 5.91737 5.88474 4.90335 5.70188 4.49607H5.69357Z" fill="white"/>
          </svg>
          <p style="margin-left: 6px">WhatsApp</p>
        </a>` +
        (amo.lang_id === "ru"
          ? `<a
          href="${self.i18n("settings.emfy_telegram")}"
          target="_blank"
          style="color: #2ca8dd"
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 16C12.4183 16 16 12.4183 16 8C16 3.58172 12.4183 0 8 0C3.58172 0 0 3.58172 0 8C0 12.4183 3.58172 16 8 16Z" fill="#2CA8DD"/>
            <path d="M6.30749 11.6206C6.02117 11.6206 6.06328 11.5027 5.97064 11.2248L5.12012 8.42898L11.6549 4.54688" fill="#C8DAEA"/>
            <path d="M6.20605 11.6205C6.43342 11.6205 6.52605 11.5195 6.65237 11.4016L7.83974 10.29L6.35763 9.43945" fill="#9FBFD3"/>
            <path d="M6.40039 9.38112L9.93723 12.0506C10.333 12.2695 10.6278 12.1601 10.7288 11.6632L12.1604 4.75796C12.312 4.15165 11.9414 3.87375 11.5541 4.05059L3.11618 7.37691C2.53513 7.6127 2.54355 7.94112 3.00671 8.08428L5.17092 8.7748L10.1899 5.55796C10.4257 5.40638 10.6446 5.49059 10.4678 5.64217" fill="white"/>
          </svg>
          <p style="margin-left: 6px">Telegram</p>
        </a>`
          : "") +
        `${links}
      </div>
      <button>
        <svg class="emfy-svg" width="17" height="16" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15.3 0H1.7C0.760467 0 0.00793333 0.715429 0.00793333 1.6L0 16L3.4 12.8H15.3C16.2395 12.8 17 12.0834 17 11.2V1.6C17 0.716571 16.2395 0 15.3 0ZM3.4 5.6H13.6V7.2H3.4V5.6ZM10.2 9.6H3.4V8H10.2V9.6ZM13.6 4.8H3.4V3.2H13.6V4.8Z" fill="#363B44"/>
        </svg>
        <p>${contacts}</p>
      </button>
    </div>
    <a href="${self.i18n("settings.emfy_support_link")}" target="_blank">
      <svg class="emfy-svg" width="93" height="30" viewBox="0 0 92 30" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M29.3842 11.5692C29.3709 11.5647 29.3449 11.558 29.3264 11.5513C28.9355 11.5513 1.86691 11.5513 1.86691 11.5513C1.75863 11.5476 1.69263 11.5558 1.62588 11.561C1.63328 11.5677 1.6904 11.607 1.6904 11.607L1.73193 11.6418C2.54033 12.3093 4.20236 13.5101 6.95683 15.4999L9.25074 17.1589L10.1711 17.7968L8.34297 23.3072C8.34297 23.3072 6.92272 27.6814 6.92272 27.6829C6.91892 27.6962 6.86709 27.8854 6.86709 27.8854C6.86709 27.8854 6.8633 27.8987 6.86117 27.9054C6.90864 27.8787 6.94943 27.8572 7.0273 27.8082C7.02958 27.8067 7.12891 27.7422 7.12891 27.7422C7.1185 27.7489 7.32544 27.6073 7.32544 27.6073C7.32544 27.6073 29.0297 11.8495 29.3486 11.6188C29.3598 11.6025 29.3768 11.5825 29.3842 11.5692ZM30.3936 12.7091L22.524 18.4227L8.19835 28.8228C8.11158 28.8859 8.02999 28.9415 7.94767 28.9956C7.90836 29.0208 7.87054 29.0453 7.83346 29.0698C7.57314 29.2367 7.34101 29.3598 7.15189 29.4161C6.86561 29.5133 6.54522 29.5163 6.26339 29.4392C6.26112 29.4392 6.25747 29.4376 6.25599 29.4376C6.21965 29.4273 6.18479 29.4147 6.15067 29.4013C6.11509 29.3879 6.08022 29.3746 6.04684 29.3583C6.03868 29.3531 6.03052 29.3501 6.02311 29.3472C5.98158 29.3257 5.94227 29.3041 5.90371 29.2789C5.87109 29.2582 5.83844 29.2381 5.80952 29.2137C5.63894 29.075 5.51063 28.9185 5.42683 28.7308C5.41794 28.7108 5.4083 28.6908 5.40086 28.6715C5.40086 28.67 5.4001 28.6663 5.39934 28.6648C5.34668 28.5165 5.31924 28.3519 5.32221 28.1724C5.31993 28.1323 5.32373 28.0901 5.32601 28.047C5.32829 28.0011 5.33121 27.9551 5.33637 27.9054C5.33789 27.8905 5.34017 27.8809 5.34157 27.8661C5.3475 27.8179 5.35342 27.7704 5.36234 27.7207C5.36234 27.7177 5.36311 27.714 5.36387 27.7111C5.37351 27.6584 5.38835 27.6035 5.40168 27.5494L5.4269 27.4767C5.44323 27.4114 5.46396 27.3388 5.48326 27.2661C5.49067 27.2446 5.49586 27.2231 5.50403 27.2001L6.92428 22.8325C7.33367 21.6088 7.82242 20.1455 8.39719 18.3893C8.38903 18.3834 8.38014 18.3782 8.37197 18.3715C4.04373 15.2381 1.82769 13.6628 0.779 12.7966L0.701868 12.7424C0.701868 12.7424 0.588396 12.6564 0.4549 12.5036C0.0158455 12.0319 -0.0709285 11.5083 0.0492196 11.05C0.158982 10.6317 0.453418 10.3269 0.916946 10.1808C1.18691 10.0851 1.51397 10.045 1.8974 10.0539H11.076H19.8037H29.5304C30.2772 10.2134 30.7237 10.6057 30.8327 11.0982C31.0345 11.5625 30.9031 12.1425 30.3936 12.7091Z" fill="#363B44"/>
        <path d="M23.113 29.1151L23.1879 29.1715C23.1879 29.1715 23.3058 29.2538 23.492 29.3324C24.0757 29.6046 24.6015 29.5253 24.9997 29.2687C25.3624 29.0365 25.5627 28.6605 25.5582 28.1747C25.5649 27.8892 25.5026 27.5651 25.3765 27.2024L23.0655 20.0938L16.835 24.6163C20.2562 27.1134 22.094 28.4662 23.113 29.1151Z" fill="#363B44"/>
        <path d="M16.837 0.920748C16.4543 0.260683 15.9425 -0.0426504 15.4397 0.00481494C14.9369 -0.0426504 14.4259 0.260683 14.0432 0.920748L11.6514 8.28381H19.2288L16.837 0.920748Z" fill="#363B44"/>
        <path d="M51.2012 11.002C51.2012 11.1784 51.2012 24.3683 51.2012 24.5454C51.3659 24.5454 54.0548 24.5454 54.2195 24.5454C54.2195 24.3683 54.2195 13.4351 54.2195 13.4351H58.2497C58.2497 13.4351 58.2497 24.3683 58.2497 24.5454C58.4132 24.5454 60.9064 24.5454 61.0711 24.5454C61.0711 24.3683 61.0711 13.3855 61.0711 13.3855H65.1001C65.1001 13.3855 65.1001 24.3683 65.1001 24.5454C65.2636 24.5454 67.7085 24.5454 67.872 24.5454C67.872 24.3683 67.872 13.6562 67.872 13.6562C67.872 12.9428 67.6317 12.2938 67.1933 11.8293C66.6842 11.2881 65.9151 11.002 64.9701 11.002C64.9701 11.002 51.3795 11.002 51.2012 11.002Z" fill="#363B44"/>
        <path d="M37.8028 7.9623V21.2494C37.8028 24.1674 39.595 24.6034 40.6638 24.6034H48.9286L48.9038 22.1418L40.6725 22.091V15.7564C40.6725 15.7564 46.8887 15.7564 47.0633 15.7564C47.0633 15.5954 47.0633 13.4032 47.0633 13.4032H40.5746V8.24467C40.5746 8.24467 48.7168 8.27067 48.8927 8.27193C48.8927 8.17905 48.8753 5.74346 48.8753 5.74346L40.5164 5.74219C38.9186 5.74219 37.8028 6.65564 37.8028 7.9623Z" fill="#363B44"/>
        <path d="M76.5667 5.66994C75.9895 5.66994 75.229 5.66994 75.229 5.66994C72.2937 5.66994 72.1451 7.97487 72.1451 8.43685V11.8298C72.1451 11.8298 70.2352 11.8757 70.0742 11.8794C70.0742 12.0379 70.0742 14.2122 70.0742 14.3744C70.2389 14.3744 72.1946 14.3744 72.1946 14.3744C72.1946 14.3744 72.1946 24.3688 72.1946 24.546C72.3593 24.546 75.0965 24.546 75.2612 24.546C75.2612 24.3688 75.2612 14.3744 75.2612 14.3744C75.2612 14.3744 78.6697 14.3744 78.8406 14.3744C78.8406 14.2122 78.8406 12.0435 78.8406 11.8812C78.6697 11.8812 75.2117 11.8812 75.2117 11.8812L75.2092 8.21823C75.2092 8.21823 78.6697 8.21823 78.8406 8.21823C78.8406 6.44711 77.5959 5.66994 76.5667 5.66994Z" fill="#363B44"/>
        <path d="M89.0336 10.9668C89.0336 11.1439 89.0336 21.8325 89.0336 21.8325H83.9668C83.9668 21.8325 83.9668 11.1439 83.9668 10.9668C83.802 10.9668 81.1169 10.9668 80.9521 10.9668C80.9521 11.1439 80.9521 21.653 80.9521 21.653C80.9521 22.7676 82.1102 24.3877 83.9247 24.3877H89.0857L89.0931 25.9105L89.0944 27.058C89.0944 27.058 84.1934 27.058 84.0238 27.058C84.025 27.302 84.0746 28.0463 84.6245 28.6421C85.1434 29.2031 85.9621 29.488 87.0557 29.488H89.0745C91.6197 29.488 92 27.754 92 26.7211V24.7728L91.9936 21.7434C91.9936 21.7434 91.9936 11.1433 91.9936 10.9668C91.8289 10.9668 89.1984 10.9668 89.0336 10.9668Z" fill="#363B44"/>
      </svg>
    </a>
  `;

      if (settings) {
        settings.append(footer);

        const mailButton = dom.get(".emfy-mail");
        const mailCopied = mailButton && mailButton.children[2];
        const phoneButton = dom.get(".emfy-phone");
        const phoneCopied = phoneButton && phoneButton.children[2];

        const doCopyAnimation = (button, copied) => {
          const text = button.children[1].innerText;
          navigator.clipboard.writeText(text);

          button.disabled = true;

          copied.style.opacity = 1;
          setTimeout(() => (copied.style.opacity = 0), 1300);
          setTimeout(() => (button.disabled = false), 2000);
        };

        mailButton &&
          dom.addListener(mailButton, "click", () =>
            doCopyAnimation(mailButton, mailCopied),
          );

        phoneButton &&
          dom.addListener(phoneButton, "click", () =>
            doCopyAnimation(phoneButton, phoneCopied),
          );

        if (mobileOrTablet) {
          const childrenID = footer.children[0].tagName === "SPAN" ? 1 : 0;
          const linkButtons = Array.from(
            footer.children[childrenID].children[0].children,
          );

          linkButtons.forEach(
            (button) => (button.style.pointerEvents = "none"),
          );

          const containerButton = footer.children[childrenID].children[1];

          containerButton.setAttribute("closed", "Y");

          const interval = setInterval(() => {
            const settings = dom.get(".widget_settings_block");

            if (!settings) {
              clearInterval(interval);
              return;
            }

            const containerButton = footer.children[childrenID].children[1];

            if (!containerButton) return;

            const linkButtons = Array.from(
              footer.children[childrenID].children[0].children,
            );
            const closed = containerButton.getAttribute("closed");

            if (
              window.getComputedStyle(linkButtons[0]).opacity === "1" &&
              closed === "Y"
            ) {
              setTimeout(
                () =>
                  linkButtons.forEach(
                    (button) => (button.style.pointerEvents = "all"),
                  ),
                300,
              );
              containerButton.setAttribute("closed", "N");
            }

            if (
              window.getComputedStyle(linkButtons[0]).opacity === "0" &&
              closed === "N"
            ) {
              linkButtons.forEach(
                (button) => (button.style.pointerEvents = "none"),
              );

              containerButton.setAttribute("closed", "Y");
            }
          }, 100);
        }

        const installed = self.get_install_status();
        const enabled = this.afterSaveEnableCheck();

        if (installed !== "installed" || !enabled) return;

        const payButton = dom.get(`a.emfy-renew`);

        if (!payButton) return;

        dom.addListener(payButton, "click", () => this.initPaymentRequest());
      }
    }

    /**
     * Создает футер
     * @private
     */
    #addFooterAdvanced() {
      const self = this.#self;
      const { dom, amo, options } = self;
      const widgetCode = options.get("params").widget_code;
      const workArea = dom.get(`#work-area-${widgetCode}`);
      const paymentInfo = this.#addPaymentInfo();
      const mobileOrTablet = this.mobileOrTablet();

      const copied = self.i18n("settings.copied");
      const contacts = self.i18n("settings.contacts_button");

      const whatsappLink = mobileOrTablet
        ? self.i18n("settings.support_wa_mobile")
        : self.i18n("settings.support_wa");

      const links = mobileOrTablet
        ? `
          <a 
            href="mailto:${self.i18n("settings.emfy_email")}"
            style="color: var(--palette-text-primary)"
          >
            <svg class="emfy-svg" width="17" height="13" viewBox="0 0 17 13" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15.3 0H1.7C0.760467 0 0.00793333 0.726917 0.00793333 1.625L0 11.375C0 11.806 0.179107 12.2193 0.497918 12.524C0.81673 12.8288 1.24913 13 1.7 13H15.3C15.7509 13 16.1833 12.8288 16.5021 12.524C16.8209 12.2193 17 11.806 17 11.375V1.625C17 1.19402 16.8209 0.780698 16.5021 0.475951C16.1833 0.171205 15.7509 0 15.3 0ZM15.3 3.25L8.5 7.3125L1.7 3.25V1.625L8.5 5.6875L15.3 1.625V3.25Z" fill="#363B44"/>
            </svg>
            <p style="margin-left: 5px">${self.i18n("settings.emfy_email")}</p>
          </a>
          <a 
            href="tel:${self.i18n("settings.emfy_phone_href")}" 
            style="color: var(--palette-text-primary)"
          >
            <svg class="emfy-svg" width="12" height="13" viewBox="0 0 12 13" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M2.4168 5.63018C3.3768 7.67473 4.92 9.34582 6.81 10.3858L8.2764 8.79273C8.35845 8.70015 8.46671 8.63382 8.5873 8.60224C8.70788 8.57065 8.83529 8.57526 8.9532 8.61545C9.71593 8.88847 10.5213 9.02806 11.3328 9.02791C11.7036 9.02791 12 9.34936 12 9.75V12.2779C12 12.6797 11.7036 13 11.3328 13C5.0736 13 0 7.50454 0 0.722091C0 0.320273 0.3 0 0.6672 0H3C3.3696 0 3.6672 0.321455 3.6672 0.722091C3.6672 1.62027 3.7992 2.49127 4.0464 3.30082C4.08426 3.42658 4.08915 3.55975 4.06061 3.68788C4.03207 3.81601 3.97104 3.93493 3.8832 4.03355L2.4168 5.63018Z" fill="#363B44"/>
            </svg>
            <p style="margin-left: 10px">${self.i18n("settings.emfy_phone")}</p>
          </a>
        `
        : `
          <button class="emfy-mail">
            <svg class="emfy-svg" width="17" height="13" viewBox="0 0 17 13" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15.3 0H1.7C0.760467 0 0.00793333 0.726917 0.00793333 1.625L0 11.375C0 11.806 0.179107 12.2193 0.497918 12.524C0.81673 12.8288 1.24913 13 1.7 13H15.3C15.7509 13 16.1833 12.8288 16.5021 12.524C16.8209 12.2193 17 11.806 17 11.375V1.625C17 1.19402 16.8209 0.780698 16.5021 0.475951C16.1833 0.171205 15.7509 0 15.3 0ZM15.3 3.25L8.5 7.3125L1.7 3.25V1.625L8.5 5.6875L15.3 1.625V3.25Z" fill="#363B44"/>
            </svg>
            <p style="margin-left: 5px">${self.i18n("settings.emfy_email")}</p>
            <div style="opacity:0">${copied}</div>
          </button>
          <button class="emfy-phone">
            <svg class="emfy-svg" width="12" height="13" viewBox="0 0 12 13" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M2.4168 5.63018C3.3768 7.67473 4.92 9.34582 6.81 10.3858L8.2764 8.79273C8.35845 8.70015 8.46671 8.63382 8.5873 8.60224C8.70788 8.57065 8.83529 8.57526 8.9532 8.61545C9.71593 8.88847 10.5213 9.02806 11.3328 9.02791C11.7036 9.02791 12 9.34936 12 9.75V12.2779C12 12.6797 11.7036 13 11.3328 13C5.0736 13 0 7.50454 0 0.722091C0 0.320273 0.3 0 0.6672 0H3C3.3696 0 3.6672 0.321455 3.6672 0.722091C3.6672 1.62027 3.7992 2.49127 4.0464 3.30082C4.08426 3.42658 4.08915 3.55975 4.06061 3.68788C4.03207 3.81601 3.97104 3.93493 3.8832 4.03355L2.4168 5.63018Z" fill="#363B44"/>
            </svg>
            <p style="margin-left: 10px">${self.i18n("settings.emfy_phone")}</p>
            <div style="opacity:0">${copied}</div>
          </button>
        `;

      const footer = dom.add("div");
      footer.className = "emfy-footer";
      footer.innerHTML =
        `
        ${paymentInfo ? paymentInfo : ""}
        <div>
          <div>
            <a 
              href="${whatsappLink}" 
              target="_blank"
              style="color: #1faf38"
            >
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M0.0664935 7.92935C0.0664935 9.32571 0.423896 10.6888 1.08052 11.894L0 16L4.03117 14.8945C5.13512 15.5247 6.38394 15.8569 7.65507 15.8587C11.8442 15.8587 15.2519 12.3096 15.2519 7.93766C15.2662 5.8508 14.4707 3.8397 13.0327 2.32727C12.3437 1.59379 11.5119 1.00897 10.5886 0.608752C9.6652 0.208533 8.66974 0.00137148 7.66338 0C3.47429 0.00831169 0.0664935 3.56571 0.0664935 7.93766" fill="#1FAF38"/>
                <path d="M5.69357 4.49607C5.55227 4.1553 5.39435 4.14698 5.25305 4.13867H4.88733C4.78738 4.14082 4.68902 4.16415 4.59875 4.20714C4.50848 4.25012 4.42837 4.31177 4.3637 4.38802C4.18084 4.59581 3.67383 5.09452 3.67383 6.10023C3.67383 7.11426 4.38032 8.09504 4.48006 8.22802C4.5798 8.36101 5.83487 10.4971 7.83798 11.32C9.50032 12.0098 9.83279 11.8685 10.1902 11.8353C10.5559 11.802 11.3538 11.3366 11.5201 10.8628C11.6863 10.3807 11.6863 9.97348 11.6364 9.88205C11.5866 9.79893 11.4536 9.74906 11.2541 9.64932C11.0629 9.54127 10.0905 9.04257 9.91591 8.98439C9.73305 8.90958 9.60006 8.87633 9.47539 9.08413C9.3424 9.28361 8.96006 9.74906 8.85201 9.88205C8.73565 10.0233 8.61928 10.04 8.4198 9.94023C8.22863 9.83218 7.58863 9.61607 6.84058 8.91789C6.4109 8.50231 6.0441 8.02631 5.75175 7.50491C5.63539 7.2888 5.73513 7.18075 5.83487 7.08101L6.13409 6.7153C6.23383 6.59893 6.25876 6.51582 6.32526 6.38283C6.39175 6.24153 6.3585 6.11685 6.30863 6.01711C6.25876 5.91737 5.88474 4.90335 5.70188 4.49607H5.69357Z" fill="white"/>
              </svg>
              <p style="margin-left: 6px">WhatsApp</p>
            </a>` +
        (amo.lang_id === "ru"
          ? `<a
              href="${self.i18n("settings.emfy_telegram")}"
              target="_blank"
              style="color: #2ca8dd"
            >
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 16C12.4183 16 16 12.4183 16 8C16 3.58172 12.4183 0 8 0C3.58172 0 0 3.58172 0 8C0 12.4183 3.58172 16 8 16Z" fill="#2CA8DD"/>
                <path d="M6.30749 11.6206C6.02117 11.6206 6.06328 11.5027 5.97064 11.2248L5.12012 8.42898L11.6549 4.54688" fill="#C8DAEA"/>
                <path d="M6.20605 11.6205C6.43342 11.6205 6.52605 11.5195 6.65237 11.4016L7.83974 10.29L6.35763 9.43945" fill="#9FBFD3"/>
                <path d="M6.40039 9.38112L9.93723 12.0506C10.333 12.2695 10.6278 12.1601 10.7288 11.6632L12.1604 4.75796C12.312 4.15165 11.9414 3.87375 11.5541 4.05059L3.11618 7.37691C2.53513 7.6127 2.54355 7.94112 3.00671 8.08428L5.17092 8.7748L10.1899 5.55796C10.4257 5.40638 10.6446 5.49059 10.4678 5.64217" fill="white"/>
              </svg>
              <p style="margin-left: 6px">Telegram</p>
            </a>`
          : "") +
        `${links}
          </div>
          <button class="main-button">
            <svg class="emfy-svg" width="17" height="16" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15.3 0H1.7C0.760467 0 0.00793333 0.715429 0.00793333 1.6L0 16L3.4 12.8H15.3C16.2395 12.8 17 12.0834 17 11.2V1.6C17 0.716571 16.2395 0 15.3 0ZM3.4 5.6H13.6V7.2H3.4V5.6ZM10.2 9.6H3.4V8H10.2V9.6ZM13.6 4.8H3.4V3.2H13.6V4.8Z" fill="#363B44"/>
            </svg>
            <p>${contacts}</p>
          </button>
        </div>
        <a href="${self.i18n("settings.emfy_support_link")}" target="_blank">
          <svg class="emfy-svg" width="93" height="30" viewBox="0 0 92 30" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M29.3842 11.5692C29.3709 11.5647 29.3449 11.558 29.3264 11.5513C28.9355 11.5513 1.86691 11.5513 1.86691 11.5513C1.75863 11.5476 1.69263 11.5558 1.62588 11.561C1.63328 11.5677 1.6904 11.607 1.6904 11.607L1.73193 11.6418C2.54033 12.3093 4.20236 13.5101 6.95683 15.4999L9.25074 17.1589L10.1711 17.7968L8.34297 23.3072C8.34297 23.3072 6.92272 27.6814 6.92272 27.6829C6.91892 27.6962 6.86709 27.8854 6.86709 27.8854C6.86709 27.8854 6.8633 27.8987 6.86117 27.9054C6.90864 27.8787 6.94943 27.8572 7.0273 27.8082C7.02958 27.8067 7.12891 27.7422 7.12891 27.7422C7.1185 27.7489 7.32544 27.6073 7.32544 27.6073C7.32544 27.6073 29.0297 11.8495 29.3486 11.6188C29.3598 11.6025 29.3768 11.5825 29.3842 11.5692ZM30.3936 12.7091L22.524 18.4227L8.19835 28.8228C8.11158 28.8859 8.02999 28.9415 7.94767 28.9956C7.90836 29.0208 7.87054 29.0453 7.83346 29.0698C7.57314 29.2367 7.34101 29.3598 7.15189 29.4161C6.86561 29.5133 6.54522 29.5163 6.26339 29.4392C6.26112 29.4392 6.25747 29.4376 6.25599 29.4376C6.21965 29.4273 6.18479 29.4147 6.15067 29.4013C6.11509 29.3879 6.08022 29.3746 6.04684 29.3583C6.03868 29.3531 6.03052 29.3501 6.02311 29.3472C5.98158 29.3257 5.94227 29.3041 5.90371 29.2789C5.87109 29.2582 5.83844 29.2381 5.80952 29.2137C5.63894 29.075 5.51063 28.9185 5.42683 28.7308C5.41794 28.7108 5.4083 28.6908 5.40086 28.6715C5.40086 28.67 5.4001 28.6663 5.39934 28.6648C5.34668 28.5165 5.31924 28.3519 5.32221 28.1724C5.31993 28.1323 5.32373 28.0901 5.32601 28.047C5.32829 28.0011 5.33121 27.9551 5.33637 27.9054C5.33789 27.8905 5.34017 27.8809 5.34157 27.8661C5.3475 27.8179 5.35342 27.7704 5.36234 27.7207C5.36234 27.7177 5.36311 27.714 5.36387 27.7111C5.37351 27.6584 5.38835 27.6035 5.40168 27.5494L5.4269 27.4767C5.44323 27.4114 5.46396 27.3388 5.48326 27.2661C5.49067 27.2446 5.49586 27.2231 5.50403 27.2001L6.92428 22.8325C7.33367 21.6088 7.82242 20.1455 8.39719 18.3893C8.38903 18.3834 8.38014 18.3782 8.37197 18.3715C4.04373 15.2381 1.82769 13.6628 0.779 12.7966L0.701868 12.7424C0.701868 12.7424 0.588396 12.6564 0.4549 12.5036C0.0158455 12.0319 -0.0709285 11.5083 0.0492196 11.05C0.158982 10.6317 0.453418 10.3269 0.916946 10.1808C1.18691 10.0851 1.51397 10.045 1.8974 10.0539H11.076H19.8037H29.5304C30.2772 10.2134 30.7237 10.6057 30.8327 11.0982C31.0345 11.5625 30.9031 12.1425 30.3936 12.7091Z" fill="#363B44"/>
            <path d="M23.113 29.1151L23.1879 29.1715C23.1879 29.1715 23.3058 29.2538 23.492 29.3324C24.0757 29.6046 24.6015 29.5253 24.9997 29.2687C25.3624 29.0365 25.5627 28.6605 25.5582 28.1747C25.5649 27.8892 25.5026 27.5651 25.3765 27.2024L23.0655 20.0938L16.835 24.6163C20.2562 27.1134 22.094 28.4662 23.113 29.1151Z" fill="#363B44"/>
            <path d="M16.837 0.920748C16.4543 0.260683 15.9425 -0.0426504 15.4397 0.00481494C14.9369 -0.0426504 14.4259 0.260683 14.0432 0.920748L11.6514 8.28381H19.2288L16.837 0.920748Z" fill="#363B44"/>
            <path d="M51.2012 11.002C51.2012 11.1784 51.2012 24.3683 51.2012 24.5454C51.3659 24.5454 54.0548 24.5454 54.2195 24.5454C54.2195 24.3683 54.2195 13.4351 54.2195 13.4351H58.2497C58.2497 13.4351 58.2497 24.3683 58.2497 24.5454C58.4132 24.5454 60.9064 24.5454 61.0711 24.5454C61.0711 24.3683 61.0711 13.3855 61.0711 13.3855H65.1001C65.1001 13.3855 65.1001 24.3683 65.1001 24.5454C65.2636 24.5454 67.7085 24.5454 67.872 24.5454C67.872 24.3683 67.872 13.6562 67.872 13.6562C67.872 12.9428 67.6317 12.2938 67.1933 11.8293C66.6842 11.2881 65.9151 11.002 64.9701 11.002C64.9701 11.002 51.3795 11.002 51.2012 11.002Z" fill="#363B44"/>
            <path d="M37.8028 7.9623V21.2494C37.8028 24.1674 39.595 24.6034 40.6638 24.6034H48.9286L48.9038 22.1418L40.6725 22.091V15.7564C40.6725 15.7564 46.8887 15.7564 47.0633 15.7564C47.0633 15.5954 47.0633 13.4032 47.0633 13.4032H40.5746V8.24467C40.5746 8.24467 48.7168 8.27067 48.8927 8.27193C48.8927 8.17905 48.8753 5.74346 48.8753 5.74346L40.5164 5.74219C38.9186 5.74219 37.8028 6.65564 37.8028 7.9623Z" fill="#363B44"/>
            <path d="M76.5667 5.66994C75.9895 5.66994 75.229 5.66994 75.229 5.66994C72.2937 5.66994 72.1451 7.97487 72.1451 8.43685V11.8298C72.1451 11.8298 70.2352 11.8757 70.0742 11.8794C70.0742 12.0379 70.0742 14.2122 70.0742 14.3744C70.2389 14.3744 72.1946 14.3744 72.1946 14.3744C72.1946 14.3744 72.1946 24.3688 72.1946 24.546C72.3593 24.546 75.0965 24.546 75.2612 24.546C75.2612 24.3688 75.2612 14.3744 75.2612 14.3744C75.2612 14.3744 78.6697 14.3744 78.8406 14.3744C78.8406 14.2122 78.8406 12.0435 78.8406 11.8812C78.6697 11.8812 75.2117 11.8812 75.2117 11.8812L75.2092 8.21823C75.2092 8.21823 78.6697 8.21823 78.8406 8.21823C78.8406 6.44711 77.5959 5.66994 76.5667 5.66994Z" fill="#363B44"/>
            <path d="M89.0336 10.9668C89.0336 11.1439 89.0336 21.8325 89.0336 21.8325H83.9668C83.9668 21.8325 83.9668 11.1439 83.9668 10.9668C83.802 10.9668 81.1169 10.9668 80.9521 10.9668C80.9521 11.1439 80.9521 21.653 80.9521 21.653C80.9521 22.7676 82.1102 24.3877 83.9247 24.3877H89.0857L89.0931 25.9105L89.0944 27.058C89.0944 27.058 84.1934 27.058 84.0238 27.058C84.025 27.302 84.0746 28.0463 84.6245 28.6421C85.1434 29.2031 85.9621 29.488 87.0557 29.488H89.0745C91.6197 29.488 92 27.754 92 26.7211V24.7728L91.9936 21.7434C91.9936 21.7434 91.9936 11.1433 91.9936 10.9668C91.8289 10.9668 89.1984 10.9668 89.0336 10.9668Z" fill="#363B44"/>
          </svg>
        </a>
      `;

      if (workArea) {
        workArea.append(footer);

        const allArea = workArea.closest("#work_area");
        allArea.style.paddingBottom = "0";

        const mailButton = dom.get(".emfy-mail");
        const mailCopied = mailButton && mailButton.children[2];
        const phoneButton = dom.get(".emfy-phone");
        const phoneCopied = phoneButton && phoneButton.children[2];

        const doCopyAnimation = (button, copied) => {
          const text = button.children[1].innerText;
          navigator.clipboard.writeText(text);

          button.disabled = true;

          copied.style.opacity = 1;
          setTimeout(() => (copied.style.opacity = 0), 1300);
          setTimeout(() => (button.disabled = false), 2000);
        };

        mailButton &&
          dom.addListener(mailButton, "click", () =>
            doCopyAnimation(mailButton, mailCopied),
          );

        phoneButton &&
          dom.addListener(phoneButton, "click", () =>
            doCopyAnimation(phoneButton, phoneCopied),
          );

        if (mobileOrTablet) {
          const childrenID = footer.children[0].tagName === "SPAN" ? 1 : 0;
          const linkButtons = Array.from(
            footer.children[childrenID].children[0].children,
          );

          linkButtons.forEach(
            (button) => (button.style.pointerEvents = "none"),
          );

          const containerButton = footer.children[childrenID].children[1];

          containerButton.setAttribute("closed", "Y");

          const interval = setInterval(() => {
            const widgetCode = options.get("params").widget_code;
            const workArea = dom.get(`#work-area-${widgetCode}`);

            if (!workArea) {
              clearInterval(interval);
              return;
            }

            const containerButton = footer.children[childrenID].children[1];

            if (!containerButton) return;

            const linkButtons = Array.from(
              footer.children[childrenID].children[0].children,
            );
            const closed = containerButton.getAttribute("closed");

            if (
              window.getComputedStyle(linkButtons[0]).opacity === "1" &&
              closed === "Y"
            ) {
              setTimeout(
                () =>
                  linkButtons.forEach(
                    (button) => (button.style.pointerEvents = "all"),
                  ),
                300,
              );
              containerButton.setAttribute("closed", "N");
            }

            if (
              window.getComputedStyle(linkButtons[0]).opacity === "0" &&
              closed === "N"
            ) {
              linkButtons.forEach(
                (button) => (button.style.pointerEvents = "none"),
              );

              containerButton.setAttribute("closed", "Y");
            }
          }, 100);
        }

        const payButton = dom.get(`a.emfy-renew`);

        if (!payButton) return;

        dom.addListener(payButton, "click", () => this.initPaymentRequest());
      }
    }

    /**
     * Добавляет свайпер
     * @param {number} tour Количество изображений тура
     * @param {string} video Ссылка на embeded версию видео с youtube.
     */
    addSwiper(tour, video = undefined) {
      if (!tour) return;

      this.#addSwiper(tour, video);
    }

    /**
     * Добавляет футер Emfy
     */
    addFooter() {
      this.#addSettingsStyles();

      this.#addFooter();
    }

    /**
     * Добавляет футер Emfy в расширенные настройки
     */
    addFooterAdvanced() {
      this.#addFooterStylesAdvanced();

      this.#addFooterAdvanced();
    }

    mobileOrTablet() {
      const { dom } = this.#self;

      const mobile = dom.get("html").classList.contains("mobile");
      const tablet = dom.get("html").classList.contains("tablet");

      return mobile || tablet;
    }

    /**
     * Применение настроек с окружения AMO
     */
    setWidgetOptionsFromAMO() {
      const { options } = this.#self;
      const widgetOptions = options.get("widget_options");
      if (!widgetOptions) {
        const defaultSettings = { is_actived: true, options: [] };
        const rawSettings = this.#self.params.custom_emfy_settings;
        let customEmfySettings = defaultSettings;

        if (typeof rawSettings === "string") {
          try {
            const parsed = JSON.parse(rawSettings);
            if (parsed && typeof parsed === "object") {
              customEmfySettings = parsed;
            }
          } catch (error) {
            console.warn(
              "Failed to parse custom_emfy_settings:",
              error.message,
            );
          }
        } else if (
          typeof rawSettings === "object" &&
          !Array.isArray(rawSettings)
        ) {
          customEmfySettings = JSON.parse(JSON.stringify(rawSettings));
        }
        options.set("widget_options", customEmfySettings);
        options.set("custom_emfy_settings", customEmfySettings);

        this.initSettings(true);
      }
    }

    /**
     * Получение настроек всех виджетов
     * @param {boolean} force Принудительное получение данных с сервера
     */
    getAllSettings(force) {
      const { options, amo } = this.#self;

      const widgetOptions = options.get("widget_options");

      if (!force && widgetOptions !== null) return;

      const received = amo.get("emfy_core_get_widget_settings");
      this.setWidgetOptionsFromAMO();
      if (force || !received) {
        this.getSettings();
      } else {
        this.#waitSettings();
      }
    }

    /**
     * Применение настроек виджетов
     */
    initSettings(first = false) {
      const { options, dom, wo } = this.#self;
      const widgetOptions = options.get("widget_options");

      if (typeof widgetOptions !== "object") return;

      const module = options.get("module");
      const defaultWidgetOptions = options.get("default_widget_options");

      if (defaultWidgetOptions) {
        Object.entries(defaultWidgetOptions).map(([key, option]) => {
          if (!option.is_editable) return;

          defaultWidgetOptions[key].define_value =
            widgetOptions.options[key] ??
            defaultWidgetOptions[key].define_value;
        });

        options.set("default_widget_options", defaultWidgetOptions);
      }

      dom.addEvent(document, `initSettings_${module}`);

      if (wo && wo.initSettings) wo.initSettings(first);
      if (!first) {
        const module = options.get("module");
        dom.addEvent(document, `settingsFetched_${module}`);
      }
    }

    /**
     * Получение настроек с сервера Emfy
     */
    async getSettings(stage = 0) {
      const { amo, storage, options, utils } = this.#self;

      amo.set("emfy_core_get_widget_settings", 1);

      const server = options.get("server_emfy");
      const widgetModule = options.get("module");
      const params = options.get("params");

      const url = `${server}?module=${widgetModule}&get_options=1`;
      const data = {
        method: "POST",
        body: JSON.stringify({
          account_id: amo.get("account").id,
          api_key: options.get("api_access_key"),
          timezone_offset: new Date().getTimezoneOffset(),
          now_settings: params,
          widget_code: params.widget_code,
        }),
      };
      try {
        await storage.fetch(url, data, "json").then((res) => {
          if (res.result) {
            if (!amo.get("emfy_core_widget_settings")) {
              amo.set("emfy_core_widget_settings", res.all_widgets);
            }

            this.#setWidgetOptions(res);
            this.initSettings();
          } else {
            amo.set("emfy_core_get_widget_settings", 0);
            const err = `Error getting all widget options: ${res.message}`;
            amo.errorNote(err);
            throw new Error(err);
          }
        });
      } catch (error) {
        if (stage < 5) {
          this.getSettings(stage + 1);
        } else {
          utils.log("Can't get widget_options after 5 tries!");
        }
      }
    }

    /**
     * Скрывает панель настроек в превью виджета после установки.
     */
    hideSettings() {
      const { dom } = this.#self;

      const saveButton = dom.get(".emfy-save-button");
      saveButton.parentElement.hidden = true;

      const emfySettingsStyles = dom.get("#emfy-settings-styles");
      emfySettingsStyles.parentElement.nextElementSibling.hidden = true;
    }

    /**
     * Ожидание настроек с сервера Emfy
     * @private
     */

    #waitSettings() {
      const { options, amo, utils } = this.#self;

      const interval = setInterval(() => {
        const emfyCoreWidgetSettings = amo.get("emfy_core_widget_settings");

        if (!emfyCoreWidgetSettings) return;

        clearInterval(interval);

        const widgetOptions =
          emfyCoreWidgetSettings.emfy_widgets_data[options.get("module_code")];

        if (!widgetOptions) {
          this.getSettings(0);
        } else {
          this.#setWidgetOptions(widgetOptions);
          this.initSettings();
        }
      }, 100);
    }

    /**
     * Применение настроек с сервера Emfy
     * @param {object} newOptions Полученные настройки
     */
    #setWidgetOptions(newOptions) {
      const { amo, options, dom } = this.#self;

      if (!newOptions.result || !newOptions.data) {
        if (newOptions.message) {
          amo.set("emfy_core_get_widget_settings", 0);

          amo.errorNote(newOptions.message);

          throw new Error(newOptions.message);
        } else {
          amo.errorNote("Error setting widget options");

          throw new Error("Error setting widget options");
        }
      }

      options.set("widget_options", newOptions.data);
      options.set("custom_emfy_settings", newOptions.data);
      options.set("empty_users", newOptions.empty_users);
    }

    async saveSettings(data) {
      const self = this.#self;
      const { amo, storage, options, utils, dom } = self;
      try {
        utils.useSaveButton("load");

        const customEmfySettingsInput = dom.get(
          'input[name="custom_emfy_settings"]',
        );
        if (customEmfySettingsInput) {
          const length = JSON.stringify(data).length;
          if (length < 10000) {
            customEmfySettingsInput.value = JSON.stringify(data);
          } else {
            const ces = Object.assign({}, data);
            ces.options = { isInstalled: true };
            customEmfySettingsInput.value = JSON.stringify(ces);
          }

          utils.clickSaveButton();
        }

        const server = options.get("server_emfy");
        const widgetModule = options.get("module");

        const url = `${server}?module=${widgetModule}&set_options=2`;
        const fetchData = {
          method: "POST",
          body: JSON.stringify({
            account_id: amo.get("account").id,
            api_key: options.get("api_access_key"),
            options: data.options,
          }),
        };

        await storage.fetch(url, fetchData, "json");

        utils.useSaveButton("loaded");
        utils.useSaveButton("close");
      } catch (error) {
        console.error(error);
        utils.useSaveButton("loaded");
      }
    }
    async saveAdvancedSettings(data) {
      const self = this.#self;
      const { amo, storage, options, utils } = self;

      try {
        utils.useSaveButton("load");

        const server = options.get("server_emfy");
        const widgetModule = options.get("module");

        const url = `${server}?module=${widgetModule}&set_options=2&save_at_amo=1`;
        const fetchData = {
          method: "POST",
          body: JSON.stringify({
            account_id: amo.get("account").id,
            api_key: options.get("api_access_key"),
            options: data.options,
          }),
        };

        await storage.fetch(url, fetchData, "json");

        utils.useSaveButton("loaded");
        utils.useSaveButton("close");
      } catch (error) {
        console.log(error);
        utils.useSaveButton("loaded");
      }
    }

    /**
     * Добавление стилей css виджета
     */
    insertCSS() {
      const self = this.#self;
      const { dom, options } = self;

      const params = options.get("params");

      const css = dom.get("#" + params.widget_code + "_css");

      if (css) return;

      const style = dom.add("link");

      style.id = params.widget_code + "_css";
      style.href = params.path + "/css/style.css?v=" + self.get_version();
      style.type = "text/css";
      style.rel = "stylesheet";

      document.head.appendChild(style);
    }

    /**
     * Получить текст с платежной информацией
     * @private
     * @returns {string | undefined}
     */
    #getPaymentText() {
      const self = this.#self;
      const { options } = self;

      const widgetOptions = options.get("widget_options");

      const paidTill = widgetOptions.paid_till
        ? widgetOptions.paid_till
        : undefined;
      const paidLeft = widgetOptions.paid_left
        ? widgetOptions.paid_left
        : undefined;

      if (!paidTill || !paidLeft) return;

      const getFree = `
    <a 
      data-id="pay_for_widget"
      class="subscription_renew" 
    >
      ${self.i18n("settings.get_free")}
    </a>
  `;

      if (!widgetOptions.is_actived) {
        return `
        <span> 
          ${self.i18n("settings.paid_till")} ${paidTill}.
        </span>
        ${getFree}
        ${
          paidLeft.text && paidLeft.days < 5
            ? `<div class="subscription_left"> 
                ${self.i18n("settings.paid_left")}: ${paidLeft.text}!
              </div>`
            : ""
        }
      `;
      } else if (widgetOptions.is_test_period) {
        return `
        <span>
          ${self.i18n("settings.test_active")} ${paidTill}!
        </span> 
        ${getFree}
      `;
      } else if (paidTill !== "unlimited") {
        return `
        <span>
          ${self.i18n("settings.test_not_active")} ${paidTill}!
        </span>
        ${getFree}
      `;
      }
    }

    /**
     * Добавляет элемент HTML с платежной информацией
     * @returns
     */
    addPaymentInfo() {
      const { options, dom } = this.#self;

      const widgetOptions = options.get("widget_options");

      if (!widgetOptions) return;

      const innerHTML = this.#getPaymentText();

      if (!innerHTML) return;

      const paymentInfo = dom.add("div");
      paymentInfo.className = widgetOptions.is_actived
        ? "subscription_block"
        : "client_id_block";
      paymentInfo.innerHTML = `
      <div class="subscription_till">
        ${innerHTML}
      </div>
    `;

      const hr = dom.get(".widget_settings_block__separator.custom_separator");

      if (hr) {
        hr.after(paymentInfo);
        return;
      }

      const desc = dom.get(".widget_settings_block__descr");

      if (desc) {
        desc.after(paymentInfo);
        return;
      }
    }

    /**
     * Перезагрузка страницы
     * @returns {Function} amo.reload()
     */
    refreshPage() {
      const { amo, dom, options } = this.#self;
      const module = options.get("module");

      options.set("page_ids", []);
      options.set("leads_timestamp", {});
      options.set("leads_info", {});
      options.set("changed_leads", {});
      options.set("processing_colorize", false);
      options.set("leads_tags_cache", false);

      dom.addEvent(document, `refreshPage_${module}`);

      return amo.reload();
    }

    /**
     * Создание заявки на оплату
     */
    initPaymentRequest() {
      const self = this.#self;
      const { template, amo, options, dom, storage } = self;

      const params = options.get("params");
      const module = options.get("module");
      const user = amo.get("user");

      const name = user.name;
      const phone = user.personal_mobile !== null ? user.personal_mobile : "";
      const email = user.login;
      const widgetCode = params.widget_code;

      new Modal({
        class_name: "modal-window",
        init: ($modal_body) => {
          const modalBody = $modal_body[0];

          const panel = `
        <div class="modal-body__inner">
          <p>
            <style>
              .user-profile__table_inputs {
                width: 100%;
              }
            </style>
          </p>
          <span class="modal-body__close">
            <span class="icon icon-modal-close"></span>
          </span>
          <h2 class="modal-body__caption head_2">
            ${self.i18n("settings.make_subscription")}
          </h2>
          <div class="user-profile__table_fields">
            <div class="user-profile__table_inputs">
              <input 
                name="user_name" 
                class="text-input" 
                type="text" 
                value="${name}" 
                autocomplete="off"
                placeholder="${self.i18n("settings.full_name")}"
              >
            </div>
          </div>
          <div class="user-profile__table_fields">
            <div class="user-profile__table_inputs">
              <input 
                name="user_phone" 
                class="text-input" 
                type="text" 
                value="${phone}" 
                autocomplete="off"
                placeholder="${self.i18n("settings.phone")}"
              >
            </div>
          </div>
          <div class="user-profile__table_fields">
            <div class="user-profile__table_inputs">
              <input 
                name="user_email" 
                class="text-input" 
                type="text" 
                value="${email}" 
                autocomplete="off"
                placeholder="E-mail"
              >
            </div>
          </div>
          <div class="user-profile__table_fields user-profile__table_fields-note-row">
            <div class="user-profile__table_inputs">
              <textarea 
                name="user_comment" 
                class="text-input text-input-textarea"
                placeholder="${self.i18n("settings.comment")}"
              ></textarea>
            </div>
          </div>
          <div class="modal-body__actions">
            <button 
              type="button" 
              class="button-input button-input_blue" 
              id="partner-emfy-pay-request-${widgetCode}"
            >
              <span class="button-input-inner">
                <span class="button-input-inner__text">
                  ${self.i18n("settings.send_request")}
                </span>
              </span>
            </button>
          </div>
        </div>
      `;

          dom.trigger(modalBody, "modal:loaded", { bubbles: true });
          modalBody.innerHTML = panel;
          dom.trigger(modalBody, "modal:centrify", { bubbles: true });

          const payButton = dom.get(
            `#partner-emfy-pay-request-${params.widget_code}`,
          );

          dom.addListener(payButton, "click", () => {
            const payButton = dom.get(
              `#partner-emfy-pay-request-${params.widget_code}`,
            );

            dom.trigger(payButton, "button:load:start", { bubbles: true });

            const user_name = dom.get('input[name="user_name"]');
            const user_phone = dom.get('input[name="user_phone"]');
            const user_email = dom.get('input[name="user_email"]');
            const user_comment = dom.get('textarea[name="user_comment"]');
            const url =
              "https://core.emfy.com/widgets/actions/subscription.php";
            const data = {
              method: "POST",
              body: JSON.stringify({
                amo_login: amo.widgets.system.amouser,
                amo_domain: amo.widgets.system.subdomain,
                amo_account_id: amo.get("account").id,
                lang_id: amo.lang_id,
                code: module,
                user_name: user_name.value,
                user_phone: user_phone.value,
                user_email: user_email.value,
                user_comment: user_comment.value,
                amo_user_phone: amo.get("user").personal_mobile,
                amo_user_name: amo.get("user").name,
              }),
            };

            storage
              .fetch(url, data)
              .then(() => {
                amo.openAlert(
                  `${self.i18n("settings.payment_request_success")}`,
                  "success",
                  {},
                );
              })
              .catch(() =>
                amo.openAlert(
                  `${self.i18n("settings.payment_request_error")}`,
                  "error",
                  {},
                ),
              );
          });
        },
        destroy: () => {
          this.refreshPage();
        },
      });
    }

    /**
     * Проверка на то, установлен ли виджет
     * @returns {boolean} Установлен виджет или нет
     */
    afterSaveEnableCheck() {
      const { dom } = this.#self;

      const checked = dom.get("#widget_active__sw:checked");

      if (!checked) return false;

      const checkbox = dom.get("#widget_active__sw");

      if (!checkbox) return false;

      return checked.value === "Y" && checkbox.value === "Y";
    }

    /**
     * Кодируем в base64
     * @param {string} str - простая строка
     * @returns {string} кодированную строку
     */
    encodeToBase64(str) {
      return btoa(String.fromCharCode(...new TextEncoder().encode(str)));
    }
    /**
     * Декодируем из base64
     * @param {string} base64 - Строка в формате Base64
     * @returns {object} декодированную строку
     */
    decodeFromBase64(base64) {
      try {
        return new TextDecoder().decode(
          Uint8Array.from(atob(base64), (c) => c.charCodeAt(0)),
        );
      } catch (e) {
        console.error(e);
        return base64;
      }
    }
  };
});
