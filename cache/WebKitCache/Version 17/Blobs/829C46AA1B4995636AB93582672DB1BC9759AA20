"use strict";(window.webpackChunk=window.webpackChunk||[]).push([[42378],{252742:(e,t,i)=>{i.r(t),i.d(t,{default:()=>y});var s=i(267651),n=i.n(s),a=i(827378),o=i(937634),r=i(629133),l=i.n(r),c=i(436132),h=i(500034),d=i(580326),_=i(418860),p=i(353256);function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,s=new Array(t);i<t;i++)s[i]=e[i];return s}function m(e,t,i,s,n,a,o){try{var r=e[a](o),l=r.value}catch(e){return void i(e)}r.done?t(l):Promise.resolve(l).then(s,n)}function f(e){return function(){var t=this,i=arguments;return new Promise((function(s,n){var a=e.apply(t,i);function o(e){m(a,s,n,o,r,"next",e)}function r(e){m(a,s,n,o,r,"throw",e)}o(void 0)}))}}function v(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function g(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},s=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(i).filter((function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})))),s.forEach((function(t){v(e,t,i[t])}))}return e}function w(e,t){var i,s,n,a,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return a={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function r(a){return function(r){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,s&&(n=2&a[0]?s.return:a[0]?s.throw||((n=s.return)&&n.call(s),0):s.next)&&!(n=n.call(s,a[1])).done)return n;switch(s=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,s=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((n=(n=o.trys).length>0&&n[n.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){o.label=a[1];break}if(6===a[0]&&o.label<n[1]){o.label=n[1],n=a;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(a);break}n[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],s=0}finally{i=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,r])}}}var b="generate";const y={isAiTaskAvailable:(0,h.isFeatureAvailable)("ai_agent_viewable")||(0,h.isFeatureAvailable)("kommo_ai_trial_started")&&!(0,h.isFeatureAvailable)("kommo_ai_trial_ended"),shouldPreventAiHelpersInit:!1,getAiParams:function(){var e,t,i,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=s.externalChatTarget,a=void 0===n?null:n,o=s.availableHelpers,r=void 0===o?[c.AiHelperType.ANSWER]:o,_=s.talkId,p=s.answerType,u=s.text,m=s.shouldCheckGrammar,f=(a?a.getTalkId():null===(t=this._active_view)||void 0===t||null===(e=t.getTalkId)||void 0===e?void 0:e.call(t))||_,v=null===(i=this.options.notes.last_dialogs_ids)||void 0===i?void 0:i[f],w={};if(f&&v){var y=v.model.toJSON(),A=y.id,T=y.chat_id,C=y.author,k=y.dialog,E=k.read_status,P=k.opened,I=d.AmoJoMediator.get()[T]||{contacts:{},users:{}},S=Boolean(E),x=l().chain(APP.element_types).pick("leads","customers").values().contains(I.entity_type).value(),O=I&&!x&&"amocrm"!==C.origin&&!C.bot,H=P&&!S&&O||p===b,V=function(e){return l().contains(r,e)};w={shouldAiAnswerShow:((0,h.isFeatureAvailable)("ai_rewriter_fast_reply")?H&&!this.isAnswerApplied:H)&&V(c.AiHelperType.ANSWER),shouldAiTaskShow:!this.checkIsTaskExists()&&V(c.AiHelperType.TASK),messageId:A,answerType:p,text:u,shouldCheckGrammar:m}}return g({talkId:f},w)},checkShouldPreventInit:function(e){var t,i,s=e.externalChatTarget,n=void 0===s?null:s,a=e.answerType,o=e.availableHelpers,r=void 0===o?[c.AiHelperType.ANSWER]:o,d=e.talkId,p=n||(null===(i=this._active_view)||void 0===i||null===(t=i._chat_params)||void 0===t?void 0:t.external_chat_target);switch(!0){case l().contains(r,c.AiHelperType.TASK):var u,m=!l().contains([_.default.ACTIVE_VIEW_TYPE_CHAT,_.default.ACTIVE_VIEW_TYPE_TASK],null===(u=this._active_view)||void 0===u?void 0:u.options._type);return(0,h.isFeatureAvailable)("ai_limited")||m;case l().contains(r,c.AiHelperType.ANSWER)&&a===b:return(0,h.isFeatureAvailable)("ai_limited");default:var f;return l().propertyOf(this)(["aiHelpers","options","talkId"])===d||this._last_used.type!==_.default.ACTIVE_VIEW_TYPE_CHAT||(null===(f=this._active_view)||void 0===f?void 0:f.options._type)!==_.default.ACTIVE_VIEW_TYPE_CHAT||(0,h.isFeatureAvailable)("ai_limited")||!p}},initAiHelpersWithPreventCheck:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var s;this.shouldPreventAiHelpersInit||this.initAiHelpers.apply(this,function(e){if(Array.isArray(e))return u(e)}(s=t)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(s)||function(e,t){if(e){if("string"==typeof e)return u(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(i):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?u(e,t):void 0}}(s)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}())},initAiHelpers:l().throttle(f((function(){var e,t,s,n,a,o,r,l,c,h,d,_=arguments;return w(this,(function(p){switch(p.label){case 0:return e=this,t=_.length>0&&void 0!==_[0]?_[0]:{},s=this.getAiParams(t),n=s.talkId,a=s.text,o=s.answerType,r=function(e,t){if(null==e)return{};var i,s,n=function(e,t){if(null==e)return{};var i,s,n={},a=Object.keys(e);for(s=0;s<a.length;s++)i=a[s],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(s=0;s<a.length;s++)i=a[s],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}(s,["talkId","text","answerType"]),this.checkShouldPreventInit((u=g({},t),m=null!=(m={talkId:n})?m:{},Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(m)):function(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);i.push.apply(i,s)}return i}(Object(m)).forEach((function(e){Object.defineProperty(u,e,Object.getOwnPropertyDescriptor(m,e))})),u))?[2]:(this.aiHelpers&&this.destroyAiHelper(),this.unsubscribeAiPastingPubSub=this.subscribeAiPastingPubSub(),[4,i.e(63503).then(i.bind(i,963503))]);case 1:return l=p.sent(),c=l.default,this.isAiAnswerShown=!1,h=function(t){e._toggleFirstTaskVisibility(t)},d=g({el:this._elem("feed_ai_helpers"),talkId:n,text:a,answerType:o,elementType:this.options.notes.element_type,elementId:this.options.notes.element_id,getText:function(){return e._active_view.getExistingText()},setText:function(t){var i,s;return null===(i=(s=e._active_view).setTextFromAiHelpers)||void 0===i?void 0:i.call(s,t)},onAnswerReply:function(t){return e.handleAiAnswerProcessing(t)},onHelperVisibilityChange:h,onLoad:function(t){return e.toggleComposeLoader(t)},checkIsTaskExists:function(){return e.checkIsTaskExists()}},r),this.aiHelpers=this._addComponent(c,d),this._elem("feed_ai_helpers").removeClass("hidden"),[2]}var u,m}))})),100,{leading:!1}),subscribeAiHelpersInitPubSub:function(){var e,t=this,i=(e=f((function(e,i){var s,n,a,o,r,l;return w(this,(function(e){switch(e.label){case 0:return(0,h.isFeatureAvailable)("ai_limited")?(t.unmountAiErrorModal=t.mountAiErrorModal({code:402}),[2]):(s=i.talkId,n=i.text,a=i.isReplyAvailable,o=i.userId,a?[3,3]:(t.shouldPreventAiHelpersInit=!0,"chat"===(null===(l=t._active_view)||void 0===l||null===(r=l.options)||void 0===r?void 0:r._type)?[3,2]:[4,t.setCompose("chat",{talk_id:s,user_id:o})]));case 1:e.sent(),e.label=2;case 2:t.openComposeForm(),t.shouldPreventAiHelpersInit=!1,e.label=3;case 3:return t.isAnswerApplied=!1,t.initAiHelpersWithPreventCheck({talkId:s,text:n,answerType:b}),[2]}}))})),function(t,i){return e.apply(this,arguments)}),s=n().subscribe(p.AI_ANSWER_GENERATE_RESPONSE,i);return function(){n().unsubscribe(s)}},handleAiAnswerProcessing:function(e){this.isAiAnswerShown=e,(0,h.isFeatureAvailable)("ai_rewriter_fast_reply")?this._toggleFirstTaskVisibility(e):this._opened||this.options.onToggle(e?"open":"close")},mountAiErrorModal:function(e){var t,s=this;return i.e(41562).then(i.bind(i,341562)).then((function(i){var n=i.default,r=document.createElement("div");r.id="aiHelpersErrorModalRoot",s.el.append(r);var c=(0,a.createElement)(n,{onModalCloseRequest:l().bind(s.handleAiErrorModalCloseRequest,s),error:e});(t=(0,o.createRoot)(r)).render(c)})),function(){t&&t.unmount()}},handleAiErrorModalCloseRequest:function(){var e;null===(e=this.unmountAiErrorModal)||void 0===e||e.call(this),this._findElem("aiHelpersErrorModalRoot").remove()},destroyAiHelper:function(){var e;this.aiHelpers.destroy(),this._elem("feed_ai_helpers").addClass("hidden"),this.isAiAnswerShown=!1,this.aiHelpers=null,null===(e=this.unsubscribeAiPastingPubSub)||void 0===e||e.call(this)},subscribeAiPastingPubSub:function(){var e=this,t=n().subscribe(c.AI_COMPOSE_ANSWER_PASTED,(function(){e.isAnswerApplied=!0}));return function(){n().unsubscribe(t)}},onActiveViewChangeHelpersInit:function(e){var t=e.view;switch(!0){case(e.viewOptions||{}).shouldPreventAiHelpers:this.initAiHelpersWithPreventCheck({availableHelpers:[]});break;case"chat"===t:var i=[c.AiHelperType.ANSWER];this.isAiTaskAvailable&&this.isAiTaskEnabled&&i.push(c.AiHelperType.TASK),this.initAiHelpersWithPreventCheck({availableHelpers:i,shouldCheckGrammar:"chat"===t});break;case"task"===t&&this.isAiTaskAvailable&&this.isAiTaskEnabled:this.initAiHelpersWithPreventCheck({availableHelpers:[c.AiHelperType.TASK],talkId:l().propertyOf(this._last_used)(["data","talk_id"]),shouldCheckGrammar:"chat"===t})}},checkIsAiHelpersAvailable:function(){var e=(0,h.isFeatureAvailable)("airewriter")&&((0,h.isFeatureAvailable)("is_customization_for_global")||(0,h.isFeatureAvailable)("is_ai_configured"));return(0,h.isFeatureAvailable)("kommo_ai_trial_started")&&!(0,h.isFeatureAvailable)("kommo_ai_trial_ended")||e},checkIsTaskExists:function(){return Boolean(this.options.notes.find((function(e){return"tasks"===e.get("object_type").code&&!e.get("status")}),this))},_toggleFirstTaskVisibility:function(e){this.options.onFirstTaskVisibilityToggle(e?"open":"close")}};var A="../build/transpiled/interface/notes/views/add/mixins/aiHelpers";window.define(A,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([A])},942378:(e,t,i)=>{i.r(t),i.d(t,{default:()=>V});var s=i(162262),n=i.n(s),a=i(460159),o=i.n(a),r=i(629133),l=i.n(r),c=i(436132),h=i(313981),d=i(335745),_=i(440776),p=i(323344),u=i(450422),m=i(500034),f=i(859200),v=i(214558),g=i(445368),w=i(168807),b=i(258471),y=i(960190),A=i(573388),T=i(70094),C=i(397240),k=i(418860),E=i(445227),P=i(252742),I=i(661533);function S(e,t,i,s,n,a,o){try{var r=e[a](o),l=r.value}catch(e){return void i(e)}r.done?t(l):Promise.resolve(l).then(s,n)}function x(e){return function(){var t=this,i=arguments;return new Promise((function(s,n){var a=e.apply(t,i);function o(e){S(a,s,n,o,r,"next",e)}function r(e){S(a,s,n,o,r,"throw",e)}o(void 0)}))}}function O(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function H(e,t){var i,s,n,a,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return a={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function r(a){return function(r){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,s&&(n=2&a[0]?s.return:a[0]?s.throw||((n=s.return)&&n.call(s),0):s.next)&&!(n=n.call(s,a[1])).done)return n;switch(s=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,s=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((n=(n=o.trys).length>0&&n[n.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){o.label=a[1];break}if(6===a[0]&&o.label<n[1]){o.label=n[1],n=a;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(a);break}n[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],s=0}finally{i=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,r])}}}const V=h.default.extend({_mail_compose_data:null,_mailbox_data:null,className:"feed-compose",_classes:function(){return{inner:"feed-compose__inner",switcher:"feed-compose-switcher",switcher_tip:"feed-compose-switcher__tip",switcher_tip_chat:"js-switcher-chat",switcher_tip_email:"js-switcher-email",switcher_tip_note:"js-switcher-note",switcher_tip_sms:"js-switcher-sms",switcher_tip_widget_title:"js-switcher-widget-title",switcher_tip_widget:"js-switcher-widget",switcher_external:"feed-compose-switcher__item-wrapper"}},_selectors:function(){return{textarea:"[contenteditable]",textarea_mail:".feed-compose__message-area",switcher_input:'[name="feed-compose-switcher"]',feed_ai_helpers:".js-feed-ai-helpers",feed_compose_loader:".js-feed-loader",aiHelpersErrorModalRoot:"#aiHelpersErrorModalRoot"}},events:{click:"composeStopPropagation","click .js-note-edit-cancel":"cancelClick","click .js-task-edit-cancel":"cancelClick","click .js-switcher-widget-title":"stopPropagation","keydown [contenteditable]":"openComposeForm","click .feed-compose-switcher__tip .js-tips-item":"changeViewClick","click .feed-compose-switcher":"showSwitcherTipClick",'change [name="feed-compose-switcher"]':"onChangeActiveView","mouseover .feed-compose-switcher":"switcherMouseOver","mouseover .feed-compose-switcher__tip":"switcherTipMouseOver","mouseleave .feed-compose-switcher":"switcherTextMouseLeave","mouseleave .feed-compose-switcher__tip":"switcherMouseLeave"},document_events:{"notes:compose:switch":"setComposeFromOutside","notes:compose:open":"openComposeForm","widgets:sources:add":"_fetchLastType","notes:compose:answer-to":"catchRepliesEvents","notes:compose:add-quot":"catchRepliesEvents"},initialize:function(e){var t=this,i=this;this.cards_with_subscribers=l().pick(APP.element_types,"leads","customers"),this.opened_talks_collection=l().propertyOf(e)(["notes","opened_talks_collection"]),this.isAiAgentAvailable=(0,m.isFeatureAvailable)("kommo_ai_trial_active")||(0,m.isFeatureAvailable)("ai_agent_available"),(0,m.isFeatureAvailable)("ai_agent_viewable")&&l().isUndefined((0,m.isFeatureAvailable)("is_ai_task_suggestion_enabled"))&&this.getTaskSuggestionEnabled(),this.options=l().extend({onToggle:l().noop},e),this._possible_views={AmoJoComposeView:l().noop,NoteComposeView:l().noop,SmsComposeView:l().noop,WidgetComposeView:l().noop,MailComposeView:l().noop,TaskComposeView:l().noop},this._opened=!1,this._last_used={},this._last_fetched={},this._setComposeTti=l().once((function(){(0,d.logPerformanceMetric)({type:(0,d.getRealCardPageType)(),name:"composeTti"})})),this.trackComposeTti=l().once((function(){(0,b.trackPerformanceMetric)({name:b.TrackedMetricName.COMPOSE_TTI,group:b.TrackedMetricGroupName.TTI})})),this._isChatEnabled=l().isFunction(e.isChatEnabled)?e.isChatEnabled:function(){return!0},l().bindAll(this,"onFileApiWindowOver"),h.default.prototype.initialize.apply(this,arguments),this._form=this._addComponent(E.default),n().mixin(this,P.default),this.listenTo(this.options.notes,"add remove",l().bind(l().debounce(this._fetchLastType,200,!0),this)).listenTo(this.options.notes,"notes:compose:switch",l().bind(this.setCompose,this)).listenTo(this.options.notes,"notes:dnd:compose",l().bind(this.onFileApiWindowOver,this)),this.opened_talks_collection&&(this.listenTo(this.opened_talks_collection,"add remove change:read_status",l().bind(l().debounce(this._fetchLastType,200,!0),this)),this.isAiAgentAvailable&&this.listenToOnce(this.options.notes,"views:added",this.initAgentView)),l().contains(this.cards_with_subscribers,this.options.notes.element_type)&&(this._addComponent(T.default,{el:I("#show-chat-list").parent(),entity_type:this.options.getExtraData().elements[0].element_type,entity_id:this.options.getExtraData().elements[0].id}),(0,f.canEditCard)()&&this._addComponent(A.default,{el:I("#show-bots-list").parent(),entity_type:this.options.getExtraData().elements[0].element_type,entity_id:this.options.getExtraData().elements[0].id,notes:this.options.notes})),this._setActiveView().then((function(){t.trackComposeTti(),(APP.constant("load_from_server")||APP.first_load)&&t._setComposeTti(),i.options.notes.element_id?i._fetchLastType():i._setEdit()})),this.checkIsAiHelpersAvailable()&&(this.unsubscribeAiHelpersInitPubSub=this.subscribeAiHelpersInitPubSub())},destroy:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var s;return null===(s=this.unsubscribeAiHelpersInitPubSub)||void 0===s||s.call(this),h.default.prototype.destroy.apply(this,t)},initAgentView:function(){return x((function(){var e,t,s;return H(this,(function(n){switch(n.label){case 0:return e=this,l().contains(this.cards_with_subscribers,this.options.notes.element_type)?[4,i.e(70681).then(i.bind(i,670681))]:[2];case 1:return t=n.sent(),s=t.default,this.aiAgentView=this._addComponent(s,{el:I("#show-agent").parent()}),this.renderAiAgentCardControl(this.opened_talks_collection),this.listenTo(this.opened_talks_collection,"sync change add remove",(function(){e.renderAiAgentCardControl(e.opened_talks_collection)})),[2]}}))})).apply(this)},catchRepliesEvents:function(e,t,i,s){return x((function(){var n,a,o;return H(this,(function(r){switch(r.label){case 0:return o="answerTo","add_quotation"!==t&&"add_reply"!==t||(o="addQuotation"),"chat"===this._active_view.options._type?[3,2]:[4,this.setCompose("chat",{user_id:i.attributes.author.id})];case 1:r.sent(),r.label=2;case 2:return null===(n=(a=this._active_view)[o])||void 0===n||n.call(a,e,t,i,s),[2]}}))})).apply(this)},getOpenedTalksIds:function(e){var t=e._byId;return l().chain(t).keys().filter((function(e){return!l().isNaN(parseInt(e))&&1!==t[e].get("status")})).map(Number).value()},getAllPipelineSourceIdsWithAgent:function(){return x((function(){return H(this,(function(e){switch(e.label){case 0:return[4,(0,y.getBaseAgentSettings)()];case 1:return[2,e.sent().triggerConditions]}}))}))()},checkIsAgentAvailableForSources:function(e){return x((function(){var t,i,s,n,a,o,r;return H(this,(function(c){switch(c.label){case 0:return i=null===(t=this.options.mainEntityData)||void 0===t?void 0:t.pipeline_id,l().isNull(i)?[2,!1]:(s=this,[4,this.getAllPipelineSourceIdsWithAgent()]);case 1:return s.allPipelinesSourceIdsWithAgent=c.sent(),this.allPipelinesSourceIdsWithAgent&&(n=this.allPipelinesSourceIdsWithAgent[i])?(a=n.sourceIds,o=new Set(a),r=e._byId,[2,l().some(r,(function(e){var t;return o.has(null==e||null===(t=e.attributes)||void 0===t?void 0:t.sourceId)}))]):[2,!1]}}))})).apply(this)},renderAiAgentCardControl:function(e){return x((function(){return H(this,(function(t){switch(t.label){case 0:return this.aiAgentView?[4,this.checkIsAgentAvailableForSources(e)]:[2];case 1:return t.sent()?(this.aiAgentView.render({talkIds:this.getOpenedTalksIds(e)}),[2]):[2]}}))})).apply(this)},handleUserChange:function(e){var t=e.external_chat_target,i=this.getAiParams({externalChatTarget:t}).shouldAiAnswerShow,s=(0,m.isFeatureAvailable)("ai_rewriter_fast_reply")&&i;this.checkIsAiHelpersAvailable()&&(this._opened||s)&&(0,m.isFeatureAvailable)("ai_answer")&&t?this.initAiHelpersWithPreventCheck({externalChatTarget:t}):this.aiHelpers&&(this._opened||this.options.onToggle("close"))},delegateEvents:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var s=h.default.prototype.delegateEvents.apply(this,t);return this._setComposeByUrl(),s},_setComposeByUrl:function(){var e,t,i,s,n=(0,p.getQueryParam)("compose");if(n){if(t=(e=n.split(":"))[0],i=e[1],"mailto"!==t)throw new Error("Unknown compose type.");this.setCompose("email",{email:i}),s=(0,p.removeQueryParam)("compose"),APP.router.navigate(window.location.pathname+(s?"?".concat(s):""),{trigger:!1,replace:!0})}},onFileApiWindowOver:function(e){this._active_view.options&&"task"===this._active_view.options._type||e&&(this.setCompose(),this._active_view.model.trigger("notes:dnd:window"))},setComposeFromOutside:function(e,t,i){this.setCompose(t,i)},showSwitcherTipClick:function(e){var t=this._findElem("switcher_tip");1!==t.find(".js-tips-item:not(.hidden)").length&&(e&&e.stopPropagation&&e.stopPropagation(),t.is(":hidden")&&this.switcherTipShow())},switcherMouseOver:function(){var e=this._findElem("switcher_tip");e.is(":hidden")&&e.find(".js-tips-item:not(.hidden)").length>1&&(this._switcher_tip_timeout=l().delay(l().bind(this.switcherTipShow,this),100)),clearTimeout(this._switcher_timeout)},switcherTipShow:function(){var e=this._findElem("switcher_tip"),t=e.find(".js-tip-items");this._checkIfDefaultNeeded("email")?this._findElem("switcher_tip_email").removeClass("hidden"):this._findElem("switcher_tip_email").addClass("hidden"),this._findElem("switcher_tip_widget_title").remove(),this._findElem("switcher_tip_widget").remove(),l().each(_.default.get(),(function(e,i){!this._isType(i,"widget")||this._isType(i,"sms")&&!this._checkIfDefaultNeeded("sms")||this._isType(i,"email")&&!this._checkIfDefaultNeeded("email")||t.append(o()({ref:"/tmpl/common/tip_item.twig"}).render({selected:this._elem("switcher_input").val(),item:{id:i,class_name:this._class("switcher_tip_widget"),text:e.text}}))}),this),this._findElem("switcher_tip_widget").length&&this._findElem("switcher_tip_widget").eq(0).before('<div class="tips-item tips-item_title '.concat(this._class("switcher_tip_widget_title"),'">').concat((0,g.i18n)("Integrations"),"</div>")),e.trigger("tip:show").addClass("tips-at-top tips_slide-up")},switcherTipMouseOver:function(){clearTimeout(this._switcher_timeout)},switcherMouseLeave:function(){this._switcher_timeout=l().delay(l().bind((function(){this._$document.trigger("controls:hide",["tip"])}),this),200)},switcherTextMouseLeave:function(){clearTimeout(this._switcher_tip_timeout),this.switcherMouseLeave()},changeViewClick:function(e){var t=I(e.currentTarget),i=t.attr("data-id"),s=this._elem("switcher_input");s.val(i),t.data("widget-code")?s.attr("data-widget-code",t.data("widget-code")):s.data("widget-code")&&s.removeAttr("data-widget-code"),s.trigger("change",{is_user_action:!0}),this._$document.trigger("controls:hide",["tip"])},onChangeActiveView:function(e){this._onChangeActiveView(e)},_onChangeActiveView:function(e,t){var i=this._elem("switcher_input").val(),s=this._elem("switcher_input").attr("data-widget-code"),n='.js-tips-item[data-id="'.concat(i,'"]'),a=this._getUpdatedLastUsedTypes(i),o=!l().isEmpty(e)&&e.is_user_action;return!this.options.notes.element_id&&"chat"===i||(0,u.isAmoChatsFullEnabled)()&&!l().contains(["chat","note","sms","widget"],i)?Promise.resolve():(s&&(n+='[data-widget-code="'.concat(s,'"]')),this._elem("switcher_tip").find(".tips-item_selected").removeClass("tips-item_selected"),this._elem("switcher_tip").find(n).addClass("tips-item_selected"),o&&this._memorizeLastUsedTypes(a),this._last_used=l().extend(this._last_used,a),this._setActiveView(t))},stopPropagation:function(e){e.stopPropagation()},composeStopPropagation:function(e){I(e.target).closest(".js-tip-holder").length||I(e.target).closest(".tasks-date").length||I(e.target).closest(".control--suggest").length||I(e.target).closest(".control--select").length||(this._$document.trigger({type:"controls:hide",target:e.target}),e.stopPropagation()),this._setEdit()},_setEdit:function(){this._memorizeLastUsedTypes(this._getUpdatedLastUsedTypes(this._active_view.options._type)),this._opened||(this.options.setEdit(this),this.openComposeForm())},openComposeForm:function(e){if(!this._opened){if(this._opened=!0,this.$el.removeClass("minimized"),this.checkIsAiHelpersAvailable()){this.isAnswerApplied=!1;var t=[c.AiHelperType.ANSWER];this.isAiTaskAvailable&&this.isAiTaskEnabled&&t.push(c.AiHelperType.TASK)}e||(this._active_view._onOpenCompose(),this._memorizeLastUsedTypes(this._getUpdatedLastUsedTypes(this._active_view.options._type)))}},cancelClick:function(e){e.stopPropagation(),this._active_view._form.revert(),this.cancel()},_getListOfSmsWidgets:function(){var e=this;return l().chain(_.default.get()).keys().filter((function(t){return e._isType(t,"sms")})).value()},_checkIfDefaultNeeded:function(e){var t,i=!!l().propertyOf(APP.constant("amomail"))(["mailboxes","active"]),s=!l().isEmpty(this._mailbox_data);if(!l().contains(["email","sms"],e))return!1;if("email"===e&&!i&&!s)return!1;var n=this.options.getExtraData().elements;switch(e){case"sms":t="phone";break;case"email":t="email"}return!!l().find(n,(function(e){return e[t]&&e[t].length}))},_getLastTimelineMessage:function(){var e,t=I.Deferred(),i=this._checkIfDefaultNeeded("email"),s=this._elem("switcher_tip_note").is(":not(.hidden)"),n=this._checkIfDefaultNeeded("sms")&&!l().isEmpty(this._getListOfSmsWidgets());return e=(e=this.options.notes.max(l().bind((function(e){switch(!0){case e.get("type")===APP.note_types.common&&s:case e.get("type")===APP.note_types.mail_message&&i:case e.get("type")===APP.note_types.sms_in&&n:case e.get("type")===APP.note_types.sms_out&&n:return e.get("date_create");case!l().isUndefined(e.get("chat_id")):return this._filterLastMessage(e);case e.get("type")===APP.note_types.mail_message&&!i:return-1;default:return 0}}),this)))===-1/0||e.get("type")===APP.note_types.common||this._isCommentsTalk(e)?{}:e.toJSON(),t.resolve(e)},_filterLastMessage:function(e){var t,i,s=l().propertyOf(e.get("dialog"));if(e.get("author")){if(s("id")&&!1===s("opened")&&this._chatHasOtherOpenedTalks(e.get("chat_id"))||this._isCommentsTalk(e))return!1;var n=e.get("author").id===(0,v.current)("amojo_id"),a="amocrm"===e.get("author").origin;return e.get("recipient")&&(t=e.get("recipient").id===(0,v.current)("amojo_id"),i="amocrm"!==e.get("recipient").origin),e.get("author").bot?!e.get("recipient")||e.get("recipient")&&!t?0:e.get("created_at"):a&&!n&&e.get("recipient")&&i?0:e.get("created_at")}},_isCommentsTalk:function(e){var t,i,s,n,a,o,r,l,c,h="secondary"===(null===(t=e.get("dialog"))||void 0===t?void 0:t.category),d=null===(i=e.get("recipient"))||void 0===i?void 0:i.origin,_=null===(s=e.get("author"))||void 0===s?void 0:s.origin,p=(null===(n=e.get("message_attributes"))||void 0===n?void 0:n.custom)||{},u=null===(r=e.get("reply_to"))||void 0===r||null===(o=r.message)||void 0===o||null===(a=o.message_attributes)||void 0===a?void 0:a.custom,m=null===(l=p.post)||void 0===l?void 0:l.url,f=p.thread_last_message_id,v=[d,_].includes("instagram_business"),g=Boolean(m)||Boolean(f),w=Boolean(null==u||null===(c=u.post)||void 0===c?void 0:c.url)||Boolean(null==u?void 0:u.thread_last_message_id);return(v||g||w)&&h},_chatHasOtherOpenedTalks:function(e){var t=l().propertyOf(this.options)(["notes","opened_talks_collection"]);return!!t&&l().filter(t.toJSON(),(function(t){return t.chat_id===e})).length>0},_getLastTimelineEmail:function(){var e=!1,t=this.options.notes.max((function(t){return t.get("type")===APP.note_types.mail_message?(e=!0,t.get("date_create")):-1}));return e?t:null},_loadMailboxData:function(){var e=this;return this._mailbox_def&&"pending"===this._mailbox_def.state()||(this._mailbox_def=I.Deferred(),this._mailbox_data?this._mailbox_def.resolve():Promise.resolve().then(i.bind(i,238935)).then((function(t){t.default.get("compose").then(l().bind((function(t){e._mailbox_data=t,e._mailbox_def.resolve()}),e),l().bind((function(){e._mailbox_def.reject()}),e))}))),this._mailbox_def.promise()},_fetchMailComposeData:function(e){var t=this;return l().contains(this.options.disabled_types,"email")?Promise.resolve():(!0===e&&(this._mail_def=null,this._mail_compose_data=null),this._mail_def&&"pending"===this._mail_def.state()||(this._mail_def=I.Deferred(),this._loadMailboxData().always(l().bind((function(){!this._mail_compose_data&&this._checkIfDefaultNeeded("email")?Promise.resolve().then(i.bind(i,611958)).then((function(e){e.default.getComposeDataForEntity(t.options.notes.element_id,APP.getBaseEntity()).then(l().bind((function(e){t._mail_compose_data=e||[],t._elem("switcher_tip_email").removeClass("hidden"),t._mail_def.resolve(e)}),t),l().bind((function(){t._mail_def.reject(),t._elem("switcher_tip_email").addClass("hidden")}),t))})):this._mail_def.resolve(this._mail_compose_data)}),this))),this._mail_def.promise())},_fetchLastType:function(){var e,t=l().extend(this._last_used,this._getUpdatedLastUsedTypes());return this._fetchMailComposeData().then(l().bind(this._getLastTimelineMessage,this)).then(l().bind((function(i){switch(!0){case i.type===APP.note_types.mail_message:e={type:this._isType(t.widgets_by_type.email,"email")?t.widgets_by_type.email:"email",data:{}};break;case i.type===APP.note_types.sms_in:case i.type===APP.note_types.sms_out:e={type:this._isType(t.widgets_by_type.sms,"sms")?t.widgets_by_type.sms:l().first(this._getListOfSmsWidgets())};break;case!l().isUndefined(i.chat_id):e={data:this._prepareLastChatMessage(i)},(i.recipient&&i.recipient.id===(0,v.current)("amojo_id")||"chat"!==this._last_used.type)&&(e.type=this._isType(t.widgets_by_type.chat,"chat")?t.widgets_by_type.chat:"chat");break;default:e={}}l().isEqual(e,this._last_fetched)||(this._last_used=e,this._last_fetched=I.extend(!0,{},e),this._opened||this._setLastType())}),this))},_memorizeLastUsedTypes:function(e){(!this.options.notes||this.options.notes.element_id||this.options.notes.models.length)&&(w.storeWithExpiration.set(k.default.LS_LAST_TYPE,e.type),w.storeWithExpiration.set(k.default.LS_LAST_WIDGETS_BY_TYPE,e.widgets_by_type))},_isType:function(e,t){switch(t){case"default":return"note"===e;case"system":return l().contains(["note","chat","task","email"],e);case"widget":return Boolean(_.default.get(e)&&APP.widgets.list[e]);case"exists":return this._isType(e,"system")||this._isType(e,"widget");case"sms":return this._isType(e,"widget")&&"sms"===l().propertyOf(_.default.get(e))(["options","type"]);case"email":return"email"===e||this._isType(e,"widget")&&"email"===l().propertyOf(_.default.get(e))(["options","type"]);case"chat":return"chat"===e||this._isType(e,"widget")&&"chat"===l().propertyOf(_.default.get(e))(["options","type"]);default:throw new Error("You're trying to check not allowed property.")}},_getUpdatedLastUsedTypes:function(e){var t=this._isChatEnabled()?"chat":"note",i=this._isChatEnabled()&&w.storeWithExpiration.get(k.default.LS_LAST_TYPE),s=e||i||t,n=this._isChatEnabled()&&w.storeWithExpiration.get(k.default.LS_LAST_WIDGETS_BY_TYPE)||{email:"email",chat:"chat"};switch(("task"===s||!this._isType(s,"exists")||this._isType(s,"email")&&!this._checkIfDefaultNeeded("email")||this._isType(s,"sms")&&!this._checkIfDefaultNeeded("sms"))&&(s=l().contains(["chat","note"],i)?i:t),!0){case this._isType(s,"email"):n.email=s;break;case this._isType(s,"chat"):n.chat=s;break;case this._isType(s,"sms"):n.sms=s}return{type:s,widgets_by_type:n}},getActiveViewType:function(){var e=this._elem("switcher_input");return this._isType(e.val(),"exists")?e.val():"note"},_setLastType:function(){var e=this._getUpdatedLastUsedTypes(this._last_used.type);this._last_used=l().extend(this._last_used,e),this._elem("switcher_input").val(e.type),this._isType(e.type,"widget")&&this._elem("switcher_input").attr("data-widget-code",e.type),this._elem("switcher_input").trigger("change")},_getInnerComposeView:function(e){return x((function(){var t,s,n,a,o,r,l,c,h,d,_,p;return H(this,(function(u){switch(u.label){case 0:switch(!0){case e===k.default.ACTIVE_VIEW_TYPE_EMAIL:return[3,1];case e===k.default.ACTIVE_VIEW_TYPE_CHAT:return[3,3];case e===k.default.ACTIVE_VIEW_TYPE_NOTE:return[3,5];case e===k.default.ACTIVE_VIEW_TYPE_TASK:return[3,7];case this._isType(e,k.default.ACTIVE_VIEW_TYPE_SMS):return[3,9]}return[3,11];case 1:return[4,Promise.resolve().then(i.bind(i,266020))];case 2:return t=u.sent(),s=t.default,this._possible_views.MailComposeView=s,[2,this._possible_views.MailComposeView];case 3:return[4,Promise.all([i.e(17815),i.e(40433),i.e(35969),i.e(40272),i.e(1934)]).then(i.bind(i,435969))];case 4:return n=u.sent(),a=n.default,this._possible_views.AmoJoComposeView=a,[2,this._possible_views.AmoJoComposeView];case 5:return[4,Promise.resolve().then(i.bind(i,915656))];case 6:return o=u.sent(),r=o.default,this._possible_views.NoteComposeView=r,[2,this._possible_views.NoteComposeView];case 7:return[4,i.e(41542).then(i.bind(i,741542))];case 8:return l=u.sent(),c=l.default,this._possible_views.TaskComposeView=c,[2,this._possible_views.TaskComposeView];case 9:return[4,i.e(17075).then(i.bind(i,517075))];case 10:return h=u.sent(),d=h.default,this._possible_views.SmsComposeView=d,[2,this._possible_views.SmsComposeView];case 11:return[4,i.e(53582).then(i.bind(i,553582))];case 12:return _=u.sent(),p=_.default,this._possible_views.WidgetComposeView=p,[2,this._possible_views.WidgetComposeView];case 13:return[2]}}))})).apply(this)},toggleComposeLoader:function(e){var t=this._elem("feed_compose_loader");e?t.removeClass("hidden"):t.addClass("hidden")},_toggleClassModificator:function(e,t){t?this.$el.addClass(e):this.$el.removeClass(e)},_setActiveView:function(e){var t=this,i=this.getActiveViewType(),s={_type:i,getExtraData:l().bind(this.options.getExtraData,this),onToggleClassModificator:l().bind(this._toggleClassModificator,this),getSubscribersService:l().bind(this._getSubscribersService,this),notes:this.options.notes,toggleComposeLoader:function(e){return t.toggleComposeLoader(e)},onCancel:l().bind(this.cancel,this),onAdd:l().bind((function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e&&(this.options.addNotes(e).then(l().bind(this.cancel,this)),this.options.notes.trigger("created",e.id)),!1!==t.need_cancel&&this.cancel(),this.options.scrollToEnd()}),this)},n=_.default.get(i)||{},a={},o=!1,r={};switch(!0){case"email"===i:a={params:l().extend({$notes_scroller:this.options.$notes_scroller,getMailComposeData:l().bind(this._fetchMailComposeData,this),getLastTimelineEmail:l().bind(this._getLastTimelineEmail,this),getMainContactId:l().bind(this.options.getMainContactId,this)},s)};break;case"chat"===i:a={params:l().extend(s,{getResponsibleId:l().bind(this.options.getResponsibleId,this),getMainContactId:l().bind(this.options.getMainContactId,this),getLastChatMessage:l().bind((function(){return"chat"!==this._last_used.type||l().isEmpty(this._last_used.data)?null:this._last_used.data}),this),toggleSwitcher:l().bind(this.showSwitcherTipClick,this),onUserChange:l().bind(this.handleUserChange,this),onInit:l().bind(this.handleChatInit,this)})};break;case"note"===i:a={params:l().extend(s,{element_id:this.options.notes.element_id,element_type:this.options.notes.element_type,toggleSwitcher:l().bind(this.showSwitcherTipClick,this),getMainContactId:l().bind(this.options.getMainContactId,this)})};break;case"task"===i:r={element_id:this.options.notes.element_id,element_type:this.options.notes.element_type,getResponsibleId:l().bind(this.options.getResponsibleId,this),toggleSwitcher:l().bind(this.showSwitcherTipClick,this),getMainContactId:l().bind(this.options.getMainContactId,this)},this.options.notes.element_type===APP.element_types.leads&&(r.pipeline_id=this.options.notes.element_info.pipeline_id,r.status_id=this.options.notes.element_info.status),a={params:l().extend(s,r)};break;case this._isType(i,"sms"):a={params:l().extend(s,{element_id:this.options.notes.element_id,toggleSwitcher:l().bind(this.showSwitcherTipClick,this),widget_code:i,widget_params:n,getMainContactId:l().bind(this.options.getMainContactId,this)})};break;default:a={params:l().extend(s,{widget_code:i,widget_params:n})}}return this._getInnerComposeView(i).then(l().bind((function(t){var s;a.handler=t,this._active_view&&(a.params.text=this._active_view.getExistingText(),this._active_view.destroy(),this._active_view=null,o=!0),this._active_view=this._addComponent(a.handler,a.params),this._active_view._onOpenCompose=l().compose(l().bind((function(){this.options.onToggle("open"),this._$document.trigger("notes:compose:change",[a.params._type])}),this),l().bind(this._active_view.onOpenCompose||l().noop,this._active_view)),this.$el.attr("class",[this.className,this.$el.hasClass("minimized")?"minimized":""].join(" ")).find(".feed-compose__inner").html("").append(this._active_view.el),this._active_view.edit(!1),this._active_view._form.model.on("has_changes",l().bind(this._handleFormChange,this,"has_changes")).on("has_reverted",l().bind(this._handleFormChange,this,"has_reverted")),this._active_view.setExistingText(),o&&this._opened&&(this._active_view._onOpenCompose(),this.checkIsAiHelpersAvailable()&&this.onActiveViewChangeHelpersInit({view:i,viewOptions:e}),this._last_used.type===k.default.ACTIVE_VIEW_TYPES_CHAT&&(null===(s=this._active_view)||void 0===s?void 0:s.options._type)===k.default.ACTIVE_VIEW_TYPES_CHAT||!this.aiHelpers||(this.destroyAiHelper(),this.aiHelpers=null))}),this))},handleChatInit:function(e){var t="chat"===this.getActiveViewType();if(!this.aiHelpers&&this.checkIsAiHelpersAvailable()&&e.getTalkId()){var i=[c.AiHelperType.ANSWER];this.isAiTaskAvailable&&this.isAiTaskEnabled&&i.push(c.AiHelperType.TASK),this.initAiHelpers({externalChatTarget:e,availableHelpers:i,shouldCheckGrammar:t})}},setMainId:function(e){this._active_view&&l().isFunction(this._active_view.setMainId)&&this._active_view.setMainId(e)},setCompose:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._elem("switcher_input").val(),t=arguments.length>1?arguments[1]:void 0;if(this._isType(e,"system")&&(!this._isType(e,"email")||this._checkIfDefaultNeeded("email"))){var i=(t||{}).generalOptions,s=void 0===i?{}:i;return this._elem("switcher_input").val(e),this._onChangeActiveView({},s).then(l().bind((function(){this._active_view&&l().isFunction(this._active_view.handleTriggerOptions)&&this._active_view.handleTriggerOptions(t||{}),this._setEdit(),this._active_view.setParamsOnSwitch(t||{})}),this))}},_prepareLastChatMessage:function(e){var t=l().propertyOf(this.options)(["notes","opened_talks_collection"]),i=l().propertyOf(e)(["dialog","id"]),s=l().find(l().result(t,"toJSON",[]),(function(t){return 1!==parseInt(t.status)&&t.chat_id===e.chat_id})),n=e.author;return e.author&&e.author.id===(0,v.current)("amojo_id")&&(n=e.recipient),{chat_id:e.chat_id,group_id:e.group_id,talk_id:s?i:"",recipient:n}},_isNoteOrTaskActive:function(){return this._active_view&&!(O(this._active_view,this._possible_views.MailComposeView)||O(this._active_view,this._possible_views.AmoJoComposeView)||O(this._active_view,this._possible_views.SmsComposeView)||O(this._active_view,this._possible_views.WidgetComposeView))},_handleFormChange:function(e){(this.hasChanges()||"has_reverted"===e)&&this._form.model.trigger(e)},_getSubscribersService:function(){return this._subscribers_service||(this._subscribers_service=this._addComponent(C.default,this.options.notes.element_type,this.options.notes.element_id)),this._subscribers_service},getTaskSuggestionEnabled:function(){return x((function(){var e;return H(this,(function(t){switch(t.label){case 0:return[4,(0,y.getTaskSuggestionSettings)()];case 1:return e=t.sent().isAiTaskSuggestionEnabled,(0,m.updateFeature)("is_ai_task_suggestion_enabled",e),this.isAiTaskEnabled=e,[2]}}))})).apply(this)},edit:function(){this.$el.removeClass("minimized")},cancel:function(){if(this._$document.trigger("controls:hide"),this._opened)return this._active_view&&l().isFunction(this._active_view.onFoldCompose)&&this._active_view.onFoldCompose(),this._active_view&&l().isFunction(this._active_view.minimizeOrCancel)&&this._active_view.minimizeOrCancel()||(this._findElem("textarea").empty().trigger("input"),this._active_view.getExistingText()||this._setLastType()),this.$el.addClass("minimized"),this._opened=!1,(0,m.isFeatureAvailable)("ai_rewriter_fast_reply")&&this.isAiAnswerShown&&this.isAnswerApplied,this.options.onToggle("close"),null},hasChanges:function(){return!!this._isNoteOrTaskActive()&&this._active_view.hasChanges()},isSaved:function(){return!!this._active_view.model.get("id")},save:function(){if(this._isNoteOrTaskActive())return this._active_view.save()}});var M="../build/transpiled/interface/notes/views/add/view";window.define(M,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([M])}}]);var _global="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};_global.SENTRY_RELEASE={id:"build_2025_11_28_17_08_33"},function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=(new Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="287248e4-aac7-4fb2-82e2-cbb22aad0cd7",e._sentryDebugIdIdentifier="sentry-dbid-287248e4-aac7-4fb2-82e2-cbb22aad0cd7")}catch(e){}}();
//# sourceMappingURL=42378.e2aabf1835e5dbaa2a86.js.map