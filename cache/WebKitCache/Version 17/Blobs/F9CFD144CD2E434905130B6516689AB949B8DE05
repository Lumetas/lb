define(["jquery", "lib/components/base/modal"], function ($, Modal) {
  /**
   * Компонент управления колбэками виджета.
   * Имеет возможность добавления / удаления функций в определенный колбэк.
   * Имеет возможность вызова необходимого колбэка виджета.
   */
  return class CallbackHandler {
    /**
     * Доступ к контексту виджета
     * @private
     */
    #self = null;

    /**
     * Поле для хранения колбэков
     * @private
     */
    #callbacks = new Map();

    /**
     * @constructor
     * @param {Class} self Контекст виджета this
     */
    constructor(self) {
      this.#self = self;
      const { options, utils } = self;

      this.#callbacks.set("render", []);
      this.#callbacks.set("init", []);
      this.#callbacks.set("bind_actions", []);
      this.#callbacks.set("destroy", []);
      this.#callbacks.set("settings", []);
      this.#callbacks.set("onSave", []);
      this.#callbacks.set("dpSettings", []);
      this.#callbacks.set("advancedSettings", []);
      this.#callbacks.set("contacts", []);
      this.#callbacks.set("customers", []);
      this.#callbacks.set("onSalesbotDesignerSave", []);
      this.#callbacks.set("leads", []);
      this.#callbacks.set("todo", []);
      this.#callbacks.set("onAddAsSource", []);
      this.#callbacks.set(
        "loadPreloadedData",
        () => new Promise((_, __) => {}),
      );
      this.#callbacks.set("loadElements", () => new Promise((_, __) => {}));
      this.#callbacks.set("linkCard", () => new Promise((_, __) => {}));
      this.#callbacks.set("searchDataInCard", () => new Promise((_, __) => {}));

      this.add("init", "end", () => options.set("params", self.params));
      this.add("init", "end", () => utils.insertCSS());
      this.add("init", "end", () => utils.addFooterStyles());
      this.add("init", "end", () => utils.getAllSettings(false));

      this.add("settings", "end", () => utils.addHr());
      this.add("settings", "end", () => utils.addSaveButton());
      this.add("settings", "end", () => utils.setActivationInputs());
      this.add("settings", "end", () => utils.addFooter());

      this.add("onSave", "end", () => this.#onSave());
    }

    /**
     * Задает колбэк указанным массивом функций
     * @param {string} name Название колбэка ("render", "init" ...)
     * @param {function[]} callbacks Массив функций, который выполнятся при старте колбэка
     */
    set(name, callbacks) {
      if (!name) {
        throw new Error("Invalid name of callback: " + name);
      }

      if (!Array.isArray(callbacks)) {
        throw new Error("Invalid typeof callbacks!");
      }

      this.#callbacks.set(name, callbacks);
    }

    /**
     * Задает колбэк который возвращает Promise, а не true.
     * @param {string} name Название колбэка ("loadPreloadedData", "loadElements" ...)
     * @param {Promise} callbacks Promise, который возвращается при вызове колбэка
     */
    assing(name, callback) {
      if (!name) {
        throw new Error("Invalid name of callback: " + name);
      }

      if (Array.isArray(this.#callbacks.get(name))) {
        throw new Error("Invalid type of callback: " + name);
      }

      this.#callbacks.set(name, callback);
    }

    /**
     * Добавляет новый колбэк к указанному в name колбэку виджета
     * @param {string} name Название колбэка ("render", "init" ...)
     * @param {string} order Добавить в начало "start" или в конец "end"
     * @param {function} callback Стрелочная функция для выполнения: () => { . . .}
     */
    add(name, order, callback) {
      const { amo } = this.#self;

      if (!name) {
        throw new Error("Invalid name of callback: " + name);
      }

      if (!order) {
        throw new Error(err, "Invalid order: " + order);
      }

      if (!callback || typeof callback !== "function") {
        throw new Error("Invalid callback");
      }

      const callbacks = this.get(name);

      switch (order) {
        case "start":
          callbacks.unshift(callback);
          this.#callbacks.set(name, callbacks);
          return;

        case "end":
          callbacks.push(callback);
          this.#callbacks.set(name, callbacks);
          return;

        default:
          const err = "Unknown order type: " + order;
          amo.errorNote(err);
          throw new Error(err);
      }
    }

    /**
     * Удаляет колбэк из указанного name колбэка виджета с указанным index
     * @param {string} name Название колбэка ("render", "init" ...)
     * @param {number} index Индекс в массиве колбэка
     */
    delete(name, index) {
      if (!name) {
        throw new Error("Invalid name of callback: " + name);
      }

      const callbacks = this.get(name);

      if (callbacks[index]) {
        callbacks.splice(index, 1);
      } else {
        throw new Error("Invalid index: " + index);
      }
    }

    /**
     * Возвращает все колбэки с указанным name.
     * Можно использовать в связке с
     * console.log(this.callback.get(<NAME>).toString()) для наглядности.
     * @param {string} name Название колбэка ("render", "init" ...)
     * @returns {function[]}
     */
    get(name) {
      if (!name) {
        throw new Error("Invalid name of callback:" + name);
      }

      const callbacks = this.#callbacks.get(name);

      if (callbacks !== null) {
        return callbacks;
      } else {
        throw new Error("Invalid name of callback:" + name);
      }
    }

    /**
     * Возвращает все колбэки
     * @returns {Map}
     */
    getAll() {
      return this.#callbacks;
    }

    /**
     * Колбэк render
     */
    render() {
      this.#callbacks.get("render").forEach((callback) => {
        callback();
      });
    }

    /**
     * Колбэк init
     */
    init() {
      this.#callbacks.get("init").forEach((callback) => {
        callback();
      });
    }

    /**
     * Колбэк bind_actions
     */
    bind_actions() {
      this.#callbacks.get("bind_actions").forEach((callback) => {
        callback();
      });
    }

    /**
     * Колбэк destroy
     */
    destroy() {
      this.#callbacks.get("destroy").forEach((callback) => {
        callback();
      });
    }

    /**
     * Колбэк settings
     */
    settings() {
      const self = this.#self;

      const notInstalled = self.get_install_status() === "install";

      if (notInstalled) return;

      const { options, dom } = this.#self;

      const widgetOptions = options.get("widget_options");

      if (widgetOptions) {
        this.#callbacks.get("settings").forEach((callback) => {
          callback();
        });
      } else {
        const settings = dom.get(".widget-settings__desc-space");
        const size = settings.getBoundingClientRect();

        const style = document.documentElement.hasAttribute("data-color-scheme")
          ? "spinner-icon-white"
          : "spinner-icon-black";

        const loader = dom.add("div");
        loader.style.position = "absolute";
        loader.style.display = "flex";
        loader.style.justifyContent = "center";
        loader.style.alignItems = "center";
        loader.style.top = "90px";
        loader.style.width = size.width + "px";
        loader.style.height = size.height + 2 + "px";
        loader.style.background = "var(--palette-background-primary)";
        loader.style.zIndex = "2";
        loader.innerHTML = `
        <span 
          class="modal-overlay__spinner spinner-icon ${style}"
        >
        </span>
      `;

        settings.after(loader);

        const interval = setInterval(() => {
          const widgetOptions = options.get("widget_options");

          if (!widgetOptions) return;

          clearInterval(interval);

          loader.remove();

          this.#callbacks.get("settings").forEach((callback) => {
            callback();
          });
        }, 100);
      }
    }

    /**
     * Колбэк onSave
     */
    onSave() {
      this.#callbacks.get("onSave").forEach((callback) => {
        callback();
      });
    }

    /**
     * Колбэк onSave по умолчанию
     */
    #onSave() {
      const { dom, amo, storage, utils, options } = this.#self;
      const url = "https://core.emfy.com/widgets/actions/add_to_crm.php";
      const data = {
        method: "POST",
        body: JSON.stringify({
          amo_login: amo.widgets.system.amouser,
          amo_user_id: amo.widgets.system.amouser_id,
          amo_domain: amo.widgets.system.subdomain,
          amo_account_id: amo.get("account").id,
          lang_id: amo.lang_id,
          user_name: dom.get(`input[name="user_name"]`).value,
          user_phone: dom.get(`input[name="user_phone"]`).value,
          enabled: utils.afterSaveEnableCheck(),
          code: options.get("module"),
          amo_user_phone: amo.get("user").personal_mobile,
          amo_user_name: amo.get("user").name,
          amo_account_paid_from: amo.get("account").paid_from,
          amo_account_paid_till: amo.get("account").paid_till,
          amo_account_pay_type: amo.get("account").pay_type,
        }),
      };
      storage.fetch(url, data, "text").finally(() => this.init());
    }

    /**
     * Колбэк dpSettings
     */
    dpSettings() {
      this.#callbacks.get("dpSettings").forEach((callback) => {
        callback();
      });
    }

    /**
     * Колбэк advancedSettings
     */
    advancedSettings() {
      this.#callbacks.get("advancedSettings").forEach((callback) => {
        callback();
      });
    }

    /**
     * Колбэк contacts
     */
    contacts() {
      this.#callbacks.get("contacts").forEach((callback) => {
        callback();
      });
    }

    /**
     * Колбэк contacts
     */
    customers() {
      this.#callbacks.get("customers").forEach((callback) => {
        callback();
      });
    }

    /**
     * Колбэк onSalesbotDesignerSave
     */
    onSalesbotDesignerSave() {
      this.#callbacks.get("onSalesbotDesignerSave").forEach((callback) => {
        callback();
      });
    }

    /**
     * Колбэк leads
     */
    leads() {
      this.#callbacks.get("leads").forEach((callback) => {
        callback();
      });
    }

    /**
     * Колбэк todo
     */
    todo() {
      this.#callbacks.get("todo").forEach((callback) => {
        callback();
      });
    }

    /**
     * Колбэк onAddAsSource
     */
    onAddAsSource() {
      this.#callbacks.get("onAddAsSource").forEach((callback) => {
        callback();
      });
    }

    /**
     * Колбэк loadPreloadedData
     * @returns {Promise}
     */
    loadPreloadedData() {
      return this.#callbacks.get("loadPreloadedData")();
    }

    /**
     * Колбэк loadElements
     * @returns {Promise}
     */
    loadElements(type, id) {
      return this.#callbacks.get("loadElements")(type, id);
    }

    /**
     * Колбэк linkCard
     * @returns {Promise}
     */
    linkCard(links) {
      return this.#callbacks.get("linkCard")(links);
    }

    /**
     * Колбэк searchDataInCard
     * @returns {Promise}
     */
    searchDataInCard(query, type, id) {
      return this.#callbacks.get("searchDataInCard")(query, type, id);
    }
  };
});
