"use strict";(window.webpackChunk=window.webpackChunk||[]).push([[63865],{757748:(e,t,i)=>{function o(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}i.r(t),i.d(t,{ALLOWED_CONTEXT_MENU_TYPES:()=>n});var n=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},n=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(i).filter((function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})))),n.forEach((function(t){o(e,t,i[t])}))}return e}({ADD_REPLY:"add_reply",ADD_QUOTATION:"add_quotation"},i(131657).NOT_QUOTATION_CONTEXT_MENU_TYPES)},131657:(e,t,i)=>{i.r(t),i.d(t,{NOT_QUOTATION_CONTEXT_MENU_TYPES:()=>o});var o={ANSWER_TO_COMMENT:"answer_to_comment",ANSWER_TO_DIRECT:"answer_to_direct",GENERATE_RESPONSE:"generate_response"}},493325:(e,t,i)=>{i.r(t),i.d(t,{ALLOWED_CONTEXT_MENU_TYPES:()=>n.ALLOWED_CONTEXT_MENU_TYPES,NOT_QUOTATION_CONTEXT_MENU_TYPES:()=>o.NOT_QUOTATION_CONTEXT_MENU_TYPES});var o=i(131657),n=i(757748),a="../build/transpiled/interface/notes/views/constants";window.define(a,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([a])},439193:(e,t,i)=>{i.r(t),i.d(t,{default:()=>s});var o=i(629133),n=i.n(o),a=i(632925);const s=a.default.extend({_selectors:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return n().extend({},a.default.prototype._selectors.apply(this,t))},events:n().extend({},a.default.prototype.events||{},{}),_getTemplateName:function(){return"note"},_getTemplate:function(){return"/tmpl/notes/types/file.twig"}});var r="../build/transpiled/interface/notes/views/file";window.define(r,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([r])},762091:(e,t,i)=>{i.r(t),i.d(t,{default:()=>k});var o=i(629133),n=i.n(o),a=i(418860),s=i(580326),r=i(632925),l=i(968924),d=i(709849),c=i(675920),u=i(762794),_=i(567898),h=i(885766),p=i(466730),m=i(763358),g=i(649442),f=i(461344),v=i(726379),y=i(441665),b=i(439193),w=i(918873),E=i(776695);function k(e,t){switch(!0){case e.type===APP.note_types.attachment:case e.type===APP.note_types.common:return d.default;case 111===e.type:return b.default}if(t)switch(!0){case"geolocation"===t:return v.default;case"grouped_amojo_ex"===t:return h.default;case"grouped_complex"===t:return _.default;case"joined_creation"===t:case"grouped"===t:return u.default;case e.object_type&&"tasks"===e.object_type.code:return l.default;case e.type===APP.note_types.mail_message:return g.default;default:return c.default}switch(!0){case e.object_type&&"opened_talks"===e.object_type.code:return E.default;case e.object_type&&"event"===e.object_type.code:return e.type===a.default.ENTITY_MERGE?f.default:r.default;case!n().isUndefined(e.chat_id):return n().isEqual((s.AmoJoMediator.get()[e.chat_id]||{}).entity_type,APP.element_types.contacts)?h.default:p.default;case e.type===APP.note_types.mail_message:return g.default;case e.type===APP.note_types.chat:return m.default;case e.object_type&&"tasks"===e.object_type.code:return l.default;case e.type===APP.note_types.geolocation:return v.default;case e.type===APP.note_types.extended_service_message:return y.default;case e.type===APP.note_types.ai_result:return w.default;default:return r.default}}var T="../build/transpiled/interface/notes/views/getview";window.define(T,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([T])},885766:(e,t,i)=>{i.r(t),i.d(t,{default:()=>w});var o=i(661533),n=i.n(o),a=i(629133),s=i.n(a),r=i(460159),l=i.n(r),d=i(156040),c=i(500034),u=i(762794),_=i(567898),h=i(580326),p=i(181605),m=i(570286),g=i(632925),f=i(466730);function v(e,t,i,o,n,a,s){try{var r=e[a](s),l=r.value}catch(e){return void i(e)}r.done?t(l):Promise.resolve(l).then(o,n)}var y=0,b=0;n()(document).on("page:changed",(function(){y=0}));const w=_.default.extend({_rendered_models:[],_rendered_views:[],_head_template:"/tmpl/notes/types/grouped/amojo_ex_head.twig",_selectors:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return s().extend({},_.default.prototype._selectors.apply(this,t)||{},f.default.prototype._selectors.apply(this,t),{show_more:".js-show-more",head:".js-feed-note-head"})},_classes:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return s().extend(f.default.prototype._classes.apply(this,t))},events:s().extend({},_.default.prototype.events||{},{"click .js-show-more":"onClickShowMore","click .feed-note__replied-to-name .js-amojo-reply":"onAmoJoReplyClick","click .js-return-to-thread":"handleReturnToThreadClick"}),initialize:function(e){_.default.prototype.initialize.apply(this,arguments),s().each(e.models,(function(e){this.listenTo(e,"change",this.handleModelChange)}),this),l()._preload([this._head_template])},handleReturnToThreadClick:function(e){var t=n()(e.currentTarget),i=t.data("thread-last-message-id"),o=1e3*t.data("thread-last-message-timestamp");i&&o&&f.default.prototype.scrollToMessage.call(this,i,o)},_getChatUser:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return u.default.prototype._getChatUser.apply(this,t)},_getTemplate:function(){return"/tmpl/notes/types/grouped/amojo_ex.twig"},_getSubView:function(){return f.default},_getOriginType:function(){return"amojo"},_getRenderParams:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var o,n,a=_.default.prototype._getRenderParams.apply(this,t),r=this.model.toJSON(),l=r.chat_id,d=h.AmoJoMediator.get()[l]||{contacts:{},users:{}},u=p.Chat.getExternalContact(d),g=r.recipient&&f.default.prototype._getChatUser.call(this,d,{id:r.recipient.id,origin:r.recipient.origin});return s().extend(a,{replied_to:g&&s().extend(g,{amojo_id:r.recipient.id}),origin:u&&m.ExternalContact.getOrigin(u),origin_icon:u&&m.ExternalContact.getOriginIconUrl(u)},u&&(h.AmoJoMediator.checkWithLeadSourceNameShown(a.chat_id)||(0,c.isFeatureAvailable)("ig_replies_to_comments")&&this.model.collection.isMultipleCategories(l))||this._getCommentsAttributes().isCommentsTalk?{show_source:!0,source_name:m.ExternalContact.getLeadSourceName(u,null===(o=r.dialog)||void 0===o?void 0:o.category)||m.ExternalContact.getOriginName(u,null===(n=r.dialog)||void 0===n?void 0:n.category)}:{show_source:!1},this._getCommentsAttributes()),a},onAmoJoReplyClick:function(e){e.stopPropagation(),this.model.trigger("notes:compose:switch","chat",{user_id:n()(e.currentTarget).attr("data-id"),talk_id:s().propertyOf(this.model.get("dialog"))("id")})},onClickShowMore:function(){var e=this.options.scrollUpdate();this._showMoreMessages({is_update_sticky_needed:!0}),e()},_render:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var o,n,a=this;g.default.prototype._render.apply(this,t),this.el.classList.add("".concat(this.className,"-grouped-complex")),Date.now()-y>2e3&&(b=0),b<10||this.model.collection.isLookingModeActive()?this._showMoreMessages():(o=function(){var e=a.options.scrollUpdate({anchor_el:a.el});a._showMoreMessages({is_update_sticky_needed:!0}),e(),b=0},n=null,"production"===APP.environment&&d.isPageComponentLoading(d.components.card)?(n=setTimeout((function(){o(),n=null}),800),d.onPageComponentLoadEnd((function(){n&&(clearTimeout(n),setTimeout(o))}),d.components.card,!0)):setTimeout(o)),f.default.prototype.resizeFeedButtons.apply(this)},_getHiddenMessages:function(){return s().difference(this.models,this._rendered_models)},_showMoreMessages:function(e){var t,i;e=e||{};var o=this._getHiddenMessages();o.length?(t=e.show_all?o:s().last(o,10),(i=s().last(t))&&0===this._rendered_models.length&&i.set("show_dialog",!0),this._rendered_models=this._rendered_models.concat(t)):(this._subviews=null,t=this._rendered_models),this._renderSubViews(t),e.is_update_sticky_needed&&this.options.debouncedStickyUpdate()},_updateHiddenCounter:function(){var e=this._getHiddenMessages();e.length?this._findElem("show_more").text([APP.lang.button_more,e.length>=10?10:e.length,APP.lang.step_of,e.length].join(" ")):this._elem("show_more").remove()},_renderSubViews:function(e,t){var i,o=document.createDocumentFragment(),n=[];t=t||{},this._subviews||(this._subviews=[]),s().each(e,(function(e){var t=e.get("dialog")||{},a=s().indexOf(this.models,e),r=this.models[a+1],l=r&&r.get("dialog");e.set("grouped",l&&t.id===l.id),r&&s().isEqual(r.get("author"),e.get("author"))&&s().isEqual(r.get("dialog"),t)&&e.set("dont_show_meta",!0),"secondary"===t.category&&(0,c.isFeatureAvailable)("ig_replies_to_comments")&&e.set("is_dialog_category_secondary",!0),b++,y=Date.now(),i=this._addComponent(this._getSubView(),s().extend({},this.options,{models:[e],onDestroy:s().bind(this._checkSubViewDestroy,this)})),n.push(i),i._render(),o.appendChild(i.el),this._subviews.push(i)}),this),t.append?this._rendered_views=this._rendered_views.concat(n):this._rendered_views=n.concat(this._rendered_views);var a=this._rendered_views[this._rendered_views.length-1];a._getAutocloseDelay()&&a.model.get("dialog")&&(a.model.get("dialog").opened&&a.isIncoming()&&a.clearAutocloseAt(),a.model.get("dialog").opened&&!a.isIncoming()&&a.model.get("id")===a.model.collection.last().get("id")&&a.setAutocloseAt(a.model.get("created_at"))),this._findElem("subviews")[t.append?"append":"prepend"](o),this._updateHiddenCounter()},_checkAddedModelsOnRerender:function(){var e,t=s().filter(s().last(this.models,this._rendered_models.length),(function(e){return!s().findWhere(this._rendered_models,{id:e.id})}),this);return!!t&&(e=this.options.scrollUpdate(),s().each(t,(function(e){var t=s().last(this._rendered_views);t.model.get("author").id===e.get("author").id&&t.model&&e&&t.model.get("dialog")&&e.get("dialog")&&s().isEqual(t.model.get("dialog").id,e.get("dialog").id)&&t.model.set("dont_show_meta",!0),t.model&&e&&t.model.get("dialog")&&e.get("dialog")&&s().isEqual(t.model.get("dialog").id,e.get("dialog").id)&&t.model.set("grouped",!0),t.render(),this._rendered_models.push(e),this._renderSubViews([e],{append:!0})}),this),e(),!0)},_reRenderFromEvent:function(e){var t=s().filter(this._rendered_views,(function(t){return s().findWhere(e,{id:t.model.id})}),this),i=this._checkAddedModelsOnRerender();t.length?s().each(t,(function(e){e.render()})):i||this._render()},_getCommentsAttributes:function(){var e,t,i,o,n,a=(null===(e=this.model.get("message_attributes"))||void 0===e?void 0:e.custom)||(null===(t=this.model.get("message_attributes"))||void 0===t?void 0:t.facebook),s=null===(i=this.model.get("author"))||void 0===i?void 0:i.origin,r=null===(o=this.model.get("recipient"))||void 0===o?void 0:o.origin,l=null==a?void 0:a.thread_last_message_id,d=null==a?void 0:a.thread_last_message_at,c="secondary"===(null===(n=this.model.get("dialog"))||void 0===n?void 0:n.category),u=[s,r].includes("instagram_business")&&c&&!(null==a?void 0:a.media);return{thread_last_message_id:l,thread_last_message_at:d,isCommentsTalk:!u&&Boolean(l)&&c,isInstagramCommentsTalk:u}},handleModelChange:function(e){var t,i=this._hasFacebookCommentAttributes(e)||this._hasCustomCommentAttributes(e),o=e.get("show_source")&&(null===(t=e.changed)||void 0===t?void 0:t.show_source);(i||o)&&(o&&this.models.forEach((function(e){e.set("show_source",!0,{silent:!0})})),this._headerUpdate())},_hasFacebookCommentAttributes:function(e){var t,i,o,n,a;return(null===(i=e.get("message_attributes"))||void 0===i||null===(t=i.facebook)||void 0===t?void 0:t.thread_last_message_id)&&(null===(a=e.changed)||void 0===a||null===(n=a.message_attributes)||void 0===n||null===(o=n.facebook)||void 0===o?void 0:o.thread_last_message_id)},_hasCustomCommentAttributes:function(e){var t,i,o,n,a;return(null===(i=e.get("message_attributes"))||void 0===i||null===(t=i.custom)||void 0===t?void 0:t.thread_last_message_id)&&(null===(a=e.changed)||void 0===a||null===(n=a.message_attributes)||void 0===n||null===(o=n.custom)||void 0===o?void 0:o.thread_last_message_id)},_headerUpdate:function(){return(e=function(){return function(e,t){var i,o,n,a,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return a={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function r(a){return function(r){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(n=2&a[0]?o.return:a[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,a[1])).done)return n;switch(o=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((n=(n=s.trys).length>0&&n[n.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){s.label=a[1];break}if(6===a[0]&&s.label<n[1]){s.label=n[1],n=a;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(a);break}n[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],o=0}finally{i=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,r])}}}(this,(function(e){return this._elem("head").html(l()({ref:this._head_template}).render(this._getRenderParams())),[2]}))},function(){var t=this,i=arguments;return new Promise((function(o,n){var a=e.apply(t,i);function s(e){v(a,o,n,s,r,"next",e)}function r(e){v(a,o,n,s,r,"throw",e)}s(void 0)}))}).apply(this);var e},retrieveGroupedViewByModel:function(e){var t=n().Deferred(),i=!1;return(i=s().find(this._subviews,(function(t){return s().propertyOf(t)(["models",0])===e})))||(this._showMoreMessages({show_all:!0}),i=s().find(this._subviews,(function(t){return s().propertyOf(t)(["models",0])===e}))),i&&t.resolve(i.$el),t.promise()}});var E="../build/transpiled/interface/notes/views/grouped/amojo_ex";window.define(E,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([E])},567898:(e,t,i)=>{i.r(t),i.d(t,{default:()=>l});var o=i(629133),n=i.n(o),a=i(632925),s=i(649442),r=i(661533);const l=a.default.extend({_selectors:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return n().extend({},a.default.prototype._selectors.apply(this,t),{subviews:".js-grouped-subviews"})},_getTemplate:function(){return"/tmpl/notes/types/grouped/complex.twig"},_getRenderParams:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return n().extend(a.default.prototype._getRenderParams.apply(this,t),{icon_type:this._getOriginType(),icon_direction:this._checkDirection()})},events:{},_destroyOnRemove:function(){this._$window.off(this.ns),this.remove(!0)},toggleVisible:function(){var e=n().find([this.model].concat(this.models),(function(e){return e.get("visible")}));this.el.style.display=e?"":"none"},_getSubView:function(){return"mail"===this._getOriginType()?s.default:a.default},_getOriginType:function(){switch(!0){case n().contains([102,103],this.model.get("type")):return"sms";case this.model.get("type")===APP.note_types.mail_message:return"mail";case n().indexOf([APP.note_types.call_in,APP.note_types.call_out],this.model.get("type"))>=0:return"call"}},_checkDirection:function(){var e,t,i=this._getOriginType();return n().indexOf(["mail","call","sms"],i)>=0&&(e=this._getNoteDirection(this.model.toJSON()),t=n().find(this.models,(function(t){return this._getNoteDirection(t.toJSON())!==e}),this),n().isUndefined(t))?e:""},_getNoteDirection:function(e){switch(e.type){case 102:return"incoming";case 103:return"outgoing";case APP.note_types.call_in:return"incoming";case APP.note_types.call_out:return"outgoing";case APP.note_types.mail_message:return e.data.params.manager?"outgoing":"incoming"}},_checkSubViewDestroy:function(e){e.model!==this.model&&(this.models=n().filter(this.models,(function(t){return e.model!==t}))),this.models[0]!==this.model||this.model.collection||this._destroyOnRemove()},_render:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];a.default.prototype._render.apply(this,t),this.el.classList.add("".concat(this.className,"-grouped-complex")),this._renderSubViews(this.models)},_renderSubViews:function(e){var t,i=document.createDocumentFragment();this._subviews||(this._subviews=[]),n().each(e,(function(e){(t=this._addComponent(this._getSubView(),n().extend({},this.options,{models:[e],onDestroy:n().bind(this._checkSubViewDestroy,this)})))._render(),i.appendChild(t.el),this._subviews.push(t)}),this),this._findElem("subviews").prepend(i)},retrieveGroupedViewByModel:function(e){var t=r.Deferred(),i=n().find(this._subviews,(function(t){return n().propertyOf(t)(["models",0])===e}));return i&&t.resolve(i.$el),t.promise()}});var d="../build/transpiled/interface/notes/views/grouped/complex";window.define(d,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([d])},762794:(e,t,i)=>{i.r(t),i.d(t,{default:()=>r});var o=i(629133),n=i.n(o),a=i(214558),s=i(632925);const r=s.default.extend({events:{"click .js-grouped-expand":"_groupedExpandClick"},initialize:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this._debouncedRender=n().debounce(n().bind(this._onFilter,this),100),s.default.prototype.initialize.apply(this,t)},_getTemplate:function(){return this.model.get("chat_id")?"/tmpl/notes/types/grouped/amojo.twig":"/tmpl/notes/types/grouped/index.twig"},_getVisibleCount:function(){return this.models.reduce((function(e,t){return t.get("visible")&&e++,e}),0)},_getTemplateName:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return this.model.get("chat_id")?"amojo":s.default.prototype._getTemplateName.apply(this,t)},_getRenderParams:function(){return n().extend(this.model.toJSON(),{count:this._getVisibleCount(),template:this._getTemplateName(),note_types:n().invert(APP.note_types),authors:n().reduce(this.models,(function(e,t){var i;return t.get("author")&&(e[(i=this._getChatUser(t.toJSON(),t.get("author").id)).id]=i),e}),{},this),system_props:{need_msec:(0,a.current)("settings").need_msec||!1},format:"date"})},_getChatUser:function(e,t){var i=(0,a.getByAmoJoId)(),o=this.options.getExtraData(),s={};return{id:(s=1==!n().isUndefined(i[t])?i[t]||{}:n().find(o.elements,(function(t){return parseInt(n().propertyOf(o)(["chats",e.chat_id,"entity_id"]))===parseInt(t.id)}))||{}).id,name:s.name||s.title,avatar:s.avatar}},_groupedExpandClick:function(e){var t=this,i=n().map(this.models,(function(e){return e.toJSON()}),this),o=this.options.scrollUpdate();this.model.trigger("note:view:destroy",this.model),this.options.onAdd(i,{exclude_reducers:["joinable","groupable"]}).then((function(){t.destroy(!0),o()})),e.preventDefault()},_onFilter:function(){0===this._getVisibleCount()?this.el.style.display="none":(this.el.style.display="",this.render())},_render:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];s.default.prototype._render.apply(this,t),this.el.classList.add("".concat(this.className,"_grouped"))},toggleVisible:function(){this._debouncedRender()}});var l="../build/transpiled/interface/notes/views/grouped/index";window.define(l,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([l])},709849:(e,t,i)=>{i.r(t),i.d(t,{default:()=>r});var o=i(629133),n=i.n(o),a=i(704479),s=i(439182);const r=a.default.extend({initialize:function(e){e=this._checkNoteIsPresent(e),arguments[0]=e,a.default.prototype.initialize.apply(this,arguments)},_checkNoteIsPresent:function(e){var t,i=null;return e.models=n().sortBy(e.models,(function(e){return e.get("type")!==APP.note_types.common})),n().each(e.models,(function(e){n().contains([APP.note_types.common,APP.note_types.geolocation],e.get("type"))&&(i=e)})),i||(t=new s.default(n().extend({data:{params:[],text:""},type:APP.note_types.common},n().omit(e.models[0].toJSON(),"id","data","type","note_type","editable"))),e.models=[t.set("editable",t.get("deletable"))].concat(e.models)),e.model=e.models[0],e},_hasFakeModel:function(){return!this.model.id},hasChanges:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return this._hasFakeModel()&&this._editing?n().chain(n().extend({},this._changes,{form:!0})).values().compact().value().length:a.default.prototype.hasChanges.apply(this,t)},_validateFiles:function(){return this.file_uploader._files_queue.length+n().filter(this.models,(function(e){return APP.note_types.attachment===e.get("type")})).length-this._files_remove.length>0},validate:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return!(!this._hasFakeModel()||!this._validateFiles())||a.default.prototype.validate.apply(this,t)},_removeFileClick:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var o=a.default.prototype._removeFileClick.apply(this,t);return this._setChanges({files:!0}),o},cancel:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var o=a.default.prototype.cancel.apply(this,t),s=n().find(this.models,(function(e){return e.collection}));return s&&s.trigger("notes:update-sticky"),o},_render:function(e){var t=a.default.prototype._render.apply(this,arguments),i=!1,o=null;return n().each(this.models,(function(e){e.get("pinned")&&(i=!0),e.collection&&(o=e)})),i&&o&&"edit"===e&&o.trigger("notes:update-sticky"),t},save:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var o=this._hasFakeModel(),s=n().find(this.models,(function(e){return e.id&&e.get("pinned")}));return this._editing&&!this._hasFakeModel()&&!this._form.model.get("text")&&this._validateFiles()?(this._findElem("submit").trigger("button:load:start",["white"]),this.file_uploader.uploadFiles().then(n().bind((function(){return this._destroyFileAndUpdateModels()}),this)).then(n().bind((function(){return this.model.clone().destroy()}),this)).then(n().bind((function(){this.model.set({id:null,data:{text:"",params:[]},pinned:!!s});var e=n().find(this.models,(function(e){return e.id&&!e.get("pinned")}));e&&s&&e!==s&&e.set("pinned",!0).pin(),this.cancel()}),this))):a.default.prototype.save.apply(this,t).then(n().bind((function(){o&&s&&(s.set("pinned",!1).pin(),this.model.set("pinned",!0).pin()),this.options.addToCollection([this.model])}),this))},toggleVisible:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var o=n().findWhere(this.models,{type:APP.note_types.attachment});return this._hasFakeModel()&&o&&(this.el.style.display=o.get("visible")?"":"none"),a.default.prototype.toggleVisible.apply(this,t)}});var l="../build/transpiled/interface/notes/views/joined/attach_note";window.define(l,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([l])},15556:(e,t,i)=>{i.r(t),i.d(t,{GenerateResponseButton:()=>g});var o=i(629133),n=i.n(o),a=i(267651),s=i.n(a),r=i(445368),l=i(23456),d=i(214558),c=i(500034),u=i(493325),_=i(353256),h=i(309034),p=i(759612);function m(e,t,i,o,n,a,s){try{var r=e[a](s),l=r.value}catch(e){return void i(e)}r.done?t(l):Promise.resolve(l).then(o,n)}var g={handleGenerateResponseClick:function(){return(e=function(){var e;return function(e,t){var i,o,n,a,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return a={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function r(a){return function(r){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(n=2&a[0]?o.return:a[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,a[1])).done)return n;switch(o=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((n=(n=s.trys).length>0&&n[n.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){s.label=a[1];break}if(6===a[0]&&s.label<n[1]){s.label=n[1],n=a;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(a);break}n[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],o=0}finally{i=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,r])}}}(this,(function(t){switch(t.label){case 0:return[4,(0,h.getCachedSettings)()];case 1:return!0===(null==(e=t.sent())?void 0:e.isCopilotEnabled)?this.openAiCopilotWithGenerateResponse():this.triggerGenerateResponse(),[2]}}))},function(){var t=this,i=arguments;return new Promise((function(o,n){var a=e.apply(t,i);function s(e){m(a,o,n,s,r,"next",e)}function r(e){m(a,o,n,s,r,"throw",e)}s(void 0)}))}).apply(this);var e},openAiCopilotWithGenerateResponse:function(){(0,h.openCopilotWithMessage)((0,r.sprintf)((0,r.i18n)("Generate a response to this message: '%s'"),this.model.get("text"))),(0,p.sendSimpleMetric)(p.MetricActions.COPILOT_USED_WITH_GENERATE_RESPONSE_BUTTON),(0,l.kommoLogAmplitude)("AICopilotUsageFromCrm",{type:"generate_response_button"})},triggerGenerateResponse:function(){var e,t,i=this.model.get("can_be_replied")&&this.isAvailableForChatting(),o=n().propertyOf(this.model.get("author"))("id")===(0,d.current)("amojo_id");if(i&&!(0,c.isFeatureAvailable)("ai_limited")){var a=this.isInstagramComment(),r=this.isCustomPostComment();if(a||r){var l;this._$document.trigger("notes:compose:answer-to",["answer_to_comment",this.model,null===(l=this.model.get("dialog"))||void 0===l?void 0:l.id])}else{var h=this.getQuotationRenderParams("compose",this.model.attributes);this._$document.trigger("notes:compose:add-quot",[o?u.ALLOWED_CONTEXT_MENU_TYPES.ADD_QUOTATION:u.ALLOWED_CONTEXT_MENU_TYPES.ADD_REPLY,this.model,h])}}s().publish(_.AI_ANSWER_GENERATE_RESPONSE,{talkId:null===(e=this.model.get("dialog"))||void 0===e?void 0:e.id,userId:null===(t=this.model.get("author"))||void 0===t?void 0:t.id,text:this.model.get("text"),isReplyAvailable:i})}},f="../build/transpiled/interface/notes/views/mixins/generateResponseButton";window.define(f,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([f])},683451:(e,t,i)=>{i.r(t),i.d(t,{SummarizeButton:()=>d});var o=i(445368),n=i(23456),a=i(439182),s=i(309034),r=i(759612);function l(e,t,i,o,n,a,s){try{var r=e[a](s),l=r.value}catch(e){return void i(e)}r.done?t(l):Promise.resolve(l).then(o,n)}var d={events:{"click .js-ai-summarize":"handleSummarizeClick"},handleSummarizeClick:function(){return(e=function(){var e;return function(e,t){var i,o,n,a,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return a={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function r(a){return function(r){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(n=2&a[0]?o.return:a[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,a[1])).done)return n;switch(o=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((n=(n=s.trys).length>0&&n[n.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){s.label=a[1];break}if(6===a[0]&&s.label<n[1]){s.label=n[1],n=a;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(a);break}n[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],o=0}finally{i=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,r])}}}(this,(function(t){switch(t.label){case 0:return[4,(0,s.getCachedSettings)()];case 1:return!0===(null==(e=t.sent())?void 0:e.isCopilotEnabled)?this.openAiCopilotWithSummarize():this.summarize(),[2]}}))},function(){var t=this,i=arguments;return new Promise((function(o,n){var a=e.apply(t,i);function s(e){l(a,o,n,s,r,"next",e)}function r(e){l(a,o,n,s,r,"throw",e)}s(void 0)}))}).apply(this);var e},openAiCopilotWithSummarize:function(){(0,s.openCopilotWithMessage)((0,o.i18n)("Lead summary")),(0,r.sendSimpleMetric)(r.MetricActions.COPILOT_USED_WITH_SUMMARIZE_BUTTON),(0,n.kommoLogAmplitude)("AICopilotUsageFromCrm",{type:"summarize_button"})},summarize:function(){var e=this.model.get("dialog").id,t=new a.default({is_new:!0,element_id:this.options.element_id,element_type:this.options.element_type,editable:!1,visible:!0,deletable:!0});t.set({type:APP.note_types.ai_result,object_type:{code:"ai_result",id:APP.note_types.ai_result},data:{params:{talk_id:e}},author_name:(0,o.i18n)("{{brand_name.ai}}")}),this.options.onAdd(t.toJSON())}},c="../build/transpiled/interface/notes/views/mixins/summarizeButton";window.define(c,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([c])},13708:(e,t,i)=>{i.r(t),i.d(t,{default:()=>E});var o=i(661533),n=i.n(o),a=i(629133),s=i.n(a),r=i(161320),l=i.n(r),d=i(445368),c=i(889118),u=i(474564),_=i(304483);function h(e,t,i,o,n,a,s){try{var r=e[a](s),l=r.value}catch(e){return void i(e)}r.done?t(l):Promise.resolve(l).then(o,n)}function p(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function m(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},o=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(i).filter((function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})))),o.forEach((function(t){p(e,t,i[t])}))}return e}var g=null,f=null,v=null,y=function(e){return 1===String(e).length?"0".concat(e):String(e)},b=function(e){var t=Math.trunc(e/3600);return s().compact([t&&Math.floor(l().duration(e,"seconds").asHours())]).concat([y(l().duration(e,"seconds").minutes()),y(l().duration(e,"seconds").seconds())]).join(":")},w=!1;const E={events:{"click .amojo-voice__transcription-button":"_transcriptMessage","mousedown .amojo-voice__transcription-button":"_transcriptMessagePreventSelection","click .amojo-voice__play-button[data-mode=download]":"_onDownloadClick","click .amojo-voice__play-button[data-mode=play]":"_playClick","click .amojo-voice__play-button[data-mode=pause]":"_pauseClick","mousedown .amojo-voice__line_clickable":"_timelineBegin"},destroy:function(){this._destroyed=!0,this._isPlayerExist()&&(this._isLoadedInPlayer()||this._isLastLoadedInPlayer())&&(g.jPlayer("stop"),g.jPlayer("destroy"),g=null,f=null),n()(document).off("mouseup",this._timelineEndBound),n()(document).off("mousemove",this._timelineMoveBound)},_updateLastState:function(){this._isPlayerExist()&&g.data("jPlayer")&&(f=g.data("jPlayer").status)},_initVoiceState:function(){var e=this.model.get("message").attachment.duration;this._voice_player_state={show_transcription:this._isTranscripted()&&this._isTranscriptionHasText(),transcription_btn_enabled:this._isTranscripted(),transcription_failed_msg:"",transcription_retryable_msg:"",left_offset:0,current_time:b(0),duration_time:this._getVoiceTimePlaceholder(e),active_button_type:"play",once_played:!1,voice_loading:{before_timeout:!1,timeout:!1}},this._timelineEndBound=s().bind(this._timelineEnd,this),this._timelineMoveBound=s().bind(this._timelineMove,this)},_getVoiceTimePlaceholder:function(e){return s().isUndefined(e)?"--:--":b(Math.round(e))},_sliderOptions:function(e){var t=!!this._voice_slider_options&&this._voice_slider_options.forcibly_paused;e&&"init"!==e||this._dropElemCache();var i=this._elem("voice_line")[0].getBoundingClientRect(),o=this._elem("voice_slider")[0],n=this._elem("voice_progress")[0];this._voice_slider_options={max_width:Math.round(this._elem("voice_line")[0].offsetWidth),slider:o,slider_width:Math.round(o.offsetWidth),progress:n,progress_width:Math.round(n.offsetWidth),start:Math.round(i.x),end:Math.round(i.x+i.width),forcibly_paused:t}},_tryResumeAfterUpdate:function(){var e=this._isLastPlayedMedia(this.model.id);this._isLoadedInPlayer(e)&&!g.data("jPlayer").status.paused?(g.bind(n().jPlayer.event.pause,s().bind((function(){g.jPlayer("play"),g.unbind(n().jPlayer.event.pause)}),this)),this._setButton("pause")):(0,c.isOggSupported)()?this._setButton("play"):this._setButton("download")},_getVoiceData:function(){var e=this.model.get("message"),t=e.media;if(!t||!this.isVoiceMessage())return!1;var i=e.format?e.format:t.split(".").pop();return{url:t,format:i}},_updateVoiceState:function(){this._voice_player_state&&(this._voice_player_state.show_transcription=this._isTranscripted()&&this._isTranscriptionHasText(),this._voice_player_state.transcription_btn_enabled=this._isTranscripted(),1===Number(this.model.get("message").transcription.status)&&(this._voice_player_state.transcription_failed_msg=(0,d.i18n)("Failed to extract text from audio file")),3===Number(this.model.get("message").transcription.status)&&(this._voice_player_state.transcription_retryable_msg=(0,d.i18n)("Unable to generate transcription. Please try again.")),this._voice_player_state.voice_loading.timeout&&clearTimeout(this._voice_player_state.voice_loading.timeout),this._voice_player_state.voice_loading={before_timeout:!1,timeout:!1})},_isTranscripted:function(){return this.model.get("message").transcription&&2===Number(this.model.get("message").transcription.status)},_isLoadedOnce:function(){return this._voice_player_state.once_played},_isInsideTimeline:function(e){return this._getRelativePosition(e)>=0&&e<this._voice_slider_options.end},_isPlayerExist:function(){return g&&g.jPlayer},_isLastPlayedMedia:function(e){return v===e},_isLoadedInPlayer:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return!(this._isPlayerExist()&&!g.data("jPlayer"))&&g&&g.data("jPlayer").status.src===this.model.get("message").media&&e},_isLastLoadedInPlayer:function(){return!!f&&f.src===this.model.get("message").media},_isTranscriptionHasText:function(){return""!==this.model.get("message").transcription.text},_showLoadingTranscription:function(){this._findElem("voice_transcription_button").addClass(this._class("voice_transcription_btn_loading"))},_hideLoadingTranscription:function(){this._findElem("voice_transcription_button").removeClass(this._class("voice_transcription_btn_loading"))},_toggleTranscription:function(){return this._isTranscripted()?(this._findElem("voice_transcription_button").toggleClass(this._class("voice_transcription_btn_enabled")).toggleClass(this._class("voice_transcription_btn_disabled")),this._isTranscriptionHasText()&&(this._voice_player_state.show_transcription=!this._voice_player_state.show_transcription,this._findElem("voice_transcribeMessage").toggleClass("hidden")),!0):this._isTranscripted()},_transcribeError:function(){var e=this._findElem("voice_transcription_button");this._hideLoadingTranscription(),this._updateVoiceState(),e.addClass(this._class("voice_transcription_btn_error")),setTimeout(s().bind((function(){e.removeClass(this._class("voice_transcription_btn_error"))}),this),400)},_setButton:function(e){e||(e="play"),this._voice_player_state.active_button_type=e,this._findElem("voice_action_button").attr("data-mode",e)},_updateTime:function(e,t){!isNaN(Number(e))&&e>=0&&(this._voice_player_state.current_time=b(Math.floor(Number(e))),this._findElem("voice_current_time").removeClass("hidden").html(this._voice_player_state.current_time)),t&&!isNaN(Number(t))&&t>0&&(this._voice_player_state.duration_time=b(Math.floor(Number(t))),this._findElem("voice_duration_time").removeClass("hidden").html(this._voice_player_state.duration_time))},_moveToEnd:function(){this._sliderOptions("update"),this._moveTo(this._voice_slider_options.max_width-this._voice_slider_options.slider_width/2)},_moveTo:function(e){this._voice_player_state.left_offset=e,this._voice_slider_options.slider.style.left="".concat(e,"px"),this._voice_slider_options.progress.style.width="".concat(e,"px")},_reload:function(){this._moveTo(0),this._setButton("play"),this._updateTime(0)},_getRelativePosition:function(e){return e-this._voice_slider_options.start-this._voice_slider_options.slider_width/2},_getTimeByOffset:function(e){var t=0;return this._isPlayerExist()&&(t=e*g.data("jPlayer").status.duration/this._voice_slider_options.max_width),t},_moveToAbsoluteX:function(e){var t;this._isInsideTimeline(e)&&(t=this._getRelativePosition(e),this._moveTo(t),this._updateTime(this._getTimeByOffset(t)))},_firstTimeoutCallback:function(e){this._voice_player_state.voice_loading.timeout=setTimeout(s().bind((function(){this._transcribe(s().bind(this._lastTimeoutCallback,this))}),this),1e3*e.timeout_sec)},_lastTimeoutCallback:function(e){this._voice_player_state.voice_loading.timeout=setTimeout(s().bind((function(){this._transcribeError()}),this),1e3*e.timeout_sec)},_transcribe:function(e){(0,u.transcribeMessage)(this.model.get("id")).subscribe(e,s().bind((function(){this._transcribeError()}),this))},_isOggFormat:function(e){return"ogg"===e||"opus"===e},_onDownloadClick:function(){return(e=function(){var e,t,i;return function(e,t){var i,o,n,a,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return a={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function r(a){return function(r){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(n=2&a[0]?o.return:a[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,a[1])).done)return n;switch(o=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((n=(n=s.trys).length>0&&n[n.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){s.label=a[1];break}if(6===a[0]&&s.label<n[1]){s.label=n[1],n=a;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(a);break}n[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],o=0}finally{i=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,r])}}}(this,(function(o){switch(o.label){case 0:if(!(e=this._getVoiceData()))return[2];if(!this._isOggFormat(e.format))return[3,5];this._setButton("load"),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,(0,c.convertOggToWavBlob)(e.url)];case 2:return t=o.sent(),i=URL.createObjectURL(t),this.model.set({message:(n=m({},this.model.get("message")),a={media:i,format:"wav"},a=null!=a?a:{},Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(a)):function(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);i.push.apply(i,o)}return i}(Object(a)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(a,e))})),n)}),this._setButton("play"),[3,4];case 3:return o.sent(),this._destroyed?[2]:(this._setButton("download"),w?[2]:(w=!0,new _.default({destroy:function(){w=!1}}).showError((0,d.i18n)("The voice message could not be played, please try it in another browser."),!1),[3,4]));case 4:return[2];case 5:return this._setButton("play"),[2]}var n,a}))},function(){var t=this,i=arguments;return new Promise((function(o,n){var a=e.apply(t,i);function s(e){h(a,o,n,s,r,"next",e)}function r(e){h(a,o,n,s,r,"throw",e)}s(void 0)}))}).apply(this);var e},_playClick:function(){var e=this._getVoiceData();if(e){var t=e.url,i=e.format;this._setButton("pause");var o=this._isOggFormat(i)?"oga":i;"mp4"===i&&(o="m4a"),this._initializePlayer(p({},o,t)),this._updateLastState()}},_initializePlayer:function(e){var t=this;if(n().jPlayer.prototype.format.wav.codec="audio/wav",!this._isPlayerExist())return g=t._findElem("voice_player_container").jPlayer({solution:"html",supplied:"mp3,wav,oga,m4a",ready:function(){n()(this).jPlayer("setMedia",e).jPlayer("play"),v=t.model.id,t._updateLastState()}}),void this._rebindPlayer();var i=this._isLastPlayedMedia(this.model.id);this._isLoadedInPlayer(i)?(t._setButton("pause"),g.jPlayer("play")):(this._rebindPlayer(),g.jPlayer("setMedia",e).jPlayer("play"),v=this.model.id),this._updateLastState()},_pauseClick:function(){g.jPlayer("pause"),this._setButton("play")},_transcriptMessagePreventSelection:function(e){e.preventDefault(),e.stopPropagation()},_transcriptMessage:function(e){e.preventDefault(),e.stopPropagation(),this._toggleTranscription()||this._voice_player_state.voice_loading.before_timeout||(this._voice_player_state.voice_loading.before_timeout=!0,this._showLoadingTranscription(),this._transcribe(s().bind(this._firstTimeoutCallback,this)))},_autoMoveSlider:function(e,t){if(!isNaN(Number(e))&&!this._voice_slider_options.forcibly_paused){e*=1e3,t*=1e3,this._sliderOptions("update");var i=this._voice_slider_options.max_width,o=this._voice_slider_options.slider_width/2,n=Math.floor(t/250),a=i/n,s=Math.round(e/250);s>n&&(s=n),s*a>0&&this._moveTo(s*a-o)}},_rebindPlayer:function(){g.unbind(n().jPlayer.event.timeupdate),g.unbind(n().jPlayer.event.ended),g.bind(n().jPlayer.event.timeupdate,s().bind((function(e){var t=e.jPlayer.status.duration,i=e.jPlayer.status.currentTime;!isNaN(i)&&i>0&&this._updateTime(i,t),this._autoMoveSlider(i,t)}),this)),g.bind(n().jPlayer.event.ended,s().bind((function(){this._moveToEnd(),setTimeout(s().bind(this._reload,this),200)}),this)),this._isLoadedOnce()||(this._voice_player_state.once_played=!0,g.bind(n().jPlayer.event.setmedia,s().bind((function(){var e=!v||!this._isLastPlayedMedia(this.model.id);this._isLoadedInPlayer(e)||this._reload()}),this)))},_timelineBegin:function(e){var t=this._isLastPlayedMedia(this.model.id);this._isLoadedInPlayer(t)&&(e.preventDefault(),e.stopPropagation(),this._isPlayerExist()&&!g.data("jPlayer").status.paused&&(g.jPlayer("pause"),this._voice_slider_options.forcibly_paused=!0),this._sliderOptions("update"),this._moveToAbsoluteX(e.pageX),n()(document).on("mouseup",this._timelineEndBound),n()(document).on("mousemove",this._timelineMoveBound))},_timelineEnd:function(e){var t,i,o=this._getRelativePosition(e.pageX);n()(document).off("mouseup",this._timelineEndBound),n()(document).off("mousemove",this._timelineMoveBound),this._isPlayerExist()&&(i=g.data("jPlayer").status.duration,t=this._getTimeByOffset(o),g.jPlayer("playHead",t/i*100),this._autoMoveSlider(t,i),this._updateTime(t,i),this._voice_slider_options.forcibly_paused&&(g.jPlayer("play"),this._voice_slider_options.forcibly_paused=!1)),this._sliderOptions("update")},_timelineMove:function(e){e.preventDefault(),e.stopPropagation(),this._moveToAbsoluteX(e.pageX)}};var k="../build/transpiled/interface/notes/views/mixins/voice_message";window.define(k,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([k])},918873:(e,t,i)=>{i.r(t),i.d(t,{default:()=>w});var o=i(827378),n=i.n(o),a=i(937634),s=i(460159),r=i.n(s),l=i(629133),d=i.n(l),c=i(960190),u=i(445368),_=i(500034),h=i(632925),p=i(304483);function m(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,o=new Array(t);i<t;i++)o[i]=e[i];return o}function g(e,t,i,o,n,a,s){try{var r=e[a](s),l=r.value}catch(e){return void i(e)}r.done?t(l):Promise.resolve(l).then(o,n)}function f(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function v(e){return v=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},v(e)}function y(e,t){return y=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},y(e,t)}function b(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,o=v(e);if(t){var n=v(this).constructor;i=Reflect.construct(o,arguments,n)}else i=o.apply(this,arguments);return function(e,t){return!t||"object"!=((i=t)&&"undefined"!=typeof Symbol&&i.constructor===Symbol?"symbol":typeof i)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var i}(this,i)}}const w=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&y(e,t)}(l,e);var t,o,s=b(l);function l(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l),s.apply(this,arguments)}return t=l,o=[{key:"events",value:function(){return d().extend({},h.default.prototype.events||{},{"click .js-note-pinner":"handleTogglePinClick"})}},{key:"initialize",value:function(){h.default.prototype.initialize.apply(this,arguments);var e=this.model.get("data").params.talk_id,t=this.options,i=t.removeFromCollection,o=t.scrollUpdate;this.talk_id=e,this.unmountAiErrorModal=d().noop(),this.removeFromCollection=i,this.scrollUpdate=o,this.model.get("id")||(this.createNote(),this.options.scrollToEnd())}},{key:"handleTogglePinClick",value:function(e){var t=this.model,i=t.get("pinned");e.stopPropagation(),t.set("pinned",!i).pin(),this._render(),t.trigger("note:view:update",t),this.scrollUpdate()}},{key:"showErrorModal",value:function(e){var t,i=this,o=new p.default({tryAgain:function(){t=!0,o.destroy(),i.createNote()},destroy:function(){return t||(i.destroy(!0),i.removeFromCollection(i.model),t=!1),!0}});o.showError(e||(0,u.i18n)("Something went wrong"))}},{key:"handleAiErrorModalCloseRequest",value:function(){this.unmountAiErrorModal(),this.removeFromCollection(this.model),this.destroy(!0)}},{key:"mountAiErrorModal",value:function(e){var t,o=this;return Promise.all([i.e(41562).then(i.bind(i,341562)),r()._preload(["langs/ai_usage_feedback"])()]).then((function(i){var s,r,l=(s=i,r=1,function(e){if(Array.isArray(e))return e}(s)||function(e,t){var i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var o,n,a=[],s=!0,r=!1;try{for(i=i.call(e);!(s=(o=i.next()).done)&&(a.push(o.value),!t||a.length!==t);s=!0);}catch(e){r=!0,n=e}finally{try{s||null==i.return||i.return()}finally{if(r)throw n}}return a}}(s,r)||function(e,t){if(e){if("string"==typeof e)return m(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(i):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?m(e,t):void 0}}(s,r)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}())[0].default,d=document.createElement("div");o._$body.append(d);var c=n().createElement(l,{onModalCloseRequest:function(){return o.handleAiErrorModalCloseRequest()},error:e});(t=a.createRoot(d)).render(c)})),function(){t&&t.unmount()}}},{key:"createNote",value:function(){var e,t=this;return(e=function(){var e,i,o,n,a;return function(e,t){var i,o,n,a,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return a={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function r(a){return function(r){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(n=2&a[0]?o.return:a[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,a[1])).done)return n;switch(o=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((n=(n=s.trys).length>0&&n[n.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){s.label=a[1];break}if(6===a[0]&&s.label<n[1]){s.label=n[1],n=a;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(a);break}n[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],o=0}finally{i=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,r])}}}(this,(function(s){switch(s.label){case 0:e=t.talk_id,i=t.model.get("element_type"),o=t.model.get("element_id"),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,(0,c.summarize)({talkId:e,elementType:i,elementId:o})];case 2:return s.sent(),[3,4];case 3:return(n=s.sent()).code===c.RewriterErrorCodes.PAYMENT_REQUIRED?(t.unmountAiErrorModal=t.mountAiErrorModal(n),(0,_.updateFeature)("ai_limited",!0)):(t.showErrorModal(null==n||null===(a=n.responseJSON)||void 0===a?void 0:a.detail),(0,_.updateFeature)("ai_limited",!1)),[3,4];case 4:return[2]}}))},function(){var t=this,i=arguments;return new Promise((function(o,n){var a=e.apply(t,i);function s(e){g(a,o,n,s,r,"next",e)}function r(e){g(a,o,n,s,r,"throw",e)}s(void 0)}))})()}},{key:"_getTemplate",value:function(){return this.model.get("id")?"/tmpl/notes/types/ai_result.twig":"/tmpl/notes/types/ai_result_loader.twig"}},{key:"_getRenderParams",value:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var o=this.model.get("data").params,n=o.talk_id,a=o.is_error,s=o.text;return this.model.get("id")?d().extend(h.default.prototype._getRenderParams.apply(this,t),{talk_id:n,is_error:a,author_name:(0,u.i18n)("{{brand_name.ai}}"),data:{text:s}}):d().extend(h.default.prototype._getRenderParams.apply(this,t),{is_loader:!0,talk_id:n})}}],o&&f(t.prototype,o),l}(h.default);var E="../build/transpiled/interface/notes/views/types/ai_result";window.define(E,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([E])},466730:(e,t,i)=>{i.r(t),i.d(t,{default:()=>G});var o=i(661533),n=i.n(o),a=i(629133),s=i.n(a),r=i(345839),l=i.n(r),d=i(162262),c=i.n(d),u=i(460159),_=i.n(u),h=i(161320),p=i.n(h),m=i(267651),g=i.n(m),f=i(672034),v=i(323344),y=i(445368),b=i(955026),w=i(982862),E=i(998798),k=i(214558),T=i(500034),A=i(761634),P=i(632925),C=i(580326),x=i(247227),O=i(474564),S=i(13708),N=i(683451),j=i(15556),M=i(570286),D=i(181605),I=i(493325),R=i(353256),L=i(564547),U=i(383371),B=i(309034);function F(e,t,i,o,n,a,s){try{var r=e[a](s),l=r.value}catch(e){return void i(e)}r.done?t(l):Promise.resolve(l).then(o,n)}function W(e){return function(){var t=this,i=arguments;return new Promise((function(o,n){var a=e.apply(t,i);function s(e){F(a,o,n,s,r,"next",e)}function r(e){F(a,o,n,s,r,"throw",e)}s(void 0)}))}}function V(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function J(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},o=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(i).filter((function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})))),o.forEach((function(t){V(e,t,i[t])}))}return e}function K(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);i.push.apply(i,o)}return i}(Object(t)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(t,i))})),e}function q(e,t){var i,o,n,a,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return a={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function r(a){return function(r){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(n=2&a[0]?o.return:a[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,a[1])).done)return n;switch(o=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((n=(n=s.trys).length>0&&n[n.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){s.label=a[1];break}if(6===a[0]&&s.label<n[1]){s.label=n[1],n=a;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(a);break}n[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],o=0}finally{i=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,r])}}}i(53081),i(883546);var z={OPENED:0,CLOSED:1,NPS_BOT_WORKING:3,NPS_BOT_WORKED:4},$=["aiSummarize","outgoing_autoclose_wrapper","outgoing_title"];const G=P.default.extend({_uneditable_selector:"",events:s().extend(P.default.prototype.events,{"click .js-talk":"showTalkContext","click .js-talk-close":"closeTalk","click .js-talk-read":"readTalk","click .js-ai-emotion":"handleEmotionClick","click .js-talk-reply":"_onTalkReplyClick","click .feed-note__ai_answer_plug":"openIntentSelector","controls:select:open .js-ai_answer":"_onIntentOpenedBlockScroll","controls:select:hide .js-ai_answer":"_onIntentClosedUnblockScroll","mouseenter .feed-note":"_onMouseOverCheckAISelect","mouseleave .feed-note":"_onMouseLeaveDestroyAISelect",'change [name="ai_answer"]':"_onAIAnswerChange","click .button_ai":"sendSalesbotButton","click .js-toggle-autoclose":"toggleAutoclose","change .feed-note__talk-outgoing-autoclose-switcher":"switchAutoClose","load img":"onImageLoad","click .quotation__container":"handleQuotationClick","click .js-reply-to-comment":"handleCommentReplyClick","click .bubble-link":"handleBubbleLinkClick","click .feed-note__reaction":"onContextMenuToggleReaction"}),document_events:s().extend(s().result(P.default,"document_events",{}),{"controls:hide:private":"_onDialogHide","card-messages:rerender-highlights":"setHighlightsFromURL"}),_classes:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return s().extend(P.default.prototype._classes.apply(this,t),{talk_context_visible:"feed-note__talk--context-opened",talk_opened:"feed-note__talk--opened",ai_answer:"feed-note__ai-answer",message_ai_answer:"feed-note__ai_answer",plug_select:"feed-note__ai_answer_plug",talk:"js-talk",outgoing_title:"feed-note__talk-outgoing-title",outgoing_icon:"feed-note__talk-outgoing-icon",outgoing_autoclose_wrapper:"feed-note__talk-outgoing-autoclose-wrapper",icon_push:"feed-note__talk-outgoing-icon_push",active_autoclose:"active",timer_autoclose:"feed-note__talk-outgoing-autoclose_timer",talk_with_read:"feed-note__talk-outgoing-wrapper_with-read",voice_transcription_btn_enabled:"amojo-voice__transcription-button_enabled",voice_transcription_btn_disabled:"amojo-voice__transcription-button_disabled",voice_transcription_btn_loading:"amojo-voice__transcription-button_loading",voice_transcription_btn_error:"animated shake",summarize_btn_error:"animated shake",rich_link_img:"feed-note__rich-link_img",talk_reply_to_comment:"js-reply-to-comment",feedNoteButtons:"feed-note__buttons"})},_selectors:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return s().extend(P.default.prototype._selectors.apply(this,t),{info_bubble_text:".info-bubble__text",last_paragraph:".feed-note__message_paragraph:last",ai_answer_wrapper:".feed-note__ai-answer-wrapper",aiSummarize:".js-ai-summarize",aiEmotion:".js-ai-emotion",talk_wrapper:".feed-note__talk-outgoing-wrapper",talk_read_wrapper:".feed-note__talk-outgoing-wrapper_with-read",talk_read:".feed-note__talk-outgoing-read",voice_transcribeMessage:".amojo-voice__transcription",voice_transcription_button:".amojo-voice__transcription-button",voice_action_button:".amojo-voice__play-button",voice_player_container:".amojo-voice__jplayer",voice_line:".amojo-voice__line_clickable",voice_progress:".amojo-voice__progress",voice_slider:".amojo-voice__slider",voice_current_time:".amojo-voice__time_current",voice_duration_time:".amojo-voice__time_full",pause_button:".amojo-voice__play-button[data-mode=pause]",play_button:".amojo-voice__play-button[data-mode=play]",reactions_bubble_wrapper:".control-emoji-reactions-buble-wrapper"})},initialize:function(){for(var e=this,t=arguments.length,i=new Array(t),o=0;o<t;o++)i[o]=arguments[o];P.default.prototype.initialize.apply(this,i),this.notesWidth=null,this.opened_talks_collection=this.model.collection.opened_talks_collection||new(l().Collection),this.listenTo(this.model,"change:delivery_status",this._render),this.listenTo(this.model,"render",this._render),this.listenTo(this.model.collection,"render",this._render),this.listenTo(this.model,"change:rich_link",this._onRichLinkChanged),this.listenTo(this.model.collection,"dialog:closed",this._onDialogClosed),this.listenTo(this.model,"change",this._onDialogChanged),this.listenTo(this.model.collection,"bot:fetched",this._onIntentCollectionLoad),this.listenTo(this.opened_talks_collection,"remove change",this._onOpenedDialogsChange),this.listenTo(this.opened_talks_collection,"sync",this._onOpenedDialogsSync),this._isLastMessageInDialog()&&this.listenTo(this.model.collection,"notes:resize",(function(t){e.notesWidth=t,e.resizeFeedButtons()})),this.isVoiceMessage()&&(c().mixin(this,S.default),this._initVoiceState()),this.setSupportedReactions(),this.setRichLink(),this.setHighlightsFromURL(!1),this.initMagnificPopup(),(0,B.getCachedSettings)(),c().mixin(this,N.SummarizeButton),c().mixin(this,j.GenerateResponseButton)},_isLastMessageInDialog:function(){var e,t,i=null===(e=this.model.get("dialog"))||void 0===e?void 0:e.id;return i&&this.model.collection.getTalkLastMessageId(i)===(null===(t=this.model)||void 0===t?void 0:t.id)},setRichLink:function(){var e=this.model.toJSON();C.AmoJoMediator.isExternalChat(e.chat_id)&&e.has_rich_link&&this.options.getRichLink(e.message.text).then(s().bind((function(e){this.model.set({rich_link:e})}),this))},setSupportedReactions:function(){var e,t=C.AmoJoMediator.get()[this.model.get("chat_id")],i=D.Chat.getExternalContact(t),o=i?M.ExternalContact.getOrigin(i):(null===(e=this.model.get("author"))||void 0===e?void 0:e.origin)||"",n=x.default.get(o)||{supported_reactions:{}};this.model.set({supported_reactions:n.supported_reactions||{}})},onContextMenuClick:function(e){if(s().contains(s().values(I.ALLOWED_CONTEXT_MENU_TYPES),e))switch(!0){case e===I.NOT_QUOTATION_CONTEXT_MENU_TYPES.GENERATE_RESPONSE:this.handleGenerateResponseClick();break;case s().contains(s().values(I.NOT_QUOTATION_CONTEXT_MENU_TYPES),e):this.triggerAnswerTo(e);break;default:this.triggerAddQuotation(e)}},triggerAnswerTo:function(e){var t;if(e===I.NOT_QUOTATION_CONTEXT_MENU_TYPES.ANSWER_TO_DIRECT)t=this._findDirectAnswerTalkId();else{var i=this.model.get("dialog");t=i&&s().propertyOf(i)("opened")&&s().propertyOf(i)("id")}this._$document.trigger("notes:compose:answer-to",[e,this.model,t])},triggerAddQuotation:function(e){var t=this.getQuotationRenderParams("compose",this.model.attributes);this._$document.trigger("notes:compose:add-quot",[e,this.model,t])},handleCommentReplyClick:function(){this.triggerAnswerTo(I.NOT_QUOTATION_CONTEXT_MENU_TYPES.ANSWER_TO_COMMENT)},handleEmotionClick:function(e){this.showAiEmotionTooltip(e)},handleBubbleLinkClick:function(e){return W((function(){var t,o,n,a,s;return q(this,(function(r){switch(r.label){case 0:return"#withLightToBusinessWhatsAppModal"!==e.currentTarget.getAttribute("href")?[3,3]:(e.preventDefault(),e.stopPropagation(),[4,(0,U.getWaLiteFeatureInfo)({isPhonesRequested:!0})]);case 1:return(t=r.sent())?(o=t.whatsappType,n=t.totalNumbersCount,[4,Promise.all([i.e(37084),i.e(40446),i.e(38994),i.e(16228),i.e(26263),i.e(21932),i.e(88012),i.e(39515),i.e(27001),i.e(90580),i.e(12897),i.e(39042),i.e(79954),i.e(20064),i.e(7390),i.e(10642),i.e(52758),i.e(41136),i.e(39970),i.e(28419),i.e(21896),i.e(34040),i.e(79328),i.e(47419),i.e(21921),i.e(27992),i.e(74647),i.e(16025),i.e(15081),i.e(16427),i.e(10417),i.e(42162),i.e(69314),i.e(70112),i.e(60200),i.e(17815),i.e(14657),i.e(46335),i.e(95337)]).then(i.bind(i,891547))]):[2];case 2:a=r.sent(),s=a.default,this._addComponent(s,{shouldUpdateFeatureStatus:!1,initialWhatsAppCloudApiStep:o,liteConnectedNumbersCount:n}),r.label=3;case 3:return[2]}}))})).apply(this)},handleQuotationClick:function(){var e=s().propertyOf(this.model.get("reply_to"))("message")||s().propertyOf(this.model.get("forwards"))(["messages",0]);this.scrollToMessage(e.id,e.msec_created_at)},scrollToMessage:function(e,t){this.options.findAndScrollToView(e,t,"")},isVoiceMessage:function(){return"voice"===this.model.get("message").type},toggleAutoclose:function(){this._findElem("outgoing_icon").toggleClass(this._class("icon_push")),this._findElem("outgoing_autoclose_wrapper").toggleClass(this._class("active_autoclose"))},initMagnificPopup:function(){var e=!1;if(this.model.get("message_attributes")&&this.model.get("message_attributes").facebook){var t=this.model.get("message_attributes").facebook,i=t.story_url||t.reply_to_url||t.share_url||"";this.$el.magnificPopup({type:"ajax",delegate:'.feed-note__media-preview--stories:not(".feed-note__media-preview__file"):not(.feed-note__media-preview--unavailable):not(.feed-note__media-preview--load-error)',tLoading:'<span class="spinner-icon spinner-icon-abs-center"></span>',closeMarkup:'<button title="%title%" type="button" class="mfp-close mfp-close_image-button"><svg class="svg-icon mfp-close_svg-icon"><use xlink:href="#common--close-not-painted"></use></svg></button>',closeBtnInside:!1,tClose:APP.lang.button_text_close,ajax:{settings:{error:s().bind((function(e,t,i){"error"===t&&""===i?window.open(this.$el.find(".feed-note__media-preview--stories").attr("href")):this.$el.find(".feed-note__media-preview--stories").replaceWith('<div class= "feed-note__media-preview feed-note__media-preview--stories feed-note__media-preview--load-error" ><div class="feed-note__media-preview-unavailable-text">'.concat((0,y.i18n)("Story unavailable"),"</div></div>")),n().magnificPopup.close()}),this)}},callbacks:{parseAjax:s().bind((function(e){var t=e.xhr.getResponseHeader("content-type");this.$el.find(".feed-note__media-preview--stories").removeClass("feed-note__media-preview--load-error"),t.indexOf("video")>-1?(this.$el.find(".feed-note__media-preview--stories").data("type","video"),e.data='<video class="feed-note__stories--video" controls="controls" autoplay><source src="'.concat(i,'"></video>')):(this.$el.find(".feed-note__media-preview--stories").attr("src",i),e.data='<img class="feed-note__stories--image" src="'.concat(i,'" />'))}),this),beforeOpen:s().bind((function(){e="hidden"===n()("html").css("overflow")}),this),afterClose:function(){e&&n()("html").css("overflow","hidden")}}})}},switchAutoClose:function(e){e.currentTarget.checked?this._toggleCheckedWithAutoClose(1):this._toggleCheckedWithAutoClose(0)},_toggleCheckedWithAutoClose:function(e){var t=this.model.get("dialog")||{},i=this.opened_talks_collection.get(t.id);(0,O.updateAutoClose)(t.id,e).done((function(){i&&i.set({auto_close:e})})).fail((function(){i.set({auto_close:1===e?0:1})}))},onImageLoad:function(){this.model.trigger("notes:update-sticky")},showTalkContext:function(e){this._$document.trigger({type:"controls:hide",target:this.el}),e.stopPropagation(),this._findElem("talk").toggleClass("feed-note__talk--context-opened")},_onMouseOverCheckAISelect:function(){var e=this.model.get("author"),t=this.model.get("message");APP.constant("helpbot_enabled")&&!this._elem("last_paragraph").find(".js-ai_answer").length&&!s().contains(["amocrm","bot"],e.origin)&&"text"===t.type&&(0,b.hasKeys)(this.model,["collection","bots_collection"])&&""===this.model.get("metadata")&&this.model.collection.bots_collection.length&&this._elem("ai_answer_wrapper").is(":empty")&&this._elem("ai_answer_wrapper").append(_()({ref:"/tmpl/controls/select.twig"}).render({class_name:"".concat(this._class("ai_answer")," js-ai_answer"),selected:"",name:"ai_answer",items:[{id:"default",option:(0,y.i18n)("Bot")}].concat(this.model.collection.bots_collection.map((function(e){return{id:e.id,option:e.get("name")}})))}))},_onMouseLeaveDestroyAISelect:function(){var e=this._findElem("ai_answer");e.length&&!e.find(".control--select--list-opened").length&&(this.$el.closest(".notes-wrapper__scroller").css({"overflow-y":"scroll",width:"100%"}),e.remove())},_onAIAnswerChange:function(){var e=this._findElem("ai_answer").length?this._findElem("ai_answer").find("input"):this._findElem("message_ai_answer").find("input"),t=e.val();e.siblings(".custom-scroll").children('[data-value="'.concat(e.val(),'"]')).hasClass("control--select--list--item-key_selected")||n().ajax({url:"/ajax/v2/messages/".concat(this.model.id),method:"PUT",dataType:"json",contentType:"application/json",data:JSON.stringify({intent_id:e.val(),intent_type:1,is_last:this.model.collection.max((function(e){return e.get("created_at")}))===this.model})}),e.val(t).trigger("controls:change:visual")},_onIntentCollectionLoad:function(){var e=this.model.get("author"),t=this.model.get("message"),i=this.$el.find(".feed-note__ai_text").data("id");!s().contains(["amocrm","bot"],s().propertyOf(e)("origin"))&&"text"===t.type&&(0,b.hasKeys)(this.model,["collection","bots_collection"])&&this._findElem("message_ai_answer").find(".control--select").html(_()({ref:"/tmpl/controls/select.twig"}).render({selected:i,name:"ai_answer",items:this.model.collection.bots_collection.map((function(e){return{id:e.id,option:e.get("name")}}))}))},sendSalesbotButton:function(e){n().ajax({url:"/ajax/v2/messages/classify",method:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({message_id:this.model.get("id"),button_name:n()(e.currentTarget).data("text")})})},openIntentSelector:function(e){e.stopPropagation(),this._findElem("plug_select").siblings(".control--select").find(".control--select--button").trigger("click"),this._onIntentOpenedBlockScroll()},_onOpenedDialogsChange:function(){var e,t=this.model.get("dialog")||{},i=this.opened_talks_collection&&this.opened_talks_collection.get(t.id);!t.opened||i&&t.id!==i.id||(this.model.set({dialog:s().extend(t,i?i.toJSON():{status:1})}),e=s().result(i,"changedAttributes",{}),e=s().without(s().keys(e),"last_message","last_message_date","last_message_author"),s().isEmpty(e)||this.render())},_onOpenedDialogsSync:function(){var e=this.model.get("dialog")||{},t=this.opened_talks_collection&&this.opened_talks_collection.get(e.id),i=t&&t.get("auto_close_at")>0;if((0,T.isFeatureAvailable)(T.Features.EMOTION_DETECTOR_AVAILABLE)){var o=this.opened_talks_collection.find((function(t){return t.get("id")===e.id&&"NEUTRAL"!==t.get("emotion")}));if(e.is_last&&this.addEmotionInboxSubscriber(),o&&o===t&&e.is_last)return void this.checkShouldShowEmotion(o)}t&&e.is_last&&(e.read_status!==t.get("read_status")||i)&&this._render()},checkIsEmotionDetectorEnabled:function(){return W((function(){var e;return q(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,(0,f.getFeaturesByQuery)({queries:[T.Features.IS_EMOTION_DETECTOR_ENABLED],shouldCamelCase:!1})];case 1:return e=t.sent().features,(0,T.updateFeature)(T.Features.IS_EMOTION_DETECTOR_ENABLED,e[T.Features.IS_EMOTION_DETECTOR_ENABLED]||!1),[2,e[T.Features.IS_EMOTION_DETECTOR_ENABLED]||!1];case 2:return t.sent(),[3,3];case 3:return[2]}}))}))()},checkShouldShowEmotion:function(e){return W((function(){var t,i;return q(this,(function(o){switch(o.label){case 0:if(t=(0,T.getAccountFeatures)()[T.Features.IS_EMOTION_DETECTOR_ENABLED],!s().isUndefined(t))return[3,4];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.checkIsEmotionDetectorEnabled()];case 2:return i=o.sent(),t=i,[3,4];case 3:return o.sent(),[3,4];case 4:return this.model.set({dialog:K(J({},this.model.get("dialog")),{is_emotion_detector_enabled:t,emotion:e.get("emotion")})}),[2]}}))})).apply(this)},_onIntentOpenedBlockScroll:function(){var e=(0,w.getScrollBarWidth)("custom-scroll");this.$el.closest(".notes-wrapper__scroller").css({"overflow-y":"hidden",width:"calc(100% - ".concat(e,"px)")})},_onIntentClosedUnblockScroll:function(e){var t=n()(e&&e.currentTarget);this.$el.closest(".notes-wrapper__scroller").css({"overflow-y":"",width:""}),t.hasClass("feed-note__ai-answer")&&t.remove()},_onDialogClosed:function(e){this.model.get("dialog")&&e.talk===this.model.get("dialog").id&&(this._removeClass(["talk_opened","talk_context_visible"],"talk"),this.$el.find(".feed-note__talk-full").remove(),this.$el.find(".feed-note__talk-outgoing-wrapper").remove(),this._findElem("outgoing_title").addClass("feed-note__talk-outgoing-title_close"),this._findElem("outgoing_title").css("color","#8F9A9D"),this.model.set({dialog:s().extend({},this.model.get("dialog"),{amojo_autoclose:!1,opened:!1})}))},_onDialogChanged:function(e){var t=this.model.get("dialog")||{},i=this.model.get("show_dialog"),o=e.changed;o.dialog&&i&&t.id===o.dialog.id&&(this.model.set({dialog:s().extend(t,{amojo_autoclose:!1,opened:o.dialog.opened||!1,is_last:o.dialog.is_last||!1})}),this._render())},_onDialogHide:function(e){e.target!==this.el&&this._removeClass(["talk_context_visible"],"talk")},_onTalkReplyClick:function(){var e=C.AmoJoMediator.get()[this.model.get("chat_id")]||{contacts:{},users:{}},t=s().keys(e.contacts)[0];t&&this.model.trigger("notes:compose:switch","chat",{user_id:t,talk_id:s().propertyOf(this.model.get("dialog"))("id")})},_onShowDialogChanged:function(){var e,t;this.model.get("show_dialog")&&(e=this.options.getOriginCollection(this.model),this.model.collection.indexOf(this.model)===this.model.collection.length-1&&e.length>3&&(t=this.model.collection.get(e.at(e.length-3).get("id")))&&!t.get("grouped")&&t.get("show_dialog")&&(t.set("show_dialog",!1),t.trigger("render")))},_onRichLinkChanged:function(){var e=this.options.scrollUpdate({anchor_el:this.el});this._render(),e(),this.options.debouncedStickyUpdate(),this._richLinkAdded||this._elem("rich_link_img").one("error",s().bind(this._onRichLinkImgLoadError,this)),this._richLinkAdded=!0},_onRichLinkImgLoadError:function(e){this.options.onStartNoteMutations();var t=this.options.scrollUpdate({anchor_el:this.el});this.model.set("rich_link",s().extend({img_error:!0},this.model.get("rich_link")||{}),{silent:!0}),n()(e.currentTarget).remove(),t(),this.options.debouncedStickyUpdate(),this.options.onEndNoteMutations()},sendAiCloseEvent:function(e,t){((0,T.isFeatureAvailable)("airewriter")||(0,T.isFeatureAvailable)("kommo_ai_trial_started")&&!(0,T.isFeatureAvailable)("kommo_ai_trial_ended"))&&g().publish(R.AI_ANSWER_CLOSE,{talkId:e,event:t})},closeTalk:function(){var e=this,t=this.model.get("dialog").id;n().ajax({url:"/private/ajax/v2/json/chats/talk_close",method:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({request:{chat_id:this.model.get("chat_id"),talk_id:t,entity_id:this.options.element_id,entity_type:this.options.element_type}})}).then((function(){var i=e.options.getOriginCollection(e.model);if(e.sendAiCloseEvent(t,R.AiAnswerCloseEvents.CLOSE),APP.constant("account").nps_enabled){var o=e.model.get("dialog")||{},n=[z.NPS_BOT_WORKING,z.NPS_BOT_WORKED];s().includes(n,o.status)||(o.status=z.NPS_BOT_WORKING,i.nps_working_dialogs||(i.nps_working_dialogs=[]),i.nps_working_dialogs.push(o.id),e.model.set("dialog",o),e._render())}}))},readTalk:function(){var e=this.model.get("dialog").id;n().ajax({url:"/private/ajax/v2/json/chats/talk_read",method:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({request:{chat_id:this.model.get("chat_id"),talk_id:e,entity_id:this.options.element_id,entity_type:this.options.element_type}})}).then(s().bind((function(){this.sendAiCloseEvent(e,R.AiAnswerCloseEvents.READ),this._markRead([e])}),this))},_markRead:function(e){var t=this.model.get("dialog"),i=this.opened_talks_collection.get(t.id);this._findElem("talk_read_wrapper").remove(),this._findElem("outgoing_title").removeClass("feed-note__talk-outgoing-title_unread"),this.model.set({new_from_socket:!1,dialog:K(J({},t),{read_status:1})}),null==i||i.set("read_status",1),APP.constant("account").is_chats_inbox_enabled&&(0,E.isImboxSection)()&&this._$document.trigger("fake-socket-event:inbox:talks:read",[e])},destroy:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.$el.find("img").off(),P.default.prototype.destroy.apply(this,t),clearInterval(self.interval_id),this.emotionInboxToken&&g().unsubscribe(this.emotionInboxToken),this._richLinkAdded&&this._elem("rich_link_img").off()},formatTimer:function(e){var t=p().utc(1e3*e-Date.now()),i=+t.format("D")-1;return i>0?"".concat(i+(0,y.i18n)("d.")," ").concat(t.format("HH:mm:ss")):t.format("HH:mm:ss")},checkAutocloseTimer:function(){var e,t,i=this,o=this.model.get("dialog")||{},n=this.opened_talks_collection.get(o.id),a=this;if(!s().isUndefined(n)&&n.get("auto_close")){if(1e3*(e=n.get("auto_close_at"))-Date.now()<=0)return clearInterval(a.interval_id),n.set("auto_close",0),void n.set("auto_close_at",0);a.interval_id&&clearInterval(a.interval_id),a.interval_id=setInterval((function(){if(1e3*e-Date.now()<=0)return clearInterval(a.interval_id),n.set("auto_close",0),void n.set("auto_close_at",0);t=a.formatTimer(e),a._findElem("outgoing_autoclose_wrapper").find(i._selector("info_bubble_text")).html((0,y.i18n)("Auto-solve in")+" "+t),a._findElem("timer_autoclose").html(t)}),1e3)}},getQuotationRenderParams:function(e,t){var i,o,n=t.author,a=C.AmoJoMediator.get()[t.chat_id]||{contacts:{},users:{}};return o=t.id?s().clone(this._getChatUser(a,{id:n?n.id:0,origin:n?n.origin:"",isBot:!!n&&n.bot,name:n?n.name:"",avatar:n?n.avatar:""})):{name:n.name},s().extend({},t,{amo_author:o,is_instagram:!(!t.message_attributes||!t.message_attributes.facebook)&&(t.message_attributes.facebook.story||t.message_attributes.facebook.reply_to_story||t.message_attributes.facebook.share||t.message_attributes.facebook.reel),type:e,is_vk:!(!t.message_attributes||!t.message_attributes.vk)&&t.message_attributes.vk.video,isReferral:null===(i=t.message_attributes)||void 0===i?void 0:i.referral,is_incoming:"external"===e&&"amocrm"!==this.model.get("author").origin&&!this.model.get("author").bot})},_render:function(){for(var e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];return W((function(){var e,o,n,a,r;return q(this,(function(l){switch(l.label){case 0:return P.default.prototype._render.apply(this,t),this._getAutocloseDelay()>0&&this.checkAutocloseTimer(),this.isVoiceMessage()&&(s().isUndefined(this._sliderOptions)&&(c().mixin(this,S.default),this._initVoiceState(),this.delegateEvents(this.events)),this._sliderOptions("init"),this._tryResumeAfterUpdate()),this.resizeFeedButtons(),(e=this.model.get("reply_markup"))&&e.mode===L.PRODUCTS_MESSAGE&&e.products_message?[4,Promise.all([i.e(35095),i.e(35427)]).then(i.bind(i,936853))]:[3,2];case 1:o=l.sent().CatalogOutgoingMessageView,this.catalogOutgoingMessageView=this._addComponent(o,{el:this.$el,messageId:this.model.id,replyMarkup:e}),this.catalogOutgoingMessageView.render(),l.label=2;case 2:return n=this.model.get("message_attributes"),(null==(a=null==n?void 0:n.waba)?void 0:a.products_message)?[4,Promise.all([i.e(35095),i.e(5658)]).then(i.bind(i,291682))]:[3,4];case 3:r=l.sent().CatalogIncomingMessageView,this.catalogIncomingMessageView=this._addComponent(r,{el:this.$el,messageId:this.model.id,waba:a}),this.catalogIncomingMessageView.render(),l.label=4;case 4:return[2]}}))})).apply(this)},showAiEmotionTooltip:function(){return W((function(){var e,t,o,n,a,r,l,d,c,u,_,h;return q(this,(function(p){switch(p.label){case 0:return e=this,t=this.model.get("dialog").id,o=this.opened_talks_collection.get(t),n=null,o||(d=e.options.getOriginCollection(e.model),c=null===(l=d.last_dialogs_ids)||void 0===l||null===(r=l[t])||void 0===r||null===(a=r.model)||void 0===a?void 0:a.get("dialog"),n=null==c?void 0:c.emotion),u=(null==o?void 0:o.get("emotion"))||n,Boolean(event.currentTarget.querySelector("#ai-emotion-tooltip"))?[3,2]:[4,i.e(54320).then(i.bind(i,554320))];case 1:_=p.sent(),h=_.default,this.aiEmotionTooltipView=this._addComponent(h,{el:this._findElem("aiEmotion"),talkId:t,emotion:u,destroy:function(){null==o||o.set({emotion:"NEUTRAL"}),e.model.set({dialog:s().extend({},e.model.get("dialog"),{emotion:"NEUTRAL"})})}}),p.label=2;case 2:return[2]}}))})).apply(this)},resizeFeedButtons:function(){for(var e=0;e<$.length;e++){var t,i,o;if(this._findElem($[e]).length){var n=this._findElem("feedNoteButtons"),a=n[n.length-1],s=null==a||null===(t=a.getBoundingClientRect())||void 0===t?void 0:t.width,r=this.notesWidth?this.notesWidth:null==a||null===(o=a.parentElement)||void 0===o||null===(i=o.getBoundingClientRect())||void 0===i?void 0:i.width;s&&r&&(s>=r-20?this._findElem($[e]).addClass("collapsed"):s<=r-120&&this._findElem($[e]).removeClass("collapsed"))}}},setHighlightsFromURL:function(e){if((0,v.getQueryParam)("highlightId")||(0,v.getQueryParam)("highlights")){var t=(0,v.QStoJSON)((0,v.getQueryString)(),!0),i=t.highlightId,o=t.highlights;(i===this.model.get("id")||o)&&(s().isObject(o)&&!s().isArray(o)?o=s().values(o):s().isString(o)&&(o=[o]),this.model.trigger("search:highlight:init",o),!1!==e&&this._render())}},_getTemplate:function(){var e=C.AmoJoMediator.get()[this.model.get("chat_id")];return e&&e.entity_type===APP.element_types.contacts?"/tmpl/notes/types/amojo/external.twig":"/tmpl/notes/types/amojo/internal.twig"},_getTemplateName:function(){return this.model.get("chat_id")?"amojo":"chat"},isIncoming:function(){var e=this.model.toJSON(),t=C.AmoJoMediator.get()[e.chat_id]||{contacts:{}};return e.author&&Boolean(t&&t.contacts[e.author.id])},setAutocloseAt:function(e){var t=this.model.get("dialog")||{},i=this.opened_talks_collection.get(t.id),o=e+this._getAutocloseDelay();this._getAutocloseDelay()||(o=0),i&&(i.set("auto_close_at",o),i.set("auto_close",o>0?1:0)),this.checkAutocloseTimer()},isAvailableForChatting:function(){var e,t=(0,A.get)()[null===(e=this.model.get("author"))||void 0===e?void 0:e.id];return!t||t.is_available_for_chatting},clearAutocloseAt:function(){var e=this.model.get("dialog")||{},t=this.opened_talks_collection.get(e.id);t&&(t.set("auto_close_at",0),t.set("auto_close",0))},_getAutocloseDelay:function(){return APP.constant("account").talks_auto_close_delay},_getAmoJoUserForReaction:function(e,t){var i=t||{},o=i.full_name,n=i.origin,a=i.bot,s=C.AmoJoMediator.get()[this.model.toJSON().chat_id],r=this._getChatUser(s,{name:o,id:e,origin:n,isBot:a});return{name:r.name,avatar:r.avatar,id:e,isBot:a}},_reduceEmojiData:function(e){var t={};return s().reduce(e,(function(e,i){return t[i.user_id]||(t[i.user_id]=this._getAmoJoUserForReaction(i.user_id,null==i?void 0:i.author)),e[i.emoji]&&e[i.emoji].users?e[i.emoji].users.push({user:t[i.user_id]}):e[i.emoji]={users:[{user:t[i.user_id]}]},e}),{},this)},updateDialogEmotion:function(e){var t=e.emotion,i=e.talkId,o=this.opened_talks_collection.get(i),n=this.model.get("dialog");n&&!n.emotion!==t&&n.id===i&&(o&&o.set("emotion",t),this.model.set({dialog:K(J({},n),{is_emotion_detector_enabled:(0,T.isFeatureAvailable)(T.Features.IS_EMOTION_DETECTOR_ENABLED),emotion:t})}),this.aiEmotionTooltipViewAdded&&(this.aiEmotionTooltipViewAdded=!1))},subscribeInboxEmotion:function(){var e=this;return g().subscribe("socket-event:talks:emotion",(function(t,i){return e.updateDialogEmotion(i)}))},addEmotionInboxSubscriber:function(){this.emotionInboxToken||(this.emotionInboxToken=this.subscribeInboxEmotion())},_addSubscribers:function(e){e.dialog&&e.dialog.is_last&&(0,T.isFeatureAvailable)(T.Features.IS_EMOTION_DETECTOR_ENABLED)&&this.addEmotionInboxSubscriber()},_getRenderParams:function(){var e=this.options.getOriginCollection(this.model),t=this.model.toJSON(),i=t.error.link,o=!1;try{new URL(i).origin!==window.location.origin&&(o=!0)}catch(e){o=!1}var n,a=C.AmoJoMediator.get()[t.chat_id]||{contacts:{},users:{}},r=D.Chat.getExternalContact(a),l=this._getChatUser(a,{id:t.author?t.author.id:0,origin:t.author?t.author.origin:"",isBot:!!t.author&&t.author.bot,name:t.author?t.author.name:"",avatar:t.author?t.author.avatar:""}),d=!t.recipient&&s().isNull(t.group_id)?{}:this._getChatUser(a,{id:t.recipient&&t.recipient.id,group_id:t.group_id,origin:t.recipient&&t.recipient.origin}),c=s().isUndefined(this.model.collection.bots_collection)?{}:this.model.collection.bots_collection.map((function(e){return{id:e.id,option:e.get("name")}})),u=this._getExtensionForFileIcon(s().propertyOf(t.message)(["attachment","type"])||s().propertyOf(t.message)("type"),s().propertyOf(t.message)(["attachment","name"])||s().propertyOf(t.message)("media_file_name")),_=t.author&&Boolean(a&&a.contacts[t.author?t.author.id:0]),h=s().extend({helpbot_disabled:!APP.constant("helpbot_enabled"),is_available_for_chatting:this.isAvailableForChatting(),nps_disabled:!APP.constant("account").nps_enabled,entity_type:APP.data.current_entity,DIALOG_STATUSES:z,is_external:a&&!s().contains(s().values(s().pick(APP.element_types,"leads","customers")),a.entity_type),is_incoming:_,current_user_amojo_id:(0,k.current)("amojo_id"),amo_author:l,amo_recipient:d,origin:r&&M.ExternalContact.getOrigin(r),origin_icon:r&&M.ExternalContact.getOriginIconUrl(r),intent_items:c,embed_maps_key:APP.constant("google_embed_maps_api_key"),extension:u,isExternalLink:o},t),p=t.metadata||[],m=this._getAutocloseDelay(),g=this.model.get("dialog")||{},f=_?0:1;if(h.reactions&&(h.reactions_data=this._reduceEmojiData(h.reactions)),this.model.get("crm_bot_name")&&(h.external_author_name=this.model.get("crm_bot_name")),this.isVoiceMessage()&&this._voice_player_state&&(this._updateVoiceState(),h.message.voice_player_state=this._voice_player_state),h.reply_to&&(h.quot_data=[this.getQuotationRenderParams(h.is_external?"external":"internal",h.reply_to.message)]),h.forwards&&(h.quot_data=s().map(h.forwards.messages,(function(e){return this.getQuotationRenderParams(h.is_external?"external":"internal",e)}),this)),g.id&&(n=this.opened_talks_collection.get(g.id),s().isUndefined(n)||n.id!==g.id?(h.dialog.auto_close=m?1:0,h.dialog.amojo_autoclose=!!m,h.dialog.read_status=s().isEmpty(this.model.get("external_id"))||!_?1:0):(h.dialog.auto_close=m?n.get("auto_close"):0,h.dialog.auto_close_at=n.get("auto_close_at"),h.dialog.auto_close_timeout=m,h.dialog.auto_close_at_formatted=this.formatTimer(n.get("auto_close_at")),h.dialog.status=0,h.dialog.read_status=this.model.get("new_from_socket")||s().isUndefined(n.get("read_status"))?f:n.get("read_status"),h.dialog.amojo_autoclose=!!m)),this.model.set("show_dialog",!this.model.get("grouped")),h.show_dialog=!this.model.get("grouped"),t.metadata){if(s().isString(t.metadata))try{p=JSON.parse(t.metadata)}catch(e){p=t.metadata}s().each(p,(function(e){2!==e.type&&4!==e.type||(e.data.user_name=(0,k.getUserName)(e.data.user_id))}),this),this.model.set("metadata",p),h.metadata=p}if(h.dialog&&s().includes(e.nps_working_dialogs,h.dialog.id)&&(h.dialog.status=z.NPS_BOT_WORKING),h.dialog&&(h.dialog=s().extend(h.dialog,{is_last:this.model.collection.getTalkLastMessageId(h.dialog.id)===h.id})),h.dialog&&h.dialog.is_last){var v,y=null===(v=h.dialog)||void 0===v?void 0:v.id,b=this.opened_talks_collection.find((function(e){return e.get("id")===y&&e.get("emotion")&&"NEUTRAL"!==e.get("emotion")}));y&&b&&(h.dialog.emotion=b.get("emotion"),h.dialog.is_emotion_detector_enabled=(0,T.isFeatureAvailable)(T.Features.IS_EMOTION_DETECTOR_ENABLED))}return h.system_props={need_msec:(0,k.current)("settings").need_msec||!1},h},onAmoJoReplyClick:function(e){var t=n()(e.currentTarget),i=t.closest(".js-amojo-reply");e.stopPropagation(),i.hasClass("js-amojo-recipient")&&this.model.get("group_id")?this.model.trigger("notes:compose:switch","chat",{group_id:this.model.get("group_id")}):this.model.trigger("notes:compose:switch","chat",{user_id:t.attr("data-id"),talk_id:s().propertyOf(this.model.get("dialog"))("id")})},_getChatUser:function(e,t){var i=(0,k.getByAmoJoId)(),o=this.options.getExtraData(),n=e.contacts[t.id],a={};switch(!0){case parseInt(t.group_id)>=0:return{id:t.group_id,name:(0,k.getGroupName)(t.group_id),avatar:""};case t.isBot&&"bot"!==t.origin:a={user:t.id,name:t.name,avatar:"/frontend/images/interface/inbox/mesage_bot_avatar.png"};break;case"bot"===t.origin:var r=(0,A.get)()[t.id];a=r&&r.name&&r.avatar&&r.is_integration_bot?{user:t.id,name:r.name,avatar:r.avatar}:{user:t.id,name:"SalesBot",avatar:"/frontend/images/interface/inbox/mesage_bot_avatar.png"};break;case s().isObject(i[t.id]):a={id:i[t.id].id,avatar:i[t.id].avatar,name:i[t.id].title,alt:s().compact([i[t.id].title,"(".concat((0,k.getGroupName)(i[t.id].group),")")]).join(" ")};break;case"unsorted"===APP.getBaseEntity():a={id:null,name:o.name,avatar:o.avatar};break;case Boolean(n):(a=(a=s().find(o.elements,(function(e){return M.ExternalContact.getLinkedEntityId(n)===parseInt(e.id)})))&&C.AmoJoMediator.checkWithOriginalProfilePhoneShown(D.Chat.getId(e))?s().extend({},a,{name:"".concat(a.name," ").concat((0,y.phone)(M.ExternalContact.getOriginalProfilePhone(n)))}):a||{}).name=(0,y.contactName)(a.name),a.type="contact";break;default:a={}}return{id:a.id,name:a.name||a.title,alt:a.alt,avatar:a.avatar}},_getExtensionForFileIcon:function(e,t){var i;if(!s().contains(["text","contact","location"],e)){switch(i=this._getExtensionFile(t).toLowerCase(),!0){case"pdf"===i:i="pdf";break;case"xls"===i:case"xlsx"===i:i="xls";break;case"pptx"===i:case"ppt"===i:i="ppt";break;case s().contains(["img","jpg","jpeg","gif","tiff","bmp","raw","png"],i):i="img";break;case s().contains(["avi","mov","flv","mp4","mpeg","3gp"],i):i="vid";break;case s().contains(["mp3","wav","wma","aud","mpa","aiff","aac"],i):i="aud";break;case s().contains(["doc","docx","docm","dot"],i):i="doc";break;default:i.length>3&&(i="".concat(i.slice(0,2),"..."))}var o=s().contains(["img","doc","pdf","vid","aud","xls"],i);return o||(i=i.toUpperCase()),{extension:i,is_standard_extension:o}}},_findDirectAnswerTalkId:function(){var e,t=null===(e=this.model.get("author"))||void 0===e?void 0:e.origin,i=this.opened_talks_collection.findWhere({status:0,origin:t,category:"main"});return(null==i?void 0:i.get("id"))||0},_getExtensionFile:function(e){return e.match(/\.([^.]+)$|$/)[1]||""}});var Q="../build/transpiled/interface/notes/views/types/amojo";window.define(Q,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([Q])},763358:(e,t,i)=>{i.r(t),i.d(t,{default:()=>r});var o=i(629133),n=i.n(o),a=i(632925),s=i(661533);const r=a.default.extend({events:n().extend({},a.default.prototype.events||{},{"click .note-chat:not(note-chat-expanded)":"expandChatNote","click .note-chat.note-chat-expanded":"contractChatNote"}),expandChatNote:function(){s(event.target).closest(".js-call-play").length||this.$(".note-chat").addClass("note-chat-expanded")},contractChatNote:function(e){s(e.target).closest(".js-call-play").length||this.$(".note-chat").removeClass("note-chat-expanded")}});var l="../build/transpiled/interface/notes/views/types/chat";window.define(l,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([l])},441665:(e,t,i)=>{i.r(t),i.d(t,{default:()=>s});var o=i(629133),n=i.n(o),a=i(632925);const s=a.default.extend({_classes:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return n().extend(a.default.prototype._classes.apply(this,t),{note_text:"feed-note__extended_service_message-note",short_text:"feed-note__extended_service_message-note-text-short"})},expandHeader:function(e){e.stopPropagation(),this._findElem("note_text").toggleClass(this._class("short_text")),a.default.prototype.expandHeader.call(this,e)},checkHeaderExpander:function(){this._findElem("header").toggleClass("expandable",this.model.get("data").text.indexOf("\n")>-1)}});var r="../build/transpiled/interface/notes/views/types/extended_service_message";window.define(r,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([r])},726379:(e,t,i)=>{i.r(t),i.d(t,{default:()=>n});var o=i(709849);const n=o.default.extend({_getTemplate:function(e){var t=o.default.prototype._getTemplate.apply(this,arguments);return"edit"!==e&&(t="/tmpl/notes/types/geolocation.twig"),t}});var a="../build/transpiled/interface/notes/views/types/geolocation";window.define(a,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([a])},461344:(e,t,i)=>{i.r(t),i.d(t,{default:()=>r});var o=i(629133),n=i.n(o),a=i(810455),s=i(632925);const r=s.default.extend({events:n().extend({},s.default.prototype.events||{},{"click .js-feed-note-button":"startUnmerge"}),initialize:function(){s.default.prototype.initialize.apply(this,arguments)},_getRenderParams:function(e){var t=this.model.get("data").params.unmerge_hash;return n().extend({can_unmerge:t&&!n().isEmpty(t)},s.default.prototype._getRenderParams.apply(this,e))},startUnmerge:function(){this.ma=this._addComponent(a.UnmergeElements,{entity:APP.getBaseEntity(),hash:this.model.get("data").params.unmerge_hash,type:this.model.get("element_type")}),this.listenTo(this.ma,"unmerge:complete",this.unmergeComplete),this.listenTo(this.ma,"unmerge:failed",this.unmergeFailed)},unmergeComplete:function(){this.ma.destroy(),this._$document.trigger("page:reload")},unmergeFailed:function(){this.ma.destroy()}});var l="../build/transpiled/interface/notes/views/types/merge";window.define(l,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([l])},776695:(e,t,i)=>{i.r(t),i.d(t,{default:()=>p});var o=i(629133),n=i.n(o),a=i(323344),s=i(214558),r=i(445368),l=i(632925),d=i(761634),c=i(580326),u=i(570286),_=i(181605),h=i(661533);const p=l.default.extend({events:n().extend({},l.default.prototype.events||{},{"click .js-feed-talk-pinned":"onScrollToTalkClick"}),initialize:function(){var e=this;l.default.prototype.initialize.apply(this,arguments),this.opened_talks_collection=this.model.collection.opened_talks_collection,this.listenTo(this.opened_talks_collection,"change",this.onTalkChanged),this.listenTo(this.opened_talks_collection,"refresh",(function(){e.model.collection.remove(e.model.trigger("destroy",e.model))}))},_getRenderParams:function(){var e=l.default.prototype._getRenderParams.apply(this,arguments),t=(0,s.get)(),i=this.options.getExtraData();return e.data=n().map(e.data,(function(e){var o=c.AmoJoMediator.get()[e.chat_id]||{contacts:{},users:{}},a=_.Chat.getExternalContact(o)||{},s=e.last_message_author||{},l={};switch(!0){case"contact"!==s&&(0,d.get)()[s.id]:l={name:(0,d.get)()[s.id].name};break;case"contact"!==s.type&&parseInt(s.id)<=0:l={name:"SalesBot"};break;case"contact"===s.type&&s.id===a.id:l=(l=n().find(i.elements,(function(e){return u.ExternalContact.getLinkedEntityId(a)===parseInt(e.id)})))&&c.AmoJoMediator.checkWithOriginalProfilePhoneShown(_.Chat.getId(o))?n().extend({},l,{name:l.name+" "+(0,r.phone)(u.ExternalContact.getOriginalProfilePhone(a))}):l||{};break;case n().isObject(t[s.id]):l={name:t[s.id].title};break;default:l={}}return n().extend({origin_icon:u.ExternalContact.getOriginIconUrl(a),last_message_outgoing:n().propertyOf(e)(["last_message_author","id"])!==n().propertyOf(a)("id")},e,{last_message_author:{name:l.name}})})),n().extend({expanded:!!this._expanded},e)},onTalkChanged:function(e){var t=this;if(n().propertyOf(e.changed)("last_message_date")){var i=n().sortBy(this.model.get("data"),"last_message_date");if(1!==i.length||i[0].id===e.id){var o=n().chain(i).reduce((function(e,i){var o=t.opened_talks_collection.get(i.id);return o&&e.push(o.toJSON()),e}),[]).sortBy("last_message_date").value();n().isEqual(i,o)||(this.model.set({date_create:o[0].last_message_date,data:o}).trigger("note:view:update",this.model),this.render(),this.model.trigger("notes:update-sticky"))}}},onScrollToTalkClick:function(e){var t=h(e.currentTarget);this.options.scrollToTalkId(parseInt(t.attr("data-id")),this.model.get("date_create"))},getContextMenuLinkTo:function(){var e=n().propertyOf(this.model.get("data"))([0,"id"]);if(!e)return l.default.prototype.getContextMenuLinkTo.apply(this,arguments);var t=this.model.get("date_create"),i=(0,a.removeQueryParam)(["t","tid","cid"]);return"".concat(window.location.origin).concat(window.location.pathname).concat((0,a.setQueryParam)({t,cid:e},{query_string:i,only_query_string:!0}))}});var m="../build/transpiled/interface/notes/views/types/opened_talks";window.define(m,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([m])},780753:(e,t,i)=>{i.r(t),i.d(t,{default:()=>d});var o=i(629133),n=i.n(o),a=i(460159),s=i.n(a),r=i(313981),l=i(661533);const d=r.default.extend({template:"/tmpl/notes/types/grouped/users_online.twig",template_item:"/tmpl/notes/types/grouped/user_online_item.twig",className:"feed-note-wrapper feed-note-wrapper-amojo feed-note-typing-wrapper-amojo",events:{"click .js-target_typing":"onAmoJoReplyClick","click .js-grouped-expand-interaction":"expandInteractiveUsers"},initialize:function(e){r.default.prototype.initialize.apply(this,arguments),this.expanded=e.expanded,this.setExpanded=e.setExpanded},getUsersArray:function(e){var t=[];return n().each(e.models,(function(e){var i={id:e.id,avatar:e.get("avatar"),name:e.get("title"),typing:e.get("typing")};t.push(i)})),t},expandInteractiveUsers:function(){this.expanded=this.setExpanded(),this._render()},onAmoJoReplyClick:function(e){e.stopPropagation(),this._$document.trigger("notes:compose:switch",["chat",{user_id:l(e.currentTarget).attr("data-id")}])},render:function(){return this.collection.length<2||this.expanded?s()._preload([this.template_item])().then(n().bind(this._render,this)):s()._preload([this.template])().then(n().bind(this._render,this))},_render:function(){var e=this,t=this.getUsersArray(this.collection),i=n().filter(t,(function(e){return e.typing}));this.$el.html(""),t.length<2||this.expanded?n().each(t,(function(t){e.$el.append(s()({ref:e.template_item}).render({author:t}))})):this.$el.append(s()({ref:this.template}).render({authors:t,count:t.length,authors_typing:i,expanded:this.expanded}))}});var c="../build/transpiled/interface/notes/views/users_online";window.define(c,(function(){var e="undefined",i=typeof t===e?typeof __WEBPACK_AMD_DEFINE_RESULT__===e?typeof module===e?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:t;return i&&i.default||i})),window.require([c])}}]);var _global="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};_global.SENTRY_RELEASE={id:"build_2025_11_28_17_08_33"},function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=(new Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="7036c982-fcef-4e3c-ba9c-e16e33214633",e._sentryDebugIdIdentifier="sentry-dbid-7036c982-fcef-4e3c-ba9c-e16e33214633")}catch(e){}}();
//# sourceMappingURL=63865.039fbc7b689c1adc4fef.js.map