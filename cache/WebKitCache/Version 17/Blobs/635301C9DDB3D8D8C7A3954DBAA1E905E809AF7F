"use strict";(window.webpackChunk=window.webpackChunk||[]).push([[68924],{131629:(t,e,s)=>{s.r(e),s.d(e,{default:()=>_});var i=s(629133),n=s.n(i),o=s(460159),a=s.n(o),r=s(180137),d=s(210734),l=s(661533);s(818194);const _=d.default.extend({controlClassName:"card-task__type-wrapper",_selectors:function(){return{text:"textarea",type_name:'input[name="task_type_name"]',type:'input[name="type"]:checked',preview:".card-task__type",opened:".card-task__type-opened",scroller:".card-task__types"}},_classes:function(){return{right_position:"card-task__type-icon-picker_right-position"}},document_events:{"controls:hide:private":"_hide","click .card-task__type-opened":"_stopPropagation",'change .card-task__types-item input[name="type"]':"_customTypeChange",'keydown .card-task__types-item input[name="task_type_name"]':"_onCustomTypeKeydown",toggleWidgetPanel:"_setPositions","touchstart .card-task__types-item-label":"_checkTaskTypeCheckedOnClick","mouseup .card-task__types-item-label":"_checkTaskTypeCheckedOnClick","click .card-task__types-item-label_custom .task_type_select__icon":"_openIconPicker","click .modal-body__inner__todo-types__item__iconpick__icon-wrap":"_onTypeIconChosen","click .modal-body__inner__todo-types__item__iconpick__ok":"_hide"},events:{click:"_open","task-comment:refresh":"_refresh","task-comment:type-save":"_saveCustomType"},initialize:function(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];d.default.prototype.initialize.apply(this,e),this._$opened_node=null,this._$window.on("resize".concat(this.ns),n().bind(this._setPositions,this))},destroy:function(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];this._$opened_node&&(this.$el.append(this._$opened_node),this._$opened_node=null),d.default.prototype.destroy.apply(this,e)},_onCustomTypeKeydown:function(t){13===t.keyCode&&this._hide()},_customTypeChange:function(t){var e=l(t.currentTarget);this._$opened_node&&("custom"===e.val()?(this._$opened_node.find(this._selector("type_name")).show().focus(),this._openIconPicker()):(this._$opened_node.find(this._selector("type_name")).val("").hide(),this._hide()))},_open:function(t){var e,s;this._$opened_node||(t&&t.stopPropagation&&t.stopPropagation(),this._$document.trigger({type:"controls:hide",target:this.el}),this._$opened_node=this._elem("opened"),this._toggleBodyOverlay(this._$opened_node,this._hide),e=this._$opened_node.find(this._selector("scroller")),(s=this._$opened_node.find(this._selector("type"))).length||(s=this._$opened_node.find('input[type="radio"]:first')),e.scrollTop(s.parent().position().top-e.height()/2),this._setPositions())},_openIconPicker:function(){var t=this;this._$opened_node&&!this._$icon_picker&&(this._$icon_picker=l(a()({ref:"/tmpl/common/modal/todo_type_icon_picker.twig"}).render({color:this.$('[name="icon_color"]').val(),class_name:"card-task__type-icon-picker"})),this._$opened_node.append(this._$icon_picker),this._$icon_picker.find(".modal-body__inner__todo-types__item__colorpick").colpick({layout:"hex",isTransparent:!1,height:152,flat:!0,color:this.$('[name="icon_color"]').val(),onChange:function(){var e=this.find(".colpick_hex_field input").val();t._$icon_picker.find("svg").css("fill","#".concat(e)),t._$opened_node.find(".card-task__types-item-label_custom svg").css("fill","#".concat(e)),t._$opened_node.find('[name="icon_color"]').val(e)}}),this._$icon_picker.offset().left<0&&this._$icon_picker.addClass(this._class("right_position")))},_hide:function(){var t=this._hideIconPicker();return!1!==t&&(t=this._hideControl()),t},_hideIconPicker:function(){if(this._$opened_node)return this._$opened_node.find(this._selector("type_name")).val()||"custom"!==this._$opened_node.find(this._selector("type")).val()?void(this._$icon_picker&&(this._$icon_picker.remove(),this._$icon_picker=null)):(this._shakeCustomTypeOnError(),!1)},_hideControl:function(){var t,e,s,i="";if(this._$opened_node){if(s=this._$opened_node.find(this._selector("type_name")).val(),t=this._$opened_node.find(this._selector("type")).val(),e=APP.constant("task_types")["key_".concat(t)]||{icon_id:this._$opened_node.find('[name="icon_id"]').val(),color:this._$opened_node.find('[name="icon_color"]').val()},!s&&"custom"===t)return this._shakeCustomTypeOnError(),!1;i=s||this._$opened_node.find(".card-task__types-item input:checked + .card-task__types-item-label").html(),this.$(".card-task__type").html(a()({ref:"/tmpl/common/tasks_type_name.twig"}).render({icon_class_name:"card-task__type-icon",text_class_name:this.$(".card-task__type").data("class-name-text"),type:parseInt(t),type_name:i,type_icon:e.icon_id,type_color:e.color})),this._toggleBodyOverlay(!1),this.$el.removeClass("opened"),this._$opened_node.hide(),this._$opened_node=null,this.$el.find('input[type="hidden"], input:checked, '.concat(this._selector("type_name"))).trigger("change")}},_refresh:function(){this._open(),this._hide()},_shakeCustomTypeOnError:function(){if(this._$opened_node){var t=this._$opened_node.find('[name="task_type_name"]').closest(".card-task__types-item");t.addClass("animated shake"),n().delay(n().bind((function(){t.removeClass("animated shake")})),400)}},_setPositions:function(){if(this._$opened_node){var t=this._elem("preview").get(0).getBoundingClientRect(),e=this._$window.scrollTop();this._$opened_node.css({display:"",top:t.top+e,left:t.left,zIndex:this._maxControlBodyZIndex}).css(Modernizr.prefixed("transform"),""),this._$window.height()-this._$opened_node.get(0).getBoundingClientRect().bottom<10&&this._$opened_node.css("top",t.bottom+e).css(Modernizr.prefixed("transform"),"translateY(calc(-100% + 21px))")}},_toggleBodyOverlay:function(t){return d.default.prototype._toggleBodyOverlay.call(this,t,this._hide)},_stopPropagation:function(t){t.stopPropagation()},_checkTaskTypeCheckedOnClick:function(t){var e=t.currentTarget.parentNode.querySelector("input:checked");t.stopPropagation(),e&&"custom"!==e.value&&this._hide()},_onTypeIconChosen:function(t){if(this._$opened_node){var e=l(t.currentTarget).find("svg").clone();this._$opened_node.find(".card-task__types-item-label_custom svg").replaceWith(e),this._$opened_node.find('[name="icon_id"]').val(e.attr("data-icon-id"))}},_saveCustomType:function(){var t,e=this._findElem("type_name").val(),s=this._findElem("type").val(),i=parseInt(this.$('[name="icon_id"]').val()),o=this.$('[name="icon_color"]').val(),a=function(t){this.$el.trigger("task-comment:type-saved",[t])};if(!e)return"custom"===s&&(this._shakeCustomTypeOnError(),s=!1),void a.call(this,s);(0,r.addCustomType)({name:e,icon_id:i,icon_color:o}).done(n().bind((function(r){"OK"===r.status?((t=n().isEmpty(APP.constant("task_types"))?{}:APP.constant("task_types"))["key_".concat(r.data.ID)]={id:r.data.ID,option:n().escape(e),icon_id:i,color:o},APP.constant("task_types",t),s=r.data.ID):(this._shakeCustomTypeOnError(),s=!1),a.call(this,s)}),this)).fail(n().bind(a,this,!1))}});var c="../build/transpiled/interface/card/controls/task_type";window.define(c,(function(){var t="undefined",s=typeof e===t?typeof __WEBPACK_AMD_DEFINE_RESULT__===t?typeof module===t?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:e;return s&&s.default||s})),window.require([c])},128244:(t,e,s)=>{s.r(e),s.d(e,{default:()=>l});var i=s(661533),n=s.n(i),o=s(629133),a=s.n(o),r=s(460159),d=s.n(r);d()._preload(["/tmpl/todo/form/completed_task.twig","/tmpl/todo/form/task_result.twig"])();const l={_selectors:{wrapper:".card-task__result-wrapper__inner",result:".task_edit_result",paragraph:".card-task__result-wrapper__inner__paragraph",editor:".card-task__result-wrapper__result-editor",submit_btn:".js-task-submit"},_setEditClick:function(t){if(this.$el=t.$el,this.$el.parent().show(),this._findElem("paragraph").hide(),!this.$el.data("is_open_editor")){var e={template_name:"completed_task",render_data:{task_id:t.task_id,result_id:t.result.id,result_text:t.result.text}};this._render(e);var s=this._findElem("result");s.on("input change",{prev_result:t.result.text,$submit_btn:this._findElem("submit_btn")},this._validateResult),s.focus(),this.$el.data("is_open_editor",!0),this.$el.trigger("modal:centrify")}},_getTemplate:function(t){return a().isUndefined(t)&&(t="completed_task"),{completed_task:"/tmpl/todo/form/completed_task.twig",task_result:"/tmpl/todo/form/task_result.twig"}[t]},_getRenderedTemplate:function(t){var e=this._getTemplate(t.template_name);return d()({ref:e}).render({render_data:t.render_data})},_render:function(t){this.$el.append(this._getRenderedTemplate(t))},_updateResultCompletedTask:function(t){var e;this.$el=t.$el;var s=t.model.get("id"),i=t.model.get("result"),o=i.id,r=this._findElem("result");e=r.val();var d=this._findElem("submit_btn");if(this._validateResult({data:{result:e,prev_result:i.text,$submit_btn:d}})){d.trigger("button:load:start",["white"]);var l={BODY:e,NOTE_TYPE:13,ACTION:"EDIT_NOTE",ELEMENT_TYPE:4};a().isEmpty(i)?(l.ELEMENT_ID=s,l.ACTION="ADD_NOTE"):l.ID=o,n().ajax({url:"/private/notes/edit2.php",data:l,method:"POST"}).done(a().bind((function(){var s=this._findElem("paragraph"),n=this._findElem("editor"),o=this.$el.data("is_open_editor");i.text=a().escape(e),t.model.set("result",i);var r={template_name:"task_result",render_data:i};n.remove(),e=this._getRenderedTemplate(r),s.html(e),s.show(),a().isUndefined(o)&&(this.$el=this._findElem("wrapper")),this.$el.data("is_open_editor",!1),this.$el.trigger("modal:centrify"),this.$el.trigger("modal:need-page-reload")}),this))}},_findElem:function(t){return this.$el.find(this._selectors[t])},_validateResult:function(t){var e,s="button-input-disabled",i={};e=t.type?n()(this).val().trim():t.data.result.trim();var o=t.data.prev_result,r=t.data.$submit_btn;switch(!0){case a().isEmpty(e):case o===a().escape(e):i.is=!0}return i.is?(r.toggleClass(s,!0),t.type&&t.stopPropagation(),!1):(r.toggleClass(s,!1),!0)}};var _="../build/transpiled/interface/notes/views/completed_task";window.define(_,(function(){var t="undefined",s=typeof e===t?typeof __WEBPACK_AMD_DEFINE_RESULT__===t?typeof module===t?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:e;return s&&s.default||s})),window.require([_])},210989:(t,e,s)=>{s.r(e),s.d(e,{default:()=>_});var i=s(629133),n=s.n(i),o=s(161320),a=s.n(o),r=s(460159),d=s.n(r),l=s(661533);const _={events:{"click .js-task-complete-btn":"complete","click .js-todo-result:not(.button-input-disabled)":"setResult","click .js-todo-result-skip":"skipResultClick","click .js-task-result-button":"completeClick","click .js-clone-task-preset":"_onPresetClick","focus .card-task__result-wrapper__inner__textarea":"_showCloneControls"},completeClick:function(t){var e=l.Deferred(),s=this._form.model.get("result"),i=this.$(".js-task-result-button");if("Y"!==i.attr("data-loading"))return t&&t.stopPropagation&&t.stopPropagation(),i.trigger("button:load:start",["white"]),this._cloneThis(this._getCloneData()).then(n().bind((function(t){this.model.set({date_modify:a()().unix(),status:1,result_form:!0,result_text:s,has_clone:!!t}),t&&this.model.collection.add(t),this.model.complete({silent:Boolean(s)||!n().isUndefined(t)}).then(n().bind(this._setResult,this,s),n().bind((function(){this.model.set({status:0}),this._loadStop()}),this)).then(n().bind((function(){t&&(this.$el.addClass("hidden"),this.options.onAdd(t).then(n().bind((function(){this.cancel(),this.$el.removeClass("hidden"),this._scrollOnEdit()}),this)))}),this)).then(e.resolve)}),this)),e.promise()},_setResult:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.is_open=!1,this.model.set("result_form",!1),t&&(this._setChanges(!1),this.model.resultNotSync(t,e)),this.cancel()},_onPresetClick:function(t){var e=l(t.currentTarget),s=e.parent(),i=a()();switch(t.stopPropagation(),s.children().not(e).remove(),e.attr("data-preset")){case"tomorrow":i.add(1,"days");break;case"next_week":i.add(1,"weeks");break;case"next_month":i.add(1,"months")}this.$('[name="clone_task"]').prop("checked",!0).trigger("change"),s.html(d()({ref:"/tmpl/common/tasks_date.twig"}).render({date:i.set("hours",23).set("minutes",59).format(APP.system.format.date.full),main_user:this.model.get("responsible_user_id"),type:this._form.model.get("type"),typeName:this._form.model.get("task_type_name"),duration:0,wrapper_class_name:"card-task__clone__dates__preset-datetime-wrapper"})).find(".tasks-date").one("controls:view:init",(function(){s.find(".tasks-date__caption-date").click()}))},_onDateCloneChange:function(t){var e=l(t.currentTarget).parent();e.parent().children().not(e).remove(),this.$('[name="clone_task"]').prop("checked",!0).trigger("change")},_changeCloneDateRadio:function(){var t=this.$('.card-task__clone__dates__preset-datetime [name="date"]').val();this.$(".js-task-clone-preset-custom").val(t)},_getCloneData:function(){var t=[this.$('.card-task__clone__dates [name="date"]').val(),this.$('.card-task__clone__dates [name="time"]').val()].join(" ").trim();return t||(t=a()().add(1,"days").hours("23").minute("59").format(APP.system.format.date.full)),{timestamp:this._getTimeStampFromString(t),duration:this.$('.card-task__clone__dates [name="duration"]').val()||0}},_cloneThis:function(t){var e=l.Deferred(),s=this.model.clone();return this.$(".card-task__clone__checkbox input:checked").length?this.$(".card-task__type-wrapper").one("task-comment:type-saved".concat(this.ns),n().bind((function(i,n){s.set({complete_till:t.timestamp,duration:t.duration,id:null,result_form:!1,status:0,type:n||s.get("type")}),s.save().then((function(){e.resolve(s.toJSON())}))}),this)).trigger("task-comment:type-save"):e.resolve(),e.promise()},_showCloneControls:function(){this.$el.css("height","").find(".card-task__clone").css("display",Modernizr.prefixed("flex")),this.model.trigger("notes:update-sticky")},_loadStop:function(){this.$(".js-task-result-button").trigger("button:load:stop")},complete:function(t){return t&&(t.stopPropagation(),l(t.currentTarget).find(".js-task-complete-icon").addClass("animated tada")),this.model.set({date_modify:a()().unix(),status:1,result_form:!0}),this.model.complete().then(n().bind((function(){this.cancel(),APP.is_touch_device||this.$(".task-complete__textarea-input").focus()}),this))},showCompleted:function(){this.model.set({date_modify:a()().unix(),status:1,result_form:!0}),this.model.trigger("sync",this.model),this.cancel()},skipResultClick:function(){this.model.set("result_form",!1),this.cancel()},setResult:function(t){var e=this._form.model.get("task_result");return t&&t.stopPropagation(),n().isEmpty(this.validate())?this.model._pending?this.model._loading:(this.model.set({result_form:!1}),this._findElem("submit").trigger("button:load:start",["white"]),this.model.result(e).then(n().bind(this.cancel,this))):new Promise((function(t,e){e("Empty result text")}))}};var c="../build/transpiled/interface/notes/views/mixins/task_complete";window.define(c,(function(){var t="undefined",s=typeof e===t?typeof __WEBPACK_AMD_DEFINE_RESULT__===t?typeof module===t?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:e;return s&&s.default||s})),window.require([c])},968924:(t,e,s)=>{s.r(e),s.d(e,{default:()=>C});var i=s(629133),n=s.n(i),o=s(162262),a=s.n(o),r=s(230385),d=s.n(r),l=s(445368),_=s(184437),c=s(982862),p=s(859200),h=s(214558),u=s(632925),m=s(128244),f=s(649442),g=s(210989),y=s(622150),k=s(386769),v=s(393455),P=s(893381),b=s(661533);s(131629);var w=n().invert(APP.element_types),E=null,T={},$=u.default.extend({_selectors:function(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];return n().extend({},u.default.prototype._selectors.apply(this,e),{comment:".card-task__type-wrapper",task_date:".tasks-date",result_textarea:".js-task-result-textarea",editable_control:".js-control-contenteditable",textarea:".control-contenteditable__area",result_completed_task:".js-edit-result-completed-task",task_inner:".card-task__inner"})},events:n().extend({},u.default.prototype.events||{},{"click .js-task-edit-cancel":"cancel","click .js-task-submit:not(.button-input-disabled)":"save","click .card-task__inner":"editClick","click:note_expander .js-note-expander":"_updateSticky","click .card-task__result-wrapper":"_stopPropagation","mousedown .js-task-result-textarea":"_saveScrollPosBeforeFocus","touchstart .js-task-result-textarea":"_saveScrollPosBeforeFocus","focus .js-task-result-textarea":"_resetScrollPosAfterFocus",'change [name="type"]':"_onChangeTypeFocusOnText","autosize.resized .js-task-result-textarea":"_updateSticky","input [contenteditable]":"onContenteditableInput","focus [contenteditable]":"_updateActiveInput","input .js-task-result-textarea":"updateLastInputInfo"}),initialize:function(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];u.default.prototype.initialize.apply(this,e),this.model.get("is_add")||a().mixin(this,g.default),this.models.length>1&&a().mixin(this,f.default.prototype),this.listenTo(this.model,"sync",this._startFutureTimer,this),n().propertyOf(this)(["model","collection"])&&this.listenTo(this.model.collection,"notes:update-sticky",this._restoreFocus,this),this.listenTo(this.model,"task:complete-after-chat",this._focusCompleteAfterChat,this),this._startFutureTimer()},destroy:function(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];this._check_complete_interval&&clearInterval(this._check_complete_interval),u.default.prototype.destroy.apply(this,e)},_stopPropagation:function(t){t.stopPropagation()},_restoreFocus:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._editing&&t.after_resort&&n().propertyOf(T)(["$active_input","length"])&&((0,c.setCursorPosition)(T.$active_input,T.end_position,T.cursorNode),this._scrollOnEdit())},_setEditClick:function(t){var e,s=b(t.target).hasClass("js-note-expander");if(this.model.get("is_completed")&&!s)return e={$el:this._findElem("result_completed_task"),task_id:this.model.get("id"),result:this.model.get("result")},void m.default._setEditClick(e);u.default.prototype._setEditClick.apply(this,arguments)},cancel:function(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];if(this.is_open)return this.is_open=!1,this._editing=!1,T={},this.$(".card-task").removeClass("expanded"),this._updateSticky(),void(this._form&&this._form.destroy());this.model.set("result_form",!1),u.default.prototype.cancel.apply(this,e)},_render:function(t){var e=this._isFutureTask();u.default.prototype._render.apply(this,arguments),e&&this.el.parentNode&&this.el.parentNode.classList["edit"===t?"add":"remove"]("editing"),"edit"===t||e||(this._initForm(),this._subscribeToFormChanges())},_updateTasksDateTitle:function(){this._findElem("task_date").attr("data-responsible",this._form.model.get("main_user")).attr("data-title",this._form.model.get("body")).attr("data-type",this._form.model.get("type")).attr("data-type-name",this._form.model.get("task_type_name"))},_isFutureTask:function(){var t=this.model.get("complete_till");switch(!0){case n().isUndefined(t):t=d()().hour(23).minutes(59).format("X");break;case n().isString(t):t=this._getTimeStampFromString(t)}return d().utc(t,"X").tz(APP.system.timezone).isAfter(d()())},_focusCompleteAfterChat:function(){this.is_open||this.edit(),n().delay(n().bind((function(){this.$el.addClass("animated js-complete-after-chat").one(APP.animation_event+this.ns,n().bind((function(){this.$el.removeClass("animated js-complete-after-chat")}),this))}),this),150)},edit:function(){var t=this.is_open,e=!1;this.model.get("status")?(e=!0,this.model.set("result_form",!0),this._render(),this.el.classList.add("".concat(this.className,"-in-edit"))):t||(e=!0,this.is_open=!0,this.$(".card-task").addClass("expanded"),this._updateSticky()),this._editing=!0,e?(this._initForm(),this._subscribeToFormChanges(),this.$("textarea").trigger("controls:textarea:autosize"),(0,_.setCursorToEnd)(this.$("textarea"))):this.enterEditMode()},_subscribeToFormChanges:function(){var t=this;this._form.model.on("has_changes has_reverted",(function(){t._updateTasksDateTitle()}))},editClick:function(t){this.is_open&&(t.stopPropagation(),this.enterEditMode())},enterEditMode:function(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];!0===this.model.get("editable")&&(this.is_open=!1,this._form&&(this._form.destroy(),this._form=null),u.default.prototype.edit.apply(this,e),this._subscribeToFormChanges(),this.$el.one("controls:view:init",this._selector("editable_control"),n().bind((function(){APP.is_touch_device||(0,_.setCursorToEnd)(this._elem("textarea"))}),this)),this._scrollOnEdit(),this._updateSticky())},_scrollOnEdit:function(){this._isFutureTask()&&n().isFunction(this.options.scrollToEnd)&&this.options.scrollToEnd(this.$el)},_onChangeTypeFocusOnText:function(){var t=this._findElem("textarea");t.length&&(t.focus(),this._putCursorToEnd({currentTarget:t.get(0)}))},_getRenderParams:function(t){var e=this.model.get("complete_till"),s=n().reduce(APP.constant("task_types"),(function(t,e,s){var i=parseInt(e.icon_id)>0?e.icon_id:0,o=e.color;return t[s]={id:e.id,icon_id:e.icon_id,color:e.color,option:['<span class="task_type_select__icon">','<svg class="svg-icon svg-tasks--types-icons--'.concat(i,'-dims" style="fill: #').concat(o||"568FFA",'">'),'<use xlink:href="#tasks--types-icons--'.concat(i,'"></use>'),"</svg>","</span>"].join("")+n().escape(e.option)},t}),{}),i=(0,p.isAdmin)(),o=n().extend({1:{id:1,option:'<span class="task_type_select__icon icon icon-inline icon-follow-up"></span>'.concat(APP.todo_types[1])},2:{id:2,option:'<span class="task_type_select__icon icon icon-inline icon-case-red"></span>'.concat(APP.todo_types[2])}},s,i?{custom:{id:"custom",option:'<span class="task_type_select__icon"><svg class="svg-icon svg-tasks--types-icons--0-dims"><use xlink:href="#tasks--types-icons--0"></use></svg></span>'.concat(APP.lang.tasks_custom)}}:{}),a=APP.todo_types[this.model.get("type")],r=s["key_".concat(this.model.get("type"))]||{},l=this.model._getResult(),_=this.model.get("result"),c=(0,h.current)("settings").default_task_preset,u=n().contains(["after_15_minutes","after_30_minutes","in_an_hour"],c),m=u?1800:0;return a||(a=r.option),n().isString(e)?e=this._getTimeStampFromString(e):!e&&c&&(e=(0,P.default)(c).tz(APP.system.timezone),u||(e=e.hours(23).minutes(59)),e=e.unix()),n().extend({duration:m},this.model.toJSON(),{is_edit:"edit"===t||this.model.get("result_form"),template:this._getTemplateName(),_templates:v.default,complete_till:e,main_element_type:this.options.element_type,element_type_code:w[this.model.get("element_type")],type_name:a,type_icon:r.icon_id,type_color:r.color,expired:e<=d()().unix(),expired_diff:Math.abs(d()().diff(d()(e,"X"),"days")),is_not_exist:!this.model.get("element_id"),is_today:d().utc(e,"X").tz(APP.system.timezone).isSame(d()(),"day"),is_future:d().utc(e,"X").tz(APP.system.timezone).isAfter(d()()),task_types:o,joined:n().map(n().without(this.models,this.model),(function(t){return n().extend(t.toJSON(),{_links:t.links,element_id:t.get("element_id"),element_type_code:w[t.get("element_type")],extra:n().extend(this.options.getExtraData(t),{users:this._getUsers()})})}),this),result:_||l&&l.toJSON(),extra:n().extend(this.options.getExtraData(this.model),{users:this._getUsers()})})},_getExistingUsers:function(){var t=this._getUsers()[this.model.get("responsible_user_id")]||{};return[n().extend({id:this.model.get("responsible_user_id"),title:t.full_name||(0,l.i18n)("notes_user_deleted")},t)]},_getTemplateName:function(){return"task"},_getTemplate:function(t){return this.model.get("status")?"/tmpl/notes/types/task_completed.twig":"edit"===t?"/tmpl/cards/tasks/edit.twig":"/tmpl/cards/tasks/view.twig"},_copyFormToModel:function(){var t=APP.constant("user")||{},e=parseInt(this._form.model.get("type")),s=[this._form.model.get("date"),this._form.model.get("time")].join(" "),i=this._getTimeStampFromString(s);this.model.set({complete_till:i,duration:this._form.model.get("duration"),type:e,data:n().extend({},this.model.get("data"),{text:this._form.model.get("body")||""}),responsible_user_id:this._form.model.get("main_user"),created_by:t.id,expired:d()(i,"X").tz(APP.system.timezone).isBefore(d()().tz(APP.system.timezone))})},_getTimeStampFromString:function(t){return d()(t,"".concat(APP.system.format.date.date," ").concat(APP.system.format.date.time)).unix()-60*(new Date).getTimezoneOffset()+60*d().tz.zone(APP.system.timezone).utcOffset(d()())},validate:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return!this._form.model.get("task_result")&&this.model.get("status")&&(t=n().extend(t||{},{task_result:!1})),n().isEmpty(t)||this.$el.addClass("note-has-error"),t},_saveScrollPosBeforeFocus:function(){E=n().compose((function(){E=null}),this.options.scrollUpdate())},_resetScrollPosAfterFocus:function(t){this.$("textarea").trigger("controls:textarea:autosize"),n().isFunction(E)&&(E(),this._afterRender()),this._updateActiveInput(t)},save:function(){return new Promise(n().bind((function(t,e){var s=this.validate();if(this.model._pending)e("model already saving");else switch(!0){case!(this._editing&&this._findElem("editable_control").length||this.model.get("status")):this.completeClick().then(t,e);break;case parseInt(this.model.get("status"))>0:this.setResult().then(t,e);break;case!n().isEmpty(s):e(s);break;default:if(!0===this._custom_type_pending)return void e("custom todo type saving");this._findElem("submit").trigger("button:load:start",["white"]),this._custom_type_pending=!0,this.$el.one("task-comment:type-saved".concat(this.ns),this._selector("comment"),n().bind((function(s,i){this._custom_type_pending=!1,!1!==i?(this._form.model.set("type",i),this.model.set("type",i),u.default.prototype.save.call(this).then(t,e)):e()}),this)),this._findElem("comment").trigger("task-comment:type-save")}}),this))},_onUserChanged:function(t){t&&!t.is_new?this.$(".js-task-main_user").val(t.id).trigger("change"):t=(0,h.get)(this.model.get("responsible_user_id"))},_startFutureTimer:function(){this._isFutureTask()&&!this.model.get("is_new")&&(clearInterval(this._check_complete_interval),this._check_complete_interval=setInterval(n().bind(this._checkIsComplete,this),6e3))},_checkIsComplete:function(){this._isFutureTask()||this._findElem("result_textarea").val()||(this.render(),this.model.trigger("note:view:update",this.model),clearInterval(this._check_complete_interval))},_updateSticky:function(){var t=n().isFunction(this.options.scrollUpdate)&&this.options.scrollUpdate();n().isFunction(t)||(t=n().noop),this.model.trigger("notes:update-sticky",t)},updateLastInputInfo:function(t){this._updateActiveInput(t),this._updateEndPosition(t)},onContenteditableInput:function(t){this._updateSticky(t),this.updateLastInputInfo(t)},_updateActiveInput:function(t){n().extend(T,{$active_input:b(t.currentTarget)}),n().defaults(T,{end_position:0})},_updateEndPosition:function(t){var e=window.getSelection();n().extend(T,{end_position:n().propertyOf(b(t.currentTarget))(["0","selectionEnd"])||1===e.rangeCount&&e.getRangeAt(0).endOffset||0,cursorNode:e.baseNode})}});a().mixin($,y.default,k.default);const C=$;var x="../build/transpiled/interface/notes/views/task";window.define(x,(function(){var t="undefined",s=typeof e===t?typeof __WEBPACK_AMD_DEFINE_RESULT__===t?typeof module===t?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:e;return s&&s.default||s})),window.require([x])},649442:(t,e,s)=>{s.r(e),s.d(e,{default:()=>p});var i=s(629133),n=s.n(i),o=s(69991),a=s(632925),r=s(56973),d=s(304483),l=s(845043),_=s(611958),c=s(661533);const p=a.default.extend({events:n().extend({},a.default.prototype.events||{},{"click .js-note-mail-share":"shareThread","click .js-note-mail-message":"viewMail","click .js-note-mail-resend":"resendOnClick"}),resendOnClick:function(t){var e=this.model.get("data");t.preventDefault(),_.default.resendMessage(e.params.link_data.thread_id,e.params.link_data.message_id),e.params.delivery.status="queued",this.model.set("data",e),this._render()},shareThread:function(t){var e={id:+c(t.currentTarget).attr("data-note_id"),entity_type:+c(t.currentTarget).attr("data-element_type")},s=+c(t.currentTarget).attr("data-thread_id");e.entity_type=n().invert(APP.element_types)[e.entity_type],e.entity_type=e.entity_type.substring(0,e.entity_type.length-1),_.default.getThread(s).done((function(){new l.default({class_name:"modal-list",text:APP.lang.mail_confirm_share_access,accept:function(){var t={contacts:[],companies:[],leads:[],customers:[]},i={};i[APP.element_types.contacts]="contacts",i[APP.element_types.leads]="leads",i[APP.element_types.companies]="companies",i[APP.element_types.customers]="customers",t[APP.data.current_entity].push(+APP.data.current_card.id),APP.data.current_card&&APP.data.current_card.linked_forms&&APP.data.current_card.linked_forms.form_models&&APP.data.current_card.linked_forms.form_models.each((function(e){e.get("ID")&&t[i[e.get("ELEMENT_TYPE")]].push(+e.get("ID"))})),_.default.shareThread(s,t,e).done(n().bind((function(){this.requestSuccess(APP.lang.mail_share_success),c(document).trigger("page:reload")}),this)).fail(o.default.threadCommonFailModal)}})})).fail(o.default.threadCommonFailModal)},viewMail:function(t){var e,s,i=this,o=c(t.currentTarget),a=o.attr("data-thread_id"),l=o.attr("data-contact_id");return this.thread_modal=new d.default({class_name:"modal-list thread_modal",init:function(t){this.threadView=new r.default({id:a,filter:{contact_id:l},el:t,in_modal:!0,destroyFromReply:n().bind(this.destroy,this),modalShowError:n().bind(this.showError,this),onload:function(){t.trigger("modal:loaded").trigger("modal:centrify"),t.on("click",".thread_letter__contacts a, .mail_thread__linked_lead a",(function(t){t.preventDefault(),e=window.location.pathname,s=c(t.currentTarget).attr("href"),i.thread_modal.destroy(),e!==s&&(APP.router.navigate(s,{trigger:!0}),i._$document.trigger("page:show:overlay"),c("#card_change_loader").trigger("overlay:show"))}))}})},destroy:function(){c("#card_change_loader").trigger("overlay:hide"),i.thread_modal.threadView.destroy()}}),!1}});var h="../build/transpiled/interface/notes/views/types/mail";window.define(h,(function(){var t="undefined",s=typeof e===t?typeof __WEBPACK_AMD_DEFINE_RESULT__===t?typeof module===t?void 0:module.exports:__WEBPACK_AMD_DEFINE_RESULT__:e;return s&&s.default||s})),window.require([h])}}]);var _global="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};_global.SENTRY_RELEASE={id:"build_2025_11_28_18_50_52"},function(){try{var t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},e=(new Error).stack;e&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[e]="167c9b27-1515-4f38-bab3-7dea359adc09",t._sentryDebugIdIdentifier="sentry-dbid-167c9b27-1515-4f38-bab3-7dea359adc09")}catch(t){}}();
//# sourceMappingURL=68924.c512df53e56a67eec304.js.map